<!DOCTYPE html>
<html lang="en">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.80.0" />

    
    
    

<title>Reads network addresses in /proc • Brice Dutheil</title>













    
<meta property="og:locale" content="en">
<meta property="og:site_name" content="Brice Dutheil">
<meta property="og:title" content="Reads network addresses in /proc">
<meta property="og:type" content="website">
<meta property="og:url" content="https://blog.arkey.fr/2020/10/23/read-network-addresses-in-procfs/" />
<meta property="og:description" content="Java mostly, and general tech">
<meta property="og:image" content="https://blog.arkey.fr/social-sharing.png">
<meta property="og:image:type" content="image/png">
    
    
    
<meta property="og:image:width" content="192">
<meta property="og:image:height" content="192">
    

<meta property="og:updated_time" content="2020-10-23T23:25:32&#43;0200">



<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@BriceDutheil">
<meta name="twitter:title" content="Reads network addresses in /proc">

<meta name="twitter:image" content="https://blog.arkey.fr/social-sharing.png">

<meta name="twitter:description" content="Java mostly, and general tech">
<meta name="twitter:creator" content="@BriceDutheil">
    
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.4.1/styles/a11y-light.min.css" media="(prefers-color-scheme: light)"><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.4.1/styles/gruvbox-dark.min.css" media="(prefers-color-scheme: dark)">




<link rel="stylesheet" href="/scss/hyde-hyde.68d03b2cb787b87038e5c0a832e858f54dd397fe99de425b3b8ba50f015288eb.css" integrity="sha256-aNA7LLeHuHA45cCoMuhY9U3Tl/6Z3kJbO4ulDwFSiOs=">


<link rel="stylesheet" href="/scss/hyde-hyde-dark.39442299e30d42987c30cfc6196b66307d39e37e28dbb3bc9058e90c0eae1664.css" integrity="sha256-OUQimeMNQph8MM/GGWtmMH05434o27O8kFjpDA6uFmQ=" media="(prefers-color-scheme: dark)">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    
    <link rel="shortcut icon" sizes="192x192" href="/android-192-favicon.png">

    
    <link rel="shortcut icon" href="/android-192-favicon.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/v4-shims.min.css" integrity="sha512-KNosrY5jkv7dI1q54vqk0N3x1xEmEn4sjzpU1lWL6bv5VVddcYKQVhHV08468FK6eBBSXTwGlMMZLPTXSpHYHA==" crossorigin="anonymous" />

    
    


    
</head>


    <body class="">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="https://blog.arkey.fr">Brice Dutheil</a>
      </span>
      
      
        <div class="author-image">
          <img src="https://www.gravatar.com/avatar/f31c7fbcbb0766d0632d96fd7e74b649?s=240&d=mp" class="img--circle img--headshot element--center" alt="gravatar">
        </div>
      
      <p class="site__description">
         Java mostly, and general tech 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">Brice Dutheil</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/"><span class='fa-icon'><i class='fas fa-home'></i></span><code>cd <em>~</em></code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/posts/"><span class='fa-icon'><i class='fas fa-stream'></i></span><code>ls <em>posts/*</em></code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/series/"><span class='fa-icon'><i class='fas fa-list-alt'></i></span><code>grep -o <em>series</em> posts/* | sort -u</code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/tags/"><span class='fa-icon'><i class='fas fa-tags'></i></span><code>grep -o <em>tags</em> posts/* | sort -u</code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/cool-stuff/"><span class='fa-icon'><i class='fas fa-thumbtack'></i></span><code>cd <em>cool-stuff</em></code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/whoami/"><span class='fa-icon'><i class='fas fa-id-card'></i></span><code>whoami</code>
						<span></span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://twitter.com/BriceDutheil" rel="me"><i class="fa-w-16" aria-hidden="true"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="bird" class="svg-inline--fa fa-bird fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></i></a>
	
	
	
	<a href="https://github.com/bric3" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	<a href="https://speakerdeck.com/bric3" rel="me"><i class="fab fa-speaker-deck" aria-hidden="true"></i></i></a>
	
	
	
	
	
	
	
	<a href="https://linkedin.com/in/dutheilbrice" rel="me"><i class="fa-w-16" aria-hidden="true"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="pro-network" class="svg-inline--fa fa-pro-network fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></i></a>
	
	
	<a href="https://stackoverflow.com/users/48136/brice" rel="me"><i class="fab fa-stack-overflow fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	
</section>

      </div>
    </div>

  </div>
  <div class="container fixed-container">
    
<div class="copyright">
  &copy; 2010 - 2021 Brice Dutheil
  
    <a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a>
  
</div>



  </div>
</div>

        <div class="content container">
            
    <header>

 
 
 <div class="github-edit">
     <a href="https://github.com/bric3/bric3.github.io/edit/hugo-sources/content/posts/2020-10-23-read-network-addresses-in-procfs.adoc">
     <i class="fab fa-github fa-lg" aria-hidden="true"></i> Edit this page
     </a>
 </div>
 


</header>

            
    

<article>
  <header>
    <h1>Reads network addresses in /proc</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> 2020-10-23
    
    
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/shell">shell</a>
           
      
          <a class="badge badge-tag" href="/tags/bash">bash</a>
           
      
          <a class="badge badge-tag" href="/tags/ip">ip</a>
           
      
          <a class="badge badge-tag" href="/tags/procfs">procfs</a>
           
      
          <a class="badge badge-tag" href="/tags/awk">awk</a>
          
      
    
    
    <br/>
    <i class="fas fa-clock"></i> 28 min read

    
    
    

</div>


  </header>
  
  
  
  <div class="post adoc">
    <div class="paragraph">
<p>If you happen to be on a read only container that doesn’t have the usual network utilities,
like <code>netstat</code>, <code>ss</code> (socket stat), <code>lsof</code>, etc then your only option is to leverage procfs,
however procfs displays some data in hexadecimal.</p>
</div>
<div class="paragraph">
<p>This blog post briefly presents a few tricks to read <code>/proc</code> in a human readable way.</p>
</div>
<div class="paragraph">
<p>tl;dr One of the final command could be this one :</p>
</div>
<div class="listingblock">
<div class="title">lists destination IPs on port 9042</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ cat /proc/$(pidof java)/net/tcp \
  | awk -v DPORT=$(printf &#34;:%x&#34; 9042) &#39;$3 ~ DPORT { print $3}&#39; \
  | sort -u \
  | cut -f1 -d&#39;:&#39; \
  | awk &#39;{gsub(/../,&#34;0x&amp; &#34;)} OFS=&#34;.&#34; {for(i=NF;i&gt;0;i--) printf &#34;%d%s&#34;, $i, (i == 1 ? ORS : OFS)}&#39;
10.45.12.17
10.45.1.18
10.45.77.20
10.45.31.23
10.45.84.25
10.45.8.26
10.45.54.30
10.45.55.30
10.45.12.32
10.45.19.34
10.45.10.75
10.45.32.123</code></pre>
</div>
</div>
<div class="paragraph">
<p>I understand these long awk scripts are intimidating, but they are really helpful
when you don’t have a choice. Plus you learn <code>awk</code> basics.
So let’s see how I build it, then let’s look if it’s possible to repurpose elements
of this command other use cases.</p>
</div>
<div class="sect1">
<h2 id="_constructing_the_above_command"><a class="anchor" href="#_constructing_the_above_command"></a><a class="link" href="#_constructing_the_above_command">Constructing the above command</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>First we need to see which information we need to extract from procfs</p>
</div>
<div class="listingblock">
<div class="title">output of procfs net/tcp</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ cat /proc/$(pidof java)/net/tcp
  sl  local_address rem_address   st tx_queue rx_queue tr tm-&gt;when retrnsmt   uid  timeout inode
   0: 0100007F:3A98 00000000:0000 0A 00000000:00000000 00:00000000 00000000  1337        0 1694605946 1 0000000000000000 100 0 0 10 0
   1: 00000000:3A99 00000000:0000 0A 00000000:00000000 00:00000000 00000000  1337        0 1694637598 1 0000000000000000 100 0 0 10 0
   2: 00000000:3A9E 00000000:0000 0A 00000000:00000000 00:00000000 00000000  1337        0 1694637607 1 0000000000000000 100 0 0 10 0
   3: 00000000:1F90 00000000:0000 0A 00000000:00000000 00:00000000 00000000 43514        0 1694688232 1 0000000000000000 100 0 0 10 0
   4: 00000000:3AF2 00000000:0000 0A 00000000:00000000 00:00000000 00000000  1337        0 1694605955 1 0000000000000000 100 0 0 10 0
   5: 0D07D00A:3A9E 0F01D00A:9008 01 00000000:00000000 00:00000000 00000000  1337        0 1716103554 1 0000000000000000 20 4 0 20 33
   6: 0D07D00A:9152 1D20D00A:1F90 01 00000000:00000000 00:00000000 00000000  1337        0 1713179716 1 0000000000000000 20 4 22 10 -1
   7: 0D07D00A:D290 2708DC0A:0050 01 00000000:00000000 00:00000000 00000000 43514        0 1716022449 1 0000000000000000 20 4 28 10 145
   8: 0100007F:1F90 0100007F:86DC 01 00000000:00000000 00:00000000 00000000 43514        0 1716279440 2 0000000000000000 21 4 2 10 24
   9: 0D07D00A:AC3E 7126D00A:1F90 01 00000000:00000000 00:00000000 00000000  1337        0 1694739437 1 0000000000000000 21 4 22 10 -1
  10: 0D07D00A:88FA 901BD00A:1F90 01 00000000:00000000 00:00000000 00000000  1337        0 1694718568 1 0000000000000000 20 4 30 10 -1
...</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><a href="https://www.kernel.org/doc/Documentation/networking/proc_net_tcp.txt">procfs net/tcp documentation</a></div>
<div class="content">
<pre>This document describes the interfaces /proc/net/tcp and /proc/net/tcp6.
Note that these interfaces are deprecated in favor of tcp_diag.

These /proc interfaces provide information about currently active TCP
connections, and are implemented by tcp4_seq_show() in net/ipv4/tcp_ipv4.c
and tcp6_seq_show() in net/ipv6/tcp_ipv6.c, respectively.

It will first list all listening TCP sockets, and next list all established
TCP connections. A typical entry of /proc/net/tcp would look like this (split
up into 3 parts because of the length of the line):

   46: 010310AC:9C4C 030310AC:1770 01
   |      |      |      |      |   |--&gt; connection state
   |      |      |      |      |------&gt; remote TCP port number
   |      |      |      |-------------&gt; remote IPv4 address
   |      |      |--------------------&gt; local TCP port number
   |      |---------------------------&gt; local IPv4 address
   |----------------------------------&gt; number of entry

   00000150:00000000 01:00000019 00000000
      |        |     |     |       |--&gt; number of unrecovered RTO timeouts
      |        |     |     |----------&gt; number of jiffies until timer expires
      |        |     |----------------&gt; timer_active (see below)
      |        |----------------------&gt; receive-queue
      |-------------------------------&gt; transmit-queue

   1000        0 54165785 4 cd1e6040 25 4 27 3 -1
    |          |    |     |    |     |  | |  | |--&gt; slow start size threshold,
    |          |    |     |    |     |  | |  |      or -1 if the threshold
    |          |    |     |    |     |  | |  |      is &gt;= 0xFFFF
    |          |    |     |    |     |  | |  |----&gt; sending congestion window
    |          |    |     |    |     |  | |-------&gt; (ack.quick&lt;&lt;1)|ack.pingpong
    |          |    |     |    |     |  |---------&gt; Predicted tick of soft clock
    |          |    |     |    |     |              (delayed ACK control data)
    |          |    |     |    |     |------------&gt; retransmit timeout
    |          |    |     |    |------------------&gt; location of socket in memory
    |          |    |     |-----------------------&gt; socket reference count
    |          |    |-----------------------------&gt; inode
    |          |----------------------------------&gt; unanswered 0-window probes
    |---------------------------------------------&gt; uid

timer_active:
  0  no timer is pending
  1  retransmit-timer is pending
  2  another timer (e.g. delayed ack or keepalive) is pending
  3  this is a socket in TIME_WAIT state. Not all fields will contain
     data (or even exist)
  4  zero window probe timer is pending</pre>
</div>
</div>
<div class="paragraph">
<p>From the documentation, if I need to select connection targeting the remote
port 9042, I’ll need the 3rd column.</p>
</div>
<div class="listingblock">
<div class="title">remote address</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ cat /proc/$(pidof java)/net/tcp \
  | awk &#39;{print $3}&#39;
rem_address
00000000:0000
00000000:0000
00000000:0000
00000000:0000
00000000:0000
0F01D00A:9008
1D20D00A:1F90
2708DC0A:0050
0100007F:86DC
0100007F:1F90
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we need to select the port, it’s simple as we just need
to match the hexadecimal value of 9042.</p>
</div>
<div class="listingblock">
<div class="title">connection’s destination addresses for port 9042</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ cat /proc/$(pidof java)/net/tcp \
  | awk &#39;{print $3}&#39; \
  | grep $(printf &#34;:%x&#34; 9042)
1148D00A:2352
142CD00A:2352
2207D00A:2352
2207D00A:2352
1E1BD00A:2352
1934D00A:2352
1A4CD00A:2352
4B1FD00A:2352
4B1FD00A:2352
1E2DD00A:2352
1A4CD00A:2352
1148D00A:2352
1E2DD00A:2352
1E1BD00A:2352
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>grep</code> command can be included as part of the <code>awk</code> script.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ cat /proc/$(pidof java)/net/tcp \
  | awk -v DPORT=$(printf &#34;:%x&#34; 9042) &#39;$3 ~ DPORT { print $3}&#39;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first thing to notice is the duplicate, entries, that’s expected,
there’s multiple connection to the same remote IP address (possibly with
a different state). Duplicates can be removed with <code>sort -u</code>.
Then we need to extract the IP.</p>
</div>
<div class="listingblock">
<div class="title">all destination IP (hexa reversed) on port 9042</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ cat /proc/$(pidof java)/net/tcp \
  | awk -v DPORT=$(printf &#34;:%x&#34; 9042) &#39;$3 ~ DPORT { print $3}&#39; \
  | sort -u \
  | cut -f1 -d:
110C2D0A
12012D0A
144D2D0A
171F2D0A
19542D0A
1A082D0A
1E362D0A
1E372D0A
200C2D0A
22132D0A
4B0A2D0A
7B202D0A</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we need to print these in human-readable form. Notice they all are ending by
<code>2D0A</code>, those two octets are respectively <code>0x2D=0x45</code> and <code>10</code>. This insight
suggests these IPs are actually reversed, I’m not sure why ; I only ever used
reversed IPs for <a href="https://en.wikipedia.org/wiki/Reverse_DNS">reverse DNS lookup</a>
before. (I you know the reason please drop a comment ;))</p>
</div>
<div class="paragraph">
<p>So to get human-readable form we need to separate the 4 bytes, convert them in
decimal, and reverse them.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ echo &#34;110C2D0A&#34; \
  | sed &#39;s/../0x&amp; /g&#39; \ <i class="conum" data-value="1"></i><b>(1)</b>
  | awk &#39;{ for(i=NF;i&gt;0;i--) printf &#34;%d.&#34;,$i; print &#34;&#34; }&#39; \ <i class="conum" data-value="2"></i><b>(2)</b>
  | sed &#39;s/.$//&#39; <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>tell <code>sed</code> to split the stream every two characters, and
prepend each byte by <code>0x</code>, this is useful for <code>printf &#34;%x&#34;</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>reverse the order of each field, this simply a for-loop
decrementing the index, for each field printing it as a decimal.
For each line prints a new line (that’s the role of <code>print &#34;&#34;</code>)
Then the last <code>sed</code> simply removes the last dot.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>These two sed are a bit inelegant and be replaced by a better awk script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ echo &#34;110C2D0A&#34; \
  | awk &#39;{gsub(/../,&#34;0x&amp; &#34;)} OFS=&#34;.&#34; {for(i=NF;i&gt;0;i--) printf &#34;%d%s&#34;, $i, (i == 1 ? ORS : OFS)}&#39;</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Here <code>sed &#39;s/../0x&amp; /g&#39;</code> is replaced by <code>{gsub(/../,&#34;0x&amp; &#34;)}</code></p>
</li>
<li>
<p>Replacing the last <code>sed</code> also requires a better collection joining in the <code>awk</code> script
with <code>OFS</code> <em>output field separator</em> to separate each IP’s octets and
<code>ORS</code> <em>output result separator</em>, to go to the next line, which gives for each IP
<code>printf &#34;%d%s&#34;, $i, (i == 1 ? ORS : OFS)</code></p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">human readable list of destination IPs on port 9042</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ cat /proc/$(pidof java)/net/tcp \
  | awk -v DPORT=$(printf &#34;:%x&#34; 9042) &#39;$3 ~ DPORT { print $3}&#39; \
  | sort -u \
  | cut -f1 -d&#39;:&#39; \
  | awk &#39;{gsub(/../,&#34;0x&amp; &#34;)} OFS=&#34;.&#34; {for(i=NF;i&gt;0;i--) printf &#34;%d%s&#34;, $i, (i == 1 ? ORS : OFS)}&#39;
10.45.12.17
10.45.1.18
10.45.77.20
10.45.31.23
10.45.84.25
10.45.8.26
10.45.54.30
10.45.55.30
10.45.12.32
10.45.19.34
10.45.10.75
10.45.32.123</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_exploring_other_usage"><a class="anchor" href="#_exploring_other_usage"></a><a class="link" href="#_exploring_other_usage">Exploring other usage</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are many files in procfs net directory, I just showed <code>/proc/net/tcp</code> pseudo file,
and I started this blog with a <code>port</code> filter, but they are other elements to look at, e.g.
the TCP connection state. Looking aside there are also <code>/proc/net/udp</code>, <code>/proc/net/route</code>, etc
pseudo files too.</p>
</div>
<div class="sect2">
<h3 id="_tcp_connection_state"><a class="anchor" href="#_tcp_connection_state"></a><a class="link" href="#_tcp_connection_state">TCP Connection state</a></h3>
<div class="paragraph">
<p>While this may seem tricky at first, it’s easy to tweak these few lines,
as functions, and combine them or modify them to extract on other criteria,
e.g. the fourth field is about the connection state.</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/torvalds/linux/blob/v4.19/include/net/tcp_states.h">include/net/tcp_states.h (v4.19)</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">#define _LINUX_TCP_STATES_H

enum {
	TCP_ESTABLISHED = 1,
	TCP_SYN_SENT,
	TCP_SYN_RECV,
	TCP_FIN_WAIT1,
	TCP_FIN_WAIT2,
	TCP_TIME_WAIT,
	TCP_CLOSE,
	TCP_CLOSE_WAIT,
	TCP_LAST_ACK,
	TCP_LISTEN,
	TCP_CLOSING,	/* Now a valid state */
	TCP_NEW_SYN_RECV,

	TCP_MAX_STATES	/* Leave at the end! */
};</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Thanks to this <a href="https://stackoverflow.com/questions/5992211/list-of-possible-internal-socket-statuses-from-proc#5992274">stackoverflow answer</a>
for pointing to the kernel code.</em></p>
</div>
<div class="paragraph">
<p>So if I want to list which ports are open, we need to filter on
the <code>TCP_LISTEN=0x0A</code> state, in this case the local address,
indicates what addresses have been bound by the process.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ cat /proc/$(pidof java)/net/tcp \
  | awk -v TCP_STATE=0A &#39;($4 == TCP_STATE) { print $2 }&#39;
00000000:1F90
00000000:3AF2
0100007F:3A98
00000000:3A99
00000000:3A9E</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now my previous <code>awk</code> script</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ echo &#34;110C2D0A&#34; \
  | awk &#39;{gsub(/../,&#34;0x&amp; &#34;)} OFS=&#34;.&#34; {for(i=NF;i&gt;0;i--) printf &#34;%d%s&#34;, $i, (i == 1 ? ORS : OFS)}&#39;</code></pre>
</div>
</div>
<div class="paragraph">
<p>can only format the IPs, let’s rewrite it to be able to parse the whole address</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ echo &#34;0100007F:3A98&#34; \
  | awk -F: &#39;{gsub(/../,&#34;0x&amp; &#34;, $1)} {l=split($1,hip,&#34; &#34;); for(i=l;i&gt;0;i--) printf &#34;%d%s&#34;, hip[i], (i == 1 ? &#34;:&#34; : &#34;.&#34;); printf &#34;%d%s&#34;,&#34;0x&#34;$2, ORS}&#39;</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Addresses will be split using the colon separator <code>-F:</code>.</p>
</li>
<li>
<p>Then <code>{gsub(/../,&#34;0x&amp; &#34;, $1)}</code> will split the IP field as octets and prefix them by <code>0x</code>.</p>
</li>
<li>
<p>Then I need to reverse the IP octets, as <code>awk</code> cannot expand fields, I can split
the IP field to an array <code>l=split($1,hip,&#34; &#34;)</code>, where <code>l</code> is the length of that array
then run the for-loop on this array <code>for(i=l;i&gt;0;i--) printf &#34;%d%s&#34;, hip[i], (i == 1 ? &#34;:&#34; : &#34;.&#34;)</code>.
Ending the line by printing the port field in decimal <code>printf &#34;%d%s&#34;,&#34;0x&#34;$2, ORS</code>.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ cat /proc/$(pidof java)/net/tcp \
  | awk -v TCP_STATE=0A &#39;($4 == TCP_STATE) { print $2 }&#39; \
  | awk -F: &#39;{gsub(/../,&#34;0x&amp; &#34;, $1)} {l=split($1,hip,&#34; &#34;); for(i=l;i&gt;0;i--) printf &#34;%d%s&#34;, hip[i], (i == 1 ? &#34;:&#34; : &#34;.&#34;); printf &#34;%d%s&#34;,&#34;0x&#34;$2, ORS}&#39;
0.0.0.0:8080
0.0.0.0:15090
127.0.0.1:15000
0.0.0.0:15001
0.0.0.0:15006</code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to make this script be reusable for an IP or an address (IP:port), it just need a little tweak</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-diff hljs" data-lang="diff">- awk -F: &#39;{gsub(/../,&#34;0x&amp; &#34;, $1)} {l=split($1,hip,&#34; &#34;); for(i=l;i&gt;0;i--) printf &#34;%d%s&#34;, hip[i], (i == 1 ? &#34;:&#34; : &#34;.&#34;); printf &#34;%d%s&#34;,&#34;0x&#34;$2, ORS}&#39;
+ awk -F: &#39;{gsub(/../,&#34;0x&amp; &#34;, $1)} {l=split($1,hip,&#34; &#34;); for(i=l;i&gt;0;i--) printf &#34;%d%s&#34;, hip[i], (i == 1 ? &#34;&#34; : &#34;.&#34;); if ($2 != &#34;&#34;) printf &#34;:%d%s&#34;,&#34;0x&#34;$2, ORS}&#39;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This last revision simply skip the port <code>$2</code> if it’s value is blank.</p>
</div>
<div class="listingblock">
<div class="title">formal hexadecimal IPs or network addresses</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ echo &#34;0100007F:3A98
0100007F&#34; \
  | awk -F: &#39;{gsub(/../,&#34;0x&amp; &#34;, $1)} {l=split($1,hip,&#34; &#34;); for(i=l;i&gt;0;i--) printf &#34;%d%s&#34;, hip[i], (i == 1 ? &#34;&#34; : &#34;.&#34;); if ($2 != &#34;&#34;) printf &#34;:%d%s&#34;,&#34;0x&#34;$2, ORS}&#39;
127.0.0.1:15000
127.0.0.1</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_reading_procnetroute"><a class="anchor" href="#_reading_procnetroute"></a><a class="link" href="#_reading_procnetroute">Reading /proc/net/route</a></h3>
<div class="paragraph">
<p>Likewise, in stripped down container <code>/sbin/route</code> may be missing, in that cas using procfs
offers an alternative :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ cat /proc/$(pidof java)/net/route
Iface	Destination	Gateway 	Flags	RefCnt	Use	Metric	Mask		MTU	Window	IRTT
eth0	00000000	0104F80A	0003	0	0	0	00000000	0	0	0
eth0	0204F80A	00000000	0001	0	0	0	00FFFFFF	0	0	0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Reversed hexadecimal IPs are immediately identifiable, although having a human-readable form
would be better. Reusing our previous awk command is pure profit.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ cat /proc/$(pidof java)/net/route \
  | awk &#39;$1 == &#34;eth0&#34; {print $3}&#39; \
  | awk &#39;{gsub(/../,&#34;0x&amp; &#34;)} OFS=&#34;.&#34; {for(i=NF;i&gt;0;i--) printf &#34;%d%s&#34;, $i, (i == 1 ? ORS : OFS)}&#39;
10.248.4.1
0.0.0.0</code></pre>
</div>
</div>
<div class="paragraph">
<p>I’m not quite sure about the flags, this [stackoverflow answer]
suggests to look at <a href="https://sourceforge.net/p/net-tools/code/ci/master/tree/lib/net-support.h#l225">net-tool source</a>,</p>
</div>
<div class="paragraph">
<p>Which in turns suggest to look at <a href="https://github.com/torvalds/linux/blob/v3.6/include/linux/route.h#L50-L60"><code>include/linux/route.h</code> (v3.6)</a> file,
which moved to <a href="https://github.com/torvalds/linux/blob/v3.7/include/uapi/linux/route.h#L50-L60"><code>include/uapi/linux/route.h#L50-L60</code></a> since v3.7.
This happened during this <a href="https://github.com/torvalds/linux/commit/607ca46e97a1b6594b29647d98a32d545c24bdff#diff-9a1cc27b54f86cc709009b1225d7579bc53ee715d133f6104e56782d3ec697da">commit</a>
for the creation of what is called the user space API of the kernel (uapi), or headers that can be used publicly.</p>
</div>
<div class="paragraph">
<p>See this <a href="http://lwn.net/Articles/507794/">discussion</a>, and thanks for this <a href="https://stackoverflow.com/a/18858544/48136">StackOverflow answer</a>.</p>
</div>
<div class="paragraph">
<p>Anyway here’re the flags :</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/torvalds/linux/blob/v4.19/include/uapi/linux/route.h">include/uapi/linux/route.h (v4.19)</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">#define	RTF_UP		0x0001		/* route usable		  	*/
#define	RTF_GATEWAY	0x0002		/* destination is a gateway	*/
#define	RTF_HOST	0x0004		/* host entry (net otherwise)	*/
#define RTF_REINSTATE	0x0008		/* reinstate route after tmout	*/
#define	RTF_DYNAMIC	0x0010		/* created dyn. (by redirect)	*/
#define	RTF_MODIFIED	0x0020		/* modified dyn. (by redirect)	*/
#define RTF_MTU		0x0040		/* specific MTU for this route	*/
#define RTF_MSS		RTF_MTU		/* Compatibility :-(		*/
#define RTF_WINDOW	0x0080		/* per route window clamping	*/
#define RTF_IRTT	0x0100		/* Initial round trip time	*/
#define RTF_REJECT	0x0200		/* Reject route			*/</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ipv6"><a class="anchor" href="#_ipv6"></a><a class="link" href="#_ipv6">IPv6</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Please keep in mind the above commands only account IPv4 connections, IPv6 related connections
are in their related pseudo files, e.g <code>/proc/$(pidof java)/net/tcp6</code>, <code>/proc/$(pidof java)/net/ipv6_route</code></p>
</div>
<div class="listingblock">
<div class="title">/proc/$(pidof java)/net/tcp6</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ cat /proc/$(pidof java)/net/tcp6
  sl  local_address                         remote_address                        st tx_queue rx_queue tr tm-&gt;when retrnsmt   uid  timeout inode
   0: 00000000000000000000000000000000:3AAC 00000000000000000000000000000000:0000 0A 00000000:00000000 00:00000000 00000000  1337        0 2247569106 1 0000000000000000 100 0 0 10 0
   1: 00000000000000000000000000000000:FFFD 00000000000000000000000000000000:0000 0A 00000000:00000000 00:00000000 00000000 65533        0 2247536566 1 0000000000000000 100 0 0 10 0
   2: 0000000000000000FFFF0000171F2D0A:3AAC 0000000000000000FFFF00000134D00A:9C74 06 00000000:00000000 03:000002B9 00000000     0        0 0 3 0000000000000000
   3: 0000000000000000FFFF0000171F2D0A:3AAC 0000000000000000FFFF00000134D00A:9A36 06 00000000:00000000 03:00000060 00000000     0        0 0 3 0000000000000000
   4: 0000000000000000FFFF0000171F2D0A:3AAC 0000000000000000FFFF00000134D00A:9ED8 06 00000000:00000000 03:00000511 00000000     0        0 0 3 0000000000000000</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, it’s a tad easier for IPv6 as those are expressed as hexadecimal anyway.
This should be easy for those as only bit to do is formatting to remove leading <code>0</code>s
however there’s a catch, if you notice the last bytes they look exactly like
the reversed IPv4, I’m not how exactly this reverse thing applies to the rest
of the IPv6 though. But in this case the IPv6 is</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>0000000000000000FFFF0000171F2D0A</code></p>
</li>
<li>
<p><code>0000000000000000FFFF00000A2D1F17</code> reversed the IPv4</p>
</li>
<li>
<p><code>0000:0000:0000:0000:FFFF:0000:0A2D:1F17</code> group by words (2 bytes)</p>
</li>
<li>
<p><code>0:0:0:0:ffff:0:a2d:1f17</code> removed leading 0s</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>As I’m qui unsure how tha applies to all IPv6 I’d rather be prudent there.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_closing_thoughts"><a class="anchor" href="#_closing_thoughts"></a><a class="link" href="#_closing_thoughts">Closing thoughts</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>When the containers are stripped down and read-only, and you don’t have the possibility
to <em>attach</em> a debug container, I’m quite lucky to have the ability to introspect
process <em>internals</em> thanks to the pseudo filesystem <code>/proc</code>. However sometimes
the information is not easily human accessible. I hope the few <code>awk</code> tricks here
will be useful to someone else.</p>
</div>
</div>
</div>

  </div>
  

<div class="navigation navigation-single">
    
    <a href="/2020/07/28/embracing-jvm-unified-logging-jep-158-jep-271/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">Embracing JVM unified logging (JEP-158 / JEP-271)</span>
    </a>
    
    
    <a href="/2020/10/27/maxrampercentage-is-not-what-i-wished-for/" class="navigation-next">
      <span class="navigation-tittle">MaxRamPercentage is not what I wished for</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
        
        
        
        this.page.identifier = 'https://blog.arkey.fr/2020/10/23/read-network-addresses-in-procfs/';
        this.page.title = 'Reads network addresses in \/proc';
        this.page.url = 'https://blog.arkey.fr/2020/10/23/read-network-addresses-in-procfs/';
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "thecoffeeworkshop" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</article>


            
    
<footer>

 
 
 <div class="github-edit">
     <a href="https://github.com/bric3/bric3.github.io/edit/hugo-sources/content/posts/2020-10-23-read-network-addresses-in-procfs.adoc">
     <i class="fab fa-github fa-lg" aria-hidden="true"></i> Edit this page
     </a>
 </div>
 














<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.4.1/highlight.min.js" integrity="sha512-DrpaExP2d7RJqNhXB41Q/zzzQrtb6J0zfnXD5XeVEWE8d9Hj54irCLj6dRS3eNepPja7DvKcV+9PnHC7A/g83A==" crossorigin="anonymous"></script>
    <script type="text/javascript">
        
        hljs.initHighlightingOnLoad();
    </script>
    

<script src="https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js" integrity="sha256-vrn14y7WH7zgEElyQqm2uCGSQrX/xjYDjniRUQx3NyU=" crossorigin="anonymous"></script>
<script type="text/javascript">
function addBlockSwitches() {
	$('.primary').each(function() {
		primary = $(this);
		createSwitchItem(primary, createBlockSwitch(primary)).item.addClass("selected");
		primary.children('.title').remove();
	});
	$('.secondary').each(function(idx, node) {
		secondary = $(node);
		primary = findPrimary(secondary);
		switchItem = createSwitchItem(secondary, primary.children('.switch'));
		switchItem.content.addClass('hidden');
		findPrimary(secondary).append(switchItem.content);
		secondary.remove();
	});
}

function createBlockSwitch(primary) {
	blockSwitch = $('<div class="switch"></div>');
	primary.prepend(blockSwitch);
	return blockSwitch;
}

function findPrimary(secondary) {
	candidate = secondary.prev();
	while (!candidate.is('.primary')) {
		candidate = candidate.prev();
	}
	return candidate;
}

function createSwitchItem(block, blockSwitch) {
	blockName = block.children('.title').text();
	content = block.children('.content').first().append(block.next('.colist'));
	item = $('<div class="switch--item">' + blockName + '</div>');
	blockSwitch.append(item);
	return {'item': item, 'content': content};
}

function globalSwitch() {
	$('.switch--item').each(function() {
		var blockId = blockIdForSwitchItem($(this));
		$(this).off('click');
		$(this).on('click', function() {
			selectedText = $(this).text()
			window.localStorage.setItem(blockId, selectedText);
			$(".switch--item").filter(function() {
				return blockIdForSwitchItem($(this)) === blockId;
			}).filter(function() {
				return $(this).text() === selectedText;
			}).each(function() {
				select($(this))
			});
		});
		if ($(this).text() === window.localStorage.getItem(blockId)) {
			select($(this))
		}
	});
}

function blockIdForSwitchItem(item) {
	idComponents = []
	idComponents.push(item.text().toLowerCase());
	item.siblings(".switch--item").each(function(index, sibling) {
		idComponents.push($(sibling).text().toLowerCase());
	});
	return idComponents.sort().join("-")
}

function select(selected) {
	selected.addClass('selected');
	selected.siblings().removeClass('selected');
	selectedContent = selected.parent().siblings(".content").eq(selected.index())
	selectedContent.removeClass('hidden');
	selectedContent.siblings().addClass('hidden');
}

$(addBlockSwitches);
$(globalSwitch);
</script>



</footer>

    



        </div>
    </body>
</html>

