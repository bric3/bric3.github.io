<!DOCTYPE html>
<html lang="en">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.69.0" />

    
    
    

<title>Tester votre code JMX dans des conditions pseudo réelle. • The Coffee Workshop</title>













    
<meta property="og:locale" content="en">
<meta property="og:site_name" content="The Coffee Workshop">
<meta property="og:title" content="Tester votre code JMX dans des conditions pseudo réelle.">
<meta property="og:type" content="website">
<meta property="og:url" content="https://blog.arkey.fr/2011/10/14/tester-votre-code-jmx-dans-des-conditions-pseudo-reelle/" />
<meta property="og:description" content="Java mostly, and general tech">
<meta property="og:image" content="https://blog.arkey.fr/social-sharing.png">
<meta property="og:image:type" content="image/png">
    
    
    
<meta property="og:image:width" content="192">
<meta property="og:image:height" content="192">
    

<meta property="og:updated_time" content="2011-10-14T13:01:31Z">



<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@BriceDutheil">
<meta name="twitter:title" content="Tester votre code JMX dans des conditions pseudo réelle.">

<meta name="twitter:image" content="https://blog.arkey.fr/social-sharing.png">

<meta name="twitter:description" content="Java mostly, and general tech">
<meta name="twitter:creator" content="@BriceDutheil">
    
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/github.min.css"><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/gruvbox-dark.min.css" media="(prefers-color-scheme: dark)">




<link rel="stylesheet" href="/scss/hyde-hyde.3e376ced91add18f6049ee3b08829bbb28da6d67580baee8c7556f8e5b105606.css" integrity="sha256-Pjds7ZGt0Y9gSe47CIKbuyjabWdYC67ox1VvjlsQVgY=">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    
    <link rel="shortcut icon" sizes="192x192" href="/android-192-favicon.png">

    
    <link rel="shortcut icon" href="/android-192-favicon.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css" integrity="sha256-h20CPZ0QyXlBuAw7A+KluUYx/3pK+c7lYEpqLTlxjYQ=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/v4-shims.min.css" integrity="sha256-wN7QJaqAwQ03kgUhyN4EU2phRdDkLrQYbFe0EvpQ60U=" crossorigin="anonymous" />

    
    


    
</head>


    <body class=" ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="https://blog.arkey.fr">The Coffee Workshop</a>
      </span>
      
      
        <div class="author-image">
          <img src="https://www.gravatar.com/avatar/f31c7fbcbb0766d0632d96fd7e74b649?s=240&d=mp" class="img--circle img--headshot element--center" alt="gravatar">
        </div>
      
      <p class="site__description">
         Java mostly, and general tech 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">The Coffee Workshop</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/"><span class='fa-icon'><i class='fas fa-home'></i></span><code>cd <em>~</em></code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/posts/"><span class='fa-icon'><i class='fas fa-stream'></i></span><code>ls <em>posts/*</em></code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/series/"><span class='fa-icon'><i class='fas fa-list-alt'></i></span><code>grep -o <em>series</em> posts/* | sort -u</code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/tags/"><span class='fa-icon'><i class='fas fa-tags'></i></span><code>grep -o <em>tags</em> posts/* | sort -u</code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/cool-stuff/"><span class='fa-icon'><i class='fas fa-thumbtack'></i></span><code>cd <em>cool-stuff</em></code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/whoami/"><span class='fa-icon'><i class='fas fa-id-card'></i></span><code>whoami</code>
						<span></span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://twitter.com/@BriceDutheil" rel="me"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="bird" class="svg-inline--fa fa-bird fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></a>
	
	
	
	<a href="https://github.com/bric3" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	<a href="https://speakerdeck.com/bric3" rel="me"><i class="fab fa-speaker-deck" aria-hidden="true"></i></i></a>
	
	
	
	
	
	
	
	<a href="https://linkedin.com/in/dutheilbrice" rel="me"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="pro-network" class="svg-inline--fa fa-pro-network fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></a>
	
	
	<a href="https://stackoverflow.com/users/48136/brice" rel="me"><i class="fab fa-stack-overflow fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	
</section>

      </div>
    </div>
    
<div class="copyright">
  &copy; 2010 - 2020 Brice Dutheil
  
    <a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a>
  
</div>



  </div>
</div>

        <div class="content container">
            
    
<article>
  <header>
    <h1>Tester votre code JMX dans des conditions pseudo réelle.</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> 2011-10-14
    
    
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/code">code</a>
           
      
          <a class="badge badge-tag" href="/tags/jmx">jmx</a>
           
      
          <a class="badge badge-tag" href="/tags/tdd">tdd</a>
           
      
          <a class="badge badge-tag" href="/tags/test-unitaire">test unitaire</a>
          
      
    
    
    <br/>
    <i class="fas fa-clock"></i> 8 min read

    
    <div class="page-series">
        <div class="title">In the same series :</div>
        <ul>
            
        </ul>
    </div>

</div>


  </header>
  
  
  <div class="post">
    <p>Vous devez écrire du code qui fait appel à JMX, en bon citoyen et bon développeur vous voulez tester ce code.</p>
<p>Première approche; vous enregistrez vos MBean sur un <code>MBeanServer</code>, disons celui de la plateforme (avec Java 6 : <code>ManagementFactory.getPlatformMBeanServer()</code>).</p>
<pre><code class="language-java">mBeanServer.registerMBean(theMBean, theMBean.getObjectName());
</code></pre>
<p>Étant donné que <code>MBeanServer</code> étends <code>MBeanServerConnection</code> il est possible d’exécuter des querys, de faire des invocations sur les MBean etc. Si le code est suffisamment isolé des aspects techniques de connexion à JMX, vous passerez le <code>MBeanServer</code> en lieu et place de la <code>MBeanServerConnection</code>.</p>
<p>Supposons le code suivant.</p>
<pre><code class="language-java">public class OperateOnJMXConnection implements JMXOperation {

    public void perform(MBeanServerConnection connection) {
        // doing some stuff there
    }

    public Result getResult() { return result; }
}
</code></pre>
<p>Pour tester ce code il faudrait alors écrire :</p>
<pre><code class="language-java">@Test
public void do_not_fail() {
    operateOnJMXConnection.perform(mbeanServer);

    assertThat(result).satisfies(someCondition);
}
</code></pre>
<p>Mais voilà, vous restez en local, et par exemple si vous avez merdé sur la sérialisation de vos beans, vous ne verrez pas d'échec dans vos test et vous aurez une surprise en prod, ou avant si votre projet a un processus qualité décent.</p>
<p>Évidement il y a une solution, l&rsquo;idée c&rsquo;est de pouvoir se connecter au <code>mBeanServer</code> local à votre processus (typiquement dans maven 3, l’exécution de vos tests peuvent être forkée).</p>
<p>Alors j&rsquo;ai essayé de récupérer les informations pour récupérer les informations de la VM qui tourne, mais bon on tombe dans des classes <strong>sun</strong>, j&rsquo;ai préféré ne pas continuer sur ce chemin semé d&rsquo;embûches, sans compter sur la faiblesse de cette approche.</p>
<p>Bref en relisant les articles de Khanh sur JMX, j&rsquo;ai vu quelque chose d&rsquo;intéressant <code>JMXConnectorServerFactory</code>. Cette classe permet donc de créer un <code>JMXConnectorServer</code> avec l&rsquo;URL qu&rsquo;on lui spécifie et d&rsquo;un <code>MBeanServer</code>. A noter que cette URL doit respecter un certain formalisme tel que la javadoc l&rsquo;indique : <code>service:jmx:*protocol*:*remainder*</code>.</p>
<p>Le protocole ne peut pas être n&rsquo;importe quoi, il faut qu&rsquo;il y ait le bon service enregistré pour qu&rsquo;il soit géré. Dans notre cas RMI est standard, c&rsquo;est donc le protocole que je prendrai. Pour le remainder, il s&rsquo;agit plus d&rsquo;une partie d&rsquo;une URL, je vous laisse voir la Javadoc de <code>JMXServiceUrl</code> à ce sujet, mais dans les grandes lignes la forme doit être la suivante : <code>//[host[:port]][url-path]</code></p>
<pre><code class="language-java">JMXConnectorServer connectorServer = JMXConnectorServerFactory.newJMXConnectorServer(
    new JMXServiceURL(&quot;service:jmx:rmi://&quot;),
    null,
    mBeanServer
);

connectorServer.start();
</code></pre>
<p>Hop dans le code précédent, on a créé puis démarrer notre <code>JMXConnectorServer</code>. Il n&rsquo;y a plus qu'à se connecter dessus de manière standard :</p>
<p>Je vais utiliser <code>connectorServer.getJMXServer()</code> pour récupérer l&rsquo;URL du service, il y a une raison à cela, c&rsquo;est que comme l&rsquo;indique la javadoc, l&rsquo;URL passée pour la création du <code>JMXConnectorServer</code> peut être légèrement modifiée par celui-ci, il faut donc récupérer la nouvelle URL.<!-- raw HTML omitted --></p>
<pre><code class="language-java">JMXConnector jmxConnetor = JMXConnectorFactory.connect(connectorServer.getJMXServiceUrl());
MBeanServerConnection connection = jmx.getgetMBeanServerConnection();
</code></pre>
<p>Et voilà vous avez accès à une <code>MBeanServerConnection</code>, qui vit dans la JVM locale, mais qui utilise RMI pour communiquer avec le <code>MBeanServer</code>, du coup vous êtes nettement plus proches des conditions du code de production et c&rsquo;est ce qui nous intéresse dans cet article.</p>
<p>Pour référence les articles de Khanh, et en français s&rsquo;il vous plait :) :</p>
<ul>
<li><a href="http://jetoile.blogspot.com/2010/10/jmx-pour-les-nuls-les-concepts-partie-1.html">Partie 1 : Les concepts</a></li>
<li><a href="http://jetoile.blogspot.com/2010/11/jmx-pour-les-nuls-les-differents-mbeans.html">Partie 2 : Les différents MBean</a></li>
<li><a href="http://jetoile.blogspot.com/2010/11/jmx-pour-les-nuls-les-agents-jmx-partie.html">Partie 3 : Les agents</a></li>
<li><a href="http://jetoile.blogspot.com/2010/11/jmx-pour-les-nuls-les-classes-de-base.html">Partie 4 : Les classes de bases</a></li>
<li><a href="http://jetoile.blogspot.com/2010/11/jmx-pour-les-nuls-le-mbean-server.html">Partie 5 : Le MBean server</a></li>
<li><a href="http://jetoile.blogspot.com/2010/12/jmx-pour-les-nuls-chargement-dynamique.html">Partie 6 : Le chargement dynamique</a></li>
<li><a href="http://jetoile.blogspot.com/2010/12/jmx-pour-les-nuls-les-services-jmx.html">Partie 7 : Les services JMX</a></li>
<li><a href="http://jetoile.blogspot.com/2010/12/jmx-pour-les-nuls-les-connecteurs.html">Partie 8 : Les connecteurs</a></li>
</ul>
<p>Quelques liens javadoc :</p>
<ul>
<li><a href="http://download.oracle.com/javase/6/docs/api/javax/management/remote/JMXConnectorFactory.html"><code>JMXConnectorFactory</code></a></li>
<li><a href="http://download.oracle.com/javase/6/docs/api/javax/management/remote/JMXConnectorServerFactory.html"><code>JMXConnectorServerFactory</code></a></li>
<li><a href="http://download.oracle.com/javase/6/docs/api/javax/management/remote/JMXServiceURL.html"><code>JMXServiceURL</code></a></li>
<li><a href="http://download.oracle.com/javase/6/docs/api/javax/management/remote/JMXConnectorServer.html"><code>JMXConnectorServer</code></a></li>
</ul>
<p>Enfin je me suis créé une petite classe de commodité qui permet de créé facilement un loopback pour les TU :</p>

  </div>
  

<div class="navigation navigation-single">
    
    <a href="/2010/11/04/sexprimer-regulierement-partie-3/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">Expressions régulières (Partie 3)</span>
    </a>
    
    
    <a href="/2011/10/18/afficher-les-properties-dun-projet-maven/" class="navigation-next">
      <span class="navigation-tittle">Afficher les properties d&#39;un projet maven</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
        
        
        
        this.page.identifier = 'https://blog.arkey.fr/2011/10/14/tester-votre-code-jmx-dans-des-conditions-pseudo-reelle/';
        this.page.title = 'Tester votre code JMX dans des conditions pseudo réelle.';
        this.page.url = 'https://blog.arkey.fr/2011/10/14/tester-votre-code-jmx-dans-des-conditions-pseudo-reelle/';
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "thecoffeeworkshop" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</article>


        </div>
        
    










<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js" integrity="sha256-eOgo0OtLL4cdq7RdwRUiGKLX9XsIJ7nGhWEKbohmVAQ=" crossorigin="anonymous"></script><script type="text/javascript">
        
        hljs.initHighlightingOnLoad();
    </script>
    
    


<script src="https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js" integrity="sha256-vrn14y7WH7zgEElyQqm2uCGSQrX/xjYDjniRUQx3NyU=" crossorigin="anonymous"></script>
<script type="text/javascript">
function addBlockSwitches() {
	$('.primary').each(function() {
		primary = $(this);
		createSwitchItem(primary, createBlockSwitch(primary)).item.addClass("selected");
		primary.children('.title').remove();
	});
	$('.secondary').each(function(idx, node) {
		secondary = $(node);
		primary = findPrimary(secondary);
		switchItem = createSwitchItem(secondary, primary.children('.switch'));
		switchItem.content.addClass('hidden');
		findPrimary(secondary).append(switchItem.content);
		secondary.remove();
	});
}

function createBlockSwitch(primary) {
	blockSwitch = $('<div class="switch"></div>');
	primary.prepend(blockSwitch);
	return blockSwitch;
}

function findPrimary(secondary) {
	candidate = secondary.prev();
	while (!candidate.is('.primary')) {
		candidate = candidate.prev();
	}
	return candidate;
}

function createSwitchItem(block, blockSwitch) {
	blockName = block.children('.title').text();
	content = block.children('.content').first().append(block.next('.colist'));
	item = $('<div class="switch--item">' + blockName + '</div>');
	blockSwitch.append(item);
	return {'item': item, 'content': content};
}

function globalSwitch() {
	$('.switch--item').each(function() {
		var blockId = blockIdForSwitchItem($(this));
		$(this).off('click');
		$(this).on('click', function() {
			selectedText = $(this).text()
			window.localStorage.setItem(blockId, selectedText);
			$(".switch--item").filter(function() {
				return blockIdForSwitchItem($(this)) === blockId;
			}).filter(function() {
				return $(this).text() === selectedText;
			}).each(function() {
				select($(this))
			});
		});
		if ($(this).text() === window.localStorage.getItem(blockId)) {
			select($(this))
		}
	});
}

function blockIdForSwitchItem(item) {
	idComponents = []
	idComponents.push(item.text().toLowerCase());
	item.siblings(".switch--item").each(function(index, sibling) {
		idComponents.push($(sibling).text().toLowerCase());
	});
	return idComponents.sort().join("-")
}

function select(selected) {
	selected.addClass('selected');
	selected.siblings().removeClass('selected');
	selectedContent = selected.parent().siblings(".content").eq(selected.index())
	selectedContent.removeClass('hidden');
	selectedContent.siblings().addClass('hidden');
}

$(addBlockSwitches);
$(globalSwitch);
</script>


    



    </body>
</html>
