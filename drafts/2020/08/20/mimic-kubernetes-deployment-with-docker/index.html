<!DOCTYPE html>
<html lang="en-US">
    
    


    <head>
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="https://www.gravatar.com">
    <link rel="dns-prefetch" href="https://giscus.app">

    <link href="https://gmpg.org/xfn/11" rel="profile">
    
    <link rel="canonical" href="https://blog.arkey.fr/drafts/2020/08/20/mimic-kubernetes-deployment-with-docker/">
    

    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<meta name="color-scheme" content="light dark">
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.155.3">

    
    
    

<title>Mimic kubernetes deployment options with Docker • Brice Dutheil</title>













    
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Brice Dutheil">
<meta property="og:title" content="Mimic kubernetes deployment options with Docker">
<meta property="og:type" content="website">
<meta property="og:url" content="https://blog.arkey.fr/drafts/2020/08/20/mimic-kubernetes-deployment-with-docker/" />
<meta property="og:description" content="Java mostly, and general tech">
<meta property="og:image" content="https://blog.arkey.fr/social-sharing.png">
<meta property="og:image:type" content="image/png">
    
    
    
<meta property="og:image:width" content="512">
<meta property="og:image:height" content="512">
    

<meta property="og:updated_time" content="2020-08-20T15:41:39&#43;0200">



<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@BriceDutheil">
<meta name="twitter:title" content="Mimic kubernetes deployment options with Docker">

<meta name="twitter:image" content="https://blog.arkey.fr/social-sharing.png">

<meta name="twitter:description" content="Java mostly, and general tech">
<meta name="twitter:creator" content="@BriceDutheil">
    
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/a11y-light.min.css" media="(prefers-color-scheme: light)"><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/base16/gruvbox-dark-medium.min.css" media="(prefers-color-scheme: dark)">




<link rel="stylesheet" href="/scss/ascii-press.b7ed20f520c7245e0035f7eaf7efc1794ff2e0cfec4df74d9600fd94b3f4ed0e.css" integrity="sha256-t&#43;0g9SDHJF4ANffq9&#43;/BeU/y4M/sTfdNlgD9lLP07Q4=">


<link rel="stylesheet" href="/scss/ascii-press-dark.528eb3b63dcd126b56546a61fa3855b2ab58526f312daca74feb1c533f109d65.css" integrity="sha256-Uo6ztj3NEmtWVGph&#43;jhVsqtYUm8xLaynT&#43;scUz8QnWU=" media="(prefers-color-scheme: dark)">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">




<link rel="stylesheet" href="/scss/hugo-toc.f44dcd620647796a2cf99d68a804ad4b52dacfcf98383c8344d085949175d65e.css" integrity="sha256-9E3NYgZHeWos&#43;Z1oqAStS1Laz8&#43;YODyDRNCFlJF11l4=">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js" integrity="sha512-UDJtJXfzfsiPPgnI5S1000FPLBHMhvzAMX15I+qG2E2OAzC9P1JzUwJOfnypXiOH7MRPaqzhPbBGDNNj7zBfoA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.min.js" integrity="sha512-qWVvreMuH9i0DrugcOtifxdtZVBBL0X75r9YweXsdCHtXUidlctw7NXg5KVP3ITPtqZ2S575A0wFkvgS2anqSA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <![endif]-->

    <!-- Icons from https://realfavicongenerator.net -->
<link rel="icon" href="/favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="196x196" href="/favicon-196x196.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<meta name="msapplication-TileColor" content="#b64f4f">
<meta name="theme-color" content="#b64f4f">



    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/v4-shims.min.css" integrity="sha512-fHavkBby/gcFEB2taaBfG0DLdHRGrnvkWQNXVZ5Yb/Fj6LkogecQUd6oyvBVsrWPaHSxs5tNza6LUW/Y6Az9lQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    
    

</head>


    <body class="draft">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="https://blog.arkey.fr/">Brice Dutheil</a>
      </span>
      
      
        <div class="author-image">
          <img src="https://www.gravatar.com/avatar/f31c7fbcbb0766d0632d96fd7e74b649?s=240&d=mp" class="img--circle img--headshot element--center" alt="gravatar">
        </div>
      
      <p class="site__description">
         Java mostly, and general tech 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">Brice Dutheil</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/"><span class='fa-icon'><i class='fas fa-home'></i></span><code>cd <em>~</em></code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/posts/"><span class='fa-icon'><i class='fas fa-stream'></i></span><code>ls <em>posts/*</em></code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/series/"><span class='fa-icon'><i class='fas fa-list-alt'></i></span><code>grep -o <em>series</em> posts/* | sort -u</code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/tags/"><span class='fa-icon'><i class='fas fa-tags'></i></span><code>grep -o <em>tags</em> posts/* | sort -u</code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/cool-stuff/"><span class='fa-icon'><i class='fas fa-thumbtack'></i></span><code>cd <em>cool-stuff</em></code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/whoami/"><span class='fa-icon'><i class='fas fa-id-card'></i></span><code>whoami</code>
						<span></span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://bsky.app/profile/bricedutheil.bsky.social" rel="me"><i class="fa-w-16" aria-hidden="true"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="bluesky" class="svg-inline--fa fa-bluesky fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2026 Fonticons, Inc. --><path fill="currentColor" d="M351.8 287C349.2 286.6 346.5 286.3 343.8 285.9C346.6 286.2 349.2 286.6 351.8 287zM256 232.9C236.7 192.3 178.3 116.7 125.5 79.4C74.9 43.7 55.6 50 43.1 55.6C28.2 62.2 25.6 84.7 25.6 98C25.6 111.1 32.9 206.4 37.6 222.3C53.2 274.9 108.9 292.6 160.2 286.9C162.8 286.5 165.4 286.2 168.2 285.8C165.5 286.2 162.9 286.6 160.2 286.9C85 297.8 18.3 325.4 105.8 422.8C202.1 522.5 237.7 401.4 256 340.1C274.3 401.4 295.4 518 404.5 422.8C486.4 340.1 427.0 298 351.8 286.9C349.2 286.5 346.5 286.2 343.8 285.8C346.6 286.1 349.2 286.6 351.8 286.9C403.1 292.6 458.7 274.9 474.4 222.3C479.1 206.4 486.4 111.2 486.4 98C486.4 84.6 483.8 62.2 468.9 55.6C457.5 50 438.1 43.7 386.6 79.4C333.7 116.7 275.3 192.3 256 232.9z"/></svg></i></a>
	
	
	<a href="https://mastodon.xyz/@BriceDutheil" rel="me"><i class="fa-w-16" aria-hidden="true"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="jumbo" class="svg-inline--fa fa-jumbo fa-w-18" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Pro 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path fill="currentColor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg></i></a>
	
	
	<a href="https://github.com/bric3" rel="me"><i class="fab fa-github" aria-hidden="true"></i></a>
	
	
	<a href="https://speakerdeck.com/bric3" rel="me"><i class="fab fa-speaker-deck" aria-hidden="true"></i></a>
	
	
	<a href="https://twitter.com/BriceDutheil" rel="me"><i class="fa-w-16" aria-hidden="true"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="bird" class="svg-inline--fa fa-bird fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Pro 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></i></a>
	
	
	
	
	
	
	
	
	<a href="https://linkedin.com/in/dutheilbrice" rel="me"><i class="fa-w-16" aria-hidden="true"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="pro-network" class="svg-inline--fa fa-pro-network fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Pro 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></i></a>
	
	
	<a href="https://stackoverflow.com/users/48136/brice" rel="me"><i class="fab fa-stack-overflow" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	
</section>

      </div>
    </div>

  </div>
  <div class="container fixed-container">
    
<div class="copyright">
  &copy; 2010 - 2026 Brice Dutheil
  
    <span style="white-space: nowrap;"><a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a></span>
  
</div>



  </div>
</div>

        <div class="content container">
            
    <header>

 
 
 <div class="github-edit">
     <a href="https://github.com/bric3/bric3.github.io/edit/hugo-sources/content/drafts/2020-08-20-mimic-kubernetes-deployment-with-docker.adoc">
     <i class="fab fa-github fa-lg" aria-hidden="true"></i> Edit this page
     </a>
 </div>
 


</header>

            
    

<article>
  <header>
    <h1>Mimic kubernetes deployment options with Docker</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> 2020-08-20
    
    
    
    
    
    <br/>
    <i class="fas fa-clock"></i> 20 min read

    
    
    

</div>


  </header>
  
  
  
    <div class="toc-wrapper">
      <input type="checkbox" id="tocToggle" checked>
      <label for="tocToggle"><i class="fas fa-list-ul fa-lg"></i><span id="toc-title">On this page</span></label>
      <div id="toc-toggle-cover"></div>

      
          <nav id="TableOfContents">
  <ul>
    <li><a href="#_container_resources">Container resources</a></li>
    <li><a href="#_numa_non_uniform_memory_address_or_topology">NUMA (Non-Uniform Memory Address) or Topology</a></li>
    <li><a href="#_security_context">Security context</a></li>
    <li><a href="#_volumes_mounts">Volumes mounts</a></li>
    <li><a href="#_environment_variables">Environment variables</a></li>
    <li><a href="#_other_there_are_other_flags_that_can_be_passed_to_mimic_the_kubernetes_behavior">Other there are other flags that can be passed to mimic the Kubernetes behavior</a></li>
  </ul>
</nav>
      
    </div>
  
  
  
  <div class="post adoc">
    
<div class="paragraph">
<p>In this article I will show how to duplicate options one could see in
a <em>deployment</em> descriptor locally in via the docker command line.</p>
</div>
<div class="paragraph">
<p>I will also show what the JVM sees when it is running within these containers.</p>
</div>
<div class="paragraph">
<p>In the following article I will focus on the cgroup system paths, however the
JVM has a nifty option, <code>-XshowSettings:system</code>, that reads the content of these
files on Linux.</p>
</div>
<div class="paragraph">
<p>There’s an additional way to discover these values with <code>-Xlog=container*=trace</code>,
however I find this quite unpractical to be used in the console output. Also
the cgroup information is repeatedly logged, which is spamming the console.</p>
</div>
<div class="sect1">
<h2 id="_container_resources"><a class="anchor" href="#_container_resources"></a><a class="link" href="#_container_resources">Container resources</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Resources in a kubernetes deployment descriptor :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: &#34;java-app&#34;
spec:
  template:
    spec:
      containers:
      - name: &#34;java-app&#34;
        resources:
          limits:
            cpu: &#34;6&#34;
            memory: &#34;5Gi&#34;
          requests:
            cpu: &#34;3&#34;
            memory: &#34;3Gi&#34;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Kubernetes translates</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The limit is expressed as 1000 millicores or 1 core, they in fact represent a
<strong>quota of time period</strong> of the Linux CFS, it is based on two values <code>cfs_period_us</code>
and <code>cfs_quota_us</code>. On Kubernetes the period is 100ms (100000µs) and it cannot
be changed in the deployment descriptor at this time. For example 100m CPU,
100 milliCPU, and 0.1 CPU are all the same, and they are translated to 10000µs
quota.</p>
</li>
<li>
<p>The request 1000 millicores or 1 core as 1024 <strong>cpu shares</strong>. For example
1500 millicores are translated into 1536 <strong>cpu shares</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The resources tree declared above is equivalent to these docker params</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ docker run \
  --cpu-shares=3072 \ <i class="conum" data-value="1"></i><b>(1)</b>
  --cpu-quota=600000 \ <i class="conum" data-value="2"></i><b>(2)</b>
  --memory=5g \ <i class="conum" data-value="3"></i><b>(3)</b>
  --memory-swap=5g \ <i class="conum" data-value="4"></i><b>(4)</b>
  ...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>cpu request, this is the relative weight of that container for CPU time</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>cpu limit, this limits the CPU time of container’s processes, that means throttling</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>memory limit, tells the OS to kill (oomkill) the container’s processes if they hit this limit</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>kubernetes disable swap, so need to set the amount of physical memory (<code>--memory</code>) and the sam of
Physical memory and swap (<code>--memory-swap</code>) to the same value</td>
</tr>
</tbody></table>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>In the command above I used <code>--cpu-quota=600000</code> to expresse the CPU limit,
but I could have done the same using <code>--cpus=6</code>, docker cli computes the quota
value for us.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>These values can be retrieved within the container via the <code>/sys</code> filesystem.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ cat /sys/fs/cgroup/cpu/{cpu.cfs_period_us,cpu.cfs_quota_us,cpu.shares}
100000
600000
3072</code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Using CPU limits may have severe performance drawbacks, in particular if the
process is multi-threaded, the quota indicates a time period that is shared for
all process threads, or more exactly all process threads in the same cgroup.
That means if the limit is 8 cpus (400000µs quota), and they are 20 parallel
threads running, then the quota for the period will be consumed in 400000 / 20
in 20000 µs = 20ms and the process in this cgroup will get throttled for the
rest of the period, for 80ms.</p>
</div>
<div class="paragraph">
<p>It’s possible to examine how much a process has been throttled by CFS, for
example on a container with a 0.1 CPU limit</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ cat /sys/fs/cgroup/cpu/cpu.stat
nr_periods 422 <i class="conum" data-value="1"></i><b>(1)</b>
nr_throttled 403 <i class="conum" data-value="2"></i><b>(2)</b>
throttled_time 103934922199 <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>scheduled periods</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>throttled periods, 403 periods were throttled out of 422 periods</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>throttled for 103.935s (103,934,922,199 ns)</td>
</tr>
</tbody></table>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The Kubernetes memory request is used for scheduling the pod on nodes.</p>
</div>
<div class="paragraph">
<p>Beware that by default the CPU share is 1024, in this case the JVM will not use
this value and instead use the number of processors of the host machine.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ cat /sys/fs/cgroup/cpu/cpu.shares
1024 <i class="conum" data-value="1"></i><b>(1)</b>
$ env -u JDK_JAVA_OPTIONS jshell -J-XshowSettings:system -s - \
    s&lt;&lt;&lt;&#39;System.out.printf(&#34;procs: %d%n&#34;, Runtime.getRuntime().availableProcessors())&#39;
Operating System Metrics:
    Provider: cgroupv1
    Effective CPU Count: 32
    CPU Period: 100000us
    CPU Quota: -1
    CPU Shares: -1 <i class="conum" data-value="2"></i><b>(2)</b>
    List of Processors, 32 total:
    0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31
    List of Effective Processors, 32 total:
    0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31
    List of Memory Nodes, 1 total:
    0
    List of Available Memory Nodes, 1 total:
    0
    CPUSet Memory Pressure Enabled: false
    Memory Limit: 2.00G
    Memory Soft Limit: Unlimited
    Memory &amp; Swap Limit: Unlimited
    Kernel Memory Limit: Unlimited
    TCP Memory Limit: Unlimited
    Out Of Memory Killer Enabled: true

procs: 32</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>CPU shares is this cgroup file is by default 1024</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The JVM reports the default</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p><strong>TODO</strong> other resources like hugepages</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">spec.containers[].resources.limits.hugepages-&lt;size&gt;
spec.containers[].resources.requests.hugepages-&lt;size&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_numa_non_uniform_memory_address_or_topology"><a class="anchor" href="#_numa_non_uniform_memory_address_or_topology"></a><a class="link" href="#_numa_non_uniform_memory_address_or_topology">NUMA (Non-Uniform Memory Address) or Topology</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Even if I understand how that works, I have no concrete experience with it, so
I didn’t test it. This is exposed as a
<a href="https://kubernetes.io/blog/2020/04/01/kubernetes-1-18-feature-topoloy-manager-beta/">beta feature since Kubernetes 1.18</a>,
whereas in docker it doesn’t see to be well-supported or supported at all.</p>
</div>
<div class="paragraph">
<p>A container in my Kubernetes cluster gives this.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ cat /proc/6/numa_maps
700000000 default anon=1052736 dirty=1052736 N0=1052736 kernelpagesize_kB=4
801040000 default
5653635fd000 default file=/usr/lib/jvm/java-11-amazon-corretto/bin/java mapped=1 mapmax=2 N0=1 kernelpagesize_kB=4
5653637fe000 default file=/usr/lib/jvm/java-11-amazon-corretto/bin/java anon=1 dirty=1 N0=1 kernelpagesize_kB=4
5653637ff000 default file=/usr/lib/jvm/java-11-amazon-corretto/bin/java anon=1 dirty=1 N0=1 kernelpagesize_kB=4
565363a10000 default heap anon=85366 dirty=85366 N0=85366 kernelpagesize_kB=4
7f808eafb000 default
7f808eaff000 default anon=8 dirty=8 N0=8 kernelpagesize_kB=4
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, the <code>numa_maps</code> is missing on my local docker.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_security_context"><a class="anchor" href="#_security_context"></a><a class="link" href="#_security_context">Security context</a></h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: &#34;java-app&#34;
spec:
  template:
    spec:
      containers:
      - name: &#34;java-app&#34;
        securityContext:
          fsGroup: 43600
          runAsUser: 43514</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ id
uid=43514 gid=0(root) groups=0(root),43600

$ ps -A -o pid,user,group,command
    PID USER     GROUP    COMMAND
      1 43514    root     /usr/bin/dumb-init -- /usr/bin/java -Dfile.encoding=UT
      6 43514    root     /usr/bin/java -Dfile.encoding=UTF-8 -Duser.timezone=UT
   1039 43514    root     /bin/bash
   1069 43514    root     ps -A -o pid,user,group,command

$ ls -lah
total 98M
drwxr-xr-x    1 root root  4.0K Oct 28 08:50 .
drwxr-xr-x    1 root root  4.0K Oct 28 08:50 ..
drwxr-xr-x    1 root root  4.0K Apr  7  2020 bin
drwxr-xr-x    2 root root  4.0K Feb  1  2020 boot
drwxr-xr-x    5 root root   360 Oct 28 08:50 dev
-rw-r--r--    1 root root   60M Oct 23 08:30 java-app.jar
drwxr-xr-x    1 root root  4.0K Oct 28 08:50 etc
drwxrwsrwx    2 root 43600 4.0K Oct 28 11:57 diag
drwxr-xr-x    2 root root  4.0K Feb  1  2020 home
...
dr-xr-xr-x 1263 root root     0 Oct 28 08:50 proc
drwx------    2 root root  4.0K Mar 27  2020 root
...
drwxr-xr-x    1 root root  4.0K Mar 27  2020 var</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>fsGroup</code> option is not dynamically re-mappable in docker (see this issue
<a href="https://github.com/moby/moby/issues/2259">moby/moby#2259</a>).You’ll need to <code>chown</code>
these mounts within the container. However, if a mounted volume have files with
the groupid <code>46000</code> then the right way to be able to read them is to enable the
supplementary group via <code>--group-add</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ docker run \
  --user 43514 \
  --group-add 43600 \
  ...</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">I have no name!@3f7dc5eef417:/$ id
uid=43514 gid=0(root) groups=0(root),43600</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, if the <code>runAsGroup</code> is present it means the user <code>43514</code> is no longer
part of the <code>root</code> group :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">      - name: &#34;java-app&#34;
        securityContext:
          fsGroup: 43600
          runAsUser: 43514
          runAsGroup: 43500</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ docker run \
  --user 43514:43500 \
  --group-add 43600 \
  ...</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">I have no name!@3f7dc5eef417:/$ id
uid=43514 gid=43500 groups=43500,43600</code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Consequences on the java discovery mechanism</div>
<div class="paragraph">
<p>If the specified user identifier does not exists in <code>/etc/passwd</code>, then the
shell will display <code>I have no name!</code> instead of the user name.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">I have no name!@0063735c19f7:/$</code></pre>
</div>
</div>
<div class="paragraph">
<p>But this has another consequence, the java discovery mechanism rely on the
user name (<strong>TODO</strong> <code>hsperfdata_$(whoami)</code>), if there’s none, then diagnostic
commands like <code>jps</code> or <code>jcmd</code> are not able to discover the running Java process.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">I have no name!@0063735c19f7:/$ jps -v
I have no name!@0063735c19f7:/$</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, if the user exists in the <code>/etc/passwd</code> of the container, e.g. it
contains the following line</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">java:x:43514:43500:java:/:/bin/bash</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">java@c5c84475d8b6:/$ ls -lah /tmp/hsperfdata_java/
total 40K
drwxr-xr-x 2 java java 4.0K Oct 28 12:58 .
drwxrwxrwt 1 root root 4.0K Oct 28 12:52 ..
-rw------- 1 java java  32K Oct 28 13:12 6</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">java@c5c84475d8b6:/$ jps -v
100 Jps -Dapplication.home=/usr/lib/jvm/java-11-amazon-corretto -Xms8m -Djdk.module.main=jdk.jcmd
6 /java-app.jar -Dfile.encoding=UTF-8 -Duser.timezone=UTC -Djava.security.egd=file:/dev/./urandom -Djava.awt.headless=true -XX:NativeMemoryTracking=summary</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_volumes_mounts"><a class="anchor" href="#_volumes_mounts"></a><a class="link" href="#_volumes_mounts">Volumes mounts</a></h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: &#34;java-app&#34;
spec:
  template:
    spec:
      containers:
      - name: &#34;java-app&#34;
        volumeMounts:
        - mountPath: &#34;/diag&#34;
          name: &#34;diagnostic-files&#34;
        - mountPath: &#34;/etc/java-app/config.yaml&#34;
          name: &#34;config&#34;
          subPath: &#34;config.yaml&#34;

      volumes:
      - emptyDir: {}
        name: &#34;diagnostic-files&#34;
      - configMap:
          defaultMode: 420
          name: &#34;java-app&#34;
        name: &#34;config&#34;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ docker run \
  --mount=type=bind,source=$(pwd)/test.yaml,target=/etc/user-action/config.yaml \ <i class="conum" data-value="1"></i><b>(1)</b>
  --mount=type=bind,source=$(pwd)/tmp-diag,target=/diag \ <i class="conum" data-value="2"></i><b>(2)</b>
  ...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Bind mount equivalent to the <code>config</code> volume mount</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Bind mount using local folder <code>./tmp-diag</code>, but this can be replaced by another docker volume</td>
</tr>
</tbody></table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_environment_variables"><a class="anchor" href="#_environment_variables"></a><a class="link" href="#_environment_variables">Environment variables</a></h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: &#34;java-app&#34;
spec:
  template:
    spec:
      containers:
      - name: &#34;java-app&#34;
        - name: &#34;JDK_JAVA_OPTIONS&#34;
          value: &#34;-Xms3g -Xmx3g -XX:+AlwaysPreTouch&#34;
        - name: &#34;SECRET_TOKEN&#34;
          valueFrom:
            secretKeyRef:
              key: &#34;secret-token&#34;
              name: &#34;component-token&#34;
        - name: &#34;APP_VERSION&#34;
          valueFrom:
            fieldRef:
              fieldPath: &#34;metadata.labels[&#39;java.app.image/version&#39;]&#34;
        - name: &#34;HOST_IP&#34;
          valueFrom:
            fieldRef:
              fieldPath: &#34;status.hostIP&#34;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ docker run \
  --env JDK_JAVA_OPTIONS=&#34;-Xms3g -Xmx3g -XX:+AlwaysPreTouch&#34; \
  ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>This one is straightforward, no surprises here.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_other_there_are_other_flags_that_can_be_passed_to_mimic_the_kubernetes_behavior"><a class="anchor" href="#_other_there_are_other_flags_that_can_be_passed_to_mimic_the_kubernetes_behavior"></a><a class="link" href="#_other_there_are_other_flags_that_can_be_passed_to_mimic_the_kubernetes_behavior">Other there are other flags that can be passed to mimic the Kubernetes behavior</a></h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><code>spec.template.spec.restartPolicy</code> can be mapped to the same values as
<code>--restart</code> to control the restart policy, but it’s rarely useful to test that.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">References</div>
<ul>
<li>
<p><a href="https://docs.docker.com/engine/reference/commandline/run/">docker run</a></p>
</li>
<li>
<p><a href="https://docs.docker.com/config/containers/resource_constraints/">Docker resource contraints</a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/tasks/administer-cluster/topology-manager/">Kubernetes Topology Management</a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/tasks/configure-pod-container/security-context/">Kubernetes Security Context</a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/setup/production-environment/container-runtimes/">Kubernetes Container runtimes</a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#restart-policy">Kubernetes Pod restart policy</a></p>
</li>
<li>
<p><a href="https://docs.docker.com/config/containers/start-containers-automatically/">Docker restart policy</a></p>
</li>
<li>
<p><a href="https://www.alibabacloud.com/blog/docker-container-resource-management-cpu-ram-and-io-part-2_594575">Docker Container Resource Management: CPU, RAM and IO: Part 2 - Alibaba Cloud Community</a></p>
</li>
</ul>
</div>
</div>
</div>

  </div>
  

<div class="navigation navigation-single">
    
    <a href="/drafts/2020/06/23/simple-g1gc-tuning/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">Simple G1GC tuning</span>
    </a>
    
    
    <a href="/drafts/2020/11/03/rediscover-jvm-ergonomics-with-containers/" class="navigation-next">
      <span class="navigation-tittle">Rediscovering JVM ergonomics with containers</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  
</article>


            
    
<footer>

 
 
 <div class="github-edit">
     <a href="https://github.com/bric3/bric3.github.io/edit/hugo-sources/content/drafts/2020-08-20-mimic-kubernetes-deployment-with-docker.adoc">
     <i class="fab fa-github fa-lg" aria-hidden="true"></i> Edit this page
     </a>
 </div>
 




















<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: { inlineMath: [["\\(", "\\)"]], displayMath: [["\\[", "\\]"]], ignoreClass: "nostem|nolatexmath" },
  asciimath2jax: { delimiters: [["\\$", "\\$"]], ignoreClass: "nostem|noasciimath" },
  TeX: { equationNumbers: { autoNumber: "none" } }
})
MathJax.Hub.Register.StartupHook("AsciiMath Jax Ready", function () {
  MathJax.InputJax.AsciiMath.postfilterHooks.Add(function (data, node) {
    if ((node = data.script.parentNode) && (node = node.parentNode) && node.classList.contains("stemblock")) {
      data.math.root.display = "block"
    }
    return data
  })
})
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js" integrity="sha512-M36RUChWzAh1veeenRZFql7HydLEnkYmoloiCvVrhz402UZgKI93qkV7SsaxtVKdN95Wzajh39ysrXCq34NTsg==" crossorigin="anonymous"></script>
<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/config/TeX-MML-AM_HTMLorMML-full.min.js" integrity="sha512-SdNVJmCczXFqz3Iok8gP+cloe2CScrnHJczMBwL+aSrdZVllRNqRJ5A2p83S4fUM8I4endIZgM2ZIkwNqb3Eew==" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/highlight.min.js" integrity="sha512-gU7kztaQEl7SHJyraPfZLQCNnrKdaQi5ndOyt4L4UPL/FHDd/uB9Je6KDARIqwnNNE27hnqoWLBq+Kpe4iHfeQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script type="text/javascript">
        
        
        
        
        
        var mergeHTMLPlugin = (function () {
            'use strict';

            var originalStream;

            

            function escapeHTML(value) {
                return value
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#x27;');
            }

             

             
            const mergeHTMLPlugin = {
                
                "before:highlightElement": ({ el }) => {
                    originalStream = nodeStream(el);
                },
                
                "after:highlightElement": ({ el, result, text }) => {
                    if (!originalStream.length) return;

                    const resultNode = document.createElement('div');
                    resultNode.innerHTML = result.value;
                    result.value = mergeStreams(originalStream, nodeStream(resultNode), text);
                    el.innerHTML = result.value;
                }
            };

             

            


            

            function tag(node) {
                return node.nodeName.toLowerCase();
            }

            

            function nodeStream(node) {
                 
                const result = [];
                (function _nodeStream(node, offset) {
                    for (let child = node.firstChild; child; child = child.nextSibling) {
                        if (child.nodeType === 3) {
                            offset += child.nodeValue.length;
                        } else if (child.nodeType === 1) {
                            result.push({
                                event: 'start',
                                offset: offset,
                                node: child
                            });
                            offset = _nodeStream(child, offset);
                            
                            
                            
                            if (!tag(child).match(/br|hr|img|input/)) {
                                result.push({
                                    event: 'stop',
                                    offset: offset,
                                    node: child
                                });
                            }
                        }
                    }
                    return offset;
                })(node, 0);
                return result;
            }

            

            function mergeStreams(original, highlighted, value) {
                let processed = 0;
                let result = '';
                const nodeStack = [];

                function selectStream() {
                    if (!original.length || !highlighted.length) {
                        return original.length ? original : highlighted;
                    }
                    if (original[0].offset !== highlighted[0].offset) {
                        return (original[0].offset < highlighted[0].offset) ? original : highlighted;
                    }

                    

                    return highlighted[0].event === 'start' ? original : highlighted;
                }

                

                function open(node) {
                     
                    function attributeString(attr) {
                        return ' ' + attr.nodeName + '="' + escapeHTML(attr.value) + '"';
                    }
                    
                    result += '<' + tag(node) + [].map.call(node.attributes, attributeString).join('') + '>';
                }

                

                function close(node) {
                    result += '</' + tag(node) + '>';
                }

                

                function render(event) {
                    (event.event === 'start' ? open : close)(event.node);
                }

                while (original.length || highlighted.length) {
                    let stream = selectStream();
                    result += escapeHTML(value.substring(processed, stream[0].offset));
                    processed = stream[0].offset;
                    if (stream === original) {
                        

                        nodeStack.reverse().forEach(close);
                        do {
                            render(stream.splice(0, 1)[0]);
                            stream = selectStream();
                        } while (stream === original && stream.length && stream[0].offset === processed);
                        nodeStack.reverse().forEach(open);
                    } else {
                        if (stream[0].event === 'start') {
                            nodeStack.push(stream[0].node);
                        } else {
                            nodeStack.pop();
                        }
                        render(stream.splice(0, 1)[0]);
                    }
                }
                return result + escapeHTML(value.substr(processed));
            }

            return mergeHTMLPlugin;

        }());
        hljs.addPlugin(mergeHTMLPlugin);
        


        
        hljs.highlightAll();
    </script>
    

<script src="/js/scroll-shadows.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js" integrity="sha256-vrn14y7WH7zgEElyQqm2uCGSQrX/xjYDjniRUQx3NyU=" crossorigin="anonymous"></script>
<script type="text/javascript">
function addBlockSwitches() {
	$('.primary').each(function() {
		primary = $(this);
		createSwitchItem(primary, createBlockSwitch(primary)).item.addClass("selected");
		primary.children('.title').remove();
	});
	$('.secondary').each(function(idx, node) {
		secondary = $(node);
		primary = findPrimary(secondary);
		switchItem = createSwitchItem(secondary, primary.children('.switch'));
		switchItem.content.addClass('hidden');
		findPrimary(secondary).append(switchItem.content);
		secondary.remove();
	});
}

function createBlockSwitch(primary) {
	blockSwitch = $('<div class="switch"></div>');
	primary.prepend(blockSwitch);
	return blockSwitch;
}

function findPrimary(secondary) {
	candidate = secondary.prev();
	while (!candidate.is('.primary')) {
		candidate = candidate.prev();
	}
	return candidate;
}

function createSwitchItem(block, blockSwitch) {
	blockName = block.children('.title').text();
	content = block.children('.content').first().append(block.next('.colist'));
	item = $('<div class="switch--item">' + blockName + '</div>');
	blockSwitch.append(item);
	return {'item': item, 'content': content};
}

function globalSwitch() {
	$('.switch--item').each(function() {
		var blockId = blockIdForSwitchItem($(this));
		$(this).off('click');
		$(this).on('click', function() {
			selectedText = $(this).text()
			window.localStorage.setItem(blockId, selectedText);
			$(".switch--item").filter(function() {
				return blockIdForSwitchItem($(this)) === blockId;
			}).filter(function() {
				return $(this).text() === selectedText;
			}).each(function() {
				select($(this))
			});
		});
		if ($(this).text() === window.localStorage.getItem(blockId)) {
			select($(this))
		}
	});
}

function blockIdForSwitchItem(item) {
	idComponents = []
	idComponents.push(item.text().toLowerCase());
	item.siblings(".switch--item").each(function(index, sibling) {
		idComponents.push($(sibling).text().toLowerCase());
	});
	return idComponents.sort().join("-")
}

function select(selected) {
	selected.addClass('selected');
	selected.siblings().removeClass('selected');
	selectedContent = selected.parent().siblings(".content").eq(selected.index())
	selectedContent.removeClass('hidden');
	selectedContent.siblings().addClass('hidden');
}

$(addBlockSwitches);
$(globalSwitch);
</script>

<script type="text/javascript">
  
  
  window.addEventListener("load", () => {
    if (!'IntersectionObserver' in window) {
      return;
    }

    
    const sections = Array.from(document.querySelectorAll("section[id], h2[id], h3[id], h4[id], h5[id]"));
    const visibleSectionClass = "visible-section";

    
    
    const scrollHandler = entries =>
            entries.forEach(entry => {
              const section = entry.target;
              const sectionId = section.id;
              const sectionLink = document.querySelector(`a[href="#${sectionId}"]`);

              console.log(sectionId, sectionLink);
              console.log(entry)
              console.log(entry.intersectionRect.height / entry.rootBounds.height)

              if (entry.intersectionRatio > 0) {
                section.classList.add(visibleSectionClass);
                sectionLink.classList.add(visibleSectionClass);
              } else {
                section.classList.remove(visibleSectionClass);
                sectionLink.classList.remove(visibleSectionClass);
              }
            });

    
    const observer = new IntersectionObserver(scrollHandler);
    sections.map(section => {
      if (section.tagName === "SECTION") {
        return section;
      } else {
        
        
        
        
        
        
        
        
        let actualSectionContainer = section.parentElement;
        actualSectionContainer.id = section.id;
        return actualSectionContainer;
      }
    }).forEach(section => observer.observe(section));
  });

</script>






</footer>

    



        </div>
    </body>
</html>

