<!DOCTYPE html>
<html lang="en">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.75.1" />

    
    
    

<title>Off-Heap memory reconnaissance • Brice Dutheil</title>













    
<meta property="og:locale" content="en">
<meta property="og:site_name" content="Brice Dutheil">
<meta property="og:title" content="Off-Heap memory reconnaissance">
<meta property="og:type" content="website">
<meta property="og:url" content="https://blog.arkey.fr/drafts/2020/05/23/off-heap-reconnaissance/" />
<meta property="og:description" content="Java mostly, and general tech">
<meta property="og:image" content="https://blog.arkey.fr/social-sharing.png">
<meta property="og:image:type" content="image/png">
    
    
    
<meta property="og:image:width" content="192">
<meta property="og:image:height" content="192">
    

<meta property="og:updated_time" content="2020-05-23T23:45:29&#43;0200">



<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@BriceDutheil">
<meta name="twitter:title" content="Off-Heap memory reconnaissance">

<meta name="twitter:image" content="https://blog.arkey.fr/social-sharing.png">

<meta name="twitter:description" content="Java mostly, and general tech">
<meta name="twitter:creator" content="@BriceDutheil">
    
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/a11y-light.min.css" media="(prefers-color-scheme: light)"><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/gruvbox-dark.min.css" media="(prefers-color-scheme: dark)">




<link rel="stylesheet" href="/scss/hyde-hyde.157ebce1a9aa8d33b32dc026b8fa65847644aab3c1cb1ff0e1c25efc7ec2491e.css" integrity="sha256-FX684amqjTOzLcAmuPplhHZEqrPByx/w4cJe/H7CSR4=">


<link rel="stylesheet" href="/scss/hyde-hyde-dark.e42accb90675eefea7f835f9f36a333b2e088d399217fcac85044e672158d585.css" integrity="sha256-5CrMuQZ17v6n&#43;DX582ozOy4IjTmSF/yshQROZyFY1YU=" media="(prefers-color-scheme: dark)">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    
    <link rel="shortcut icon" sizes="192x192" href="/android-192-favicon.png">

    
    <link rel="shortcut icon" href="/android-192-favicon.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css" integrity="sha256-h20CPZ0QyXlBuAw7A+KluUYx/3pK+c7lYEpqLTlxjYQ=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/v4-shims.min.css" integrity="sha256-wN7QJaqAwQ03kgUhyN4EU2phRdDkLrQYbFe0EvpQ60U=" crossorigin="anonymous" />

    
    


    
</head>


    <body class="draft">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="https://blog.arkey.fr">Brice Dutheil</a>
      </span>
      
      
        <div class="author-image">
          <img src="https://www.gravatar.com/avatar/f31c7fbcbb0766d0632d96fd7e74b649?s=240&d=mp" class="img--circle img--headshot element--center" alt="gravatar">
        </div>
      
      <p class="site__description">
         Java mostly, and general tech 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">Brice Dutheil</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/"><span class='fa-icon'><i class='fas fa-home'></i></span><code>cd <em>~</em></code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/posts/"><span class='fa-icon'><i class='fas fa-stream'></i></span><code>ls <em>posts/*</em></code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/series/"><span class='fa-icon'><i class='fas fa-list-alt'></i></span><code>grep -o <em>series</em> posts/* | sort -u</code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/tags/"><span class='fa-icon'><i class='fas fa-tags'></i></span><code>grep -o <em>tags</em> posts/* | sort -u</code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/cool-stuff/"><span class='fa-icon'><i class='fas fa-thumbtack'></i></span><code>cd <em>cool-stuff</em></code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/whoami/"><span class='fa-icon'><i class='fas fa-id-card'></i></span><code>whoami</code>
						<span></span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://twitter.com/BriceDutheil" rel="me"><i class="fa-w-16" aria-hidden="true"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="bird" class="svg-inline--fa fa-bird fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></i></a>
	
	
	
	<a href="https://github.com/bric3" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	<a href="https://speakerdeck.com/bric3" rel="me"><i class="fab fa-speaker-deck" aria-hidden="true"></i></i></a>
	
	
	
	
	
	
	
	<a href="https://linkedin.com/in/dutheilbrice" rel="me"><i class="fa-w-16" aria-hidden="true"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="pro-network" class="svg-inline--fa fa-pro-network fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></i></a>
	
	
	<a href="https://stackoverflow.com/users/48136/brice" rel="me"><i class="fab fa-stack-overflow fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	
</section>

      </div>
    </div>

  </div>
  <div class="container fixed-container">
    
<div class="copyright">
  &copy; 2010 - 2020 Brice Dutheil
  
    <a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a>
  
</div>



  </div>
</div>

        <div class="content container">
            
    

<article>
  <header>
    <h1>Off-Heap memory reconnaissance</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> 2020-05-23
    
    
    
    
    
    <br/>
    <i class="fas fa-clock"></i> 128 min read

    
    
    

</div>


  </header>
  
  
  
  <div class="post adoc">
    <div class="paragraph">
<p><em>This entry has been marinating for most of the year 2020. Rewriting it 3 times
to make it more digestible form, then I found out I should just split my thoughts
in articles a bit smaller that hopefully make sense on their own.</em></p>
</div>
<div class="sect1">
<h2 id="_motivation"><a class="anchor" href="#_motivation"></a><a class="link" href="#_motivation">Motivation</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>I ha ve been running applications in containers for a while now, and I have
noted that this shift in deployment resulted in tighter constraints. And the
closer the walls are the closer we, software developers (or anyone involved in
production), should pay more attention to how memory is consumed.</p>
</div>
<div class="paragraph">
<p>Indeed, sometime getting the right memory limit for Java applications is sometimes an
intangible task, and I think the
<a href="/2020/10/27/maxrampercentage-is-not-what-i-wished-for/"><code>MaxRAMPercentage</code> flag is certainly not the right tool for this job</a>.</p>
</div>
<div class="paragraph">
<p>Moreover, with a given limit, if an application gets <em>oomkilled</em> then
one has to ask if it is the limit that needs adjustment or if it is the
application that is misbehaving (memory leak in particular, but not always).</p>
</div>
<div class="paragraph">
<p>To answer questions about memory usage there are various things to look at,
Java Heap, Metaspace other JVM components, etc. I faced a few incidents,
where the JVM settings and the Kubernetes memory limit were seemingly
appropriate, yet the apps were constantly oomkilled because the RSS kept
growing toward this limit. Some of these issues have been solved just
by raising the memory limit. However, in some other cases it wasn’t that
crystal clear.</p>
</div>
<div class="paragraph">
<p>This served as excuse to go down the rabbit hole.</p>
</div>
<div class="paragraph">
<p>This entry will hopefully help to understand the basics of how a
<code>java</code> process uses native memory and remind some rudiments of OS
memory management.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Most of the time, figures will use the <a href="https://en.wikipedia.org/wiki/Binary_prefix">IEC binary notation</a> (<code>1 KiB = 1024 Byte</code>),
it matches the <a href="https://github.com/corretto/corretto-11/blob/055a9a1a279b9a2953c2150bc937b04f905eeba1/src/src/hotspot/share/utilities/globalDefinitions.hpp#L226">JVM</a>,
our <a href="https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#meaning-of-memory">Kubernetes</a> usage,
and Linux’s tools (<code>/proc/{pid}/stat</code> or <code>/proc/{pid}/maps</code> ; although I couldn’t find a reference link stating this).</p>
</div>
<div class="paragraph">
<p>Some charts may however use the <a href="https://en.wikipedia.org/wiki/Binary_prefix">SI metric notation</a> (<code>1 KB = 1000 Byte</code>).</p>
</div>
<div class="quoteblock">
<blockquote>
Actually, 227,893 KB is only 222 MB. For ease of discussion, I’ll truncate the KBs part by 1,000
in this chapter; pretend I’m a disk manufacturer.
</blockquote>
<div class="attribution">
— Java Performance: The Definitive Guide<br/>
<cite>Getting the Most Out of Your Code (1st Edition)</cite>
</div>
</div>
<div class="paragraph">
<p><em>Thanks to this <a href="https://twitter.com/fleming_matt/status/1282729134481965064?s=21">tweet</a>.</em></p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Also, all java snippet and command have been run with Java 11.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Getting comfortable with the memory of a (JVM) process is a tedious task
for most of us that wrote code in Java for their entire professional life.
However, this is a rewarding task, and it’s possible to extract useful
findings.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_exploration_begins"><a class="anchor" href="#_exploration_begins"></a><a class="link" href="#_exploration_begins">Exploration begins</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_the_jvm_flags_as_a_starting_point"><a class="anchor" href="#_the_jvm_flags_as_a_starting_point"></a><a class="link" href="#_the_jvm_flags_as_a_starting_point">The JVM flags as a starting point</a></h3>
<div class="paragraph">
<p>When assessing java memory, one of the fist thing to look at are the Java heap parameters.</p>
</div>
<div class="paragraph">
<p>It’s likely anyone that reads this article is familiar with <code>Xms</code> or <code>Xmx</code>, but there are
other ways to define the boundaries of the Java heap in particular if the process is started
with <code>\*RAMPercentage</code>. With these the JVM will compute the actual values from the <code>cgroup</code>,
in this case it’s possible to access the actual runtime values with <code>jcmd</code>.</p>
</div>
<div class="paragraph">
<p>In short, it’s possible to look at the command line options, but using the diagnostic
command <code>jcmd {pid} VM.flags</code> lets you peek at the actual values that the JVM used.</p>
</div>
<div class="paragraph">
<p>For example with a memory limit of <code>5 GiB</code>, if a process is started with
<code>-XX:InitialRAMPercentage=85.0 -XX:MaxRAMPercentage=85.0</code> the <code>VM.flags</code>
diagnostic command will output this :</p>
</div>
<div class="listingblock">
<div class="title">JVM current flags in a kubernetes container</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ jcmd $(pidof java) VM.flags | tr &#39; &#39; &#39;\n&#39;
6:
...
-XX:InitialHeapSize=4563402752 <i class="conum" data-value="3"></i><b>(3)</b>
-XX:InitialRAMPercentage=85.000000 <i class="conum" data-value="1"></i><b>(1)</b>
-XX:MarkStackSize=4194304
-XX:MaxHeapSize=4563402752 <i class="conum" data-value="4"></i><b>(4)</b>
-XX:MaxNewSize=2736783360
-XX:MaxRAMPercentage=85.000000 <i class="conum" data-value="2"></i><b>(2)</b>
-XX:MinHeapDeltaBytes=2097152
-XX:NativeMemoryTracking=summary
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Initial RAM at 85%</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Max RAM at 85%</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Initial heap size ~<code>4.25 GiB</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Max heap size ~<code>4.25 GiB</code></td>
</tr>
</tbody></table>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Do not confuse the <code>VM.flags</code> command which will output parameters calculated <strong>from</strong> the
<em>command line</em> and <code>VM.command_line</code> which will print the <strong>raw</strong> <em>command line</em>.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The other Hotspot flag values comes are JVM <em>defaults</em>, which may either be static values,
or computed from internal heuristics.</p>
</div>
<div class="paragraph">
<p>As we tend to dismiss regularly, the Java heap is only a part of the process memory usage.
So now let’s dig into how memory is <em>consumed</em>. The values or snippet comes from an
application running inside a container.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_real_memory_footprint_of_the_java_process_in_the_container"><a class="anchor" href="#_the_real_memory_footprint_of_the_java_process_in_the_container"></a><a class="link" href="#_the_real_memory_footprint_of_the_java_process_in_the_container">The real memory footprint of the java process in the container</a></h3>
<div class="paragraph">
<p>The JVM is doing everything to keep software developers from caring about
memory, and before containers the bigger systems helped to sustain this
comfortable way of programming. Sometime there’s a Java heap memory leak
but it doesn’t happen every day, and even more remotely there’s a problem
with the process memory.</p>
</div>
<div class="paragraph">
<p>There’s more chance we could get hit by GC pauses.</p>
</div>
<div class="paragraph">
<p>With containers, one of the most critical things to look at is the <em>resident set size</em>,
that’s the native memory, it can be obtained in various ways, using <code>ps</code>, <code>top</code> or
reading the <code>/proc</code> filesystem. E.g. on the same application on which
I got the flags above:</p>
</div>
<div class="listingblock primary">
<div class="title"><code>ps</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ ps o pid,rss -p $(pidof java)
PID   RSS
  6 4701120</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title"><code>/proc/{pid}/status</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ cat /proc/$(pgrep java)/status | grep VmRSS
VmRSS:	 4701120 kB</code></pre>
</div>
</div>
<div class="paragraph">
<p>The RSS is <code>4.6 GiB</code>, and it’s Java heap size is <code>4.25 GiB</code>, indicating
this process uses around <code>0.35 GiB</code> of non-Java heap memory, I’ll refer
to this memory as <em>native memory</em>.</p>
</div>
<div class="paragraph">
<p>I’d like to dig a bit to understand the reported number <code>4701120 KiB</code>,
what it actually measures.</p>
</div>
<div class="sect3">
<h4 id="_the_jvm_component_memory"><a class="anchor" href="#_the_jvm_component_memory"></a><a class="link" href="#_the_jvm_component_memory">The JVM component memory</a></h4>
<div class="paragraph">
<p>In order to understand how the Java process memory is consumed, we need to use
<em>Native Memory Tracking</em> (<code>-XX:NativeMemoryTracking=summary</code>) which produces
an overview of the memory usage by the <em>components of the JVM</em>. It actually gives
a pretty good picture of the &#34;cost&#34; of having a JVM.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Enabling <em>detailed</em> native memory tracking (NMT) causes a 5% to 10%
performance overhead. The <em>summary</em> mode merely has an impact in memory usage
as shown below and is usually enough.
</td>
</tr>
</tbody></table>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It is necessary to note that while the above command indicate a scale
in <code>KB</code> for the JVM it really means <code>KiB</code>.
</td>
</tr>
</tbody></table>
</div>
<div class="listingblock">
<div class="title">JVM native memory trcking report</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ jcmd $(pidof java) VM.native_memory
6:

Native Memory Tracking:

Total: reserved=7168324KB, committed=5380868KB                               <i class="conum" data-value="1"></i><b>(1)</b>
-                 Java Heap (reserved=4456448KB, committed=4456448KB)        <i class="conum" data-value="2"></i><b>(2)</b>
                            (mmap: reserved=4456448KB, committed=4456448KB)

-                     Class (reserved=1195628KB, committed=165788KB)         <i class="conum" data-value="3"></i><b>(3)</b>
                            (classes #28431)                                 <i class="conum" data-value="4"></i><b>(4)</b>
                            (  instance classes #26792, array classes #1639)
                            (malloc=5740KB #87822)
                            (mmap: reserved=1189888KB, committed=160048KB)
                            (  Metadata:   )
                            (    reserved=141312KB, committed=139876KB)
                            (    used=135945KB)
                            (    free=3931KB)
                            (    waste=0KB =0.00%)
                            (  Class space:)
                            (    reserved=1048576KB, committed=20172KB)
                            (    used=17864KB)
                            (    free=2308KB)
                            (    waste=0KB =0.00%)

-                    Thread (reserved=696395KB, committed=85455KB)
                            (thread #674)
                            (stack: reserved=692812KB, committed=81872KB)    <i class="conum" data-value="5"></i><b>(5)</b>
                            (malloc=2432KB #4046)
                            (arena=1150KB #1347)

-                      Code (reserved=251877KB, committed=105201KB)          <i class="conum" data-value="6"></i><b>(6)</b>
                            (malloc=4189KB #11718)
                            (mmap: reserved=247688KB, committed=101012KB)

-                        GC (reserved=230739KB, committed=230739KB)          <i class="conum" data-value="7"></i><b>(7)</b>
                            (malloc=32031KB #63631)
                            (mmap: reserved=198708KB, committed=198708KB)

-                  Compiler (reserved=5914KB, committed=5914KB)              <i class="conum" data-value="8"></i><b>(8)</b>
                            (malloc=6143KB #3281)
                            (arena=180KB #5)

-                  Internal (reserved=24460KB, committed=24460KB)           <i class="conum" data-value="10"></i><b>(10)</b>
                            (malloc=24460KB #13140)

-                     Other (reserved=267034KB, committed=267034KB)         <i class="conum" data-value="11"></i><b>(11)</b>
                            (malloc=267034KB #631)

-                    Symbol (reserved=28915KB, committed=28915KB)            <i class="conum" data-value="9"></i><b>(9)</b>
                            (malloc=25423KB #330973)
                            (arena=3492KB #1)

-    Native Memory Tracking (reserved=8433KB, committed=8433KB)
                            (malloc=117KB #1498)
                            (tracking overhead=8316KB)

-               Arena Chunk (reserved=217KB, committed=217KB)
                            (malloc=217KB)

-                   Logging (reserved=7KB, committed=7KB)
                            (malloc=7KB #266)

-                 Arguments (reserved=19KB, committed=19KB)
                            (malloc=19KB #521)

-                    Module (reserved=1362KB, committed=1362KB)
                            (malloc=1362KB #6320)

-              Synchronizer (reserved=837KB, committed=837KB)
                            (malloc=837KB #6877)

-                 Safepoint (reserved=8KB, committed=8KB)
                            (mmap: reserved=8KB, committed=8KB)

-                   Unknown (reserved=32KB, committed=32KB)
                            (mmap: reserved=32KB, committed=32KB)</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This shows a <code>reserved</code> value (<code>7168324 KiB</code> (~<code>6.84 GiB</code>)), it’s the amount
of addressable memory on that container, and a <code>committed</code> value (<code>4456448 KiB</code> (~<code>4.25 GiB</code>))
that represents what the JVM actually asked the OS to allocate.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>Heap</code> zone, note that reserved and committed values are the same <code>4456448 KiB</code>
here because our <code>InitialRAMPercentage</code> is the same as max. I’m not sure why this number
is different from the VM flags <code>-XX:MaxHeapSize=4563402752</code> though.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>~<code>162 MiB</code> of metaspace.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>How many classes have been loaded : <code>28431</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>There are 674 threads whose stacks are using ~<code>80 MiB</code> at this time.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td><code>Code</code> cache area (assembly of the used methods) ~<code>102 MiB</code> out of ~<code>246 MiB</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>This section contains <code>GC</code> algorithms internal data structures, this is app
is using G1GC which takes ~<code>225 MiB</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>C1 / C2 compilers (which compile bytecode to assembly) use ~<code>5.8 MiB</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>The <code>Symbol</code> section contains many things like interned strings and other
internal constants for about <code>28.2 MiB</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>The <code>Internal</code> area takes ~<code>24 MiB</code>. Before Java 11 this area included
<code>DirectByteBuffers</code>, but from Java 11 those are accounted in the <code>Other</code> zone.</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>The <code>Other</code> section after Java 11 includes <code>DirectByteBuffers</code> ~<code>261 MiB</code>.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The remaining areas are much smaller in scale, NMT takes ~<code>8.2 MiB</code>
itself, module system usage ~<code>1.3 MiB</code>, etc. Also, note that enabling
other JVM features may show up if they are activated, like flight recorder.
<a href="https://docs.oracle.com/en/java/javase/11/troubleshoot/diagnostic-tools.html#GUID-5EF7BB07-C903-4EBD-A9C2-EC0E44048D37">Source</a></p>
</div>
<div class="paragraph">
<p>There’s a lot more to read on the
<a href="https://docs.oracle.com/en/java/javase/11/vm/native-memory-tracking.html#GUID-39676837-DA61-4F8D-9C5B-9DB1F5147D80">official documentation about NMT</a>
and <a href="https://docs.oracle.com/en/java/javase/11/troubleshoot/diagnostic-tools.html#GUID-1F53A50E-86FF-491D-A023-8EC4F1D1AC77">how to Monitor VM Internal Memory</a>.
Yet another worthwhile read on <a href="https://shipilev.net/jvm/anatomy-quarks/12-native-memory-tracking/">native memory tracking</a>
by <a href="http://twitter.com/shipilev">Aleksey Shipilёv</a>.</p>
</div>
<div class="paragraph">
<p><strong>In the rest of this article when talking the context of Native Memory Tracking
I may use the terms <em>memory type</em> or <em>memory zones</em>, but the real definition would be :</strong></p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><strong>the <em>memory allocation type</em> performed by a <em>JVM component</em></strong></p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>The different sections are defined there in
<a href="https://github.com/corretto/corretto-11/blob/caa2f4cad666b508a88b92db01054ace8647a820/src/src/hotspot/share/memory/allocation.hpp#L114-L141">this <code>MemoryType</code> enumeration</a>,
and <a href="https://github.com/corretto/corretto-11/blob/2b351313740f148597cf680d8443df93931de813/src/src/hotspot/share/services/nmtCommon.cpp#L28-L51">here</a>
as they appear in the report.</p>
</div>
<div class="paragraph">
<p><em>NMT</em> is a great tool to gain an insight on the memory usage of the various
parts that compose the Java runtime. It has interesting subcommands to compare
the memory usage of the JVM components with a <em>baseline</em>
(<code>jcmd $(pidof java) VM.native_memory baseline</code>, followed at some point by
one or several <code>jcmd $(pidof java) VM.native_memory summary.diff</code>).</p>
</div>
<div class="paragraph">
<p>This is very useful for JVM components and a good complement to what I would
like to show in this article, because NMT alone <strong>does not answer
what is actually accounted in the RSS column of <code>ps</code></strong>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_revising_os_virtual_memory_and_memory_management"><a class="anchor" href="#_revising_os_virtual_memory_and_memory_management"></a><a class="link" href="#_revising_os_virtual_memory_and_memory_management">Revising OS virtual memory and memory management</a></h4>
<div class="paragraph">
<p>I mentioned this acronym already, <em>RSS</em> or <strong>R</strong>esident <strong>S</strong>et <strong>S</strong>ize,
what is it? What exactly means <em>committed</em> memory or <em>reserved</em> memory
reported in <em>NMT</em> ? How do they relate to each other?</p>
</div>
<div class="paragraph">
<p>First let’s break down the vocabulary when we talk about memory.</p>
</div>
<div class="imageblock">
<div class="content">
<svg xmlns="http://www.w3.org/2000/svg" version="1.0" shape-rendering="geometricPrecision" preserveAspectRatio="xMidYMid meet" viewBox="0 0 650 224" width="650" height="224">
  <defs>
    <style type="text/css">
      @font-face { font-family: sans-serif; }
    </style>
    <filter id="shadowBlur" x="0" y="0" width="200%" height="200%">
      <feOffset in="SourceGraphic" dx="3.0003002" dy="3.0003002" result="offOut"></feOffset>
      <feGaussianBlur in="offOut" stdDeviation="3"></feGaussianBlur>
    </filter>
  </defs>
  <g stroke-width="1" stroke-linecap="square" stroke-linejoin="round">
    <rect x="0" y="0" width="650" height="224" style="fill: #ffffff"></rect>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M25.0 133.0 L25.0 105.0 L625.0 105.0 L625.0 133.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M25.0 133.0 L25.0 105.0 L625.0 105.0 L625.0 133.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M40.0 42.0 L30.0 49.0 L40.0 56.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M610.0 42.0 L620.0 49.0 L610.0 56.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M40.0 56.0 L30.0 63.0 L40.0 70.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M480.0 56.0 L490.0 63.0 L480.0 70.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M40.0 70.0 L30.0 77.0 L40.0 84.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M360.0 70.0 L370.0 77.0 L360.0 84.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M40.0 154.0 L30.0 161.0 L40.0 168.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M610.0 154.0 L620.0 161.0 L610.0 168.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M615.0 49.0 L205.0 49.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M215.0 63.0 L485.0 63.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M365.0 77.0 L225.0 77.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M615.0 161.0 L265.0 161.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M55.0 49.0 L35.0 49.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M35.0 63.0 L55.0 63.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M55.0 77.0 L35.0 77.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M55.0 161.0 L35.0 161.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M495.0 63.0 L495.0 105.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M375.0 77.0 L375.0 105.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M625.0 49.0 L625.0 105.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M625.0 133.0 L625.0 175.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M25.0 49.0 L25.0 105.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M25.0 133.0 L25.0 175.0 "></path>
    <text x="63" y="124" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      addressable space of the process
    </text>
    <text x="71" y="166" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      contiguous addresses
    </text>
    <text x="60" y="54" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      virtual memory
    </text>
    <text x="60" y="68" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      reserved memory
    </text>
    <text x="60" y="82" font-family="sans-serif" font-size="14" stroke="none" fill="#000000">
      committed memory
    </text>
    <text x="541" y="194" font-family="sans-serif" font-size="14" stroke="none" fill="#000000">
      0x8000000
    </text>
    <text x="23" y="194" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      0 
    </text>
  </g>
</svg>
</div>
<div class="title">memory vocabulary</div>
</div>
<table class="tableblock frame-all grid-all fit-content stretch">
<caption class="title">Table 1. vocabulary breakdown (<a href="https://stackoverflow.com/a/31178912/48136">source</a>)</caption>
<colgroup>
<col/>
<col/>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Committed</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Address ranges that have been mapped or <code>malloc</code>ed.
They may or may not be backed by physical or swap due to lazy allocation and paging.
This applies to the JVM and the OS. These ranges are actually not necessarily contiguous.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Reserved</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The total address range that has been pre-mapped via <code>mmap</code> or <code>malloc</code>
for a particular memory pool. In other words <em>reserved memory</em> represents the maximum
addressable memory.
Those could be referred to as <strong>uncommitted</strong>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Resident</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OS memory pages which are currently in physical ram. This means codes,
stacks, part of the committed memory pools but also portions of <code>mmap</code>ed files
which have recently been accessed and allocations outside the control of the JVM.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Virtual</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The sum of all virtual address mappings. Covers committed, reserved
memory pools but also mapped files or shared memory. This number is rarely informative
since the JVM will reserve large address ranges upfront. We can see this number
as the pessimistic memory usage.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The above graph mostly displays the relative size by memory <em>kind</em>
within the address space of a process. In order to explain <em>resident</em> memory
it’s necessary to revise how Linux (and other OSes by the way) manage
memory using the concept of <strong>paging</strong>.</p>
</div>
<div class="paragraph">
<p>The virtual address space is divided into smaller chunks called <em>pages</em>
usually of <code>4 KiB</code>.
<em>The are other page sizes and these sizes may even co-exist (e.g. having pages of
4 KiB mixed with 2 MiB pages), it depends on the capabilities
of the processor ; working with different size of pages is something that is out
of scope for this article.
What is interesting is how paging and RSS relate to each other.</em></p>
</div>
<div class="imageblock">
<div class="content">
<svg xmlns="http://www.w3.org/2000/svg" version="1.0" shape-rendering="geometricPrecision" preserveAspectRatio="xMidYMid meet" viewBox="0 0 660 532" width="660" height="532">
  <defs>
    <style type="text/css">
      @font-face { font-family: sans-serif; }
    </style>
    <filter id="shadowBlur" x="0" y="0" width="200%" height="200%">
      <feOffset in="SourceGraphic" dx="3.0003002" dy="3.0003002" result="offOut"></feOffset>
      <feGaussianBlur in="offOut" stdDeviation="3"></feGaussianBlur>
    </filter>
  </defs>
  <g stroke-width="1" stroke-linecap="square" stroke-linejoin="round">
    <rect x="0" y="0" width="660" height="532" style="fill: #ffffff"></rect>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M525.0 455.0 L525.0 483.0 L445.0 483.0 L445.0 455.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M343.0 273.0 L343.0 299.0 L257.0 299.0 L257.0 273.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M343.0 303.0 L343.0 329.0 L257.0 329.0 L257.0 303.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M467.0 273.0 L467.0 299.0 L545.0 299.0 L545.0 280.0 Q545.0 273.0 540.0 273.0 L467.0 273.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M467.0 303.0 L467.0 329.0 L540.0 329.0 Q545.0 329.0 545.0 322.0 L545.0 303.0 L545.0 303.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M403.0 273.0 L403.0 299.0 L347.0 299.0 L347.0 273.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M463.0 273.0 L463.0 299.0 L407.0 299.0 L407.0 273.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M403.0 303.0 L403.0 329.0 L347.0 329.0 L347.0 303.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M463.0 303.0 L463.0 329.0 L407.0 329.0 L407.0 303.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M173.0 273.0 L173.0 299.0 L127.0 299.0 L127.0 273.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M173.0 303.0 L173.0 329.0 L127.0 329.0 L127.0 303.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M57.0 299.0 L57.0 273.0 L93.0 273.0 L93.0 299.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M177.0 273.0 L177.0 299.0 L213.0 299.0 L213.0 273.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M217.0 299.0 L217.0 273.0 L253.0 273.0 L253.0 299.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M57.0 303.0 L57.0 329.0 L93.0 329.0 L93.0 303.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M213.0 303.0 L213.0 329.0 L177.0 329.0 L177.0 303.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M217.0 303.0 L217.0 329.0 L253.0 329.0 L253.0 303.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M30.0 273.0 Q25.0 273.0 25.0 280.0 L25.0 299.0 L53.0 299.0 L53.0 273.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M53.0 303.0 L53.0 329.0 L30.0 329.0 Q25.0 329.0 25.0 322.0 L25.0 303.0 L25.0 303.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M123.0 273.0 L123.0 299.0 L97.0 299.0 L97.0 273.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M123.0 303.0 L123.0 329.0 L97.0 329.0 L97.0 303.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M25.0 49.0 L25.0 77.0 L45.0 77.0 L45.0 49.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M43.0 161.0 L43.0 189.0 L25.0 189.0 L25.0 161.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M607.0 189.0 L625.0 189.0 L625.0 161.0 L607.0 161.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M103.0 161.0 L103.0 189.0 L87.0 189.0 L87.0 161.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M127.0 189.0 L143.0 189.0 L143.0 161.0 L127.0 161.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M163.0 161.0 L163.0 189.0 L147.0 189.0 L147.0 161.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M183.0 161.0 L183.0 189.0 L167.0 189.0 L167.0 161.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M287.0 189.0 L303.0 189.0 L303.0 161.0 L287.0 161.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M563.0 161.0 L563.0 189.0 L547.0 189.0 L547.0 161.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M55.0 427.0 L55.0 439.0 L45.0 439.0 L45.0 427.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M55.0 471.0 L55.0 483.0 L45.0 483.0 L45.0 471.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M85.0 427.0 L85.0 439.0 L75.0 439.0 L75.0 427.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M85.0 471.0 L85.0 483.0 L75.0 483.0 L75.0 471.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M115.0 427.0 L115.0 439.0 L105.0 439.0 L105.0 427.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M115.0 471.0 L115.0 483.0 L105.0 483.0 L105.0 471.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M145.0 427.0 L145.0 439.0 L135.0 439.0 L135.0 427.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M145.0 471.0 L145.0 483.0 L135.0 483.0 L135.0 471.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M175.0 427.0 L175.0 439.0 L165.0 439.0 L165.0 427.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M175.0 471.0 L175.0 483.0 L165.0 483.0 L165.0 471.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M55.0 443.0 L55.0 453.0 L45.0 453.0 L45.0 443.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M55.0 457.0 L55.0 467.0 L45.0 467.0 L45.0 457.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M85.0 443.0 L85.0 453.0 L75.0 453.0 L75.0 443.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M85.0 457.0 L85.0 467.0 L75.0 467.0 L75.0 457.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M115.0 443.0 L115.0 453.0 L105.0 453.0 L105.0 443.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M115.0 457.0 L115.0 467.0 L105.0 467.0 L105.0 457.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M145.0 443.0 L145.0 453.0 L135.0 453.0 L135.0 443.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M145.0 457.0 L145.0 467.0 L135.0 467.0 L135.0 457.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M165.0 453.0 L165.0 443.0 L175.0 443.0 L175.0 453.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M165.0 457.0 L165.0 467.0 L175.0 467.0 L175.0 457.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M175.0 399.0 L195.0 399.0 L195.0 497.0 L25.0 497.0 L25.0 399.0 L35.0 399.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M435.0 469.0 L435.0 497.0 L585.0 497.0 L585.0 399.0 L505.0 399.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M435.0 469.0 L290.0 469.0 Q285.0 469.0 285.0 462.0 L285.0 385.0 L285.0 385.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M175.0 371.0 L360.0 371.0 Q365.0 371.0 365.0 364.0 L365.0 343.0 L365.0 343.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M525.0 455.0 L525.0 483.0 L445.0 483.0 L445.0 455.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M343.0 273.0 L343.0 299.0 L257.0 299.0 L257.0 273.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M343.0 303.0 L343.0 329.0 L257.0 329.0 L257.0 303.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M467.0 273.0 L467.0 299.0 L545.0 299.0 L545.0 280.0 Q545.0 273.0 540.0 273.0 L467.0 273.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M467.0 303.0 L467.0 329.0 L540.0 329.0 Q545.0 329.0 545.0 322.0 L545.0 303.0 L545.0 303.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M435.0 469.0 L435.0 399.0 L485.0 399.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M403.0 273.0 L403.0 299.0 L347.0 299.0 L347.0 273.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M463.0 273.0 L463.0 299.0 L407.0 299.0 L407.0 273.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M403.0 303.0 L403.0 329.0 L347.0 329.0 L347.0 303.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M463.0 303.0 L463.0 329.0 L407.0 329.0 L407.0 303.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M173.0 273.0 L173.0 299.0 L127.0 299.0 L127.0 273.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M173.0 303.0 L173.0 329.0 L127.0 329.0 L127.0 303.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M57.0 299.0 L57.0 273.0 L93.0 273.0 L93.0 299.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M177.0 273.0 L177.0 299.0 L213.0 299.0 L213.0 273.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M217.0 299.0 L217.0 273.0 L253.0 273.0 L253.0 299.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M57.0 303.0 L57.0 329.0 L93.0 329.0 L93.0 303.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M213.0 303.0 L213.0 329.0 L177.0 329.0 L177.0 303.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M217.0 303.0 L217.0 329.0 L253.0 329.0 L253.0 303.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M495.0 259.0 L495.0 224.0 Q495.0 217.0 500.0 217.0 L550.0 217.0 L550.0 217.0 Q555.0 217.0 555.0 210.0 L555.0 203.0 L555.0 203.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M115.0 413.0 L115.0 378.0 Q115.0 371.0 120.0 371.0 L155.0 371.0 L155.0 371.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M295.0 203.0 L295.0 210.0 Q295.0 217.0 300.0 217.0 L350.0 217.0 L350.0 217.0 Q355.0 217.0 355.0 224.0 L355.0 259.0 L355.0 259.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M30.0 273.0 Q25.0 273.0 25.0 280.0 L25.0 299.0 L53.0 299.0 L53.0 273.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M53.0 303.0 L53.0 329.0 L30.0 329.0 Q25.0 329.0 25.0 322.0 L25.0 303.0 L25.0 303.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M135.0 203.0 L135.0 210.0 Q135.0 217.0 140.0 217.0 L180.0 217.0 L180.0 217.0 Q185.0 217.0 185.0 224.0 L185.0 259.0 L185.0 259.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M123.0 273.0 L123.0 299.0 L97.0 299.0 L97.0 273.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M123.0 303.0 L123.0 329.0 L97.0 329.0 L97.0 303.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M25.0 49.0 L25.0 77.0 L45.0 77.0 L45.0 49.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M205.0 77.0 L225.0 77.0 L225.0 49.0 L205.0 49.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M43.0 161.0 L43.0 189.0 L25.0 189.0 L25.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M607.0 189.0 L625.0 189.0 L625.0 161.0 L607.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M63.0 161.0 L63.0 189.0 L47.0 189.0 L47.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M83.0 161.0 L83.0 189.0 L67.0 189.0 L67.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M103.0 161.0 L103.0 189.0 L87.0 189.0 L87.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M107.0 161.0 L107.0 189.0 L123.0 189.0 L123.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M127.0 189.0 L143.0 189.0 L143.0 161.0 L127.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M163.0 161.0 L163.0 189.0 L147.0 189.0 L147.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M183.0 161.0 L183.0 189.0 L167.0 189.0 L167.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M203.0 161.0 L203.0 189.0 L187.0 189.0 L187.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M223.0 161.0 L223.0 189.0 L207.0 189.0 L207.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M243.0 161.0 L243.0 189.0 L227.0 189.0 L227.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M263.0 161.0 L263.0 189.0 L247.0 189.0 L247.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M267.0 161.0 L267.0 189.0 L283.0 189.0 L283.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M287.0 189.0 L303.0 189.0 L303.0 161.0 L287.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M323.0 161.0 L323.0 189.0 L307.0 189.0 L307.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M343.0 161.0 L343.0 189.0 L327.0 189.0 L327.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M363.0 161.0 L363.0 189.0 L347.0 189.0 L347.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M383.0 161.0 L383.0 189.0 L367.0 189.0 L367.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M403.0 161.0 L403.0 189.0 L387.0 189.0 L387.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M423.0 161.0 L423.0 189.0 L407.0 189.0 L407.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M427.0 161.0 L427.0 189.0 L443.0 189.0 L443.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M447.0 189.0 L463.0 189.0 L463.0 161.0 L447.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M483.0 161.0 L483.0 189.0 L467.0 189.0 L467.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M503.0 161.0 L503.0 189.0 L487.0 189.0 L487.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M523.0 161.0 L523.0 189.0 L507.0 189.0 L507.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M543.0 161.0 L543.0 189.0 L527.0 189.0 L527.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M563.0 161.0 L563.0 189.0 L547.0 189.0 L547.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M583.0 161.0 L583.0 189.0 L567.0 189.0 L567.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M587.0 161.0 L587.0 189.0 L603.0 189.0 L603.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M185.0 343.0 L185.0 350.0 Q185.0 357.0 180.0 357.0 L170.0 357.0 L170.0 357.0 Q165.0 357.0 165.0 364.0 L165.0 413.0 L165.0 413.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M255.0 203.0 L255.0 210.0 Q255.0 217.0 250.0 217.0 L230.0 217.0 L230.0 217.0 Q225.0 217.0 225.0 224.0 L225.0 259.0 L225.0 259.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M55.0 203.0 L55.0 210.0 Q55.0 217.0 60.0 217.0 L60.0 217.0 L60.0 217.0 Q65.0 217.0 65.0 224.0 L65.0 259.0 L65.0 259.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M95.0 203.0 L95.0 210.0 Q95.0 217.0 100.0 217.0 L100.0 217.0 L100.0 217.0 Q105.0 217.0 105.0 224.0 L105.0 259.0 L105.0 259.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M55.0 427.0 L55.0 439.0 L45.0 439.0 L45.0 427.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M55.0 471.0 L55.0 483.0 L45.0 483.0 L45.0 471.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M85.0 427.0 L85.0 439.0 L75.0 439.0 L75.0 427.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M85.0 471.0 L85.0 483.0 L75.0 483.0 L75.0 471.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M115.0 427.0 L115.0 439.0 L105.0 439.0 L105.0 427.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M115.0 471.0 L115.0 483.0 L105.0 483.0 L105.0 471.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M145.0 427.0 L145.0 439.0 L135.0 439.0 L135.0 427.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M145.0 471.0 L145.0 483.0 L135.0 483.0 L135.0 471.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M175.0 427.0 L175.0 439.0 L165.0 439.0 L165.0 427.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M175.0 471.0 L175.0 483.0 L165.0 483.0 L165.0 471.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M55.0 443.0 L55.0 453.0 L45.0 453.0 L45.0 443.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M55.0 457.0 L55.0 467.0 L45.0 467.0 L45.0 457.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M85.0 443.0 L85.0 453.0 L75.0 453.0 L75.0 443.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M85.0 457.0 L85.0 467.0 L75.0 467.0 L75.0 457.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M115.0 443.0 L115.0 453.0 L105.0 453.0 L105.0 443.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M115.0 457.0 L115.0 467.0 L105.0 467.0 L105.0 457.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M145.0 443.0 L145.0 453.0 L135.0 453.0 L135.0 443.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M145.0 457.0 L145.0 467.0 L135.0 467.0 L135.0 457.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M165.0 453.0 L165.0 443.0 L175.0 443.0 L175.0 453.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M165.0 457.0 L165.0 467.0 L175.0 467.0 L175.0 457.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M40.0 98.0 L30.0 105.0 L40.0 112.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M610.0 98.0 L620.0 105.0 L610.0 112.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M40.0 112.0 L30.0 119.0 L40.0 126.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M510.0 112.0 L520.0 119.0 L510.0 126.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M40.0 126.0 L30.0 133.0 L40.0 140.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M370.0 126.0 L380.0 133.0 L370.0 140.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M30.0 252.0 L35.0 266.0 L40.0 252.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M60.0 252.0 L65.0 266.0 L70.0 252.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M100.0 252.0 L105.0 266.0 L110.0 252.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M180.0 252.0 L185.0 266.0 L190.0 252.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M220.0 252.0 L225.0 266.0 L230.0 252.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M350.0 252.0 L355.0 266.0 L360.0 252.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M490.0 252.0 L495.0 266.0 L500.0 252.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M520.0 252.0 L525.0 266.0 L530.0 252.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M40.0 406.0 L45.0 420.0 L50.0 406.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M110.0 406.0 L115.0 420.0 L120.0 406.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M160.0 406.0 L165.0 420.0 L170.0 406.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M490.0 434.0 L495.0 448.0 L500.0 434.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M430.0 462.0 L440.0 469.0 L430.0 476.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M615.0 105.0 L205.0 105.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M215.0 119.0 L515.0 119.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M35.0 203.0 L35.0 259.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M55.0 105.0 L35.0 105.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M55.0 119.0 L35.0 119.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M55.0 133.0 L35.0 133.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M45.0 343.0 L45.0 413.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M105.0 399.0 L55.0 399.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M495.0 343.0 L495.0 441.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M615.0 203.0 L615.0 224.0 Q615.0 231.0 610.0 231.0 L530.0 231.0 L530.0 231.0 Q525.0 231.0 525.0 238.0 L525.0 259.0 L525.0 259.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M125.0 399.0 L155.0 399.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M375.0 133.0 L225.0 133.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M285.0 343.0 L285.0 357.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M625.0 105.0 L625.0 161.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M385.0 133.0 L385.0 161.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M525.0 119.0 L525.0 161.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M25.0 105.0 L25.0 161.0 "></path>
    <text x="60" y="110" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      virtual memory
    </text>
    <text x="60" y="124" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      reserved memory
    </text>
    <text x="60" y="138" font-family="sans-serif" font-size="14" stroke="none" fill="#000000">
      committed memory
    </text>
    <text x="240" y="54" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      untouched/unused
    </text>
    <text x="240" y="68" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      page
    </text>
    <text x="476" y="292" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      ...
    </text>
    <text x="410" y="292" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      2000
    </text>
    <text x="410" y="320" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      6001
    </text>
    <text x="60" y="54" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      touched/used
    </text>
    <text x="60" y="68" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      page
    </text>
    <text x="562" y="305" font-family="sans-serif" font-size="10" stroke="none" fill="#000000">
      MMU
    </text>
    <text x="266" y="292" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      ...
    </text>
    <text x="266" y="320" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      ...
    </text>
    <text x="180" y="292" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      40
    </text>
    <text x="183" y="320" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      2 
    </text>
    <text x="103" y="292" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      2 
    </text>
    <text x="103" y="320" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      7 
    </text>
    <text x="350" y="292" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      1000
    </text>
    <text x="350" y="320" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      6000
    </text>
    <text x="603" y="502" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      Disk
    </text>
    <text x="33" y="292" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      0 
    </text>
    <text x="33" y="320" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      9 
    </text>
    <text x="451" y="474" font-family="sans-serif" font-size="13" stroke="none" fill="#000000">
      swap
    </text>
    <text x="136" y="292" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      ...
    </text>
    <text x="136" y="320" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      ...
    </text>
    <text x="210" y="501" font-family="sans-serif" font-size="12" stroke="none" fill="#000000">
      RAM
    </text>
    <text x="220" y="292" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      50
    </text>
    <text x="63" y="292" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      1 
    </text>
    <text x="60" y="320" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      50
    </text>
  </g>
</svg>
</div>
<div class="title">virtual memmory and paging (for a single process)</div>
</div>
<div class="paragraph">
<p>The graph above shows the addressable space of a process and its <em>pages</em>.
The process can access these pages using the addresses of its virtual space,
however these pages have to be stored physically, usually in RAM, sometime on disk.
When referring to these chunks of memory on hardware, we use the term <em>frame</em>.</p>
</div>
<div class="paragraph">
<p>The real memory address is naturally different from this virtual address space
for the process. In the CPU there’s a specialized component called MMU (Memory
Management Unit) whose role is to translate the virtual addresses
to physical addresses.</p>
</div>
<div class="paragraph">
<p>The incentive behind virtual memory and paging comes from multi-tasking, it allows
running multiple program concurrently. Each process will have the illusion of a single
big block of memory. In practice, it abstracts away useful tricks like
lazy allocation, swapping, file mapping, defragmentation, caching, etc.</p>
</div>
<div class="paragraph">
<p>The OS is hard at work performing these tricks while keeping this illusion for all
processes. Since programs run concurrently, <strong>not all memory pages is used at the
same time</strong>.</p>
</div>
<div class="paragraph">
<p>In practical terms we can observe that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <em>physical memory frame</em> won’t be used if the process didn’t <em>touch</em> a page, or
we can say this page doesn’t exist.</p>
</li>
<li>
<p>The kernel may choose to move the content of a page to a slower
device, usually a disk in a special place called <em>swap</em> if it thinks there
won’t be enough physical memory (RAM).</p>
</li>
<li>
<p>The kernel may use unemployed physical frames for caching purpose, or other tasks
like defragmentation.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <em>resident set size</em> mean the total set of pages of a process, i.e. without
untouched/unused pages.
This contrasts with virtual size which includes the total address space of
a program, this value is usually way superior to RSS.</p>
</div>
<div class="paragraph">
<p><em>If you want to dive how the whole paging thing works head to
system courses, or articles (like <a href="https://landley.net/writing/memory-faq.txt">this masterpiece</a>)
where they usually explain in depth how everything interacts.</em></p>
</div>
<div class="sect4">
<h5 id="_reserved_and_committed_memory_for_nmt"><a class="anchor" href="#_reserved_and_committed_memory_for_nmt"></a><a class="link" href="#_reserved_and_committed_memory_for_nmt">Reserved and committed memory for NMT</a></h5>
<div class="paragraph">
<p>As mentioned above, one of the idea of the <strong>reserved</strong> / <strong>committed</strong> memory is to
provide the illusion of a single <strong>continuous</strong> memory space.</p>
</div>
<div class="paragraph">
<p>Concretely for the JVM it means that</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>the <em>committed</em> memory is immediately usable,</p>
</li>
<li>
<p>and the <em>reserved</em> memory part means memory <em>put on hold</em> and not usable.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>With a better understanding of how memory works let’s look again at the output
of the <code>VM.native_memory</code> command to make more sense of it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Total: reserved=7168324KB, committed=5380868KB                               <i class="conum" data-value="1"></i><b>(1)</b>
-                 Java Heap (reserved=4456448KB, committed=4456448KB)        <i class="conum" data-value="2"></i><b>(2)</b>
                            (mmap: reserved=4456448KB, committed=4456448KB)
...
-                     Class (reserved=1195628KB, committed=165788KB)         <i class="conum" data-value="3"></i><b>(3)</b>
...
-                    Thread (reserved=696395KB, committed=85455KB)           <i class="conum" data-value="4"></i><b>(4)</b>
...
-                      Code (reserved=251877KB, committed=105201KB)
...
-                        GC (reserved=230739KB, committed=230739KB)          <i class="conum" data-value="5"></i><b>(5)</b>
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The process addressable memory and what is currently committed.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Here the NMT also show the same abstractions of committed and reserved memory,
on this process these values are the same because the <code>InitialHeapSize</code> (<code>Xms</code>) and
<code>MaxHeapSize</code> (<code>Xmx</code>)are the same. If these boundaries were different it is likely
the heap zone would show different values for reserved and committed memory; the
JVM will increase the committed memory if necessary, and can even uncommit some of
this memory if the GC algorithm allows it.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Class, Code spaces works the same way, specifics JVM flags control the reserved
and committed memory.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Java Threads are allocated within the process memory, the JVM flags only control
the size of a thread. I will expand on this later.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Then comes the other memory space of the JVM, like the GC internal structures, who
are using a different memory management, these zones usually have the same reserved/committed
amount.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Or with a picture :</p>
</div>
<div class="imageblock">
<div class="content">
<svg xmlns="http://www.w3.org/2000/svg" version="1.0" shape-rendering="geometricPrecision" preserveAspectRatio="xMidYMid meet" viewBox="0 0 770 266" width="770" height="266">
  <defs>
    <style type="text/css">
      @font-face { font-family: sans-serif; }
    </style>
    <filter id="shadowBlur" x="0" y="0" width="200%" height="200%">
      <feOffset in="SourceGraphic" dx="3.0003002" dy="3.0003002" result="offOut"></feOffset>
      <feGaussianBlur in="offOut" stdDeviation="3"></feGaussianBlur>
    </filter>
  </defs>
  <g stroke-width="1" stroke-linecap="square" stroke-linejoin="round">
    <rect x="0" y="0" width="770" height="266" style="fill: #ffffff"></rect>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M745.0 147.0 L745.0 175.0 L25.0 175.0 L25.0 147.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M745.0 147.0 L745.0 175.0 L25.0 175.0 L25.0 147.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M40.0 42.0 L30.0 49.0 L40.0 56.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M730.0 42.0 L740.0 49.0 L730.0 56.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M40.0 56.0 L30.0 63.0 L40.0 70.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M700.0 56.0 L710.0 63.0 L700.0 70.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M40.0 70.0 L30.0 77.0 L40.0 84.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M670.0 70.0 L680.0 77.0 L670.0 84.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M40.0 84.0 L30.0 91.0 L40.0 98.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M270.0 84.0 L280.0 91.0 L270.0 98.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M300.0 84.0 L290.0 91.0 L300.0 98.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M490.0 84.0 L500.0 91.0 L490.0 98.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M520.0 84.0 L510.0 91.0 L520.0 98.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M620.0 84.0 L630.0 91.0 L620.0 98.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M40.0 98.0 L30.0 105.0 L40.0 112.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M230.0 98.0 L240.0 105.0 L230.0 112.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M300.0 98.0 L290.0 105.0 L300.0 112.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M470.0 98.0 L480.0 105.0 L470.0 112.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M40.0 112.0 L30.0 119.0 L40.0 126.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M190.0 112.0 L200.0 119.0 L190.0 126.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M40.0 196.0 L30.0 203.0 L40.0 210.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M730.0 196.0 L740.0 203.0 L730.0 210.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M460.0 105.0 L475.0 105.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M735.0 49.0 L205.0 49.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M735.0 203.0 L265.0 203.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M215.0 63.0 L705.0 63.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M675.0 77.0 L225.0 77.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M195.0 91.0 L275.0 91.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M235.0 105.0 L205.0 105.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M495.0 91.0 L465.0 91.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M55.0 49.0 L35.0 49.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M35.0 63.0 L55.0 63.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M55.0 77.0 L35.0 77.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M55.0 91.0 L35.0 91.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M55.0 105.0 L35.0 105.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M55.0 119.0 L35.0 119.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M55.0 203.0 L35.0 203.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M535.0 91.0 L515.0 91.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M315.0 91.0 L295.0 91.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M315.0 105.0 L295.0 105.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M195.0 119.0 L155.0 119.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M625.0 91.0 L605.0 91.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M715.0 147.0 L715.0 63.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M25.0 175.0 L25.0 217.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M745.0 49.0 L745.0 147.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M635.0 91.0 L635.0 147.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M745.0 175.0 L745.0 217.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M505.0 91.0 L505.0 147.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M285.0 91.0 L285.0 147.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M205.0 119.0 L205.0 147.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M485.0 105.0 L485.0 147.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M25.0 49.0 L25.0 147.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M685.0 77.0 L685.0 147.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M245.0 147.0 L245.0 105.0 "></path>
    <text x="60" y="54" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      virtual memory
    </text>
    <text x="60" y="68" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      reserved memory
    </text>
    <text x="60" y="82" font-family="sans-serif" font-size="14" stroke="none" fill="#000000">
      committed memory
    </text>
    <text x="60" y="96" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      heap max size
    </text>
    <text x="60" y="110" font-family="sans-serif" font-size="15" stroke="none" fill="#ffffff">
      committed heap
    </text>
    <text x="60" y="124" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      used heap
    </text>
    <text x="63" y="166" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      addressable space of the process
    </text>
    <text x="330" y="96" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      Class reserved
    </text>
    <text x="325" y="110" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      Class commited
    </text>
    <text x="71" y="208" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      contiguous addresses
    </text>
    <text x="661" y="236" font-family="sans-serif" font-size="14" stroke="none" fill="#000000">
      0x8000000
    </text>
    <text x="544" y="96" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      others
    </text>
    <text x="23" y="236" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      0 
    </text>
  </g>
</svg>
</div>
<div class="title">JVM memory allocations</div>
</div>
<div class="paragraph">
<p>This immediately leads to new vocabulary :</p>
</div>
<table class="tableblock frame-all grid-all fit-content stretch">
<caption class="title">Table 2. Java memory vocabulary</caption>
<colgroup>
<col/>
<col/>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Used Heap</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The amount of memory occupied by live objects and to a certain
extent object that are unreachable but not yet collected by the GC. This only
relate to the JVM Java heap.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Committed heap</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The current limit if the writable memory to write objects to.
It’s the current workspace of the GC. Upon process start this value should be equal
to <code>Xms</code>, then the GC may expand it up to the Java heap reserved memory, or in Java
terms the heap max size, or <code>Xmx</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Heap Max Size</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum amount of memory that the Java heap can occupy.
It’s the <em>reserved</em> amount in Java Heap section of the NMT output.
If the application requires more memory, this will result in a <code>OutOfMemoryError</code>.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>So committed stands for writable memory and, reserved stands for total addressable
space of the memory. How does it work concretely?</p>
</div>
<div class="paragraph">
<p>The JVM starts by <a href="https://github.com/corretto/corretto-11/blob/3b31d243a19774bebde63df21cc84e994a89439a/src/src/hotspot/os/linux/os_linux.cpp#L3421-L3444"><em>reserving</em> the memory</a>,
then parts of this &#34;reserve&#34; will be made available by
<a href="https://github.com/corretto/corretto-11/blob/3b31d243a19774bebde63df21cc84e994a89439a/src/src/hotspot/os/linux/os_linux.cpp#L3517-L3531">modifying the memory mappings</a>
using <code>malloc</code>, <code>mmap</code>, as well as <code>mprotect</code> calls in particular (on Linux).</p>
</div>
</div>
<div class="sect4">
<h5 id="_malloc_and_mmap"><a class="anchor" href="#_malloc_and_mmap"></a><a class="link" href="#_malloc_and_mmap"><code>malloc</code> and <code>mmap</code></a></h5>
<div class="paragraph">
<p>The <code>malloc</code> and <code>mmap</code> C calls ask the OS to allocate memory. It’s the job of the OS to
provide the application the necessary memory, or fail if it is not possible.</p>
</div>
<div class="paragraph">
<p>Also, depending on the mapping in particular for <code>mmap</code> the OS can be asked to make a file
accessible as a memory zone, in short it’s the kernel that perform IOs, in contrast to perform
IOs with a file descriptor application side.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/assets/off-heap-recon/malloc-mmap.svg" alt="malloc mmap" title="Simple overview of malloc and mmap"/></span></p>
</div>
<details>
<summary class="title">Differences between <a href="https://linux.die.net/man/3/malloc"><code>malloc</code></a> and <a href="http://www.kernel.org/doc/man-pages/online/pages/man2/mmap.2.html"><code>mmap</code></a></summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>malloc</code> may <em>recycle</em> previously used memory that was released by <code>free</code>,
and perform a system call to get memory only required. It’s part of the C standard.</p>
</li>
<li>
<p><code>malloc</code> allows you pass a size and that’s basically it.</p>
</li>
<li>
<p><code>mmap</code> is a system call. It’s not part of the C standard, and may not be available
on all platforms.</p>
</li>
<li>
<p><code>mmap</code> can both map private memory or shared memory (as in shared with other processes).
Those are called <em>anonymous mapping</em> using flag <code>MAP_ANONYMOUS</code>.</p>
</li>
<li>
<p><code>mmap</code> can also interact with disk files on specific ranges, without having
a file descriptor.</p>
</li>
<li>
<p><code>mmap</code> can be set with various flags that are used to control how this memory
mapping behave.</p>
</li>
<li>
<p>Both have their performance characteristics, <code>malloc</code> is usually preferred for
few and small allocations, <code>mmap</code> is preferred for few but large allocations.</p>
</li>
</ul>
</div>
</div>
</details>
<div class="paragraph">
<p>When the JVM bootstrap, it requests a main memory of a certain size with the <code>PROT_NONE</code>
flag to prevent any access. This has the effect to tell the OS that this mapping should
not be backed by physical memory. Then when memory is needed by the program,
the JVM changes the mapping for a sub-range of that main memory by removing the
<code>PROT_NONE</code> flag. When new java threads are created, then the JVM will simply
request another memory segment.</p>
</div>
<details>
<summary class="title">Simple C code example</summary>
<div class="content">
<div class="paragraph">
<p>To help you understand here’s a very simple program:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>that <strong>reserves</strong> <code>16 MiB</code> via a <code>malloc</code> call and <code>16 MiB</code> via the <code>mmap</code> call</p>
</li>
<li>
<p>then this program will invoke <code>ps</code> to show its actual memory consumption (RSS)</p>
</li>
<li>
<p>then it will touch/use memory by setting a bit every <code>1 KiB</code></p>
</li>
<li>
<p>then this program will invoke <code>ps</code> again to show its actual memory consumption (RSS)</p>
</li>
</ol>
</div>
<div class="listingblock primary">
<div class="title">memory example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;sys/mman.h&gt;

#define HEAP_SIZE (16 * 1024 * 1024 * sizeof(char))

int main (int argc, char *argv[])
{
  char *heap1 = malloc(HEAP_SIZE);
  char *heap2 = mmap(0,
                     HEAP_SIZE,
                     PROT_NONE | PROT_WRITE,
                     MAP_PRIVATE | MAP_NORESERVE | MAP_ANONYMOUS,
                     -1,
                     0);

  pid_t pid = getpid();
  printf(&#34;pid: %d\n&#34;, pid);

  char buffer[50];

  sprintf(buffer, &#34;ps -p %d -o rss,vsz,command&#34;, pid);
  printf(&#34;Executing: &#39;%s&#39;\n&#34;, buffer);
  system(buffer);

  printf(&#34;Writing to some pages, but not all\n&#34;);

  for (char* i = heap1; i &lt; (heap1 + HEAP_SIZE / 16); i += 1024) {
    *i = 0x01;
  }
  for (char* i = heap2; i &lt; (heap2 + HEAP_SIZE / 8); i += 1024) {
    *i = 0x01;
  }

  sprintf(buffer, &#34;ps -p %d -o rss,vsz,command&#34;, pid);
  printf(&#34;Executing: &#39;%s&#39;\n&#34;, buffer);
  system(buffer);

  free(heap1);
  munmap(heap2, HEAP_SIZE);

  return 0;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">result (Linux / llvm)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ clang -Wall -Wpedantic -o test-alloc test-alloc.c &amp;&amp; ./test-alloc
pid: 4301956

Executing: &#39;ps -p 2904 -o rss,vsz,command&#39;
   RSS      VSZ COMMAND
   708  4301956 ./test-mem
Writing to some pages, but not all
Executing: &#39;ps -p 2904 -o rss,vsz,command&#39;
   RSS      VSZ COMMAND
  3780  4301956 ./test-mem</code></pre>
</div>
</div>
<div class="paragraph">
<p>As the <code>stdout</code> shows the RSS of this program is very low until memory
is actually written to. At the same time the virtual memory is much,
much higher; it means this simple program could address up to
about <code>4 GiB</code>.</p>
</div>
<div class="paragraph">
<p><em>This program ran on a MacBook Pro 2018 running an Intel Core i7 CPU.</em></p>
</div>
</div>
</details>
<div class="paragraph">
<p>Now after some memory management refresh, let’s go back to the main topic of this blog post.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exploring_what_nmt_does_not_show"><a class="anchor" href="#_exploring_what_nmt_does_not_show"></a><a class="link" href="#_exploring_what_nmt_does_not_show">Exploring what NMT does not show</a></h4>
<div class="paragraph">
<p>The previous section showed that NMT numbers only represents the sizes
of the different JVM memory zones, but, does not reflect the real usage.</p>
</div>
<div class="paragraph">
<p>The JVM components reported by NMT can use different <em>types of memory management</em> and
as such may have multiple allocation mechanisms. For example:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>GC based
The <code>Java heap</code> and the <code>Metaspace</code> (<code>Class</code>) are usually the biggest consumers of memory,
they both rely on <code>mmap</code>.</p>
<div class="listingblock">
<div class="title">java heap and metaspace</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">-                 Java Heap (reserved=3145728KB, committed=3145728KB)
                            (mmap: reserved=3145728KB, committed=3145728KB)

-                     Class (reserved=1195111KB, committed=164967KB)
                            (classes #27354)
                            (  instance classes #25689, array classes #1665)
                            (malloc=5223KB #86596)
                            (mmap: reserved=1189888KB, committed=159744KB)</code></pre>
</div>
</div>
<div class="paragraph">
<p>These two <em>memory zones</em> are interesting in that they are managed by the GC algorithm,
put in other words the GC is actually the memory manager of these zones, it is able to
<em>arrange</em> the memory according to the options that are passed on the command line.
E.g. with a fixed size heap (<code>Xms</code> = <code>Xmx</code>), the heap will be constituted of a large memory
segment, in this case the <em>reserved</em> and <em>committed</em> values will be the same as well.</p>
</div>
<div class="paragraph">
<p>Other options may trigger specific behavior for these memory zones, e.g. make
the heap to grow or to shrink (I never saw that in practice,
maybe I’ll see it once I use a JDK 12+ with <em>heap uncommit</em> with <a href="https://openjdk.java.net/jeps/346">JEP-346</a>,
although even the JEP mention it’ll only happen if there is very low activity, which is unlikely to
happen for some workload).</p>
</div>
</li>
<li>
<p>Threads
The Java threads are constructs controlled by the JVM runtime,
each thread is allocated on addressable space, their allocation size is always the
same, but can be controlled via a few JVM parameters. Their usage depends on
application usage. Eg. if the program request 1000 threads, then the JVM needs
to allocate 1000 threads.</p>
<div class="listingblock">
<div class="title">thread</div>
<div class="content">
<pre>-                    Thread (reserved=533903KB, committed=70439KB)
                            (thread #517)
                            (stack: reserved=531432KB, committed=67968KB) <i class="conum" data-value="1"></i><b>(1)</b>
                            (malloc=1866KB #3103) <i class="conum" data-value="2"></i><b>(2)</b>
                            (arena=605KB #1033) <i class="conum" data-value="3"></i><b>(3)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The stack memory is where the JVM puts the thread stack, it’s the sum
of all thread stack memory mappings.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The thread sub-system performed 3103 <code>malloc</code> calls amounting to <code>1866 KiB</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The thread local handles required 1033 arenas, amounting to <code>605 KiB</code>.</td>
</tr>
</tbody></table>
</div>
</li>
<li>
<p>Other native zones
The other component reported by NMT management uses different technics. Sometime using a
combination of these technics:</p>
<div class="paragraph">
<p><code>GC</code> zone for example only works with <code>malloc</code> and <code>mmap</code>, and size can grow as needed.</p>
</div>
<div class="listingblock">
<div class="title">gc</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">-                        GC (reserved=180505KB, committed=180505KB)
                            (malloc=30589KB #219593) <i class="conum" data-value="1"></i><b>(1)</b>
                            (mmap: reserved=149916KB, committed=149916KB) <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Here the GC performed 219593 <code>malloc</code> calls amounting to <code>30589 KiB</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Here the GC reserved and committed memory segment(s) amount to <code>149916 KiB</code>.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The JVM also implements its own
<a href="https://en.wikipedia.org/wiki/Region-based_memory_management">Arena based memory management</a>,
(distinct from the arena memory management of glibc). It is used by some
subsystems of the JVM or when native code uses internal objects that rely on JVM arenas
<a href="https://github.com/corretto/corretto-11/blob/885a3859f47627467a15adaef36fd90ceb517f5e/src/src/hotspot/share/utilities/bitMap.hpp#L344-L345">[1]</a>
<a href="https://github.com/corretto/corretto-11/blob/7ea9366e39d0650274e45ce966b36bb01d26ff26/src/src/hotspot/share/utilities/growableArray.hpp#L127">[2]</a></p>
</div>
<div class="paragraph">
<p><code>Compiler</code>, <code>Symbol table</code> do use this memory management for example.
Special mention of the <em>thread local handles</em> that also use JVM arenas.</p>
</div>
<div class="paragraph">
<p>NMT reports all the memory allocation technics that are used by a JVM component,
for example the GC system :</p>
</div>
<div class="listingblock">
<div class="title">compiler</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">-                  Compiler (reserved=6666KB, committed=6666KB)
                            (malloc=6533KB #3575) <i class="conum" data-value="1"></i><b>(1)</b>
                            (arena=133KB #5) <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The compiler performed 3575 <code>malloc</code> calls amounting to <code>6533 KiB</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The compiler uses 5 arenas totaling <code>133 KiB</code>.</td>
</tr>
</tbody></table>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_track_directbytebuffer_with_nmt"><a class="anchor" href="#_track_directbytebuffer_with_nmt"></a><a class="link" href="#_track_directbytebuffer_with_nmt">Track <code>DirectByteBuffer</code> with NMT</a></h4>
<div class="paragraph">
<p>Using NMT <code>baseline</code> and <code>summary.diff</code> modes, it is possible to
track the evolution of the JVM components. <code>DirectByteBuffer</code>s
allow allocating native memory segments. They are not cheap to create,
and they are only deallocated when a GC actually finalize the
references. Usually these byte buffers have a long life and
they are big.</p>
</div>
<div class="paragraph">
<p>The following snippet of code will try to show they are reported in the
<code>Other</code> section of NMT. Note that in this snippet I’m just invoking
the external process <code>jcmd</code> for brevity and clarity, but it’s possible
to invoke the diagnostic command in pure Java.</p>
</div>
<div class="listingblock">
<div class="title">Exercise <code>DirectByteBuffer</code> and NMT</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// env -u JDK_JAVA_OPTIONS java -XX:NativeMemoryTracking=summary DBB.java 1 1
import java.nio.*;
import java.lang.ProcessBuilder.*;

public class DBB {
  public static void main(String[] args) throws Exception {
    System.out.printf(&#34;nmt baseline: %n&#34;);
    new ProcessBuilder(&#34;jcmd&#34;, Long.toString(ProcessHandle.current().pid()), &#34;VM.native_memory&#34;, &#34;baseline&#34;)
            .redirectOutput(Redirect.INHERIT)
            .redirectError(Redirect.INHERIT)
            .start()
            .waitFor();

    var bbCount = Integer.parseInt(args[0]);
    var bbSizeMiB = Integer.parseInt(args[1]);
    for (var i = 0; i &lt; bbCount; i++) {
        var byteBuffer = ByteBuffer.allocateDirect(bbSizeMiB * 1024 * 1024)
                .putInt(0, 0x01);
    }

    System.out.printf(&#34;nmt summary.diff: %n&#34;);
    new ProcessBuilder(&#34;jcmd&#34;, Long.toString(ProcessHandle.current().pid()), &#34;VM.native_memory&#34;, &#34;summary.diff&#34;)
            .redirectOutput(Redirect.INHERIT)
            .redirectError(Redirect.INHERIT)
            .start()
            .waitFor();
  }
}</code></pre>
</div>
</div>
<div class="listingblock primary">
<div class="title">1 x 1MiB</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ env -u JDK_JAVA_OPTIONS java -XX:NativeMemoryTracking=summary DBB.java 1 1
nmt baseline:
779:
Baseline succeeded
nmt summary.diff:
779:

Native Memory Tracking:

Total: reserved=1916470KB +1027KB, committed=113950KB +1031KB

-                 Java Heap (reserved=509952KB, committed=32768KB)
                            (mmap: reserved=509952KB, committed=32768KB)

...

-                     Other (reserved=1034KB +1024KB, committed=1034KB +1024KB) <i class="conum" data-value="1"></i><b>(1)</b>
                            (malloc=1034KB +1024KB #3 +1) <i class="conum" data-value="2"></i><b>(2)</b>

...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>DirectByteBuffer</code> of <code>1 MiB</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>DirectByteBuffer</code>s use <code>malloc</code> underneath.</td>
</tr>
</tbody></table>
</div>
<div class="listingblock secondary">
<div class="title">10 x 1MiB</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ env -u JDK_JAVA_OPTIONS java -XX:NativeMemoryTracking=summary DBB.java 10 1
nmt baseline:
839:
Baseline succeeded
nmt summary.diff:
839:

Native Memory Tracking:

Total: reserved=1933553KB +10243KB, committed=132061KB +10247KB

-                 Java Heap (reserved=509952KB, committed=32768KB)
                            (mmap: reserved=509952KB, committed=32768KB)

...

-                     Other (reserved=10250KB +10240KB, committed=10250KB +10240KB) <i class="conum" data-value="1"></i><b>(1)</b>
                            (malloc=10250KB +10240KB #12 +10) <i class="conum" data-value="2"></i><b>(2)</b>

...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The 10 <code>DirectByteBuffer</code>s of <code>1 MiB</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>DirectByteBuffer</code>s use <code>malloc</code> underneath.</td>
</tr>
</tbody></table>
</div>
<div class="listingblock secondary">
<div class="title">20 x 100MiB</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ env -u JDK_JAVA_OPTIONS java -XX:NativeMemoryTracking=summary DBB.java 20 100
nmt baseline:
898:
Baseline succeeded
nmt summary.diff:
898:

Native Memory Tracking:

Total: reserved=2331899KB +408590KB, committed=512275KB +390462KB

Total: reserved=2323817KB +409608KB, committed=498961KB +386252KB

-                 Java Heap (reserved=509952KB, committed=10240KB -22528KB) <i class="conum" data-value="3"></i><b>(3)</b>
                            (mmap: reserved=509952KB, committed=10240KB -22528KB)

...

-                     Other (reserved=409610KB +409600KB, committed=409610KB +409600KB) <i class="conum" data-value="1"></i><b>(1)</b>
                            (malloc=409610KB +409600KB #6 +4) <i class="conum" data-value="2"></i><b>(2)</b>

...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The 20 <code>DirectByteBuffer</code>s of <code>100 iB</code>. Uh wait, <code>409600 KiB</code> is nothing near ~<code>2 GiB</code> (<code>2048000 KiB</code>),
it looks more like 4 buffers of <code>100 MiB</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>DirectByteBuffer</code>s use <code>malloc</code> underneath.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This times there is also a reduction in the Java Heap.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>As one can see the total reserved and commited memory are actually increased
by the amount of allocated memory.</p>
</div>
<div class="paragraph">
<p>The last exercise, <code>20 x 100 MiB</code>, is more captivating: the low amount of
allocated memory by <code>DirectByteBuffer</code>s is simply explained by the GC
that kicked in, if run the last command with <code>-Xlog:gc*</code> you’ll notice 4 Full GC
happenening in the middle of the loop.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[1.671s][info][gc,start       ] GC(4) Pause Full (System.gc())</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since this loop don’t keep the <em>wrapping</em>
buffers references the direct memory get collected at this time. It’s not part of
this article but it’s well worth to understand to know how <code>DirectByteBuffer</code>s
handle their garbage collection (using a <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/ref/Cleaner.html"><code>Cleaner</code></a>).</p>
</div>
<div class="paragraph">
<p>Now I mentionned that there was 4 Full GCs, that should have raised eyebrows.
If it didn’t the full GC cause should provoke the attention, <code>System.gc()</code>.
Pretending I don’t know where this came from I’ll search where these are happening</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ env -u JDK_JAVA_OPTIONS java -XX:NativeMemoryTracking=summary \
  -agentpath:async-profiler-1.8.2-linux-x64/build/libasyncProfiler.so=start,event=java.lang.System.gc,traces,file=traces.txt \
  DBB.java 20 100 &gt; /dev/null 2&gt;&amp;1

$ cat traces.txt
--- Execution profile ---
Total samples       : 4

Frame buffer usage  : 0.0012%

--- 4 calls (100.00%), 4 samples
  [ 0] java.lang.System.gc
  [ 1] java.nio.Bits.reserveMemory
  [ 2] java.nio.DirectByteBuffer.&lt;init&gt;
  [ 3] java.nio.ByteBuffer.allocateDirect
  [ 4] DBB.main
  [ 5] jdk.internal.reflect.NativeMethodAccessorImpl.invoke0
  [ 6] jdk.internal.reflect.NativeMethodAccessorImpl.invoke
  [ 7] jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke
  [ 8] java.lang.reflect.Method.invoke
  [ 9] com.sun.tools.javac.launcher.Main.execute
  [10] com.sun.tools.javac.launcher.Main.run
  [11] com.sun.tools.javac.launcher.Main.main</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default the VM limits the total size or capacity of direct byte buffers to
to <a href="https://github.com/AdoptOpenJDK/openjdk-jdk11u/blob/master/src/java.base/share/classes/jdk/internal/misc/VM.java#L114-L122">somewhat the size of the heap</a>.
This can be tuned via <code>-XX:MaxDirectMemorySize</code>. The 4 Full GC cycles indicates
for 20 allocateDirect() and 4 remaining, this means after 4 successful create the 5th allocateDirect
will require a System.gc(), this suggest a max memory limit in this range <code>[419430400;524288000[</code>,
and indeed the reported size of Java Heap section is <code>522190848</code> (<code>509952 KiB</code>).</p>
</div>
</div>
<div class="sect3">
<h4 id="_track_memory_mapped_file_with_nmt"><a class="anchor" href="#_track_memory_mapped_file_with_nmt"></a><a class="link" href="#_track_memory_mapped_file_with_nmt">Track memory mapped file with NMT</a></h4>
<div class="paragraph">
<p>Using NMT <code>baseline</code> and <code>summary.diff</code> modes, is it possible to
track the memory mapped file usage? Let’s try out.</p>
</div>
<div class="listingblock">
<div class="title">Exercise <code>MappedByteBuffer</code> and NMT</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package sandbox;

import java.nio.channels.FileChannel;
import java.nio.file.*;

public class MappedFiles {
  public static void main(String[] args) throws Exception {
    System.out.printf(&#34;nmt baseline: %n&#34;);
    new ProcessBuilder(&#34;jcmd&#34;, Long.toString(ProcessHandle.current().pid()), &#34;VM.native_memory&#34;, &#34;baseline&#34;)
        .start()
        .waitFor();

    Path src = Paths.get(&#34;/usr/lib/jvm/java-11-amazon-corretto/lib/src.zip&#34;); <i class="conum" data-value="1"></i><b>(1)</b>
    try (var fileChannel = (FileChannel) Files.newByteChannel(src, StandardOpenOption.READ)) {
      var mappedByteBuffer = fileChannel.map(
          FileChannel.MapMode.READ_ONLY,
          0, <i class="conum" data-value="2"></i><b>(2)</b>
          fileChannel.size()); <i class="conum" data-value="2"></i><b>(2)</b>
      mappedByteBuffer.load(); <i class="conum" data-value="3"></i><b>(3)</b>

      System.out.printf(&#34;nmt summary.diff: %n&#34;);
      new ProcessBuilder(&#34;jcmd&#34;, Long.toString(ProcessHandle.current().pid()), &#34;VM.native_memory&#34;, &#34;summary.diff&#34;)
          .redirectOutput(ProcessBuilder.Redirect.INHERIT)
          .redirectError(ProcessBuilder.Redirect.INHERIT)
          .start()
          .waitFor();
    }
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Opens a binary file about <code>50 MiB</code> in size.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Range of the memory mapping starts at <code>0</code>, up to the total file size.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>load</code> method will actually instruct the OS to load the range defined above
in resident memory.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Let’s look at what NMT reports.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ env -u JDK_JAVA_OPTIONS java -XX:NativeMemoryTracking=summary MappedFiles.java
nmt baseline:
nmt summary.diff:
1760:

Native Memory Tracking:

Total: reserved=1929764KB -1028KB, committed=127588KB -44KB

-                 Java Heap (reserved=509952KB, committed=32768KB)
                            (mmap: reserved=509952KB, committed=32768KB)

-                     Class (reserved=1065377KB +1KB, committed=16929KB +1KB)
                            (classes #2650 +17)
                            (  instance classes #2378 +15, array classes #272 +2)
                            (malloc=417KB +1KB #5031 +35)
                            (mmap: reserved=1064960KB, committed=16512KB)
                            (  Metadata:   )
                            (    reserved=16384KB, committed=14592KB)
                            (    used=14167KB +34KB)
                            (    free=425KB -34KB)
                            (    waste=0KB =0.00%)
                            (  Class space:)
                            (    reserved=1048576KB, committed=1920KB)
                            (    used=1720KB +9KB)
                            (    free=200KB -9KB)
                            (    waste=0KB =0.00%)

-                    Thread (reserved=19723KB -1032KB, committed=1027KB -48KB)
                            (thread #20 -1)
                            (stack: reserved=19632KB -1028KB, committed=936KB -44KB)
                            (malloc=69KB -4KB #122 -6)
                            (arena=22KB #38 -1)

-                      Code (reserved=247935KB +1KB, committed=7795KB +1KB)
                            (malloc=247KB +1KB #1692 +9)
                            (mmap: reserved=247688KB, committed=7548KB)

-                        GC (reserved=60330KB, committed=42622KB)
                            (malloc=8570KB #1516 +1)
                            (mmap: reserved=51760KB, committed=34052KB)

-                  Compiler (reserved=154KB -1KB, committed=154KB -1KB)
                            (malloc=21KB #138 -6)
                            (arena=133KB -1 #5 -1)

-                  Internal (reserved=579KB, committed=579KB)
                            (malloc=547KB #1040 -1)
                            (mmap: reserved=32KB, committed=32KB)

-                     Other (reserved=10KB, committed=10KB)
                            (malloc=10KB #2)

-                    Symbol (reserved=4386KB, committed=4386KB)
                            (malloc=3163KB #28643 +18)
                            (arena=1223KB #1)

-    Native Memory Tracking (reserved=650KB +2KB, committed=650KB +2KB)
                            (malloc=7KB +1KB #94 +18)
                            (tracking overhead=643KB +1KB)

-               Arena Chunk (reserved=20529KB +1KB, committed=20529KB +1KB)
                            (malloc=20529KB +1KB)

-                   Logging (reserved=4KB, committed=4KB)
                            (malloc=4KB #191)

-                 Arguments (reserved=18KB, committed=18KB)
                            (malloc=18KB #492)

-                    Module (reserved=60KB, committed=60KB)
                            (malloc=60KB #1041)

-              Synchronizer (reserved=48KB, committed=48KB)
                            (malloc=48KB #404 -2)

-                 Safepoint (reserved=8KB, committed=8KB)
                            (mmap: reserved=8KB, committed=8KB)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nothing. We’ll see in a later section how to see how much these files
can account in the resident memory.</p>
</div>
<div class="paragraph">
<p>As a side note before switching to OS tooling, the memory segment
used for the memory mapping is not freed until the next GC cycle.</p>
</div>
</div>
<div class="sect3">
<h4 id="_inspecting_memory_mappings"><a class="anchor" href="#_inspecting_memory_mappings"></a><a class="link" href="#_inspecting_memory_mappings">Inspecting memory mappings</a></h4>
<div class="paragraph">
<p>It’s easy to get the RSS of a process, to understand if the committed
heap actually <em>resides</em> on physical memory you need to use <code>pmap</code> or inspect
<code>/proc/{pid}/maps</code> or <code>/proc/{pid}/smaps</code>.</p>
</div>
<div class="paragraph">
<p>The <code>pmap</code> binary is part of the <a href="https://gitlab.com/procps-ng/procps/"><code>procps</code></a> utilities, that
contains other tools like: <code>ps</code>, <code>pgrep</code>, <code>watch</code> or <code>vmstat</code>. It’s likely that no additional
installation is required which is great as a container filesystem should be read-only
for security reasons, if it isn’t there, one could still look at the proc filesystem.</p>
</div>
<div class="paragraph">
<p>You have to notice one of the first memory zones is quite big and about
the size of the committed heap as shown in NMT.</p>
</div>
<div class="paragraph">
<p>To select the file mappings we can filter on the
<a href="https://www.kernel.org/doc/Documentation/filesystems/proc.txt">access permissions</a>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>r-</code>: readable memory mapping</p>
</li>
<li>
<p><code>w</code>: writable memory mapping</p>
</li>
<li>
<p><code>x</code>: executable memory mapping</p>
</li>
<li>
<p><code>s</code> or <code>p</code> : shared memory mapping or private mapping. <code>/proc/&lt;pid&gt;/maps</code></p>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><code>pmap</code> may show another mapping mode which I barely found any
reference of, here’s <a href="https://johanlouwers.blogspot.com/2017/07/oracle-linux-understanding-linux.html">one</a>
and <a href="https://linux.die.net/man/2/mmap">here</a></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>R</code>: if set, the map has no swap space reserved (<code>MAP_NORESERVE</code> flag of <code>mmap</code>).
This means that we can get a segmentation fault by accessing that memory if it has not
already been mapped to physical memory, and if the system is out of physical memory.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>There’s also the value of the inode column, if it&#39; i’s greater than <code>0</code> then
it means the address range is backed by a file, if it’s <code>0</code> it’s a memory
allocation that the application has requested.</p>
</div>
<div class="paragraph">
<div class="title">Identifying JVM memory components</div>
<p>There are three kinds of memory segments we can easily guess in the memory
mapping reported by <code>pmap</code> because we know their size, it’s the Java heap,
and the threads.</p>
</div>
<div class="paragraph">
<p>Other type of allocations can be identified but that’s for another post,
the remaining address range are too difficult to guess for two reasons,
they usually have unpredictable allocation behavior, and it
also depends on the <code>malloc</code> implementation details, (like the arenas in Glibc),
and the number of different <code>malloc</code> calls for a single component.</p>
</div>
<div class="paragraph">
<p>On a pod running por let’s have a quick look on the very first mappings. It’s easier
to spot with <code>pmap -X</code> (capital <code>X</code>).</p>
</div>
<div class="listingblock primary">
<div class="title"><code>pmap -x {pid}</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ pmap -x 7 | head -n 20
7:   /usr/bin/java -Dfile.encoding=UTF-8 -Duser.timezone=UTC -Djava.security.egd=file:/dev/./urandom -Djava.awt.headless=true -XX:NativeMemoryTracking=summary -jar /app/boot.jar
Address           Kbytes     RSS   Dirty Mode  Mapping
0000000740000000 3163648 3163648 3163648 rw---   [ anon ] <i class="conum" data-value="1"></i><b>(1)</b>
0000000801180000 1030656       0       0 -----   [ anon ]
000055bac4461000       4       4       0 r-x-- java
000055bac4662000       4       4       4 r---- java
000055bac4663000       4       4       4 rw--- java
000055bac569c000  455704  438268  438268 rw---   [ anon ] <i class="conum" data-value="2"></i><b>(2)</b>
00007ff9b91e7000      16       0       0 -----   [ anon ]
00007ff9b91eb000    1012      24      24 rw---   [ anon ]
00007ff9b92e8000      16       0       0 -----   [ anon ] <i class="conum" data-value="3"></i><b>(3)</b>
00007ff9b92ec000    1012      92      92 rw---   [ anon ] <i class="conum" data-value="4"></i><b>(4)</b>
00007ff9b93e9000      16       0       0 -----   [ anon ]
00007ff9b93ed000    1012      88      88 rw---   [ anon ]
00007ff9b94ea000      16       0       0 -----   [ anon ]
00007ff9b94ee000    1012      24      24 rw---   [ anon ]
00007ff9b95eb000      16       0       0 -----   [ anon ]
00007ff9b95ef000    1012      28      28 rw---   [ anon ]
00007ff9b96ec000      16       0       0 -----   [ anon ]
00007ff9b96f0000    1012      24      24 rw---   [ anon ]</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>native heap memory heap</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>java heap</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>a thread guard pages</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>a thread stack</td>
</tr>
</tbody></table>
</div>
<div class="listingblock secondary">
<div class="title"><code>pmap -X {pid}</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ pmap -X 7 | head -n 20
7:   /usr/bin/java -Dfile.encoding=UTF-8 -Duser.timezone=UTC -Djava.security.egd=file:/dev/./urandom -Djava.awt.headless=true -XX:NativeMemoryTracking=summary -javaagent:/newrelic-agent.jar -javaagent:/dd-java-agent.jar -jar /edge-api-boot.jar --spring.config.additional-location=/etc/edge-api/config.yaml --server.port=8080
         Address Perm   Offset Device   Inode    Size     Rss     Pss Referenced Anonymous LazyFree ShmemPmdMapped Shared_Hugetlb Private_Hugetlb Swap SwapPss Locked THPeligible Mapping
       740000000 rw-p 00000000  00:00       0 3163648 3163648 3163648    3163648   3163648        0              0              0               0    0       0      0           0 <i class="conum" data-value="1"></i><b>(1)</b>
       801180000 ---p 00000000  00:00       0 1030656       0       0          0         0        0              0              0               0    0       0      0           0
    55bac4461000 r-xp 00000000  08:01 5623642       4       4       4          4         0        0              0              0               0    0       0      0           0 java
    55bac4662000 r--p 00001000  08:01 5623642       4       4       4          4         4        0              0              0               0    0       0      0           0 java
    55bac4663000 rw-p 00002000  08:01 5623642       4       4       4          4         4        0              0              0               0    0       0      0           0 java
    55bac569c000 rw-p 00000000  00:00       0  455704  438268  438268     438268    438268        0              0              0               0    0       0      0           0 [heap] <i class="conum" data-value="2"></i><b>(2)</b>
    7ff9b91e7000 ---p 00000000  00:00       0      16       0       0          0         0        0              0              0               0    0       0      0           0
    7ff9b91eb000 rw-p 00000000  00:00       0    1012      28      28         28        28        0              0              0               0    0       0      0           0
    7ff9b92e8000 ---p 00000000  00:00       0      16       0       0          0         0        0              0              0               0    0       0      0           0 <i class="conum" data-value="3"></i><b>(3)</b>
    7ff9b92ec000 rw-p 00000000  00:00       0    1012      92      92         92        92        0              0              0               0    0       0      0           0 <i class="conum" data-value="4"></i><b>(4)</b>
    7ff9b93e9000 ---p 00000000  00:00       0      16       0       0          0         0        0              0              0               0    0       0      0           0
    7ff9b93ed000 rw-p 00000000  00:00       0    1012      88      88         88        88        0              0              0               0    0       0      0           0
    7ff9b94ea000 ---p 00000000  00:00       0      16       0       0          0         0        0              0              0               0    0       0      0           0
    7ff9b94ee000 rw-p 00000000  00:00       0    1012      24      24         24        24        0              0              0               0    0       0      0           0
    7ff9b95eb000 ---p 00000000  00:00       0      16       0       0          0         0        0              0              0               0    0       0      0           0
    7ff9b95ef000 rw-p 00000000  00:00       0    1012      28      28         28        28        0              0              0               0    0       0      0           0
    7ff9b96ec000 ---p 00000000  00:00       0      16       0       0          0         0        0              0              0               0    0       0      0           0
    7ff9b96f0000 rw-p 00000000  00:00       0    1012      24      24         24        24        0              0              0               0    0       0      0           0</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>native heap memory heap</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>java heap</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>a thread guard pages</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>a thread stack</td>
</tr>
</tbody></table>
</div>
<div class="listingblock secondary">
<div class="title"><code>/proc/{pid}/maps</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ cat /proc/7/maps | head -n 20
740000000-801180000 rw-p 00000000 00:00 0 <i class="conum" data-value="1"></i><b>(1)</b>
801180000-840000000 ---p 00000000 00:00 0
55bac4461000-55bac4462000 r-xp 00000000 08:01 5623642                    /usr/lib/jvm/java-11-amazon-corretto/bin/java
55bac4662000-55bac4663000 r--p 00001000 08:01 5623642                    /usr/lib/jvm/java-11-amazon-corretto/bin/java
55bac4663000-55bac4664000 rw-p 00002000 08:01 5623642                    /usr/lib/jvm/java-11-amazon-corretto/bin/java
55bac569c000-55bae13a2000 rw-p 00000000 00:00 0                          [heap] <i class="conum" data-value="2"></i><b>(2)</b>
7ff9b91e7000-7ff9b91eb000 ---p 00000000 00:00 0
7ff9b91eb000-7ff9b92e8000 rw-p 00000000 00:00 0
7ff9b92e8000-7ff9b92ec000 ---p 00000000 00:00 0 <i class="conum" data-value="3"></i><b>(3)</b>
7ff9b92ec000-7ff9b93e9000 rw-p 00000000 00:00 0 <i class="conum" data-value="4"></i><b>(4)</b>
7ff9b93e9000-7ff9b93ed000 ---p 00000000 00:00 0
7ff9b93ed000-7ff9b94ea000 rw-p 00000000 00:00 0
7ff9b94ea000-7ff9b94ee000 ---p 00000000 00:00 0
7ff9b94ee000-7ff9b95eb000 rw-p 00000000 00:00 0
7ff9b95eb000-7ff9b95ef000 ---p 00000000 00:00 0
7ff9b95ef000-7ff9b96ec000 rw-p 00000000 00:00 0
7ff9b96ec000-7ff9b96f0000 ---p 00000000 00:00 0
7ff9b96f0000-7ff9b97ed000 rw-p 00000000 00:00 0
7ff9b97ed000-7ff9b97f1000 ---p 00000000 00:00 0
7ff9b97f1000-7ff9b99ee000 rw-p 00000000 00:00 0</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>native heap memory heap</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>java heap</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>a thread guard pages</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>a thread stack</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The first thing to natice is that <code>pmap</code> choses to display the start address,
and the size of the mapping in another column, while the <code>maps</code> <em>file</em> is using
address ranges. As you might have guessed, the sum of the size of these mapping
is the value one can see in the <code>vsz</code> column of <code>ps</code>.</p>
</div>
<div class="olist arabic">
<div class="title">Explanation</div>
<ol class="arabic">
<li>
<p><code>740000000-801180000</code> (<code>3163648 KiB</code>), around <code>3 GiB</code> in a simple mapping,
this looks like the size of the heap, subtracting the addressed gives this number
<code>3 239 575 552</code>, which very close to the VM actual flag for the heap
<code>-XX:MaxHeapSize=3221225472</code>, the JVM must map additional space. We also note that
the RSS on this mapping is equal to the size, this means that either this flag
<code>-XX:+AlwaysPreTouch</code> is active, or that all pages in the heap have been touched once,
for this app this is the former case.</p>
<div class="paragraph">
<p>This single address range, also indicates that the minimum and the maximum value of
the heap is the same <code>Xmx</code> = <code>Xms</code>. If they weren’t we would have seen two adjacent
segment with different permissions (<code>rw-p</code> then <code>---p</code>), the JVM can grow
the read-and-write segment of the Java Heap.</p>
</div>
<div class="paragraph">
<p>Just under this mapping there’s another one <code>801180000-840000000</code> (<code>1030656 KiB</code>),
around <code>1 GiB</code>, one could think it’s the metaspace, but it isn’t. Looking at
the other columns, the mode or permissions or the RSS, we see respectively <code>---p</code>
and <code>0</code>, this means this memory segment is reserved but it is not writeable.</p>
</div>
<div class="paragraph">
<p>Finding the metaspace cannot be done this way.</p>
</div>
</li>
<li>
<p><code>55bac569c000-55bae13a2000</code>, on the extended <code>pmap</code> output this mapping has a name
<code>heap</code>, this one is the native java heap of the Java process.
One can notice the next mapping address (<code>7ff9b91e7000</code>) is not adjacent, this allows
the native heap to grow if necessary. The virtual size of this mapping is
<code>~445 MiB</code> and the active pages amounts to <code>428 MiB</code>.</p>
</li>
<li>
<p>Then there’s a lot of mapping with this pattern, first <code>16 KiB</code> with no permission (<code>---p</code>)
immediately followed by a <code>1012 KiB</code> segment with read and write permissions (<code>rw-p</code>), those
are the Java threads, by default the virtual size the of the thread stack size is <code>1 MiB</code>,
the <code>ThreadStackSize</code> flag control this maximum stack size.</p>
<div class="paragraph">
<p>The <code>16 KiB</code> are the thread guard pages, the number of pages (<code>4 KiB</code>) is controlled by
<code>StackReservedPages</code>, <code>StackYellowPages</code> and <code>StackRedPages</code> whose defaults are respectively
<code>1</code>, <code>2</code>, and <code>1</code>.
They are used when a stack overflow error happens, normally the guard pages cannot
be written to, their permission will change in order to handle the error ; read
<a href="https://pangin.pro/posts/stack-overflow-handling">this explanation</a> from <a href="https://twitter.com/apangin">Andrei Pangin</a>
to learn more on this topic.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For the keen observer the virtual size of these two memory segment is <code>1028 KiB</code>,
a bit more than <code>1 MiB</code>, I’ve learned a few months ago that
<a href="https://code.woboq.org/userspace/glibc/nptl/allocatestack.c.html#550">glibc</a>, and other
allocators apparently adds one page to the allocated stack size, if the segment size is
<a href="https://code.woboq.org/userspace/glibc/sysdeps/i386/i686/stack-aliasing.h.html#23">a multiple of 64K</a>.</p>
</div>
<div class="paragraph">
<p>This is due to <a href="http://qcd.phys.cmu.edu/QCDcluster/intel/vtune/reference/64k_Aliasing_Conflicts.htm">prevent aliasing on the CPU cache lines</a></p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>A 64K-aliasing conflict occurs when a virtual address memory references a cache line
that is modulo 64K bytes apart from another cache line that already resides in the first
level cache. Only one cache line with a virtual address modulo 64K bytes can reside
in the first level cache at the same time.</p>
</div>
<div class="paragraph">
<p>For example, accessing a byte at virtual addresses 0x10000 and 0x3000F would cause
a 64K aliasing conflict. This is because the virtual addresses for the two bytes reside
on cache lines that are modulo 64K bytes apart.</p>
</div>
</blockquote>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>In other words one can see an additional <code>4 KiB</code> (a page), for stack size like
<code>512 KiB</code>, <code>256 KiB</code>, <code>128 KiB</code>,<code>64 KiB</code>.</p>
</div>
<div class="paragraph">
<p>That being said, if pages in the mapping are not touched, they do not account as
resident memory. This <code>55bac569c000-55bae13a2000</code> mapping tells the stack was at most
<code>92 KiB</code>. Anyway with more threads there will be naturally more consumed resident
memory.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>The other JVM components are harder to identify due to the way they are allocated.
That being said <code>pmap</code> reveals <em>file-backed</em> memory mapping, these consumes pages too.</p>
</div>
</div>
<div class="sect3">
<h4 id="_inspecting_memory_mapped_files"><a class="anchor" href="#_inspecting_memory_mapped_files"></a><a class="link" href="#_inspecting_memory_mapped_files">Inspecting memory mapped files</a></h4>
<div class="paragraph">
<p>The <code>NativeMemoryTracking</code> output showed memory usage of the JVM, but it didn’t report
<code>MappedByteBuffers</code>, those are the files that are <em>memory mapped</em> to the virtual memory
of a process as explained above via the native <code>mmap</code> call.</p>
</div>
<div class="paragraph">
<p>There are two ways to read a file using a file descriptor, generally it happens when
opening a <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/io/FileInputStream.html"><code>FileInputStream</code></a>,
or using memory mapping via a
<a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/nio/channels/FileChannel.html"><code>FileChannel</code></a>.</p>
</div>
<div class="paragraph">
<p>When a file is memory mapped, the range of the content is divided by pages too, and
when accessed they are <em>copied</em> in RAM by the OS, these are accounted in RSS.
For this reason they may deserve some attention if RSS usage is high but the app
memory alone is not enough.</p>
</div>
<div class="paragraph">
<p>The <code>Mapping</code> column on the of <code>pmap -x $(pgrep java)</code> can be parsed to identify
file mappings, but this is brittle and unnecessary, one can simply look at
the output of <code>pmap -X $(pgrep java)</code> (notice the big <code>X</code>) or even at the
<code>/proc/$(pidof java)/maps</code> content looking for a non-zero value of the <code>inode</code>
column meaning this mapping is file backed.</p>
</div>
<div class="paragraph">
<p>Using the output of <code>pmap -X $(pgrep java)</code> and selecting the matching lines
with <code>awk</code> this is <em>easy</em>:</p>
</div>
<div class="listingblock">
<div class="title">Shared application memory mapped files</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ pmap -X $(pidof java) \
  | head -n -2 \ <i class="conum" data-value="4"></i><b>(4)</b>
  | awk &#39;{ if (NR &lt;= 2 || $5 &gt;0 ) \ <i class="conum" data-value="1"></i><b>(1)</b>
  printf &#34;%12s %8s %8s %4s %s\n&#34;, \ <i class="conum" data-value="2"></i><b>(2)</b>
  $1, \
  $6, \
  $7, \
  $2, \
  $19 }&#39; <i class="conum" data-value="2"></i><b>(2)</b>
          7: -Djava.awt.headless=true -XX:NativeMemoryTracking=summary /usr/bin/java
     Address     Size      Rss Perm Mapping <i class="conum" data-value="3"></i><b>(3)</b>
561ddb94a000        4        4 r-xp java
561ddbb4b000        4        4 r--p java
561ddbb4c000        4        4 rw-p java
7f355521f000        4        4 r--s instrumentation9549273990865322165.jar
7f355964d000        4        4 r--s instrumentation14393425676176063484.jar
7f3559e50000     1160     1160 r--s dd-java-agent.jar
7f355a372000      256      192 r-xp libsunec.so
7f355a3b2000     2048        0 ---p libsunec.so
7f355a5b2000       20       20 r--p libsunec.so
7f355a5b7000        8        8 rw-p libsunec.so
7f355a7b9000       16       16 r--p libresolv-2.28.so
7f355a7bd000       52       52 r-xp libresolv-2.28.so
7f355a7ca000       16       16 r--p libresolv-2.28.so
7f355a7ce000        4        0 ---p libresolv-2.28.so
7f355a7cf000        4        4 r--p libresolv-2.28.so
7f355a7d0000        4        4 rw-p libresolv-2.28.so
7f355a7d3000        4        4 r--p libnss_dns-2.28.so
7f355a7d4000       16       16 r-xp libnss_dns-2.28.so
7f355a7d8000        4        0 r--p libnss_dns-2.28.so
7f355a7d9000        4        4 r--p libnss_dns-2.28.so
7f355a7da000        4        4 rw-p libnss_dns-2.28.so
7f355a7dd000        4        4 r--s instrumentation13129117816180832587.jar
7f355a7de000        8        8 r-xp libextnet.so
7f355a7e0000     2044        0 ---p libextnet.so
7f355a9df000        4        4 r--p libextnet.so
7f355b9e9000        4        4 r--s newrelic-bootstrap1151474907525430822.jar
7f355bfea000       24       24 r-xp libmanagement_ext.so
7f355bff0000     2044        0 ---p libmanagement_ext.so
7f355c1ef000        4        4 r--p libmanagement_ext.so
7f355c1f0000        4        4 rw-p libmanagement_ext.so
7f355c1f1000       16       16 r-xp libmanagement.so
7f355c1f5000     2048        0 ---p libmanagement.so
7f355c3f5000        4        4 r--p libmanagement.so
7f355c5f7000        8        8 r--s newrelic-weaver-api14962018995408739070.jar
7f355c5f9000       12       12 r--s newrelic-api8237374132620194936.jar
7f355c5fc000        4        4 r--s newrelic-opentracing-bridge6621669571490510163.jar
7f355c5fd000       16       16 r--s agent-bridge7978421659510986627.jar
7f355c601000       88       88 r-xp libnet.so
7f355c617000     2048        0 ---p libnet.so
7f355c817000        4        4 r--p libnet.so
7f355c818000        4        4 rw-p libnet.so
7f355c819000       64       64 r-xp libnio.so
7f355c829000     2048        0 ---p libnio.so
7f355ca29000        4        4 r--p libnio.so
7f355ca2a000        4        4 rw-p libnio.so
7f355cf30000      200      128 r--p LC_CTYPE
7f355cf62000        4        4 r--p LC_NUMERIC
7f355cf63000        4        4 r--p LC_TIME
7f355cf64000     1484      156 r--p LC_COLLATE
7f355d0d7000        4        4 r--p LC_MONETARY
7f355d0d8000        4        4 r--p SYS_LC_MESSAGES
7f355d0d9000        4        4 r--p LC_PAPER
7f355d0da000        4        4 r--p LC_NAME
7f355d0db000       28       28 r--s gconv-modules.cache
7f357663b000   138232    30036 r--s modules
7f357ed39000      104       92 r-xp libzip.so
7f357ed53000     2044        0 ---p libzip.so
7f357ef52000        4        4 r--p libzip.so
7f357ef5c000       12       12 r--p libnss_files-2.28.so
7f357ef5f000       28       28 r-xp libnss_files-2.28.so
7f357ef66000        8        8 r--p libnss_files-2.28.so
7f357ef68000        4        0 ---p libnss_files-2.28.so
7f357ef69000        4        4 r--p libnss_files-2.28.so
7f357ef6a000        4        4 rw-p libnss_files-2.28.so
7f357ef71000        4        4 r--p LC_ADDRESS
7f357ef72000        4        4 r--p LC_TELEPHONE
7f357ef73000        4        4 r--p LC_MEASUREMENT
7f357ef74000       40       40 r-xp libinstrument.so
7f357ef7e000     2044        0 ---p libinstrument.so
7f357f17d000        4        4 r--p libinstrument.so
7f357f17e000        4        4 rw-p libinstrument.so
7f357f17f000      108       64 r-xp libjimage.so
7f357f19a000     2048        0 ---p libjimage.so
7f357f39a000        8        8 r--p libjimage.so
7f357f39c000        4        4 rw-p libjimage.so
7f357f39d000      164      164 r-xp libjava.so
7f357f3c6000     2048        0 ---p libjava.so
7f357f5c6000        4        4 r--p libjava.so
7f357f5c7000        4        4 rw-p libjava.so
7f357f5c9000       68       68 r-xp libverify.so
7f357f5da000     2044        0 ---p libverify.so
7f357f7d9000        8        8 r--p libverify.so
7f357f7dc000        8        8 r--p librt-2.28.so
7f357f7de000       16       16 r-xp librt-2.28.so
7f357f7e2000        8        0 r--p librt-2.28.so
7f357f7e4000        4        4 r--p librt-2.28.so
7f357f7e5000        4        4 rw-p librt-2.28.so
7f357f8e7000    17680    15012 r-xp libjvm.so
7f3580a2b000     2044        0 ---p libjvm.so
7f3580c2a000      764      764 r--p libjvm.so
7f3580ce9000      228      228 rw-p libjvm.so
7f3580d7d000       12       12 r--p libgcc_s.so.1
7f3580d80000       68       64 r-xp libgcc_s.so.1
7f3580d91000       12       12 r--p libgcc_s.so.1
7f3580d94000        4        0 ---p libgcc_s.so.1
7f3580d95000        4        4 r--p libgcc_s.so.1
7f3580d96000        4        4 rw-p libgcc_s.so.1
7f3580d97000       52       52 r--p libm-2.28.so
7f3580da4000      636      368 r-xp libm-2.28.so
7f3580e43000      852      128 r--p libm-2.28.so
7f3580f18000        4        4 r--p libm-2.28.so
7f3580f19000        4        4 rw-p libm-2.28.so
7f3580f1a000      548      548 r--p libstdc++.so.6.0.25
7f3580fa3000      688      192 r-xp libstdc++.so.6.0.25
7f358104f000      248       64 r--p libstdc++.so.6.0.25
7f358108d000        4        0 ---p libstdc++.so.6.0.25
7f358108e000       40       40 r--p libstdc++.so.6.0.25
7f3581098000        8        8 rw-p libstdc++.so.6.0.25
7f35810a0000      136      136 r--p libc-2.28.so
7f35810c2000     1312     1208 r-xp libc-2.28.so
7f358120a000      304      152 r--p libc-2.28.so
7f3581256000        4        0 ---p libc-2.28.so
7f3581257000       16       16 r--p libc-2.28.so
7f358125b000        8        8 rw-p libc-2.28.so
7f3581261000        4        4 r--p libdl-2.28.so
7f3581262000        4        4 r-xp libdl-2.28.so
7f3581263000        4        4 r--p libdl-2.28.so
7f3581264000        4        4 r--p libdl-2.28.so
7f3581265000        4        4 rw-p libdl-2.28.so
7f3581266000      100      100 r-xp libjli.so
7f358127f000     2048        0 ---p libjli.so
7f358147f000        4        4 r--p libjli.so
7f3581480000        4        4 rw-p libjli.so
7f3581481000       24       24 r--p libpthread-2.28.so
7f3581487000       60       60 r-xp libpthread-2.28.so
7f3581496000       24        0 r--p libpthread-2.28.so
7f358149c000        4        4 r--p libpthread-2.28.so
7f358149d000        4        4 rw-p libpthread-2.28.so
7f35814a2000        4        4 r--p LC_IDENTIFICATION
7f3581878000        4        4 r--p ld-2.28.so
7f3581879000      120      120 r-xp ld-2.28.so
7f3581897000       32       32 r--p ld-2.28.so
7f358189f000        4        4 r--p ld-2.28.so
7f35818a0000        4        4 rw-p ld-2.28.so</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Filter lines that have an Inode value over 0 and only from the 3rd line (included).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Print only some columns, `pmap -X {pid}’s output is verbose.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The columns are select to match the output of <code>pmap -x</code>, <code>Size</code> column is in <code>KiB</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The last two lines are filtered out; the actual
sums of the <em>size</em> and <em>rss</em> columns of the selected rows are respectively
<code>195336 KiB</code> and <code>52316 KiB</code>.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>What may catch the eye is the multiple mapping for native libraries like <code>libjvm.so</code>.
The reason for these different memory mapping is how dynamic libraries are loaded
(with <code>dl_open</code>, e.g. here <a href="https://github.com/corretto/corretto-11/blob/4e14d3399615085a1b4bc89bc5c06bfcb1a08279/src%2Fsrc%2Fhotspot%2Fos%2Flinux%2Fos_linux.cpp#L1947-L1966">os::Linux::dlopen_helper</a>).
I didn’t have any system courses, but from what I believe I know <a href="https://linux.die.net/man/3/dlopen"><code>dl_open</code></a>
will make multiple memory mapping with different objectives and permissions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>r-xp</code> means an executable segment of the library, probably the native execution stack
of the native library</p>
</li>
<li>
<p><code>r--p</code> means readable memory of the library, I believe its the library constants or symbols</p>
</li>
<li>
<p><code>rw-p</code> means writable memory, I think its purpose is for the main process to set global
variables of the library</p>
</li>
<li>
<p><code>---p</code> is a no permission segment, I’m not sure about this one, but it’s location
(between executable and writable segments) makes me think it’s about buffer overflow
prevention</p>
</li>
</ul>
</div>
<details>
<summary class="title">Simple C code example that performs a <code>dlopen</code></summary>
<div class="content">
<div class="paragraph">
<p>The program below will simply load the shared dynamic library <code>libjvm.so</code>,
and won’t even interact with it. The result shows the 4 mappings
with the different modes.</p>
</div>
<div class="listingblock primary">
<div class="title">c</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;
#include &lt;dlfcn.h&gt;

int main (int argc, char *argv[])
{
pid_t pid = getpid();
printf(&#34;pid: %d\n&#34;, pid);

  void* libjava_handle=dlopen(&#34;lib/server/libjvm.so&#34;, RTLD_LAZY);
  if (!libjava_handle) {
    fputs (dlerror(), stderr);
    exit(1);
  }

  char buffer[50];
  sprintf(buffer, &#34;pmap -X %d&#34;, pid);
  printf(&#34;Executing: &#39;%s&#39;\n&#34;, buffer);
  system(buffer);

  return 0;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">result</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ env LD_LIBRARY_PATH=$JAVA_HOME/lib/server ./test-dlopen
pid: 608
Executing: &#39;pmap -x -p 608&#39;
608:   ./test-dlopen
Address           Kbytes     RSS   Dirty Mode  Mapping
0000000000400000       4       4       0 r-x-- /src/build/exe/dlopen/test-dlopen
0000000000600000       4       4       4 r---- /src/build/exe/dlopen/test-dlopen
0000000000601000       4       4       4 rw--- /src/build/exe/dlopen/test-dlopen
0000000001ba0000     132      16      16 rw---   [ anon ]
00007f3374f11000      92      92       0 r-x-- /usr/lib64/libpthread-2.17.so
00007f3374f28000    2044       0       0 ----- /usr/lib64/libpthread-2.17.so
00007f3375127000       4       4       4 r---- /usr/lib64/libpthread-2.17.so
00007f3375128000       4       4       4 rw--- /usr/lib64/libpthread-2.17.so
00007f3375129000      16       4       4 rw---   [ anon ]
00007f337512d000   18516    5324       0 r-x-- /usr/lib/jvm/java-11-openjdk-11.0.9.11-0.el7_9.x86_64/lib/server/libjvm.so <i class="conum" data-value="1"></i><b>(1)</b>
00007f3376342000    2048       0       0 ----- /usr/lib/jvm/java-11-openjdk-11.0.9.11-0.el7_9.x86_64/lib/server/libjvm.so <i class="conum" data-value="2"></i><b>(2)</b>
00007f3376542000     836     836     836 r---- /usr/lib/jvm/java-11-openjdk-11.0.9.11-0.el7_9.x86_64/lib/server/libjvm.so <i class="conum" data-value="3"></i><b>(3)</b>
00007f3376613000     236     216     216 rw--- /usr/lib/jvm/java-11-openjdk-11.0.9.11-0.el7_9.x86_64/lib/server/libjvm.so <i class="conum" data-value="4"></i><b>(4)</b>
00007f337664e000     360     240     240 rw---   [ anon ]
00007f33766a8000    1808    1184       0 r-x-- /usr/lib64/libc-2.17.so
00007f337686c000    2044       0       0 ----- /usr/lib64/libc-2.17.so
00007f3376a6b000      16      16      16 r---- /usr/lib64/libc-2.17.so
00007f3376a6f000       8       8       8 rw--- /usr/lib64/libc-2.17.so
00007f3376a71000      20      12      12 rw---   [ anon ]
00007f3376a76000      84      64       0 r-x-- /usr/lib64/libgcc_s-4.8.5-20150702.so.1
00007f3376a8b000    2044       0       0 ----- /usr/lib64/libgcc_s-4.8.5-20150702.so.1
00007f3376c8a000       4       4       4 r---- /usr/lib64/libgcc_s-4.8.5-20150702.so.1
00007f3376c8b000       4       4       4 rw--- /usr/lib64/libgcc_s-4.8.5-20150702.so.1
00007f3376c8c000    1028     208       0 r-x-- /usr/lib64/libm-2.17.so
00007f3376d8d000    2044       0       0 ----- /usr/lib64/libm-2.17.so
00007f3376f8c000       4       4       4 r---- /usr/lib64/libm-2.17.so
00007f3376f8d000       4       4       4 rw--- /usr/lib64/libm-2.17.so
00007f3376f8e000     932     520       0 r-x-- /usr/lib64/libstdc++.so.6.0.19
00007f3377077000    2048       0       0 ----- /usr/lib64/libstdc++.so.6.0.19
00007f3377277000      32      32      32 r---- /usr/lib64/libstdc++.so.6.0.19
00007f337727f000       8       8       8 rw--- /usr/lib64/libstdc++.so.6.0.19
00007f3377281000      84      12      12 rw---   [ anon ]
00007f3377296000       8       8       0 r-x-- /usr/lib64/libdl-2.17.so
00007f3377298000    2048       0       0 ----- /usr/lib64/libdl-2.17.so
00007f3377498000       4       4       4 r---- /usr/lib64/libdl-2.17.so
00007f3377499000       4       4       4 rw--- /usr/lib64/libdl-2.17.so
00007f337749a000     136     136       0 r-x-- /usr/lib64/ld-2.17.so
00007f33776af000      24      24      24 rw---   [ anon ]
00007f33776b9000       8       8       8 rw---   [ anon ]
00007f33776bb000       4       4       4 r---- /usr/lib64/ld-2.17.so
00007f33776bc000       4       4       4 rw--- /usr/lib64/ld-2.17.so
00007f33776bd000       4       4       4 rw---   [ anon ]
00007ffc83b1d000     132      12      12 rw---   [ stack ]
00007ffc83b41000      12       0       0 r----   [ anon ]
00007ffc83b44000       4       4       0 r-x--   [ anon ]
ffffffffff600000       4       0       0 r-x--   [ anon ]
---------------- ------- ------- -------
total kB           38912    9040    1496</code></pre>
</div>
</div>
</div>
</details>
<div class="paragraph">
<p>In the above snippet the mapped files represents <code>195.3 MiB</code> of the address space
of which <code>52.3 MiB</code> are actually resident. This app is definitely OK. Some
application’s workload require to handle a lot of files suggesting raising the limit
may be the right thing. I’ve seen in the past <code>FileChannel</code> unreleased mappings,
leading to increasing memory consumption that weren’t easily identifiable in the Java heap
(unless you had to perform a heap dump and knew what to look at).</p>
</div>
</div>
<div class="sect3">
<h4 id="_inspecting_the_other_segments"><a class="anchor" href="#_inspecting_the_other_segments"></a><a class="link" href="#_inspecting_the_other_segments">Inspecting the other segments</a></h4>
<div class="paragraph">
<p>Going beyond what has been mentioned is a tad more intricate due
to how native code is performing allocations.
Even identifying direct <code>ByteBuffer</code> is almost impossible, the little program below
allocates 16 MiB segments and print the address of these memory segments, as well
as the current process mapping.</p>
</div>
<div class="listingblock">
<div class="title">DirectByteBuffers.main</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">System.out.printf(&#34;max: %d%n&#34;, Runtime.getRuntime().maxMemory());

new ProcessBuilder(&#34;pmap&#34;, &#34;-x&#34;, Long.toString(ProcessHandle.current().pid()))
        .redirectOutput(Redirect.INHERIT)
        .start()
        .waitFor();

var address = Buffer.class.getDeclaredField(&#34;address&#34;);
address.setAccessible(true);
System.out.printf(&#34;native heap (pmap shows [heap] mapping&#34;);
for (var i = 0; i &lt; 30; i++) {
    var byteBuffer = ByteBuffer.allocateDirect(16 * 1024 * 1024)
            .putInt(0, 0x01);
    System.out.printf(&#34;%s%n&#34;, Long.toHexString(address.getLong(byteBuffer)));
}

new ProcessBuilder(&#34;pmap&#34;, &#34;-x&#34;, Long.toString(ProcessHandle.current().pid()))
        .redirectOutput(Redirect.INHERIT)
        .start()
        .waitFor();</code></pre>
</div>
</div>
<div class="paragraph">



<div class="table-wrapper">
    <div class="paragraph">
<p>The mapping output <em>after</em> the buffers have been <code>malloc</code>ed shows
that the direct <code>ByteBuffer</code>s do not have their own segment, they are
part of a bigger area.</p>
</div>
<table class="tableblock frame-none grid-none stripes-none stretch">
<caption class="title">Table 1. result</caption>
<colgroup>
<col style="width: 25%;"/>
<col style="width: 75%;"/>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">7faa5afff010
7faa59ffe010
7faa58ffd010
7faa52fff010
7faa51ffe010
7faa50ffd010
7faa4fffc010
7faa4effb010
7faa4dffa010
7faa4cff9010
7faa4bff8010
7faa4aff7010
7faa49ff6010
7faa48ff5010
7faa47ff4010
7faa46ff3010
7faa45ff2010
7faa44ff1010
7faa43ff0010
7faa42fef010
7faa41fee010
7faa40fed010
7faa3ffec010
7faa3efeb010
7faa3dfea010
7faa3cfe9010
7faa3bfe8010
7faa3afe7010
7faa39fe6010
7faa38fe5010</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock primary">
<div class="title">before</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">485:   java --add-opens java.base/java.nio=ALL-UNNAMED DirectByteBuffers.java
Address           Kbytes     RSS   Dirty Mode  Mapping
00000000e0e00000   32768   19992   19992 rw---   [ anon ]
00000000e2e00000  477184       0       0 -----   [ anon ]
0000000100000000    1792    1776    1776 rw---   [ anon ]
00000001001c0000 1046784       0       0 -----   [ anon ]
000055d4549ed000       4       4       0 r-x-- java
000055d454bee000       4       4       4 r---- java
000055d454bef000       4       4       4 rw--- java
000055d455d9d000     132      28      28 rw---   [ anon ] <i class="conum" data-value="1"></i><b>(1)</b>
00007faa5c000000     132      56      56 rw---   [ anon ] <i class="conum" data-value="1"></i><b>(1)</b>
00007faa5c021000   65404       0       0 -----   [ anon ] <i class="conum" data-value="1"></i><b>(1)</b>
00007faa60000000     132       4       4 rw---   [ anon ]
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>These segments are here before the creation of the dire <code>ByteBuffer</code>s.</td>
</tr>
</tbody></table>
</div>
<div class="listingblock secondary">
<div class="title">after</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">485:   java --add-opens java.base/java.nio=ALL-UNNAMED DirectByteBuffers.java
Address           Kbytes     RSS   Dirty Mode  Mapping
00000000e0e00000   32768   19992   19992 rw---   [ anon ]
00000000e2e00000  477184       0       0 -----   [ anon ]
0000000100000000    1920    1792    1792 rw---   [ anon ]
00000001001e0000 1046656       0       0 -----   [ anon ]
000055d4549ed000       4       4       0 r-x-- java
000055d454bee000       4       4       4 r---- java
000055d454bef000       4       4       4 rw--- java
000055d455d9d000     132      28      28 rw---   [ anon ] <i class="conum" data-value="1"></i><b>(1)</b>
00007faa38fe5000  442476  442476  442476 rw---   [ anon ] <i class="conum" data-value="3"></i><b>(3)</b>
00007faa54000000     132       8       8 rw---   [ anon ] <i class="conum" data-value="4"></i><b>(4)</b>
00007faa54021000   65404       0       0 -----   [ anon ] <i class="conum" data-value="4"></i><b>(4)</b>
00007faa58ffd000   49164   49164   49164 rw---   [ anon ] <i class="conum" data-value="2"></i><b>(2)</b>
00007faa5c000000     132      56      56 rw---   [ anon ] <i class="conum" data-value="1"></i><b>(1)</b>
00007faa5c021000   65404       0       0 -----   [ anon ] <i class="conum" data-value="1"></i><b>(1)</b>
00007faa60000000     132       4       4 rw---   [ anon ]
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The segments before the creation of the dire <code>ByteBuffer</code>s.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>New segments, likely direct <code>ByteBuffer</code>s</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>New segments, likely direct <code>ByteBuffer</code>s</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Unknown glibc <code>malloc</code> arena.</td>
</tr>
</tbody></table>
</div></div></td>
</tr>
</tbody>
</table>

</div>

</div>
<div class="paragraph">
<p>Here I can say those are likely our <code>ByteBuffer</code>s, because I had the opportunity
to diff the <code>pmap</code> output around code that specifically created the new direct
buffers. Also, I know that direct <code>ByteBuffer</code>s are <em>zero</em>ed, i.e. pages
are touched/dirty, i.e. direct byte buffers immediately count toward the RSS.</p>
</div>
<div class="paragraph">
<p>In a real application it’s impossible to identify them with certainty without
the address. The possible criteria would be RSS and size are the same for the segment,
permissionsare read write and of course it’s anonymous mapping, but any other
allocation pattern or usage could meet these criteria.</p>
</div>
<div class="paragraph">
<p>Finally, if <code>pmap</code> is run with <code>-X</code> it’s likely you’ll notice segments named
<code>vsyscall</code> <code>vdso</code>, these are
<a href="https://stackoverflow.com/a/19942352">mechanisms that can accelerate some system calls</a>.
<a href="https://lwn.net/Articles/615809/"><code>vvar</code> is used to exchange Kernel data without requiring a system call</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_how_many_pages_are_used"><a class="anchor" href="#_how_many_pages_are_used"></a><a class="link" href="#_how_many_pages_are_used">How many pages are used ?</a></h4>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>In  fact,  ps  uses  the  proc  file  system  to  obtain its
information.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>While not immediately useful, it’s interesting that the displayed RSS value
by <code>ps</code> is in fact the number of page times the page size. (I suppose the
equation is a tad more complex than a single multiplication when huge pages
are involved).</p>
</div>
<div class="paragraph">
<p>For example in the <a href="https://www.kernel.org/doc/Documentation/filesystems/proc.txt">procfs documentation</a>
(the latest, as in <code>latest</code> kernel, documentation is
<a href="https://www.kernel.org/doc/html/latest/filesystems/proc.html">there</a>) gives the
description of the <code>statm</code> object.</p>
</div>
<div class="listingblock">
<div class="title">statm description</div>
<div class="content">
<pre>Table 1-3: Contents of the statm files (as of 2.6.8-rc3)
..............................................................................
 Field    Content
 size     total program size (pages)		(same as VmSize in status)
 resident size of memory portions (pages)	(same as VmRSS in status)
 shared   number of pages that are shared	(i.e. backed by a file, same
						as RssFile+RssShmem in status)
 trs      number of pages that are &#39;code&#39;	(not including libs; broken,
							includes data segment)
 lrs      number of pages of library		(always 0 on 2.6)
 drs      number of pages of data/stack		(including libs; broken,
							includes library text)
 dt       number of dirty pages			(always 0 on 2.6)</pre>
</div>
</div>
<div class="listingblock">
<div class="title">ps and statm</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ ps -o rss,vsz,command $(pidof java)
  RSS    VSZ COMMAND
4346704 6507368 /usr/bin/java -Dfile.encoding=UTF-8 -Duser.timezone=UTC -Djava.security.egd=file:/dev/./urandom -Djava

$ cat /proc/$(pidof java)/statm | tr &#39; &#39; &#39;\n&#39;
1626842 <i class="conum" data-value="1"></i><b>(1)</b>
1086676 <i class="conum" data-value="2"></i><b>(2)</b>
12638 <i class="conum" data-value="3"></i><b>(3)</b>
1
0
1283103
0</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Total size in <em>pages</em> of the addressing space, in bytes : <code>6507368 KiB</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Resident memory in <em>pages</em>, in bytes : <code>4346704 KiB</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>pages backed by a file plus shared memory</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Given the page size of <code>4 KiB</code>, the following numbers comes naturally :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>vsz = <code>1626842 * 4 = 6507368</code></p>
</li>
<li>
<p>rss = <code>1086676 * 4 = 4346704</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example lets say there is a Kubernetes memory limit of <code>6 GiB</code>
(<code>6442450944 Bytes</code> ), a <code>java</code> process is started with a bigger memory
<code>-Xmx16g</code> that the cgroup limit, we can observe that</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>a process can <em>over-commit</em> this is not an issue as long as</p>
</li>
<li>
<p>the memory used by the resident pages do not go over the cgroup limit.</p>
</li>
<li>
<p>The process will be oom-killed if it uses more than <code>6442450944 / 4 = 1310720</code>
pages (of <code>4 KiB</code>).</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">SelfPs.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import java.io.*;

public class SelfPs {
  public static void main(String[] args) throws Exception {
    var h = new ProcessBuilder(&#34;ps&#34;,
                               &#34;--no-header&#34;,
                               &#34;-orss,vsz&#34;,
                               Long.toString(ProcessHandle.current().pid()))
                    .start();
    try(var br = new BufferedReader(new InputStreamReader(h.getInputStream()))) {
      System.out.println(br.readLine());
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">result</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ env -u JDK_JAVA_OPTIONS java -Xms16g -Xmx16g SelfPs.java
143584 18996472 <i class="conum" data-value="1"></i><b>(1)</b> <i class="conum" data-value="2"></i><b>(2)</b>
$ cat /sys/fs/cgroup/memory/memory.limit_in_bytes
6442450944 <i class="conum" data-value="3"></i><b>(3)</b>
$ echo $((18996472 * 1024))
19452387328 <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>RSS in KiB</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>virtual address space in KiB</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>cgroup limit</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>virtual address space in bytes</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Another interesting element of <code>statm</code> is that it shows how many files.
In the output above, the third line, give the number of pages that
are backed by files, it maybe a good indication to look at when sizing
the container.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ cat /proc/7/statm | tr &#39; &#39; &#39;\n&#39;
1514761
1009054
11222 <i class="conum" data-value="1"></i><b>(1)</b>
1
0
1164939
0
$ pmap -X $(pidof java) | head -n -2 | awk &#39;{ if (NR &gt; 2 &amp;&amp; $5 &gt;0 ) sum += $7 } END { print sum }&#39;
46796 <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Number of pages backed by files or shared memory, so <code>11222 * 4 = 44888</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Resident set size of memory mapped files in KiB, not including shared
pages that are not file backed.</td>
</tr>
</tbody></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_paging_and_the_java_heap"><a class="anchor" href="#_paging_and_the_java_heap"></a><a class="link" href="#_paging_and_the_java_heap">Paging and the Java heap</a></h3>
<div class="paragraph">
<p>Before wrapping this article I’d like to mention an interesting effect of
virtual memory, over-commit and Java Heap.</p>
</div>
<div class="paragraph">
<p>The pages of the Java heap memory segment count if these pages have initialized
at least once, during the life of the program, the activity of the program and
the GC will increase the number of touched pages, pages that count in the RSS.</p>
</div>
<div class="paragraph">
<p>For G1GC
. New allocation will happen in a GC region called <em>Eden</em>, and more specifically
in a sub-segment called TLAB dedicated for the thread that perform the allocation.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>After some time the GC will kick in and move (or evacuate) the live objects to
GC region called <em>Survivor</em>.</p>
</li>
<li>
<p>This cycle will go on until the object is considered old enough to be
evacuated to a GC region called <em>Old</em>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>After each evacuation, the regions that previously held the objects,
are cleaned up, and their bits set to <code>0</code>, but the page are still considered dirty
and count in the RSS. This region will return to a pool of <em>Free</em> regions.</p>
</div>
<div class="paragraph">
<p>For the evacuation, the live objects can go to existing region if they have some
space or if there’s not enough space in the existing regions, G1GC will
convert a <em>Free</em> region to either a <em>Survivor</em> or an <em>Old</em> region. If the <em>Free</em>
region has been used before then no new pages will get dirty, however if the
<em>Free</em> region has never been in use before then this will touch more pages.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/assets/off-heap-recon/os-memory-paging.svg" alt="os memory paging"/>
</div>
<div class="title">Simple overview of OS paging</div>
</div>
<div class="paragraph">
<p>This can lead to a situation if the Java heap is large enough, where
many never-used-before <em>Free</em> region exists. In this situation
it is not obvious to distinguish from metrics what is consuming the memory.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/assets/off-heap-recon/memory-usage-by-pool.png" alt="memory usage by pool"/>
</div>
<div class="title">Memory usage by pool</div>
</div>
<div class="paragraph">
<p>Some people may have heard of the <code>-XX:+AlwaysPreTouch</code> Hotspot option.
This option tells the JVM to
<a href="https://github.com/corretto/corretto-11/blob/3b31d243a19774bebde63df21cc84e994a89439a/src/src/hotspot/share/runtime/os.cpp#L1825-L1829">write a zero to every OS memory pages during the JVM startup</a>.
This option has also the effect of avoiding physical memory commit
latencies later at runtime, however this only affects the heap memory zone.
Other JVM component that manage areas like thread stack or metaspace work
differently.</p>
</div>
<div class="paragraph">
<p>In other words that means parts of the <strong>committed</strong> memory shown in NMT is not <strong>resident</strong> and as such
RSS counter may not reflect what is een in the <strong>committed</strong> memory.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sizing_a_cgroup_kubernetes_resources_memory_limit"><a class="anchor" href="#_sizing_a_cgroup_kubernetes_resources_memory_limit"></a><a class="link" href="#_sizing_a_cgroup_kubernetes_resources_memory_limit">Sizing a cgroup / kubernetes <code>resources.memory.limit</code></a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>With containerization getting traction it is likely that
one has to face a memory related issue. Being equipped with
the right tooling and the tool manual is a precious help.</p>
</div>
<div class="paragraph">
<p>When a container is oomkilled either the application has problem
or its configuration is too tight.</p>
</div>
<div class="paragraph">
<p>Using the gathered information from JVM’s native memory tracking and
from memory mapping, is it possible to build a simple <em>equation</em> to
estimate the probable maximum memory usage of a process ?</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>Set the cgroup memory limit high enough, so the application isn’t oomkilled, this will
let you analyze how the app work, and adjust settings without fear (except from your
colleagues that compare everything to <em>Go</em> or <em>rust</em>).</p>
</li>
<li>
<p>If you don’t think it’s Java heap memory leak, i.e. the heap usage isn’t alarming,
try to inspect native memory, it’s easier with the flag <code>-XX:+AlwaysPreTouch</code>,
however keep in mind this will bump your RSS right from the start, so anticipate this
increase in your cgroup memory limit.</p>
</li>
</ul>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>We can already suppose there’s every reported components from the JVM,
and the mapped files reported by NMT.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Total memory = Heap + GC + Metaspace + Code Cache + Symbol tables
               + Compiler + Other JVM structures + Thread stacks
               + Direct buffers + Mapped files</pre>
</div>
</div>
<div class="paragraph">
<p>Above in this writing I noted NMT is not enough to account used memory.</p>
</div>
<div class="listingblock">
<div class="title">On a loaded application</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ jcmd $(pidof java) VM.native_memory \
   | grep -P &#34;Total.*committed=&#34; \
   | grep -o -P &#34;(?&lt;=committed=)[0-9]+(?=KB)&#34;
3841302 <i class="conum" data-value="1"></i><b>(1)</b>

$ ps --no-header -o rss $(pidof java)
4204512 <i class="conum" data-value="2"></i><b>(2)</b>

$ pmap -X $(pidof java) | head -n -2 | awk &#39;{ if (NR &gt; 2 &amp;&amp; $5 &gt;0 ) sum += $7 } END { print sum }&#39;
52668 <i class="conum" data-value="3"></i><b>(3)</b>

$ echo $((4204512 - 3841303 - 52668))
363209 <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Total committed memory reported by NMT</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>RSS of the JVM process</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>RSS of the JVM process’s mapped files</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The rest of the used memory possibly <code>malloc</code> or <code>mmap</code> performed by native libs, native allocator overhead</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Basically this shows that one must account at least this amount of data
when defining the kubernetes limit.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Total memory = Heap + GC + Metaspace + Code Cache + Symbol tables
               + Compiler + Other JVM structures + Thread stacks
               + Direct buffers + Mapped files +
               + Native libraries allocations + Malloc overhead
               + ...</pre>
</div>
</div>
<div class="paragraph">
<p>In my experience if the application doe not exhibit leaky behavior but just need
memory limit adjustment. The job is way easier using <code>AlwaysPreTouch</code>, then it’s
easier to track evolution of &#34;off-heap&#34; memory.</p>
</div>
<div class="paragraph">
<p>Additionally, when sizing the memory limit, it’s really important
to think about the OS page cache. Linux uses the <em>unused resident
memory</em> to cache pages, usually the one backed by files.</p>
</div>
<div class="paragraph">
<p>Workloads that access the filesystem for a living, like Cassandra
or ElasticSearch will profit of the OS page cache. It’s a good bet
to increase the memory limit for this cgroup.</p>
</div>
<div class="paragraph">
<p>By how much, that depends. I believe page faults is a good indicator.
It’s likely that if there’s page faults of the container,
it means that the OS don’t have the wanted pages in resident memory
and as such the kernel must fetch the backing data, likely on the
slower storage device. This is likely something that will negatively
affect the workload latencies.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_closing_words"><a class="anchor" href="#_closing_words"></a><a class="link" href="#_closing_words">Closing words</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>A cgroup is a double-edged sword, it constrains misbehaving application to avoid
or to limit damage to other sibling containers, however it may be harder to get
a suitable configuration.
Improper configurations results in <em>oomkills</em> in particular or inefficient memory
settings thus affecting negatively the cost and pod scheduling on a Kubernetes
cluster. Even memory settings that seems good but too tight may have bad
implications on application performance.</p>
</div>
<div class="paragraph">
<p>In this very long writing, I showed two tools to survey the native
memory of a process. Java ships with a very interesting tracking
mechanism. I found out that inspecting Linux proc file system, with
the help of <code>pmap</code> complement NMT well. They help to sort out memory
problems of an application or if the limit should just be adjusted.</p>
</div>
<div class="paragraph">
<p>I understand this may look superfluous and almost zealous to
look at memory segments when coming from the Java world.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>The JVM is handling it.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>In my opinion, containers changed the deal, the tighter constraints
that help to increase the deployment density, is now backfiring.
Ans rediscovering RSS (or throttling for the cgroup that limits in CPU)
is essential.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_thanks"><a class="anchor" href="#_thanks"></a><a class="link" href="#_thanks">Thanks</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The above writing tries to piece together elements from a few things I knew,
things I grepped in the JDK codebase, blog posts, stack overflow,
and things learned from — awesome — people. I hope I didn’t forget someone,
if I did or if I’m wrong please reach out.</p>
</div>
<div class="paragraph">
<p>I’d like to thank <a href="https://twitter.com/pingtimeout">Pierre Laporte</a>,
<a href="https://twitter.com/olivierbourgain">Olivier Bourgain</a>, <a href="https://twitter.com/blemale">Bastien Lemale</a>,
and <a href="https://twitter.com/ylegat">Yohan Legat</a> for their early help in
proofreading.</p>
</div>
</div>
</div>

  </div>
  

<div class="navigation navigation-single">
    
    <a href="/drafts/2020/04/29/watchman/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">Watchman</span>
    </a>
    
    
    <a href="/drafts/2020/06/23/simple-g1gc-tuning/" class="navigation-next">
      <span class="navigation-tittle">Simple G1GC tuning</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  

</article>


        </div>
        
    










<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin="anonymous"></script>
    <script type="text/javascript">
        
        hljs.initHighlightingOnLoad();
    </script>
    

<script src="https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js" integrity="sha256-vrn14y7WH7zgEElyQqm2uCGSQrX/xjYDjniRUQx3NyU=" crossorigin="anonymous"></script>
<script type="text/javascript">
function addBlockSwitches() {
	$('.primary').each(function() {
		primary = $(this);
		createSwitchItem(primary, createBlockSwitch(primary)).item.addClass("selected");
		primary.children('.title').remove();
	});
	$('.secondary').each(function(idx, node) {
		secondary = $(node);
		primary = findPrimary(secondary);
		switchItem = createSwitchItem(secondary, primary.children('.switch'));
		switchItem.content.addClass('hidden');
		findPrimary(secondary).append(switchItem.content);
		secondary.remove();
	});
}

function createBlockSwitch(primary) {
	blockSwitch = $('<div class="switch"></div>');
	primary.prepend(blockSwitch);
	return blockSwitch;
}

function findPrimary(secondary) {
	candidate = secondary.prev();
	while (!candidate.is('.primary')) {
		candidate = candidate.prev();
	}
	return candidate;
}

function createSwitchItem(block, blockSwitch) {
	blockName = block.children('.title').text();
	content = block.children('.content').first().append(block.next('.colist'));
	item = $('<div class="switch--item">' + blockName + '</div>');
	blockSwitch.append(item);
	return {'item': item, 'content': content};
}

function globalSwitch() {
	$('.switch--item').each(function() {
		var blockId = blockIdForSwitchItem($(this));
		$(this).off('click');
		$(this).on('click', function() {
			selectedText = $(this).text()
			window.localStorage.setItem(blockId, selectedText);
			$(".switch--item").filter(function() {
				return blockIdForSwitchItem($(this)) === blockId;
			}).filter(function() {
				return $(this).text() === selectedText;
			}).each(function() {
				select($(this))
			});
		});
		if ($(this).text() === window.localStorage.getItem(blockId)) {
			select($(this))
		}
	});
}

function blockIdForSwitchItem(item) {
	idComponents = []
	idComponents.push(item.text().toLowerCase());
	item.siblings(".switch--item").each(function(index, sibling) {
		idComponents.push($(sibling).text().toLowerCase());
	});
	return idComponents.sort().join("-")
}

function select(selected) {
	selected.addClass('selected');
	selected.siblings().removeClass('selected');
	selectedContent = selected.parent().siblings(".content").eq(selected.index())
	selectedContent.removeClass('hidden');
	selectedContent.siblings().addClass('hidden');
}

$(addBlockSwitches);
$(globalSwitch);
</script>


    



    </body>
</html>

