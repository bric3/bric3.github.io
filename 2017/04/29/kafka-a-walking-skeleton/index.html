<!DOCTYPE html>
<html lang="en-US">
    
    


    <head>
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="https://www.gravatar.com">
    <link rel="dns-prefetch" href="https://giscus.app">

    <link href="https://gmpg.org/xfn/11" rel="profile">
    
    <link rel="canonical" href="https://blog.arkey.fr/2017/04/29/kafka-a-walking-skeleton/">
    

    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<meta name="color-scheme" content="light dark">
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.155.3">

    
    
    

<title>Kafka, a walking skeleton • Brice Dutheil</title>













    
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Brice Dutheil">
<meta property="og:title" content="Kafka, a walking skeleton">
<meta property="og:type" content="website">
<meta property="og:url" content="https://blog.arkey.fr/2017/04/29/kafka-a-walking-skeleton/" />
<meta property="og:description" content="Java mostly, and general tech">
<meta property="og:image" content="https://blog.arkey.fr/social-sharing.png">
<meta property="og:image:type" content="image/png">
    
    
    
<meta property="og:image:width" content="512">
<meta property="og:image:height" content="512">
    

<meta property="og:updated_time" content="2017-04-29T00:00:00Z">



<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@BriceDutheil">
<meta name="twitter:title" content="Kafka, a walking skeleton">

<meta name="twitter:image" content="https://blog.arkey.fr/social-sharing.png">

<meta name="twitter:description" content="Java mostly, and general tech">
<meta name="twitter:creator" content="@BriceDutheil">
    
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/a11y-light.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" media="(prefers-color-scheme: light)"><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/base16/gruvbox-dark-medium.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" media="(prefers-color-scheme: dark)">




<link rel="stylesheet" href="/scss/ascii-press.70f0dc6b0ba925a67d364f994bc556045605a427853874a5d71b04c9e8a989af.css" integrity="sha256-cPDcawupJaZ9Nk&#43;ZS8VWBFYFpCeFOHSl1xsEyeipia8=">


<link rel="stylesheet" href="/scss/ascii-press-dark.287256807294d72877e7d6ad2033ee800b6be06de5803c28476f7543c051a8bd.css" integrity="sha256-KHJWgHKU1yh359atIDPugAtr4G3lgDwoR291Q8BRqL0=" media="(prefers-color-scheme: dark)">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">




<link rel="stylesheet" href="/scss/hugo-toc.f44dcd620647796a2cf99d68a804ad4b52dacfcf98383c8344d085949175d65e.css" integrity="sha256-9E3NYgZHeWos&#43;Z1oqAStS1Laz8&#43;YODyDRNCFlJF11l4=">




    <!-- Icons from https://realfavicongenerator.net -->
<link rel="icon" href="/favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="196x196" href="/favicon-196x196.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<meta name="msapplication-TileColor" content="#b64f4f">
<meta name="theme-color" content="#b64f4f">



    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/v4-shims.min.css" integrity="sha512-7LGn7K+dj+CdmuqnrbIF/57brSK+L1DGyHMgby+dTT5n3Y6Bgmy/MmwHdaFRgLfLr6vwBA2yHplAutXldP8qAQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    
    

</head>


    <body class="">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="https://blog.arkey.fr/">Brice Dutheil</a>
      </span>
      
      
        <div class="author-image">
          <img src="https://www.gravatar.com/avatar/f31c7fbcbb0766d0632d96fd7e74b649?s=240&d=mp" class="img--circle img--headshot element--center" alt="gravatar">
        </div>
      
      <p class="site__description">
         Java mostly, and general tech 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">Brice Dutheil</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/"><span class='fa-icon'><i class='fas fa-home'></i></span><code>cd <em>~</em></code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/posts/"><span class='fa-icon'><i class='fas fa-stream'></i></span><code>ls <em>posts/*</em></code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/series/"><span class='fa-icon'><i class='fas fa-list-alt'></i></span><code>grep -o <em>series</em> posts/* | sort -u</code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/tags/"><span class='fa-icon'><i class='fas fa-tags'></i></span><code>grep -o <em>tags</em> posts/* | sort -u</code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/cool-stuff/"><span class='fa-icon'><i class='fas fa-thumbtack'></i></span><code>cd <em>cool-stuff</em></code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/whoami/"><span class='fa-icon'><i class='fas fa-id-card'></i></span><code>whoami</code>
						<span></span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://bsky.app/profile/bricedutheil.bsky.social" rel="me"><i class="fa-w-16" aria-hidden="true"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="bluesky" class="svg-inline--fa fa-bluesky fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2026 Fonticons, Inc. --><path fill="currentColor" d="M351.8 287C349.2 286.6 346.5 286.3 343.8 285.9C346.6 286.2 349.2 286.6 351.8 287zM256 232.9C236.7 192.3 178.3 116.7 125.5 79.4C74.9 43.7 55.6 50 43.1 55.6C28.2 62.2 25.6 84.7 25.6 98C25.6 111.1 32.9 206.4 37.6 222.3C53.2 274.9 108.9 292.6 160.2 286.9C162.8 286.5 165.4 286.2 168.2 285.8C165.5 286.2 162.9 286.6 160.2 286.9C85 297.8 18.3 325.4 105.8 422.8C202.1 522.5 237.7 401.4 256 340.1C274.3 401.4 295.4 518 404.5 422.8C486.4 340.1 427.0 298 351.8 286.9C349.2 286.5 346.5 286.2 343.8 285.8C346.6 286.1 349.2 286.6 351.8 286.9C403.1 292.6 458.7 274.9 474.4 222.3C479.1 206.4 486.4 111.2 486.4 98C486.4 84.6 483.8 62.2 468.9 55.6C457.5 50 438.1 43.7 386.6 79.4C333.7 116.7 275.3 192.3 256 232.9z"/></svg></i></a>
	
	
	<a href="https://mastodon.xyz/@BriceDutheil" rel="me"><i class="fa-w-16" aria-hidden="true"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="jumbo" class="svg-inline--fa fa-jumbo fa-w-18" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Pro 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path fill="currentColor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg></i></a>
	
	
	<a href="https://github.com/bric3" rel="me"><i class="fab fa-github" aria-hidden="true"></i></a>
	
	
	<a href="https://speakerdeck.com/bric3" rel="me"><i class="fab fa-speaker-deck" aria-hidden="true"></i></a>
	
	
	<a href="https://twitter.com/BriceDutheil" rel="me"><i class="fa-w-16" aria-hidden="true"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="bird" class="svg-inline--fa fa-bird fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Pro 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></i></a>
	
	
	
	
	
	
	
	
	<a href="https://linkedin.com/in/dutheilbrice" rel="me"><i class="fa-w-16" aria-hidden="true"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="pro-network" class="svg-inline--fa fa-pro-network fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Pro 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></i></a>
	
	
	<a href="https://stackoverflow.com/users/48136/brice" rel="me"><i class="fab fa-stack-overflow" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	
</section>

      </div>
    </div>

  </div>
  <div class="container fixed-container">
    
<div class="copyright">
  &copy; 2010 - 2026 Brice Dutheil
  
    <span style="white-space: nowrap;"><a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a></span>
  
</div>



  </div>
</div>

        <div class="content container">
            
    <header>

 
 
 <div class="github-edit">
     <a href="https://github.com/bric3/bric3.github.io/edit/hugo-sources/content/posts/2017-04-29-kafka-a-walking-skeleton.md">
     <i class="fab fa-github fa-lg" aria-hidden="true"></i> Edit this page
     </a>
 </div>
 


</header>

            
    

<article>
  <header>
    <h1>Kafka, a walking skeleton</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-days"></i> 2017-04-29
    
    
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/kafka">kafka</a>
           
      
          <a class="badge badge-tag" href="/tags/zookeeper">zookeeper</a>
           
      
          <a class="badge badge-tag" href="/tags/java">java</a>
          
      
    
    
    <br/>
    <i class="fas fa-clock"></i> 33 min read

    
    
    

</div>


  </header>
  
  
  
    <div class="toc-wrapper">
      <input type="checkbox" id="tocToggle" checked>
      <label for="tocToggle"><i class="fas fa-list-ul fa-lg"></i><span id="toc-title">On this page</span></label>
      <div id="toc-toggle-cover"></div>

      
          <nav id="TableOfContents">
  <ul>
    <li><a href="#les-producers-et-les-consumers">Les producers et les consumers</a></li>
    <li><a href="#à-propos-de-la-réplication">À propos de la réplication</a></li>
  </ul>

  <ul>
    <li><a href="#démarrer-avec-1-seule-instance">Démarrer avec 1 seule instance</a></li>
  </ul>

  <ul>
    <li><a href="#la-sérialisation--désérialisation">La sérialisation / désérialisation</a></li>
  </ul>

  <ul>
    <li>
      <ul>
        <li></li>
      </ul>
    </li>
  </ul>
</nav>
      
    </div>
  
  
  
  <div class="post md">
    <p>Ce blog post est une republication de mon article sur Kafka parut dans le magazine Programmez numéro 196 en mai 2016 (pages 70-73).
Il se base sur la version 0.9 de Kafka.</p>
<hr>
<p>Vous avez entendu parlé de Kafka et vous voulez en savoir plus. En ingénierie logicielle un <em>walking skeleton</em> est un
système minimal qui fonctionne de bout en bout. J’espère que cette introduction vous sera utile pour démarrer cette
première implémentation.</p>
<h1 id="kafka-encore-un-autre-broker-de-message-">Kafka encore un autre broker de message ?</h1>
<p>Ce projet vient tout droit de LinkedIn, lorsque des ingénieurs ont identifié des problèmes de performance globaux dans
leur traitement de données. Fin des années 2000, BigTable, Hadoop et MapReduce sont des buzzwords de l’IT. Cependant,
les approches proposées reposent sur des traitements de type batch et ne permettent donc pas de traiter de gros volumes
de données en temps réel.</p>
<p>Afin de correspondre aux besoins de l’environnement de production de LinkedIn les ingénieurs avait besoin d’une solution
technique répondant aux critères suivants :</p>
<ul>
<li>Haute Performance</li>
<li>Durabilité des messages</li>
<li>Scalabilité</li>
<li>Résilience aux pannes</li>
<li>Simplicité</li>
</ul>
<p>Cette solution s’appelle <strong>Kafka</strong>, LinkedIn en a fait un projet Open Source.</p>
<p>En terme de performance, Kafka devance de très loin tous les autres acteurs avec une charge encaissée de plus de 100k
messages/secondes (certaines configurations de LinkedIn montent jusqu’à 2 Millions/secondes). Kafka “stocke” durablement
les messages, c’est-à-dire qu’ils ne sont pas effacés à la consommation ; la rétention est réglable. Un critère
important pour un site comme LinkedIn est de pouvoir monter en charge en fonction du besoin. Pour cette raison, la
topologie d’un cluster Kafka peut être modifiée au besoin : ceci permet de scaler horizontalement. Pour anticiper les
pannes ou les interventions sur les machines, Kafka réplique ses données sur plusieurs serveurs ce qui le rend
relativement résilient aux pannes. Enfin Kafka est simple car sa conception se veut basée sur une primitive simple – le
log ; également son utilisation reste simple car il ne propose que du queuing et du publish/subscribe.</p>
<h1 id="comment-ça-marche">Comment ça marche</h1>
<p>Dans les faits le <strong>log</strong> est utilisé par de nombreux systèmes, par exemple dans les bases de données, cependant ils
n’exposent pas ce log à l’utilisateur, tout au plus à l’administrateur système. En revanche avec Kafka, le log est
exposé à l’utilisateur et il est au cœur de sa conception.</p>
<p>Une des primitives de base est le <strong>topic</strong>. Les messages sont <strong>publiés</strong> dans un topic par des <strong>producers</strong>
(producteurs) et les <strong>consumers</strong> (consommateurs) souscrivent à ce même topic pour traiter ces messages.
Schématiquement une infrastructure utilisant Kafka peut être représenté de cette façon :</p>
<p><img src="/assets/kafka-walking-skeleton/Kafka-global-view.jpeg" alt="Vue globale de Kafka"></p>
<p>Techniquement un topic est un log partitionné auquel les messages sont ajoutés continuellement et ceci de manière
ordonnée (dans une même partition). Pourquoi est-ce partitionné ? Avec Kafka il y a une relation forte entre le nombre
de partitions et le nombre de consommateurs ; augmenter le nombre de partition revient à augmenter le parallélisme des
consommateurs.</p>
<p><img src="/assets/kafka-walking-skeleton/Kafka-topic-partitions.jpeg" alt="Topic et partitions"></p>
<h2 id="les-producers-et-les-consumers">Les producers et les consumers</h2>
<p>Kafka fournit une abstraction appelé <strong>consumer group</strong> (groupe de consommateurs) qui généralise à la fois les deux
patterns queuing et publish/subscribe. Chaque consommateur s’attribue un groupe, et, pour chaque message sera délivré à
une seule instance dans le groupe.</p>
<ul>
<li>Tous les consumers ont le même groupe, c’est du queuing, ou la charge est répartie sur chaque consommateur.</li>
<li>Les consumers ont un groupe différent, dans ce cas c’est du publish/subscribe.</li>
</ul>
<p>À noter sur le parallélisme, au sein d’un même consumer group, pour N partitions il ne peut y avoir que N consumers
actifs. Il peut y avoir plusieurs consumer groups abonnés à un même topic (et donc sur les même partitions).</p>
<p><img src="/assets/kafka-walking-skeleton/Kafka-consumer-groups.jpeg" alt="Groupes de consommateurs"></p>
<h2 id="à-propos-de-la-réplication">À propos de la réplication</h2>
<p>Chaque partition d’un topic est répliquée suivant la configuration donnée. Parmi tous les réplicas (les serveurs qui ont
une copie des partitions d’un topic) :</p>
<ul>
<li>L’un sera le <strong>leader</strong>, c’est celui-ci qui va traiter les demandes de lectures / écritures</li>
<li>Les autres sont des <strong>followers</strong> (suiveurs), leur but est de répliquer passivement les partitions.</li>
</ul>
<p>Si le leader s’arrête, un des suiveurs prend le relais et devient le nouveau leader pour les partitions affectées.</p>
<p>À noter que chaque serveur agit en tant que leader pour certaines partitions et en tant que follower pour d’autres
partitions, ce qui permet de garder un cluster équilibré.</p>
<p><img src="/assets/kafka-walking-skeleton/Kafka-replication.jpeg" alt="Réplication"></p>
<p>En rouge sont ce sont les partitions dont un des serveur Kafka est le leader, c’est donc la partition en rouge qui
recevra les écritures des producers. En bleu sont dessinées les partitions répliquées.</p>
<p>Pour cette introduction, ces quelques explications devraient suffire. Il y a bien sûr davantage de ressources à la fois
sur le site officiel de Kafka (kafka.apache.org) et sur le site de la société commerciale de Kafka
(<a href="http://confluent.io"><em>http://confluent.io</em></a>).</p>
<h1 id="mettre-en-place-kafka">Mettre en place Kafka</h1>
<p>Cet article se base sur la version 0.9.0.x. La sous version Scala n’a pas vraiment d’importance si vous ne faites pas de
Scala. La version utilisant Scala 2.11 est d’ailleurs recommandée.</p>
<h2 id="démarrer-avec-1-seule-instance">Démarrer avec 1 seule instance</h2>
<p>Kafka utilise Zookeeper pour stocker ses métadonnées. Il faut donc le lancer en premier. Dans un terminal à part,
lancez la commande :</p>
<pre><code class="language-sh">$ cd kafka_2.11-0.9.0.1
$ ./bin/zookeeper-server-start.sh ./config/zookeeper.properties
</code></pre>
<p>Pour vérifier son état de marche, on peut envoyer le <strong>mot de 4 lettres</strong> stat sur le port 2181, le port de
communication client.</p>
<pre><code>$ { echo stat; sleep 0.1 } | telnet 127.0.0.1 2181
Trying 127.0.0.1...
Connected to localhost.
Escape character is '^]'.
Zookeeper version: 3.4.6-1569965, built on 02/20/2014 09:09 GMT
Clients:
 /127.0.0.1:52946[0](queued=0,recved=1,sent=0)

Latency min/avg/max: 0/0/0
Received: 1
Sent: 0
Connections: 1
Outstanding: 0
Zxid: 0x0
Mode: standalone
Node count: 4
Connection closed by foreign host.
</code></pre>
<p>Si vous avez ces statistiques alors le serveur Zookeeper tourne correctement. S’il y a un autre message alors le cluster
Zookeeper n’est pas dans la bonne configuration et n’est donc pas opérationnel.</p>
<p>Ensuite démarrons une instance Kafka. Il faut donner les valeurs aux propriétés suivante dans le fichier
<code>config/server.properties</code> :</p>
<pre><code class="language-properties">broker.id=1
port=9092
logs.dirs=/tmp/kafka-logs-1
zookeeper.connect=localhost:2181
</code></pre>
<p>Enfin lancer la première instance.</p>
<pre><code class="language-sh">$ ./bin/kafka-server-start.sh ./config/server.properties
</code></pre>
<p>Ensuite nous pouvons créer le premier topic, c’est en ligne de commande
que ça se passe :</p>
<pre><code class="language-sh">$ ./bin/kafka-topics.sh --create \
                        --topic bier-bar \
                        --partition 3 \
                        --replication-factor 1 \
                        --zookeeper localhost:2181
</code></pre>
<p>Les métadonnées du topic sont donc créées sur le cluster Zookeeper. Notez les paramètres obligatoires que sont le nombre
de partitions et le facteur de réplication.</p>
<p>Il est possible de produire et de consommer des messages avec les outils en ligne de commande inclus dans la
distribution (<code>kafka-console-producer.sh</code> et <code>kafka-console-consumer.sh</code>). Ceci dit cet article se concentre plutôt sur
le code Java.</p>
<h1 id="au-niveau-code">Au niveau code</h1>
<p>Avec la version 0.9, il faut importer la dépendance <code>org.apache.kafka:kafka-clients:0.9.0.1</code>, elle est nécessaire pour
utiliser l’API java de Kafka à la fois pour produire et consommer des messages.</p>
<p>Le code minimal pour créer un producteur de données, en premier lieu il faut trois propriétés :</p>
<ul>
<li>La liste des serveurs kafka Les classes de sérialisation pour la clé et la valeur</li>
</ul>
<p>Ensuite il suffit de produire des messages sur le topic créé.</p>
<pre><code class="language-java">public static void main(String[] args) throws InterruptedException {
   Properties props = new Properties();
   props.put(BOOTSTRAP_SERVERS_CONFIG, &quot;localhost:9092&quot;);
   props.put(KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());
   props.put(VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());
   KafkaProducer&lt;String, String&gt; producer = new KafkaProducer&lt;&gt;(props);
   Runtime.getRuntime().addShutdownHook(new Thread() {
       public void run() {
           System.out.println(&quot;Barman shutting down ...&quot;);
           // always close the producer
           // timeout to allow the producer to send the data to the broker
           producer.close(1000, MILLISECONDS);
       }
   });
   while (true) {
       producer.send(new ProducerRecord&lt;&gt;(&quot;bier-bar&quot;,
                                          String.format(&quot;Bier bought at '%s'&quot;,
                                                        LocalTime.now())));
       SECONDS.sleep(1);
   }
}
</code></pre>
<p>Cette classe enverra des messages simples, qu’un consommateur traitera dans un autre process de l’infrastructure.</p>
<p>Le code minimal du consommateur est le suivant, également la configuration minimale est la même aussi les adresses des
broker Kafka, les classes désérialisation, et enfin l’identifiant de groupe. À noter, étant donné que ce code utilise la
nouvelle API Java apparue en version 0.9, il n’y a pas besoin de gérer la connexion à Zookeeper.</p>
<pre><code class="language-java">public static void main(String[] args) {
   Properties props = new Properties();
   props.put(BOOTSTRAP_SERVERS_CONFIG, &quot;localhost:9092&quot;);
   props.put(GROUP_ID_CONFIG, &quot;barfly-group&quot;);
   props.put(KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());
   props.put(VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());
   KafkaConsumer&lt;String, String&gt; consumer = new KafkaConsumer&lt;&gt;(props);
   consumer.subscribe(Collections.singletonList(&quot;bier-bar&quot;));
   try {
       for(int i = 0; i &lt; 10; i++) {
           ConsumerRecords&lt;String, String&gt; records = consumer.poll(1000);
           for (ConsumerRecord&lt;String, String&gt; record : records)
               System.out.println(record.offset() + &quot;: &quot; + record.value());
       }
   } finally {
       System.out.println(&quot;Barfly shutting down ...&quot;);
       consumer.close(); // always close the consumer
   }
}
</code></pre>
<p>Dans cette configuration le consommateur ne fera que 10 opération de polling, après quoi il s’arrêtera. En le lançant
une seconde fois, seul les nouveaux messages seront dépilés. Ce comportement est modifiable, ainsi plutôt que de
reprendre à la position du dernier message consommé, il est possible de choisir la position et donc, par exemple, de
reprendre un topic depuis le début.</p>
<p>Le code présenté ici est simple, il est facile de le réutiliser pour jouer sur le parallélisme ou les topologies de
consommateurs avec les <strong>groupes de consommateurs</strong>. Typiquement au sein d’un consumer group, une partition ne sera
assignée qu’à un seul consumer. Pour un besoin métier différent il faudra qu’un consommateur ait un autre group.id.</p>
<p>À noter qu’un consommateur n’est pas thread-safe, il prévu pour tourner dans un thread qui lui est dédié. Ainsi on peut
imaginer soumettre des taches de consommation de message sur un <code>ExecutorService</code> :</p>
<pre><code class="language-java">executorService.submit(new Barfly());
</code></pre>
<p>Cette tâche n’aurait qu’à étendre la classe <code>Runnable</code> :</p>
<pre><code class="language-java">public class Barfly implements Runnable {
   // ...
   @Override
   public void run() {
       System.out.printf(&quot;Starts consumer %s%n&quot;, uuid);
       consumer.subscribe(Collections.singletonList(&quot;bier-bar&quot;));
       try {
           while (true) {
               ConsumerRecords&lt;String, String&gt; records = consumer.poll(1000);
               for (ConsumerRecord&lt;String, String&gt; record : records) {
                   System.out.printf(&quot;%d:%s:%s -&gt; %s%n&quot;,
                                     record.partition(),
                                     record.offset(),
                                     uuid,
                                     record.value());
               }
           }
       } catch(WakeupException ignored) {
       } finally {
           System.out.println(String.format(&quot;Barfly '%s' shutting down ...&quot;, uuid));
           consumer.close(); // always close the consumer
       }
   }

   public void shutdown() {
       consumer.wakeup();
   }
}
</code></pre>
<p>À noter que pour stopper proprement le thread du consumer, il est possible d’invoquer <code>consumer.wakeup()</code>. Dans cet
exemple une <code>WakeupException</code> sera levée afin d’interrompre la boucle infinie, ce qui permet d’atteindre le bloc finally
pour clore le consumer.</p>
<h2 id="la-sérialisation--désérialisation">La sérialisation / désérialisation</h2>
<p>Kafka ne gère que des octets, il n’a pas connaissance du contenu réel d’un message. C’est pour cette raison que les
producteurs et les consommateurs ont besoin d’avoir des classes qui font la traduction entre la représentation Java et
un tableau d’octets.</p>
<p>Par exemple <code>StringSerializer</code> doit juste transformer un <code>String</code> en tableau d’octets. Coté désérialisation, c’est le
travail inverse qui est fait. Sur des messages simples, une chaîne de caractères, utiliser le <code>StringSerializer</code> peut
suffire, en revanche, s’il s’agit de faire passer des grappes d’objets plus complexes, alors il faut passer à autre
chose.</p>
<p>Pour cette article imaginons que les messages doivent être sérialisé en JSON, il est possible d’écrire ce sérializeur
JSON, de la façon suivante avec les librairies du projet Jackson.</p>
<pre><code class="language-java">public class JsonSerializer&lt;T&gt; implements Serializer&lt;T&gt; {
   private ObjectMapper objectMapper = new ObjectMapper().setVisibility(PropertyAccessor.FIELD,
                                                                        Visibility.NON_PRIVATE)
                                                         .registerModules(new Jdk8Module(),
                                                                          new JavaTimeModule());
   // ...

   @Override
   public byte[] serialize(String topic, T data) {
       try {
           return objectMapper.writeValueAsBytes(data);
       } catch (JsonProcessingException e) {
           e.printStackTrace();
           throw new UncheckedIOException(e);
       }
   }
   // ...
}
</code></pre>
<p>Ce qui donnerait le message suivant, :</p>
<pre><code>0:1400 -&gt; {&quot;message&quot;:&quot;Bier served&quot;,&quot;bierName&quot;:&quot;Gallia&quot;,&quot;timestamp&quot;:\[16,0,6,509000000\]}
</code></pre>
<p>Notez que le message est bien sous forme de string. Le premier <code>Barfly</code> consommateur pourra lire ce message comme une
String. En revanche pour transformer ce message dans un objet Java, il faut faire la même chose avec un désérialiseur,
le code de ce désérialiseur n’en sera pas plus complexe.</p>
<p>Attention ceci dit JSON ou autre représentation non binaire n’est pas optimale. Si votre format de message doit être
amener à évoluer, il sera plus judicieux d’utiliser Avro ou un équivalent. Avro ou d’autres solutions peuvent également
avoir de l’attrait en terme d’empreinte mémoire et de performance.</p>
<p>Dans une infrastructure qui fait communiquer des applications entre elles, que ce soit par HTTP, avec Kafka ou une autre
technologie, il faut tester fortement les outillages de sérialisation, penser aux montées de version des messages, ainsi
qu’au coût que la sérialisation peut engendrer en terme de performance.</p>
<h1 id="focus-sur-zookeeper">Focus sur Zookeeper</h1>
<p>Jusqu’ici Zookeeper est assez peu évoqué. C’est un composant nécessaire de Kafka. En version 0.9 de Kafka il a deux
rôles très important :</p>
<ul>
<li><em>Service Discovery</em> des instances Kafka Stockage des métadonnées des topics</li>
</ul>
<p>Afin de permettre un rééquilibrage de la charge des brokers, ceux-ci doivent se connaître, ils utilisent pour cela
Zookeeper en tant que registre.</p>
<p>Comme on l’a vu plus haut, l’outillage d’administration créer un topic sur Zookeeper, car il agit là aussi comme
registre de métadonnées.</p>
<p>Il est nécessaire qu’il soit démarré en premier et qu’il soit arrêté après Kafka. Pour ces raisons Zookeeper représente
un élément sensible de l’infrastructure. Il faut donc lui accorder le plus grand soin. Connaître ce produit est plus
qu’un simple bonus.</p>
<p>Mon avis personnel est de prendre la distribution officielle de Zookeeper plutôt que de prendre le Zookeeper livré dans
la distribution Kafka, la distribution Zookeeper contient des outils additionnels intéressants pour les opérations pour
gérer le cluster Zookeeper.</p>
<p>En production, où la haute disponibilité est un prérequis, on pensera à affecter au minimum trois machines dédiés pour
chacune des instances du cluster Zookeeper. L’emplacement de ces machines sera de préférence dans des armoires
différentes. Cette utilisation des ressources matérielles autorisera des interventions, par exemple sur les
alimentations électriques.</p>
<p>Sur un petit SI, ou une durée d’indisponibilité est autorisée, une seule instance Zookeeper sur une machine dédiée
suffira.</p>
<p>Dans tous les cas il faut éviter de faire tourner les brokers Kafka sur les mêmes machines que Zookeeper. Si une machine
hébergeant à la fois Zookeeper et Kafka tombe alors cela peut mener à la corruption de données de topologie du cluster
Kafka et donc d’interrompre le service.</p>
<p>À noter que Zookeeper n’est pas encore équipé d’auto-discovery ni d’ajout d’instance à la volée. Le travail est en cours
sur la version 3.5, il faudra donc bien dimensionner son cluster Zookeeper. Aujourd’hui en version 3.4.x il faut lancer
une procédure de rolling restart, en ajoutant dans la configuration une nouvelle instance à la fois.</p>
<h1 id="en-production">En production</h1>
<p>Kafka peut manquer de maturité, mais l’outil est considéré <strong>production-ready</strong>. Il fonctionne très bien en
environnement de production, des noms comme Linkedin, Twitter, Uber, Netflix, Spotify le prouvent chaque jour.</p>
<p>La société Confluent vend du support technique, et finance le développement de Kafka ; la société a été fondé par les
ingénieurs de LinkedIn à l’origine du projet.</p>
<p>Pour amener Kafka en production l’idéal est de travailler sur une fonctionnalité simple. Ainsi il est possible d’avoir
des retours techniques grâce au trafic réel de production, et des retours humains par l’exploitant. Ce code devra bien
sûr être activable à la demande (feature toggle) afin de ne pas compromettre la production.</p>
<h1 id="les-points-dattention">Les points d’attention</h1>
<p>Comme tous les produits il y a des points forts et des éléments à
améliorer, même si Kafka tourne sur certaines des plus grosses
productions du monde il n’en reste pas moins jeune sur certains aspects :</p>
<ul>
<li>En phase de développement, l’outillage de test est assez maigre.</li>
<li>Comme tous les brokers il faut que l’équipe comprenne les contraintes et la sémantique qui entourent le messaging,
en particulier <strong>at-least-once</strong> et l’<strong>ordre des messages</strong>.</li>
<li>La configuration de Kafka est simple, mais si la configuration des machines est plus avancée (plusieurs interfaces
réseau, noms de domaine interne, etc.) alors la documentation commence à montrer ses lacunes.</li>
<li>En environnement d’exploitation, l’expérience pourrait être améliorée. Typiquement le <strong>rééquilibrage</strong> d’un cluster
est une opération qui pourrait être simplifiée.</li>
<li>Kafka ne vient pas avec une interface graphique d’administration, il existe le projet KafkaManager maintenu par des
gens de Yahoo, mais celui-ci n’a pas exactement le même cycle de vie que Kafka.</li>
</ul>
<h1 id="pour-finir">Pour finir</h1>
<p>Kafka est encore jeune, mais offre une alternative intéressante et performante aux systèmes actuels. Réaliser un
comparatif avec d’autres acteurs du marché n’est pas forcément pertinent, il faut avant tout identifier ses besoins.</p>
<p>Si le besoin d’un broker avec des fonctionnalités plus avancées comme le support des transactions, les garanties de
d’ordre alors Kafka n’est peut-être pas le bon outil.</p>
<p>Par contre si les critères primordiaux sont de pouvoir encaisser une forte charge, de pouvoir ajouter des instances
suivant le besoin, ou de persister durablement les messages, alors Kafka est une option sérieuse à envisager.</p>
<h6 id="sources">Sources</h6>
<ul>
<li><a href="http://alistair.cockburn.us/Walking&#43;skeleton">Walking skeleton</a></li>
<li><a href="http://kafka.apache.org/">kafka</a></li>
<li><a href="https://engineering.linkedin.com/kafka/benchmarking-apache-kafka-2-million-writes-second-three-cheap-machines">2 million writes second three at LinkedIn on cheap hardware</a></li>
<li><a href="https://www.quora.com/What-are-the-differences-between-Apache-Kafka-and-RabbitMQ?share=1&amp;redirected_qid=625566">Differences between Apache Kafka and RabbitMQ (question on Quora)</a></li>
<li><a href="http://www.confluent.io">Confluent</a></li>
<li><a href="http://www.confluent.io/blog/using-logs-to-build-a-solid-data-infrastructure-or-why-dual-writes-are-a-bad-idea/">Using logs to build a solid data infrastructure (or: why dual writes are a bad idea)</a></li>
<li><a href="http://www.confluent.io/blog/how-to-choose-the-number-of-topicspartitions-in-a-kafka-cluster/">How to choose the number of topics/partitions in a Kafka cluster?</a></li>
<li><a href="https://zookeeper.apache.org/doc/trunk/zookeeperAdmin.html#The&#43;Four&#43;Letter&#43;Words">The Four Letter Words</a></li>
<li><a href="http://docs.confluent.io/2.0.1/kafka/post-deployment.html">Post-deployment doc</a></li>
</ul>
<p>Code</p>
<p><a href="https://github.com/bric3/articles-kafka-walking-skeleton">bric3/articles-kafka-walking-skeleton</a></p>

  </div>
  

<div class="navigation navigation-single">
    
    <a href="/2016/12/05/make-docker-container-access-host-ssh-tunnel/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">Connecter un container docker sur un tunnel ssh OSX</span>
    </a>
    
    
    <a href="/2017/10/02/pagination_hateoas_link.en/" class="navigation-next">
      <span class="navigation-tittle">JAX-RS 2.0 pagination with Link header</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  

  <script
    src="https://giscus.app/client.js"
    data-repo="bric3/bric3.github.io"
    data-repo-id="MDEwOlJlcG9zaXRvcnk2MDc3NjczMQ=="
    data-category="Blog Comments"
    data-category-id="DIC_kwDOA59hG84CR_S_"
    data-mapping="pathname"
    data-reactions-enabled="1"
    data-input-position="top"
    data-theme="preferred-color-scheme"
    data-lang="en"
    data-loading="lazy"
    data-strict="1"
    
    data-theme="preferred-color-scheme"
    crossorigin="anonymous"
    async
  ></script>


</article>


            
    
<footer>

 
 
 <div class="github-edit">
     <a href="https://github.com/bric3/bric3.github.io/edit/hugo-sources/content/posts/2017-04-29-kafka-a-walking-skeleton.md">
     <i class="fab fa-github fa-lg" aria-hidden="true"></i> Edit this page
     </a>
 </div>
 















<script>
window.MathJax = {
  loader: {
    load: ['input/asciimath']
  },
  tex: {
    inlineMath: [['\\(', '\\)']],
    displayMath: [['\\[', '\\]']],
    tags: 'none'
  },
  asciimath: {
    delimiters: [['$', '$'], ['`', '`']]
  },
  options: {
    ignoreHtmlClass: 'nostem|nolatexmath|noasciimath',
    processHtmlClass: 'stemblock|latexmath|asciimath'
  },
  startup: {
    ready() {
      MathJax.startup.defaultReady();
      MathJax.startup.promise.then(() => {
        
        const asciimath = MathJax._.input.asciimath.AsciiMath?.AsciiMath;
        if (asciimath) {
          const originalCompile = asciimath.Compile;
          asciimath.Compile = function(latex, display) {
            const node = this.parseMath(latex);
            
            if (node && node.parentNode?.parentNode?.classList?.contains('stemblock')) {
              display = true;
            }
            return originalCompile.call(this, latex, display);
          };
        }
      });
    }
  }
};



</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/4.0.0/tex-mml-chtml.js" integrity="sha512-D0eU0TwZjXn2FsQXymdhToKse0yD7CFS6dQhhBQe5sUKYVp1hufw6lQtXxpvwBRj7dDjVJ858l2HEfktsOBv0A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js" integrity="sha512-EBLzUL8XLl+va/zAsmXwS7Z2B1F9HUHkZwyS/VKwh3S7T/U0nF4BaU29EP/ZSf6zgiIxYAnKLu6bJ8dqpmX5uw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script type="text/javascript">
        
        
        
        
        
        var mergeHTMLPlugin = (function () {
            'use strict';

            var originalStream;

            

            function escapeHTML(value) {
                return value
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#x27;');
            }

             

             
            const mergeHTMLPlugin = {
                
                "before:highlightElement": ({ el }) => {
                    originalStream = nodeStream(el);
                },
                
                "after:highlightElement": ({ el, result, text }) => {
                    if (!originalStream.length) return;

                    const resultNode = document.createElement('div');
                    resultNode.innerHTML = result.value;
                    result.value = mergeStreams(originalStream, nodeStream(resultNode), text);
                    el.innerHTML = result.value;
                }
            };

             

            


            

            function tag(node) {
                return node.nodeName.toLowerCase();
            }

            

            function nodeStream(node) {
                 
                const result = [];
                (function _nodeStream(node, offset) {
                    for (let child = node.firstChild; child; child = child.nextSibling) {
                        if (child.nodeType === 3) {
                            offset += child.nodeValue.length;
                        } else if (child.nodeType === 1) {
                            result.push({
                                event: 'start',
                                offset: offset,
                                node: child
                            });
                            offset = _nodeStream(child, offset);
                            
                            
                            
                            if (!tag(child).match(/br|hr|img|input/)) {
                                result.push({
                                    event: 'stop',
                                    offset: offset,
                                    node: child
                                });
                            }
                        }
                    }
                    return offset;
                })(node, 0);
                return result;
            }

            

            function mergeStreams(original, highlighted, value) {
                let processed = 0;
                let result = '';
                const nodeStack = [];

                function selectStream() {
                    if (!original.length || !highlighted.length) {
                        return original.length ? original : highlighted;
                    }
                    if (original[0].offset !== highlighted[0].offset) {
                        return (original[0].offset < highlighted[0].offset) ? original : highlighted;
                    }

                    

                    return highlighted[0].event === 'start' ? original : highlighted;
                }

                

                function open(node) {
                     
                    function attributeString(attr) {
                        return ' ' + attr.nodeName + '="' + escapeHTML(attr.value) + '"';
                    }
                    
                    result += '<' + tag(node) + [].map.call(node.attributes, attributeString).join('') + '>';
                }

                

                function close(node) {
                    result += '</' + tag(node) + '>';
                }

                

                function render(event) {
                    (event.event === 'start' ? open : close)(event.node);
                }

                while (original.length || highlighted.length) {
                    let stream = selectStream();
                    result += escapeHTML(value.substring(processed, stream[0].offset));
                    processed = stream[0].offset;
                    if (stream === original) {
                        

                        nodeStack.reverse().forEach(close);
                        do {
                            render(stream.splice(0, 1)[0]);
                            stream = selectStream();
                        } while (stream === original && stream.length && stream[0].offset === processed);
                        nodeStack.reverse().forEach(open);
                    } else {
                        if (stream[0].event === 'start') {
                            nodeStack.push(stream[0].node);
                        } else {
                            nodeStack.pop();
                        }
                        render(stream.splice(0, 1)[0]);
                    }
                }
                return result + escapeHTML(value.substr(processed));
            }

            return mergeHTMLPlugin;

        }());
        hljs.addPlugin(mergeHTMLPlugin);
        


        
        hljs.highlightAll();
    </script>
    

<script>


(function() {
  'use strict';

  
  function getScrollInfo(element, checkChildren = true) {
    let scrollLeft = element.scrollLeft;
    let scrollWidth = element.scrollWidth;
    const clientWidth = element.clientWidth;

    if (checkChildren) {
      
      const codeElement = element.querySelector('code');
      if (codeElement && codeElement.scrollWidth > scrollWidth) {
        scrollWidth = codeElement.scrollWidth;
        if (codeElement.scrollLeft > 0 || element.scrollLeft === 0) {
          scrollLeft = Math.max(scrollLeft, codeElement.scrollLeft);
        }
      }

      
      const tableElement = element.querySelector('table');
      if (tableElement && tableElement.scrollWidth > scrollWidth) {
        scrollWidth = tableElement.scrollWidth;
        if (tableElement.scrollLeft > 0 || element.scrollLeft === 0) {
          scrollLeft = Math.max(scrollLeft, tableElement.scrollLeft);
        }
      }
    }

    const maxScroll = scrollWidth - clientWidth;
    
    const hasOverflow = scrollWidth > clientWidth + 2;

    return { scrollLeft, scrollWidth, clientWidth, maxScroll, hasOverflow };
  }

  
  function applyScrollClasses(element, scrollInfo) {
    if (!scrollInfo.hasOverflow) {
      element.classList.remove('has-scroll-shadow-left', 'has-scroll-shadow-right');
      return;
    }

    
    if (scrollInfo.scrollLeft > 5) {
      element.classList.add('has-scroll-shadow-left');
    } else {
      element.classList.remove('has-scroll-shadow-left');
    }

    
    if (scrollInfo.scrollLeft < scrollInfo.maxScroll - 5) {
      element.classList.add('has-scroll-shadow-right');
    } else {
      element.classList.remove('has-scroll-shadow-right');
    }
  }

  
  function updateScrollShadows(element) {
    const scrollInfo = getScrollInfo(element);
    applyScrollClasses(element, scrollInfo);
  }

  function initScrollShadows() {
    
    const selectors = [
      '.post.adoc .literalblock pre',
      '.post.adoc .listingblock > .content > pre',
      '.post.adoc .openblock > .content > pre',  
      '.post.md pre',  
      '.table-wrapper',  
    ];

    const scrollables = document.querySelectorAll(selectors.join(', '));
    scrollables.forEach(element => {
      
      let scrollingElement = element;
      let targetElement = element;  

      
      let checkChildren = true;

      if (element.classList.contains('table-wrapper')) {
        
        const admonitionBlock = element.querySelector(':scope > .admonitionblock');
        if (admonitionBlock) {
          const computedStyle = window.getComputedStyle(admonitionBlock);
          if (computedStyle.overflowX === 'auto' || computedStyle.overflowX === 'scroll') {
            scrollingElement = admonitionBlock;  
            targetElement = element;  
            checkChildren = true;  
          }
        } else {
          
          const table = element.querySelector(':scope > table');
          if (table) {
            const computedStyle = window.getComputedStyle(table);
            if (computedStyle.overflowX === 'auto' || computedStyle.overflowX === 'scroll') {
              scrollingElement = table;  
              targetElement = element;  
              checkChildren = false;  
            }
          }
        }
      }

      
      const updateShadows = () => {
        const scrollInfo = getScrollInfo(scrollingElement, checkChildren);
        applyScrollClasses(targetElement, scrollInfo);
      };

      
      updateShadows();

      
      scrollingElement.addEventListener('scroll', updateShadows, { passive: true });

      
      if (checkChildren) {
        
        const codeElement = scrollingElement.querySelector('code');
        if (codeElement) {
          codeElement.addEventListener('scroll', updateShadows, { passive: true });
        }

        
        const tableElement = scrollingElement.querySelector('table');
        if (tableElement) {
          tableElement.addEventListener('scroll', updateShadows, { passive: true });
        }
      }
    });

    
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        scrollables.forEach(element => updateScrollShadows(element));
      }, 150);
    }, { passive: true });
  }

  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initScrollShadows);
  } else {
    initScrollShadows();
  }

  
  window.addEventListener('load', () => {
    setTimeout(() => {
      const selectors = [
        '.post.adoc .literalblock pre',
        '.post.adoc .listingblock > .content > pre',
        '.post.adoc .openblock > .content > pre',  
        '.post.md pre',
        '.table-wrapper'
      ];
      const scrollables = document.querySelectorAll(selectors.join(', '));
      scrollables.forEach(element => updateScrollShadows(element));
    }, 500);
  });

  
  window.debugScrollShadow = function(element) {
    if (typeof element === 'string') {
      element = document.querySelector(element);
    }
    if (!element) {
      console.error('Element not found');
      return;
    }
    updateScrollShadows(element);
  };

  
  window.refreshScrollShadows = function() {
    const selectors = [
      '.post.adoc .literalblock pre',
      '.post.adoc .listingblock > .content > pre',
      '.post.adoc .openblock > .content > pre',
      '.post.md pre',
      '.table-wrapper'
    ];
    const scrollables = document.querySelectorAll(selectors.join(', '));
    scrollables.forEach(element => {
      
      if (element.offsetParent === null) return;
      updateScrollShadows(element);
    });
  };
})();
</script>
<script type="text/javascript">

function children(element, selector) {
	if (!selector) return Array.from(element.children);
	return Array.from(element.children).filter(child => child.matches(selector));
}

function siblings(element, selector) {
	const sibs = Array.from(element.parentElement.children).filter(child => child !== element);
	return selector ? sibs.filter(sib => sib.matches(selector)) : sibs;
}

function getOffset(element) {
	const rect = element.getBoundingClientRect();
	return {
		top: rect.top + window.scrollY,
		left: rect.left + window.scrollX
	};
}

function addBlockSwitches() {
	document.querySelectorAll('.primary').forEach(primary => {
		const switchItem = createSwitchItem(primary, createBlockSwitch(primary));
		switchItem.item.classList.add("selected");
		const title = children(primary, '.title')[0];
		if (title) title.remove();
	});

	document.querySelectorAll('.secondary').forEach(secondary => {
		const primary = findPrimary(secondary);
		const switchElement = children(primary, '.switch')[0];
		const switchItem = createSwitchItem(secondary, switchElement);
		switchItem.content.classList.add('hidden');
		findPrimary(secondary).appendChild(switchItem.content);
		secondary.remove();
	});
}

function createBlockSwitch(primary) {
	const blockSwitch = document.createElement('div');
	blockSwitch.className = 'switch';
	primary.prepend(blockSwitch);
	return blockSwitch;
}

function findPrimary(secondary) {
	let candidate = secondary.previousElementSibling;
	while (candidate && !candidate.matches('.primary')) {
		candidate = candidate.previousElementSibling;
	}
	return candidate;
}

function createSwitchItem(block, blockSwitch) {
	const titleElement = children(block, '.title')[0];
	const blockName = titleElement ? titleElement.textContent : '';
	const contentElement = children(block, '.content')[0];
	const colist = block.nextElementSibling?.matches('.colist') ? block.nextElementSibling : null;
	if (contentElement && colist) {
		contentElement.appendChild(colist);
	}
	const item = document.createElement('div');
	item.className = 'switch--item';
	item.textContent = blockName;
	blockSwitch.appendChild(item);
	return {'item': item, 'content': contentElement};
}

function globalSwitch() {
	document.querySelectorAll('.switch--item').forEach(item => {
		const blockId = blockIdForSwitchItem(item);

		
		const newItem = item.cloneNode(true);
		item.parentNode.replaceChild(newItem, item);

		newItem.addEventListener('click', function() {
			const selectedText = this.textContent;
			window.localStorage.setItem(blockId, selectedText);

			
			const clickedSwitch = this.closest('.openblock.primary');

			
			const scrollTopBefore = window.scrollY;
			const offsetTopBefore = getOffset(clickedSwitch).top;

			Array.from(document.querySelectorAll(".switch--item"))
				.filter(el => blockIdForSwitchItem(el) === blockId)
				.filter(el => el.textContent === selectedText)
				.forEach(el => select(el));

			
			requestAnimationFrame(function() {
				requestAnimationFrame(function() {
					
					const offsetTopAfter = getOffset(clickedSwitch).top;

					
					const scrollAdjustment = offsetTopAfter - offsetTopBefore;

					if (Math.abs(scrollAdjustment) > 1) {
						window.scrollTo({
							top: scrollTopBefore + scrollAdjustment,
							behavior: 'instant'
						});
					}

					
					setTimeout(function() {
						if (typeof window.refreshScrollShadows === 'function') {
							window.refreshScrollShadows();
						}
					}, 0);
				});
			});
		});

		if (newItem.textContent === window.localStorage.getItem(blockId)) {
			select(newItem);
		}
	});
}

function blockIdForSwitchItem(item) {
	const idComponents = [];
	idComponents.push(item.textContent.toLowerCase());
	siblings(item, ".switch--item").forEach(sibling => {
		idComponents.push(sibling.textContent.toLowerCase());
	});
	return idComponents.sort().join("-");
}

function select(selected) {
	selected.classList.add('selected');
	siblings(selected).forEach(sib => sib.classList.remove('selected'));

	const parent = selected.parentElement;
	const selectedIndex = Array.from(parent.children).indexOf(selected);
	const contentElements = siblings(parent, ".content");

	if (contentElements[selectedIndex]) {
		contentElements[selectedIndex].classList.remove('hidden');
		contentElements.forEach((content, idx) => {
			if (idx !== selectedIndex) {
				content.classList.add('hidden');
			}
		});
	}
}


if (document.readyState === 'loading') {
	document.addEventListener('DOMContentLoaded', function() {
		addBlockSwitches();
		globalSwitch();
	});
} else {
	addBlockSwitches();
	globalSwitch();
}
</script>

<script type="text/javascript">
  
  
  window.addEventListener("load", () => {
    if (!'IntersectionObserver' in window) {
      return;
    }

    
    const sections = Array.from(document.querySelectorAll("section[id], h2[id], h3[id], h4[id], h5[id]"));
    const visibleSectionClass = "visible-section";

    
    
    const scrollHandler = entries =>
            entries.forEach(entry => {
              const section = entry.target;
              const sectionId = section.id;
              const sectionLink = document.querySelector(`a[href="#${sectionId}"]`);

              console.log(sectionId, sectionLink);
              console.log(entry)
              console.log(entry.intersectionRect.height / entry.rootBounds.height)

              if (entry.intersectionRatio > 0) {
                section.classList.add(visibleSectionClass);
                sectionLink.classList.add(visibleSectionClass);
              } else {
                section.classList.remove(visibleSectionClass);
                sectionLink.classList.remove(visibleSectionClass);
              }
            });

    
    const observer = new IntersectionObserver(scrollHandler);
    sections.map(section => {
      if (section.tagName === "SECTION") {
        return section;
      } else {
        
        
        
        
        
        
        
        
        let actualSectionContainer = section.parentElement;
        actualSectionContainer.id = section.id;
        return actualSectionContainer;
      }
    }).forEach(section => observer.observe(section));
  });

</script>






</footer>

    



        </div>
    </body>
</html>

