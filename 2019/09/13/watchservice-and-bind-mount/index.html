<!DOCTYPE html>
<html lang="en-US">
    
    


    <head>
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="https://www.gravatar.com">
    <link rel="dns-prefetch" href="https://giscus.app">

    <link href="https://gmpg.org/xfn/11" rel="profile">
    
    <link rel="canonical" href="https://blog.arkey.fr/2019/09/13/watchservice-and-bind-mount/">
    

    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<meta name="color-scheme" content="light dark">
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.155.3">

    
    
    

<title>When Java&amp;rsquo;s WatchService is not the right tool in a container â€¢ Brice Dutheil</title>













    
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Brice Dutheil">
<meta property="og:title" content="When Java&rsquo;s WatchService is not the right tool in a container">
<meta property="og:type" content="website">
<meta property="og:url" content="https://blog.arkey.fr/2019/09/13/watchservice-and-bind-mount/" />
<meta property="og:description" content="Java mostly, and general tech">
<meta property="og:image" content="https://blog.arkey.fr/social-sharing.png">
<meta property="og:image:type" content="image/png">
    
    
    
<meta property="og:image:width" content="512">
<meta property="og:image:height" content="512">
    

<meta property="og:updated_time" content="2019-09-13T00:00:00Z">



<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@BriceDutheil">
<meta name="twitter:title" content="When Java&rsquo;s WatchService is not the right tool in a container">

<meta name="twitter:image" content="https://blog.arkey.fr/social-sharing.png">

<meta name="twitter:description" content="Java mostly, and general tech">
<meta name="twitter:creator" content="@BriceDutheil">
    
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/a11y-light.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" media="(prefers-color-scheme: light)"><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/base16/gruvbox-dark-medium.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" media="(prefers-color-scheme: dark)">




<link rel="stylesheet" href="/scss/ascii-press.70f0dc6b0ba925a67d364f994bc556045605a427853874a5d71b04c9e8a989af.css" integrity="sha256-cPDcawupJaZ9Nk&#43;ZS8VWBFYFpCeFOHSl1xsEyeipia8=">


<link rel="stylesheet" href="/scss/ascii-press-dark.287256807294d72877e7d6ad2033ee800b6be06de5803c28476f7543c051a8bd.css" integrity="sha256-KHJWgHKU1yh359atIDPugAtr4G3lgDwoR291Q8BRqL0=" media="(prefers-color-scheme: dark)">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">




<link rel="stylesheet" href="/scss/hugo-toc.f44dcd620647796a2cf99d68a804ad4b52dacfcf98383c8344d085949175d65e.css" integrity="sha256-9E3NYgZHeWos&#43;Z1oqAStS1Laz8&#43;YODyDRNCFlJF11l4=">




    <!-- Icons from https://realfavicongenerator.net -->
<link rel="icon" href="/favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="196x196" href="/favicon-196x196.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<meta name="msapplication-TileColor" content="#b64f4f">
<meta name="theme-color" content="#b64f4f">



    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/v4-shims.min.css" integrity="sha512-7LGn7K+dj+CdmuqnrbIF/57brSK+L1DGyHMgby+dTT5n3Y6Bgmy/MmwHdaFRgLfLr6vwBA2yHplAutXldP8qAQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    
    

</head>


    <body class="">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="https://blog.arkey.fr/">Brice Dutheil</a>
      </span>
      
      
        <div class="author-image">
          <img src="https://www.gravatar.com/avatar/f31c7fbcbb0766d0632d96fd7e74b649?s=240&d=mp" class="img--circle img--headshot element--center" alt="gravatar">
        </div>
      
      <p class="site__description">
         Java mostly, and general tech 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">Brice Dutheil</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/"><span class='fa-icon'><i class='fas fa-home'></i></span><code>cd <em>~</em></code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/posts/"><span class='fa-icon'><i class='fas fa-stream'></i></span><code>ls <em>posts/*</em></code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/series/"><span class='fa-icon'><i class='fas fa-list-alt'></i></span><code>grep -o <em>series</em> posts/* | sort -u</code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/tags/"><span class='fa-icon'><i class='fas fa-tags'></i></span><code>grep -o <em>tags</em> posts/* | sort -u</code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/cool-stuff/"><span class='fa-icon'><i class='fas fa-thumbtack'></i></span><code>cd <em>cool-stuff</em></code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/whoami/"><span class='fa-icon'><i class='fas fa-id-card'></i></span><code>whoami</code>
						<span></span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://bsky.app/profile/bricedutheil.bsky.social" rel="me"><i class="fa-w-16" aria-hidden="true"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="bluesky" class="svg-inline--fa fa-bluesky fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2026 Fonticons, Inc. --><path fill="currentColor" d="M351.8 287C349.2 286.6 346.5 286.3 343.8 285.9C346.6 286.2 349.2 286.6 351.8 287zM256 232.9C236.7 192.3 178.3 116.7 125.5 79.4C74.9 43.7 55.6 50 43.1 55.6C28.2 62.2 25.6 84.7 25.6 98C25.6 111.1 32.9 206.4 37.6 222.3C53.2 274.9 108.9 292.6 160.2 286.9C162.8 286.5 165.4 286.2 168.2 285.8C165.5 286.2 162.9 286.6 160.2 286.9C85 297.8 18.3 325.4 105.8 422.8C202.1 522.5 237.7 401.4 256 340.1C274.3 401.4 295.4 518 404.5 422.8C486.4 340.1 427.0 298 351.8 286.9C349.2 286.5 346.5 286.2 343.8 285.8C346.6 286.1 349.2 286.6 351.8 286.9C403.1 292.6 458.7 274.9 474.4 222.3C479.1 206.4 486.4 111.2 486.4 98C486.4 84.6 483.8 62.2 468.9 55.6C457.5 50 438.1 43.7 386.6 79.4C333.7 116.7 275.3 192.3 256 232.9z"/></svg></i></a>
	
	
	<a href="https://mastodon.xyz/@BriceDutheil" rel="me"><i class="fa-w-16" aria-hidden="true"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="jumbo" class="svg-inline--fa fa-jumbo fa-w-18" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Pro 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path fill="currentColor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg></i></a>
	
	
	<a href="https://github.com/bric3" rel="me"><i class="fab fa-github" aria-hidden="true"></i></a>
	
	
	<a href="https://speakerdeck.com/bric3" rel="me"><i class="fab fa-speaker-deck" aria-hidden="true"></i></a>
	
	
	<a href="https://twitter.com/BriceDutheil" rel="me"><i class="fa-w-16" aria-hidden="true"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="bird" class="svg-inline--fa fa-bird fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Pro 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></i></a>
	
	
	
	
	
	
	
	
	<a href="https://linkedin.com/in/dutheilbrice" rel="me"><i class="fa-w-16" aria-hidden="true"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="pro-network" class="svg-inline--fa fa-pro-network fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Pro 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></i></a>
	
	
	<a href="https://stackoverflow.com/users/48136/brice" rel="me"><i class="fab fa-stack-overflow" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	
</section>

      </div>
    </div>

  </div>
  <div class="container fixed-container">
    
<div class="copyright">
  &copy; 2010 - 2026 Brice Dutheil
  
    <span style="white-space: nowrap;"><a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a></span>
  
</div>



  </div>
</div>

        <div class="content container">
            
    <header>

 
 
 <div class="github-edit">
     <a href="https://github.com/bric3/bric3.github.io/edit/hugo-sources/content/posts/2019-09-13-watchservice-and-bind-mount.md">
     <i class="fab fa-github fa-lg" aria-hidden="true"></i> Edit this page
     </a>
 </div>
 


</header>

            
    

<article>
  <header>
    <h1>When Java&rsquo;s <code>WatchService</code> is not the right tool in a container</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-days"></i> 2019-09-13
    
    
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/java">java</a>
           
      
          <a class="badge badge-tag" href="/tags/linux">linux</a>
           
      
          <a class="badge badge-tag" href="/tags/docker">docker</a>
           
      
          <a class="badge badge-tag" href="/tags/kubernetes">kubernetes</a>
           
      
          <a class="badge badge-tag" href="/tags/inotify">inotify</a>
           
      
          <a class="badge badge-tag" href="/tags/watchservice">watchservice</a>
          
      
    
    
    <br/>
    <i class="fas fa-clock"></i> 25 min read

    
    
    

</div>


  </header>
  
  
  
    <div class="toc-wrapper">
      <input type="checkbox" id="tocToggle" checked>
      <label for="tocToggle"><i class="fas fa-list-ul fa-lg"></i><span id="toc-title">On this page</span></label>
      <div id="toc-toggle-cover"></div>

      
          <nav id="TableOfContents">
  <ul>
    <li><a href="#boring-code-that-should-be-written-once-and-run-everywhere">Boring code that should be written once and run everywhere</a>
      <ul>
        <li><a href="#running-this-code-locally-on-a-physical-machine">Running this code locally (on a physical machine)</a></li>
        <li><a href="#running-this-code-in-a-container">Running this code in a container</a></li>
      </ul>
    </li>
    <li><a href="#understanding-how-this-code-is-working-differently-on-these-two-platforms">Understanding how this code is working differently on these two platforms</a>
      <ul>
        <li><a href="#linux-watch-service-uses-inotify">Linux Watch Service uses <code>inotify</code></a></li>
      </ul>
    </li>
    <li><a href="#the-clue">The clue</a></li>
    <li><a href="#how-to-fix-this">How to fix this</a></li>
    <li><a href="#remaining-questions">Remaining questions</a></li>
  </ul>
</nav>
      
    </div>
  
  
  
  <div class="post md">
    <h2 id="boring-code-that-should-be-written-once-and-run-everywhere">Boring code that should be written once and run everywhere</h2>
<p>Suppose the application you&rsquo;re working on needs to monitor changes to a
file and rely on Java&rsquo;s <code>WatchService</code> introduced in Java 7. Development
and test on the local machine works ; the unit tests rely on a
<code>TemporaryFolder</code> Junit rule as you want to control the content of the file,
running the code on the actual machine just works as expected.
Everything is green to go live.</p>
<p>The file is <code>/etc/hosts</code> (that&rsquo;s important).</p>
<p>However, when the application is live in production, nothing happen when
the file is modified.</p>
<p>The code to reproduce this issue is quite boring:</p>
<pre><code class="language-java">import java.lang.Exception;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.FileSystems;
import java.nio.file.StandardWatchEventKinds;
import java.nio.file.WatchEvent;
import java.nio.file.WatchKey;
import java.nio.file.WatchService;

public class WatchFile {
    public static void main(String... args) throws Exception {
        String filepath = args[0];
        Path path = FileSystems.getDefault()
                               .getPath(filepath);
        System.out.printf(&quot;Watching : %s%n&quot;, path);
        try (WatchService watchService = FileSystems.getDefault().newWatchService()) {
            WatchKey watchKey = (Files.isDirectory(path) ? path : path.getParent())
                                    .register(watchService, 
                                              StandardWatchEventKinds.ENTRY_MODIFY);
            while (true) {
                WatchKey wk = watchService.take();
                for (WatchEvent&lt;?&gt; event : wk.pollEvents()) {
                    Path changed = (Path) event.context();
                    System.out.printf(&quot;Modified : %s%n&quot;, changed);
                    if (changed.endsWith(path.getFileName().toString())) {
                        System.out.printf(&quot;  -&gt; : %s%n&quot;, path);
                    }
                }
            }
        }
    }
}
</code></pre>
<h3 id="running-this-code-locally-on-a-physical-machine">Running this code locally (on a physical machine)</h3>
<p>This simple code expects an argument that is a path to a directory or, a file.
When this code is run locally on the physical machine:</p>
<pre><code>############ terminal A ##############|############ terminal B ###########
&gt; java WatchFile /etc/hosts           | 
Watching : /etc/hosts                 | # wait for WatchFile to be started
                                      | &gt; touch /etc/hosts
Modified : hosts                      |
  -&gt; : /etc/hosts                     |
</code></pre>
<p>The code work as expected.</p>
<h3 id="running-this-code-in-a-container">Running this code in a container</h3>
<p>Then we are running in a container (and on Linux), expecting the following should
just work. <em>Write once run everywhere!</em></p>
<pre><code>############ terminal A ##############|############ terminal B ###########
&gt; docker container run -it \          | &gt; docker container exec -it \
  adoptopenjdk/openjdk8:latest \      |   612f6247d0b7 \
  /bin/bash                           |   /bin/bash
root@612f6247d0b7:/# \                | # wait for WatchFile to be started
  java WatchFile /etc/hosts           | root@612f6247d0b7:/# \
Watching : /etc/hosts                 |   touch /etc/hosts
                                      | 
# nothing happens                     | 
</code></pre>
<p>But no, it doesn&rsquo;t ! If it works fine on a physical machine, and
in a JUnit test what is happening for this code to not work within a container ?!</p>
<h2 id="understanding-how-this-code-is-working-differently-on-these-two-platforms">Understanding how this code is working differently on these two platforms</h2>
<p>When using <code>WatchService</code> the first thing to understand about it is that
it tries to abstract filesystems and platform facilities regarding file
changes that happen on the file-system. However, while the API tries
its best to be platform agnostic there are substantial variations in behavior
in each platform implementation.</p>
<p>For example the JDK 8 on MacOs the following statement
<code>FileSystems.getDefault().newWatchService()</code> will return a very basic
<a href="https://hg.openjdk.java.net/jdk8u/jdk8u/jdk/file/478a4add975b/src/share/classes/sun/nio/fs/PollingWatchService.java">polling watcher</a>,
other platforms integration code may benefit from more intimate knowledge of the OS
and the file-system. Linux uses <code>inotify</code> and its integration appears to leverage it.</p>
<h3 id="linux-watch-service-uses-inotify">Linux Watch Service uses <code>inotify</code></h3>
<p>The above code works on almost any - if not all - Linux physical box.
What&rsquo;s wrong then? First let&rsquo;s dig a little bit in the <code>WatchService</code>
Linux implementation.</p>
<p>Depending on the installed JDK distribution <code>sun.nio.fs.LinuxWatchService</code>
may or may not be available, however the source is available in the JDK
repository.
<a href="https://hg.openjdk.java.net/jdk8u/jdk8u/jdk/file/478a4add975b/src/solaris/classes/sun/nio/fs/LinuxWatchService.java"><code>sun.nio.fs.LinuxWatchService</code></a>
makes use of <code>inotify</code> and <code>inotify</code> has been around for a long time, it
is a proven technology to watch file-system events on Linux.</p>
<p>The issue has to be between the chair and the keyboard!</p>
<pre><code class="language-java">/**
 * Linux implementation of WatchService based on inotify.
 *
 * In summary a background thread polls inotify plus a socket used for the wakeup
 * mechanism. Requests to add or remove a watch, or close the watch service,
 * cause the thread to wakeup and process the request. Events are processed
 * by the thread which causes it to signal/queue the corresponding watch keys.
 */
</code></pre>
<p>In shorts <code>inotify</code> allows to register a <em>watch</em> and receive notifications
upon file-system change events. So let&rsquo;s try with the system tools in our
container in order to have a quick understanding of how it works.</p>
<p>First install <code>inotify-tools</code> in the running container.</p>
<pre><code class="language-bash">root@612f6247d0b7:/# apt-get update
...
root@612f6247d0b7:/# apt-get install -y inotify-tools
</code></pre>
<p>Then let&rsquo;s add a watch on <code>/etc/hosts</code> in shell session <em>A</em>, once
<em>established</em> modify the watched file in session <em>B</em>.</p>
<pre><code>############ terminal A ##############|############ terminal B ###########
root@612f6247d0b7:/# \                | 
  inotifywait -m /etc/hosts           | 
Setting up watches.                   | 
Watches established.                  | 
                                      | root@612f6247d0b7:/# \
                                      |   touch /etc/hosts
/etc/hosts OPEN                       | 
/etc/hosts ATTRIB                     | 
/etc/hosts CLOSE_WRITE,CLOSE          | 
</code></pre>
<p>In terminal <em>A</em>, the expected events are being observed, meaning that <code>inotify</code>
appears to be working as desired.</p>
<p>The question remains ; why is this working when using system tools but not in
the Java program?</p>
<p>Now remember that the Java <code>WatchService</code> API only allow to register a directory.</p>
<pre><code class="language-java">/**
 * A watch service that &lt;em&gt;watches&lt;/em&gt; registered objects for changes and
 * events. For example a file manager may use a watch service to monitor a
 * directory for changes so that it can update its display of the list of files
 * when files are created or deleted.
 * ...
 */
</code></pre>
<p>So let&rsquo;s try again with a watch on the <code>/etc</code> folder instead following the
same scenario: in shell session <em>A</em> set-up a watch, then once ready modify
the actual file in session <em>B</em>:</p>
<pre><code>############ terminal A ##############|############ terminal B ###########
root@612f6247d0b7:/# \                | 
  inotifywait -m /etc                 | 
Setting up watches.                   | 
Watches established.                  | 
                                      | root@612f6247d0b7:/# \
                                      |   touch /etc/hosts
/etc/ OPEN ld.so.cache                | 
/etc/ CLOSE_NOWRITE,CLOSE ld.so.cache | 
</code></pre>
<p>The first thing to notice is that in terminal <em>A</em>, a different set of events
are being observed ; but neither <code>ATTRIB</code> or <code>MODIFY</code> events and there&rsquo;s something
especially that catches our attention: the events are about <code>ld.so.cache</code>.</p>
<p>That&rsquo;s unexpected, let&rsquo;s try the same scenario on a different file in <code>/etc</code>,
that is a newly created file named <code>somefile</code></p>
<pre><code>############ terminal A ##############|############ terminal B ###########
root@612f6247d0b7:/# \                | 
  inotifywait -m /etc                 | 
Setting up watches.                   | 
Watches established.                  | 
                                      | root@612f6247d0b7:/# \
                                      |   touch /etc/somefile
/etc/ OPEN ld.so.cache                | 
/etc/ CLOSE_NOWRITE,CLOSE ld.so.cache | 
/etc/ CREATE somefile
/etc/ OPEN somefile
/etc/ ATTRIB somefile
/etc/ CLOSE_WRITE,CLOSE somefile
</code></pre>
<p>OK, we&rsquo;ve got <code>ld.so.cache</code> events plus the wanted events. If we run our
Java <code>WatchFile</code> program it is notified by the file change, as expected.</p>
<pre><code>############ terminal A ##############|############ terminal B ###########
root@612f6247d0b7:/# \                |
  java WatchFile /etc/somefile        | 
Watching : /etc/somefile              | # wait for WatchFile to be started
                                      | root@612f6247d0b7:/# \
                                      |   touch /etc/somefile
Modified : somefile                   |
  -&gt; : /etc/somefile                  |
</code></pre>
<p>This raises questions about <code>/etc/hosts</code> in particular, there is something that
prevents <code>inotify</code> to see the change if the watch is set up on the parent directory.</p>
<p>In the example with <code>/etc/hosts</code>, <code>inotify</code> only emitted <code>OPEN</code>,
<code>CLOSE_NO_WRITE</code> and <code>CLOSE</code> events, those events alone are not what
the Linux implementation expects in order to be notified of file
modifications (<a href="https://hg.openjdk.java.net/jdk8u/jdk8u/jdk/file/478a4add975b/src/solaris/classes/sun/nio/fs/LinuxWatchService.java#l382">source code (line 382)</a>).</p>
<h2 id="the-clue">The clue</h2>
<p>When reading the javadoc of <code>WatchService</code> one paragraph caught my eye :</p>
<pre><code class="language-java">/**
 * ...
 * &lt;p&gt; If a watched file is not located on a local storage device then it is
 * implementation specific if changes to the file can be detected. In particular,
 * it is not required that changes to files carried out on remote systems be
 * detected.
 * ...
 */
</code></pre>
<p>This means that changes carried out on remote filesystems may not be detected.
It&rsquo;s natural to think that <code>/etc/hosts</code> is present on the local filesystem, but
this code runs in a container, and containers <del>may</del> do fancy stuff especially
on the <code>hosts</code> file.</p>
<p>Let&rsquo;s have a look at mounts:</p>
<pre><code class="language-bash">root@612f6247d0b7:/# findmnt
TARGET                          SOURCE                                                                               FSTYPE  OPTIONS
/                               overlay                                                                              overlay rw,relatime,lowerdir=/var/lib/docker/overlay2/l/TZPBTDTJWKHEY
|-/proc                         proc                                                                                 proc    rw,nosuid,nodev,noexec,relatime
| |-/proc/bus                   proc[/bus]                                                                           proc    ro,relatime
| |-/proc/fs                    proc[/fs]                                                                            proc    ro,relatime
| |-/proc/irq                   proc[/irq]                                                                           proc    ro,relatime
| |-/proc/sys                   proc[/sys]                                                                           proc    ro,relatime
| |-/proc/sysrq-trigger         proc[/sysrq-trigger]                                                                 proc    ro,relatime
| |-/proc/acpi                  tmpfs                                                                                tmpfs   ro,relatime
| |-/proc/kcore                 tmpfs[/null]                                                                         tmpfs   rw,nosuid,size=65536k,mode=755
| |-/proc/keys                  tmpfs[/null]                                                                         tmpfs   rw,nosuid,size=65536k,mode=755
| |-/proc/timer_list            tmpfs[/null]                                                                         tmpfs   rw,nosuid,size=65536k,mode=755
| `-/proc/sched_debug           tmpfs[/null]                                                                         tmpfs   rw,nosuid,size=65536k,mode=755
|-/dev                          tmpfs                                                                                tmpfs   rw,nosuid,size=65536k,mode=755
| |-/dev/console                devpts[/0]                                                                           devpts  rw,nosuid,noexec,relatime,gid=5,mode=620,ptmxmode=666
| |-/dev/pts                    devpts                                                                               devpts  rw,nosuid,noexec,relatime,gid=5,mode=620,ptmxmode=666
| |-/dev/mqueue                 mqueue                                                                               mqueue  rw,nosuid,nodev,noexec,relatime
| `-/dev/shm                    shm                                                                                  tmpfs   rw,nosuid,nodev,noexec,relatime,size=65536k
|-/sys                          sysfs                                                                                sysfs   ro,nosuid,nodev,noexec,relatime
| |-/sys/firmware               tmpfs                                                                                tmpfs   ro,relatime
| `-/sys/fs/cgroup              tmpfs                                                                                tmpfs   ro,nosuid,nodev,noexec,relatime,mode=755
|   |-/sys/fs/cgroup/cpuset     cpuset[/docker/612f6247d0b7cae71c1373076d88f1b71f44e7fc44c5535564052260e2ed3ab8]     cgroup  ro,nosuid,nodev,noexec,relatime,cpuset
|   |-/sys/fs/cgroup/cpu        cpu[/docker/612f6247d0b7cae71c1373076d88f1b71f44e7fc44c5535564052260e2ed3ab8]        cgroup  ro,nosuid,nodev,noexec,relatime,cpu
|   |-/sys/fs/cgroup/cpuacct    cpuacct[/docker/612f6247d0b7cae71c1373076d88f1b71f44e7fc44c5535564052260e2ed3ab8]    cgroup  ro,nosuid,nodev,noexec,relatime,cpuacct
|   |-/sys/fs/cgroup/blkio      blkio[/docker/612f6247d0b7cae71c1373076d88f1b71f44e7fc44c5535564052260e2ed3ab8]      cgroup  ro,nosuid,nodev,noexec,relatime,blkio
|   |-/sys/fs/cgroup/memory     memory[/docker/612f6247d0b7cae71c1373076d88f1b71f44e7fc44c5535564052260e2ed3ab8]     cgroup  ro,nosuid,nodev,noexec,relatime,memory
|   |-/sys/fs/cgroup/devices    devices[/docker/612f6247d0b7cae71c1373076d88f1b71f44e7fc44c5535564052260e2ed3ab8]    cgroup  ro,nosuid,nodev,noexec,relatime,devices
|   |-/sys/fs/cgroup/freezer    freezer[/docker/612f6247d0b7cae71c1373076d88f1b71f44e7fc44c5535564052260e2ed3ab8]    cgroup  ro,nosuid,nodev,noexec,relatime,freezer
|   |-/sys/fs/cgroup/net_cls    net_cls[/docker/612f6247d0b7cae71c1373076d88f1b71f44e7fc44c5535564052260e2ed3ab8]    cgroup  ro,nosuid,nodev,noexec,relatime,net_cls
|   |-/sys/fs/cgroup/perf_event perf_event[/docker/612f6247d0b7cae71c1373076d88f1b71f44e7fc44c5535564052260e2ed3ab8] cgroup  ro,nosuid,nodev,noexec,relatime,perf_event
|   |-/sys/fs/cgroup/net_prio   net_prio[/docker/612f6247d0b7cae71c1373076d88f1b71f44e7fc44c5535564052260e2ed3ab8]   cgroup  ro,nosuid,nodev,noexec,relatime,net_prio
|   |-/sys/fs/cgroup/hugetlb    hugetlb[/docker/612f6247d0b7cae71c1373076d88f1b71f44e7fc44c5535564052260e2ed3ab8]    cgroup  ro,nosuid,nodev,noexec,relatime,hugetlb
|   |-/sys/fs/cgroup/pids       pids[/docker/612f6247d0b7cae71c1373076d88f1b71f44e7fc44c5535564052260e2ed3ab8]       cgroup  ro,nosuid,nodev,noexec,relatime,pids
|   `-/sys/fs/cgroup/systemd    cgroup[/docker/612f6247d0b7cae71c1373076d88f1b71f44e7fc44c5535564052260e2ed3ab8]     cgroup  ro,nosuid,nodev,noexec,relatime,name=systemd
|-/etc/resolv.conf              /dev/sda1[/docker/containers/612f6247d0b7cae71c1373076d88f1b71f44e7fc44c5535564052260e2ed3ab8/resolv.conf]
|                                                                                                                    ext4    rw,relatime,stripe=1024,data=ordered
|-/etc/hostname                 /dev/sda1[/docker/containers/612f6247d0b7cae71c1373076d88f1b71f44e7fc44c5535564052260e2ed3ab8/hostname]
|                                                                                                                    ext4    rw,relatime,stripe=1024,data=ordered
`-/etc/hosts                    /dev/sda1[/docker/containers/612f6247d0b7cae71c1373076d88f1b71f44e7fc44c5535564052260e2ed3ab8/hosts]
                                                                                                                     ext4    rw,relatime,stripe=1024,data=ordered
</code></pre>
<blockquote>
<p><em>You can find the same content in the container at the following location
<code>/proc/self/mountinfo</code>.</em></p>
</blockquote>
<p>The information above looks interesting, <code>/etc/hosts</code> appears to be a
<a href="http://man7.org/linux/man-pages/man8/mount.8.html"><em>bind mount</em></a> where the
source comes from another filesystem.
(To understand better what is a bind mound there&rsquo;s a more human and
pedagogic explanation in this
<a href="https://unix.stackexchange.com/questions/198590/what-is-a-bind-mount">StackExchange answer</a>).</p>
<p>When there&rsquo;s a <em>filesystem boundary</em> <code>inotify</code> encounter some
limitations in its ability to report events, the man page
is not quite clear on the matter though:</p>
<blockquote>
<pre><code>Limitations and caveats
      The inotify API provides no information about the user or process
      that triggered the inotify event.  In particular, there is no easy
      way for a process that is monitoring events via inotify to
      distinguish events that it triggers itself from those that are
      triggered by other processes.

      *Inotify reports only events that a user-space program triggers
      through the filesystem API.*  As a result, it does not catch remote
      events that occur on network filesystems.  *(Applications must fall
      back to polling the filesystem to catch such events.)*  Furthermore,
      various pseudo-filesystems such as /proc, /sys, and /dev/pts are not
      monitorable with inotify.

      The inotify API does not report file accesses and modifications that
      may occur because of mmap(2), msync(2), and munmap(2).
</code></pre>
</blockquote>
<p>source: <a href="http://man7.org/linux/man-pages/man7/inotify.7.html">man7.org</a></p>
<p>What this mean is that for some files and for <code>/etc/hosts</code> in this case
this constraint may cause some misbehavior for some tools,
e.g (non exhaustive list of issues) :</p>
<ul>
<li><a href="https://github.com/docker/for-mac/issues/2375">https://github.com/docker/for-mac/issues/2375</a></li>
<li><a href="https://github.com/moby/moby/issues/11705">https://github.com/moby/moby/issues/11705</a></li>
<li><a href="https://github.com/libuv/libuv/issues/1201">https://github.com/libuv/libuv/issues/1201</a></li>
</ul>
<p>Concretely this explains why the code was working when being tested with
JUnit 4&rsquo;s <code>TemporaryFolder</code> and on a physical machine because the watched
was not <em>bind mounted</em>.</p>
<h2 id="how-to-fix-this">How to fix this</h2>
<p>This knowledge is interesting, but the program still has to watch changes to this
file which in practice suggests two approaches:</p>
<ol>
<li>Either poll the file regularly</li>
<li>or use an implementation that leverage the right <code>inotify</code>
abstraction (i.e. that do not only allow to watch folder).</li>
</ol>
<p>Implementations for both approaches exist. However, at this time
I&rsquo;m uneasy to share a list or to recommend any as I do not have
sufficient experience with the second alternative and as such unable to
make a critical assessment comparing both.</p>
<p>Typically, when watching files there&rsquo;s some tricky details that cannot
be overlooked when using the whole set of events offered by <code>inotify</code>
or when considering other OS native file watching API. Additionally,
this may very well depend on the actual use case that has to be solved.</p>
<p>Note that this happened on <code>/etc/hosts</code>, but the same issue can happen
on any file that is <em>bind mounted</em> in the container, like it is customary
for configuration files (configmap) in Kubernetes.</p>
<h2 id="remaining-questions">Remaining questions</h2>
<p>The Java&rsquo;s <code>WatchService</code> design targets both simplicity and portability at
a time when containers (and their funky filesystem) were not a thing.</p>
<p>The API is flexible enough to enable the usage of the platform
specific features. I&rsquo;m certainly hoping for a way to tweak the
behavior of the Linux integration as the current one does not
yet support any modifiers
(<a href="https://hg.openjdk.java.net/jdk8u/jdk8u/jdk/file/478a4add975b/src/solaris/classes/sun/nio/fs/LinuxWatchService.java#l230"><code>// no modifiers supported at this time</code></a>)</p>
<p>This could be implemented this way:</p>
<blockquote>
<p>The WatchService API allows customization using <em>modifiers</em>
<code>WatchKey Path.register(WatchService watcher, WatchEvent.Kind&lt;?&gt;[] events, WatchEvent.Modifier... modifiers)</code>.
For example <code>com.sun.nio.file.SensitivityWatchEventModifier</code>.
Using this, it could be possible to tweak <code>inotify</code> usage.</p>
</blockquote>
<p>Also, why the Java watchservice only allow to register folders ?
Since there is some differences in the implementation already
why not relaxing the limitation for implementation to allow them
to watch files and in the case of Linux it would allow to leverage
the <code>inotify</code> event model. For backward compatibility this could be
enabled only when the right modifier is passed to <code>Path.register(...)</code>.</p>
<p>At this time I could only find these discussions on the matter:</p>
<ul>
<li><a href="http://mail.openjdk.java.net/pipermail/nio-dev/2010-September/thread.html#1059">http://mail.openjdk.java.net/pipermail/nio-dev/2010-September/thread.html#1059</a></li>
<li><a href="http://mail.openjdk.java.net/pipermail/nio-dev/2010-September/001070.html">http://mail.openjdk.java.net/pipermail/nio-dev/2010-September/001070.html</a></li>
</ul>

  </div>
  

<div class="navigation navigation-single">
    
    <a href="/2018/06/18/minikube-with-hyperkit/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">Minikube with hyperkit</span>
    </a>
    
    
    <a href="/2020/04/01/manage_dotfiles_with_chezmoi/" class="navigation-next">
      <span class="navigation-tittle">Managing dotfiles and secret with chezmoi</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  

  <script
    src="https://giscus.app/client.js"
    data-repo="bric3/bric3.github.io"
    data-repo-id="MDEwOlJlcG9zaXRvcnk2MDc3NjczMQ=="
    data-category="Blog Comments"
    data-category-id="DIC_kwDOA59hG84CR_S_"
    data-mapping="pathname"
    data-reactions-enabled="1"
    data-input-position="top"
    data-theme="preferred-color-scheme"
    data-lang="en"
    data-loading="lazy"
    data-strict="1"
    
    data-theme="preferred-color-scheme"
    crossorigin="anonymous"
    async
  ></script>


</article>


            
    
<footer>

 
 
 <div class="github-edit">
     <a href="https://github.com/bric3/bric3.github.io/edit/hugo-sources/content/posts/2019-09-13-watchservice-and-bind-mount.md">
     <i class="fab fa-github fa-lg" aria-hidden="true"></i> Edit this page
     </a>
 </div>
 















<script>
window.MathJax = {
  loader: {
    load: ['input/asciimath']
  },
  tex: {
    inlineMath: [['\\(', '\\)']],
    displayMath: [['\\[', '\\]']],
    tags: 'none'
  },
  asciimath: {
    delimiters: [['$', '$'], ['`', '`']]
  },
  options: {
    ignoreHtmlClass: 'nostem|nolatexmath|noasciimath',
    processHtmlClass: 'stemblock|latexmath|asciimath'
  },
  startup: {
    ready() {
      MathJax.startup.defaultReady();
      MathJax.startup.promise.then(() => {
        
        const asciimath = MathJax._.input.asciimath.AsciiMath?.AsciiMath;
        if (asciimath) {
          const originalCompile = asciimath.Compile;
          asciimath.Compile = function(latex, display) {
            const node = this.parseMath(latex);
            
            if (node && node.parentNode?.parentNode?.classList?.contains('stemblock')) {
              display = true;
            }
            return originalCompile.call(this, latex, display);
          };
        }
      });
    }
  }
};



</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/4.0.0/tex-mml-chtml.js" integrity="sha512-D0eU0TwZjXn2FsQXymdhToKse0yD7CFS6dQhhBQe5sUKYVp1hufw6lQtXxpvwBRj7dDjVJ858l2HEfktsOBv0A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js" integrity="sha512-EBLzUL8XLl+va/zAsmXwS7Z2B1F9HUHkZwyS/VKwh3S7T/U0nF4BaU29EP/ZSf6zgiIxYAnKLu6bJ8dqpmX5uw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script type="text/javascript">
        
        
        
        
        
        var mergeHTMLPlugin = (function () {
            'use strict';

            var originalStream;

            

            function escapeHTML(value) {
                return value
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#x27;');
            }

             

             
            const mergeHTMLPlugin = {
                
                "before:highlightElement": ({ el }) => {
                    originalStream = nodeStream(el);
                },
                
                "after:highlightElement": ({ el, result, text }) => {
                    if (!originalStream.length) return;

                    const resultNode = document.createElement('div');
                    resultNode.innerHTML = result.value;
                    result.value = mergeStreams(originalStream, nodeStream(resultNode), text);
                    el.innerHTML = result.value;
                }
            };

             

            


            

            function tag(node) {
                return node.nodeName.toLowerCase();
            }

            

            function nodeStream(node) {
                 
                const result = [];
                (function _nodeStream(node, offset) {
                    for (let child = node.firstChild; child; child = child.nextSibling) {
                        if (child.nodeType === 3) {
                            offset += child.nodeValue.length;
                        } else if (child.nodeType === 1) {
                            result.push({
                                event: 'start',
                                offset: offset,
                                node: child
                            });
                            offset = _nodeStream(child, offset);
                            
                            
                            
                            if (!tag(child).match(/br|hr|img|input/)) {
                                result.push({
                                    event: 'stop',
                                    offset: offset,
                                    node: child
                                });
                            }
                        }
                    }
                    return offset;
                })(node, 0);
                return result;
            }

            

            function mergeStreams(original, highlighted, value) {
                let processed = 0;
                let result = '';
                const nodeStack = [];

                function selectStream() {
                    if (!original.length || !highlighted.length) {
                        return original.length ? original : highlighted;
                    }
                    if (original[0].offset !== highlighted[0].offset) {
                        return (original[0].offset < highlighted[0].offset) ? original : highlighted;
                    }

                    

                    return highlighted[0].event === 'start' ? original : highlighted;
                }

                

                function open(node) {
                     
                    function attributeString(attr) {
                        return ' ' + attr.nodeName + '="' + escapeHTML(attr.value) + '"';
                    }
                    
                    result += '<' + tag(node) + [].map.call(node.attributes, attributeString).join('') + '>';
                }

                

                function close(node) {
                    result += '</' + tag(node) + '>';
                }

                

                function render(event) {
                    (event.event === 'start' ? open : close)(event.node);
                }

                while (original.length || highlighted.length) {
                    let stream = selectStream();
                    result += escapeHTML(value.substring(processed, stream[0].offset));
                    processed = stream[0].offset;
                    if (stream === original) {
                        

                        nodeStack.reverse().forEach(close);
                        do {
                            render(stream.splice(0, 1)[0]);
                            stream = selectStream();
                        } while (stream === original && stream.length && stream[0].offset === processed);
                        nodeStack.reverse().forEach(open);
                    } else {
                        if (stream[0].event === 'start') {
                            nodeStack.push(stream[0].node);
                        } else {
                            nodeStack.pop();
                        }
                        render(stream.splice(0, 1)[0]);
                    }
                }
                return result + escapeHTML(value.substr(processed));
            }

            return mergeHTMLPlugin;

        }());
        hljs.addPlugin(mergeHTMLPlugin);
        


        
        hljs.highlightAll();
    </script>
    

<script>


(function() {
  'use strict';

  
  function getScrollInfo(element, checkChildren = true) {
    let scrollLeft = element.scrollLeft;
    let scrollWidth = element.scrollWidth;
    const clientWidth = element.clientWidth;

    if (checkChildren) {
      
      const codeElement = element.querySelector('code');
      if (codeElement && codeElement.scrollWidth > scrollWidth) {
        scrollWidth = codeElement.scrollWidth;
        if (codeElement.scrollLeft > 0 || element.scrollLeft === 0) {
          scrollLeft = Math.max(scrollLeft, codeElement.scrollLeft);
        }
      }

      
      const tableElement = element.querySelector('table');
      if (tableElement && tableElement.scrollWidth > scrollWidth) {
        scrollWidth = tableElement.scrollWidth;
        if (tableElement.scrollLeft > 0 || element.scrollLeft === 0) {
          scrollLeft = Math.max(scrollLeft, tableElement.scrollLeft);
        }
      }
    }

    const maxScroll = scrollWidth - clientWidth;
    
    const hasOverflow = scrollWidth > clientWidth + 2;

    return { scrollLeft, scrollWidth, clientWidth, maxScroll, hasOverflow };
  }

  
  function applyScrollClasses(element, scrollInfo) {
    if (!scrollInfo.hasOverflow) {
      element.classList.remove('has-scroll-shadow-left', 'has-scroll-shadow-right');
      return;
    }

    
    if (scrollInfo.scrollLeft > 5) {
      element.classList.add('has-scroll-shadow-left');
    } else {
      element.classList.remove('has-scroll-shadow-left');
    }

    
    if (scrollInfo.scrollLeft < scrollInfo.maxScroll - 5) {
      element.classList.add('has-scroll-shadow-right');
    } else {
      element.classList.remove('has-scroll-shadow-right');
    }
  }

  
  function updateScrollShadows(element) {
    const scrollInfo = getScrollInfo(element);
    applyScrollClasses(element, scrollInfo);
  }

  function initScrollShadows() {
    
    const selectors = [
      '.post.adoc .literalblock pre',
      '.post.adoc .listingblock > .content > pre',
      '.post.adoc .openblock > .content > pre',  
      '.post.md pre',  
      '.table-wrapper',  
    ];

    const scrollables = document.querySelectorAll(selectors.join(', '));
    scrollables.forEach(element => {
      
      let scrollingElement = element;
      let targetElement = element;  

      
      let checkChildren = true;

      if (element.classList.contains('table-wrapper')) {
        
        const admonitionBlock = element.querySelector(':scope > .admonitionblock');
        if (admonitionBlock) {
          const computedStyle = window.getComputedStyle(admonitionBlock);
          if (computedStyle.overflowX === 'auto' || computedStyle.overflowX === 'scroll') {
            scrollingElement = admonitionBlock;  
            targetElement = element;  
            checkChildren = true;  
          }
        } else {
          
          const table = element.querySelector(':scope > table');
          if (table) {
            const computedStyle = window.getComputedStyle(table);
            if (computedStyle.overflowX === 'auto' || computedStyle.overflowX === 'scroll') {
              scrollingElement = table;  
              targetElement = element;  
              checkChildren = false;  
            }
          }
        }
      }

      
      const updateShadows = () => {
        const scrollInfo = getScrollInfo(scrollingElement, checkChildren);
        applyScrollClasses(targetElement, scrollInfo);
      };

      
      updateShadows();

      
      scrollingElement.addEventListener('scroll', updateShadows, { passive: true });

      
      if (checkChildren) {
        
        const codeElement = scrollingElement.querySelector('code');
        if (codeElement) {
          codeElement.addEventListener('scroll', updateShadows, { passive: true });
        }

        
        const tableElement = scrollingElement.querySelector('table');
        if (tableElement) {
          tableElement.addEventListener('scroll', updateShadows, { passive: true });
        }
      }
    });

    
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        scrollables.forEach(element => updateScrollShadows(element));
      }, 150);
    }, { passive: true });
  }

  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initScrollShadows);
  } else {
    initScrollShadows();
  }

  
  window.addEventListener('load', () => {
    setTimeout(() => {
      const selectors = [
        '.post.adoc .literalblock pre',
        '.post.adoc .listingblock > .content > pre',
        '.post.adoc .openblock > .content > pre',  
        '.post.md pre',
        '.table-wrapper'
      ];
      const scrollables = document.querySelectorAll(selectors.join(', '));
      scrollables.forEach(element => updateScrollShadows(element));
    }, 500);
  });

  
  window.debugScrollShadow = function(element) {
    if (typeof element === 'string') {
      element = document.querySelector(element);
    }
    if (!element) {
      console.error('Element not found');
      return;
    }
    updateScrollShadows(element);
  };

  
  window.refreshScrollShadows = function() {
    const selectors = [
      '.post.adoc .literalblock pre',
      '.post.adoc .listingblock > .content > pre',
      '.post.adoc .openblock > .content > pre',
      '.post.md pre',
      '.table-wrapper'
    ];
    const scrollables = document.querySelectorAll(selectors.join(', '));
    scrollables.forEach(element => {
      
      if (element.offsetParent === null) return;
      updateScrollShadows(element);
    });
  };
})();
</script>
<script type="text/javascript">

function children(element, selector) {
	if (!selector) return Array.from(element.children);
	return Array.from(element.children).filter(child => child.matches(selector));
}

function siblings(element, selector) {
	const sibs = Array.from(element.parentElement.children).filter(child => child !== element);
	return selector ? sibs.filter(sib => sib.matches(selector)) : sibs;
}

function getOffset(element) {
	const rect = element.getBoundingClientRect();
	return {
		top: rect.top + window.scrollY,
		left: rect.left + window.scrollX
	};
}

function addBlockSwitches() {
	document.querySelectorAll('.primary').forEach(primary => {
		const switchItem = createSwitchItem(primary, createBlockSwitch(primary));
		switchItem.item.classList.add("selected");
		const title = children(primary, '.title')[0];
		if (title) title.remove();
	});

	document.querySelectorAll('.secondary').forEach(secondary => {
		const primary = findPrimary(secondary);
		const switchElement = children(primary, '.switch')[0];
		const switchItem = createSwitchItem(secondary, switchElement);
		switchItem.content.classList.add('hidden');
		findPrimary(secondary).appendChild(switchItem.content);
		secondary.remove();
	});
}

function createBlockSwitch(primary) {
	const blockSwitch = document.createElement('div');
	blockSwitch.className = 'switch';
	primary.prepend(blockSwitch);
	return blockSwitch;
}

function findPrimary(secondary) {
	let candidate = secondary.previousElementSibling;
	while (candidate && !candidate.matches('.primary')) {
		candidate = candidate.previousElementSibling;
	}
	return candidate;
}

function createSwitchItem(block, blockSwitch) {
	const titleElement = children(block, '.title')[0];
	const blockName = titleElement ? titleElement.textContent : '';
	const contentElement = children(block, '.content')[0];
	const colist = block.nextElementSibling?.matches('.colist') ? block.nextElementSibling : null;
	if (contentElement && colist) {
		contentElement.appendChild(colist);
	}
	const item = document.createElement('div');
	item.className = 'switch--item';
	item.textContent = blockName;
	blockSwitch.appendChild(item);
	return {'item': item, 'content': contentElement};
}

function globalSwitch() {
	document.querySelectorAll('.switch--item').forEach(item => {
		const blockId = blockIdForSwitchItem(item);

		
		const newItem = item.cloneNode(true);
		item.parentNode.replaceChild(newItem, item);

		newItem.addEventListener('click', function() {
			const selectedText = this.textContent;
			window.localStorage.setItem(blockId, selectedText);

			
			const clickedSwitch = this.closest('.openblock.primary');

			
			const scrollTopBefore = window.scrollY;
			const offsetTopBefore = getOffset(clickedSwitch).top;

			Array.from(document.querySelectorAll(".switch--item"))
				.filter(el => blockIdForSwitchItem(el) === blockId)
				.filter(el => el.textContent === selectedText)
				.forEach(el => select(el));

			
			requestAnimationFrame(function() {
				requestAnimationFrame(function() {
					
					const offsetTopAfter = getOffset(clickedSwitch).top;

					
					const scrollAdjustment = offsetTopAfter - offsetTopBefore;

					if (Math.abs(scrollAdjustment) > 1) {
						window.scrollTo({
							top: scrollTopBefore + scrollAdjustment,
							behavior: 'instant'
						});
					}

					
					setTimeout(function() {
						if (typeof window.refreshScrollShadows === 'function') {
							window.refreshScrollShadows();
						}
					}, 0);
				});
			});
		});

		if (newItem.textContent === window.localStorage.getItem(blockId)) {
			select(newItem);
		}
	});
}

function blockIdForSwitchItem(item) {
	const idComponents = [];
	idComponents.push(item.textContent.toLowerCase());
	siblings(item, ".switch--item").forEach(sibling => {
		idComponents.push(sibling.textContent.toLowerCase());
	});
	return idComponents.sort().join("-");
}

function select(selected) {
	selected.classList.add('selected');
	siblings(selected).forEach(sib => sib.classList.remove('selected'));

	const parent = selected.parentElement;
	const selectedIndex = Array.from(parent.children).indexOf(selected);
	const contentElements = siblings(parent, ".content");

	if (contentElements[selectedIndex]) {
		contentElements[selectedIndex].classList.remove('hidden');
		contentElements.forEach((content, idx) => {
			if (idx !== selectedIndex) {
				content.classList.add('hidden');
			}
		});
	}
}


if (document.readyState === 'loading') {
	document.addEventListener('DOMContentLoaded', function() {
		addBlockSwitches();
		globalSwitch();
	});
} else {
	addBlockSwitches();
	globalSwitch();
}
</script>

<script type="text/javascript">
  
  
  window.addEventListener("load", () => {
    if (!'IntersectionObserver' in window) {
      return;
    }

    
    const sections = Array.from(document.querySelectorAll("section[id], h2[id], h3[id], h4[id], h5[id]"));
    const visibleSectionClass = "visible-section";

    
    
    const scrollHandler = entries =>
            entries.forEach(entry => {
              const section = entry.target;
              const sectionId = section.id;
              const sectionLink = document.querySelector(`a[href="#${sectionId}"]`);

              console.log(sectionId, sectionLink);
              console.log(entry)
              console.log(entry.intersectionRect.height / entry.rootBounds.height)

              if (entry.intersectionRatio > 0) {
                section.classList.add(visibleSectionClass);
                sectionLink.classList.add(visibleSectionClass);
              } else {
                section.classList.remove(visibleSectionClass);
                sectionLink.classList.remove(visibleSectionClass);
              }
            });

    
    const observer = new IntersectionObserver(scrollHandler);
    sections.map(section => {
      if (section.tagName === "SECTION") {
        return section;
      } else {
        
        
        
        
        
        
        
        
        let actualSectionContainer = section.parentElement;
        actualSectionContainer.id = section.id;
        return actualSectionContainer;
      }
    }).forEach(section => observer.observe(section));
  });

</script>






</footer>

    



        </div>
    </body>
</html>

