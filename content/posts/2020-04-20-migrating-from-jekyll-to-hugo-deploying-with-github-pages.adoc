---
authors: ["brice.dutheil"]
date: "2020-04-20T23:42:10+02:00"
tags: ["webpages", "jekyll", "staticsite", "hugo", "github pages", "github"]
slug: "migrating-from-jekyll-to-hugo-deploying-with-github-pages"
title: "Migrating From Jekyll to Hugo, deploying with Github Pages"
series: ["Jekyll to Hugo with Asciidoctor and GitHub"]
language: en
---

Moving away form Jekyll. Import is easy, but tackling important details 
(conserve links to article, conserve comments, migrate some jekyll liquid 
template, theme tweaking deployment) has been challenging sometime.

== Motivation

When started this blog in 2010 I went like a lot other to Wordpress 
as this was the one of the most common and easy way to write and publish
something, then I got pissed at Wordpress as it was a pain to maintain
and to write code, not to mention the speed, it was bad, then Github
announced _Github Pages_, this was a revelation : articles written in 
pure Markdown, no database or server to maintain, fast writing, fast page 
thanks to static files. There were quite a few things that were icky 
like theme modifications, and some Wordpress plugins that were simply 
not there, but once done it was a robust machine.

Now would like to write using **Asciidoc**.  

So what's wrong with Jekyll with Github Pages.

 * GitHub Pages for good reasons limit what can be executed on their
   server, that means limited jekyll plugins, and with limited plugins 
   comes limited theme choice.
 * Generating the files locally is hazardous, because you need to keep the same
   configuration as the one used by Github Pages, I was fist installing Ruby 
   packages, but that was resolved when I switched to a docker images.  
 * You basically to fork or copy the theme files in the repo, making difficult 
   to track change from upstream while keeping your local changes.
 * I want to write in **Asciidoc** as it offers more way to layout information
   in the article.   

I could have chosen to simply use a Jekyll Asciidoc plugin, generate the static 
files and push them to Github in an automated way. There's now decent 
alternatives to consider, like Hugo, to be fair it's the only thing I tried
because of it's _native_ `asciidoctor` support. And it has other interesting 
aspects: 
  
 * Just one executable
 * Really fast to generate (with markdown content), not that jekyll was too slow 
   for me, but the speed is noticeable.
 * Theme (from another repo) and content are well separated
 * Templating and overrides is superior in my opinion
 * Support more than markdown if external tool are available like `asciidoctor`.
 * Multi lingual content supported 

This long article won't talk much about Asciidoc, but much more about the migration 
phase as there was a lot of rocks on the road. Let's start by the first step: 
Importing Jekyll blog.

== Importing from Jekyll

[source, bash]
----
â¯ hugo import jekyll --log ../bric3.github.io .
Importing...
Congratulations! 42 post(s) imported!
Now, start Hugo by yourself:
$ git clone https://github.com/spf13/herring-cove.git ./themes/herring-cove
$ cd .
$ hugo server --theme=herring-cove
â¯ git clone https://github.com/achary/engimo.git ./themes/engimo
Cloning into './themes/herring-cove'...
remote: Enumerating objects: 40, done.
remote: Counting objects: 100% (40/40), done.
remote: Compressing objects: 100% (27/27), done.
remote: Total 4367 (delta 14), reused 26 (delta 12), pack-reused 4327
Receiving objects: 100% (4367/4367), 4.77 MiB | 6.88 MiB/s, done.
Resolving deltas: 100% (2270/2270), done.
----

Letâ€™s run the server to see that basic import works

[source, bash]
----
â¯ hugo server --theme=engimo

                   | EN
-------------------+------
  Pages            | 294
  Paginator pages  |   4
  Non-page files   |   0
  Static files     | 106
  Processed images |   0
  Aliases          | 127
  Sitemaps         |   1
  Cleaned          |   0

Built in 170 ms
Watching for changes in /Users/bric3/private/bric3-hugo/{archetypes,content,data,layouts,static,themes}
Watching for config changes in /Users/bric3/private/bric3-hugo/config.yaml
Environment: "development"
Serving pages from memory
Running in Fast Render Mode. For full rebuilds on change: hugo server --disableFastRender
Web Server is available at http://localhost:1313/ (bind address 127.0.0.1)
Press Ctrl+C to stop
----

But nothingâ€™s there. 

What I missed is that I actually needed to copy the `config.yaml|toml`  configuration 
example file from the themeâ€™s `exampleSite` folder.  Eventually depending on the theme, 
this file format may be `yaml` or `tool` format, my theme one was a `toml` file, so 
I had to remove the `yaml` configuration file that was generated by the Hugo import; 
the generated content was pretty thin so that was easy to port over the `config.toml`.

[source,bash]
----
cp themes/hyde-hyde/exampleSite/config.toml .
rm config.yaml 
----

Also, I noticed itâ€™s easier to switch theme by not using the command line flag `--theme=<theme>` 
and instead use the configuration file `config.yaml|toml` instead by using the 
`theme` field. And simply run `hugo server`.

[source,toml]
----
theme = "hyde-hyde"
----

By the way hereâ€™s what my directory structure looks like, before I perform some 
changes to fix some issues

[source]
----
/Users/bric3/private/bric3-hugo
â”œâ”€â”€archetypes
â”œâ”€â”€config.toml
â”œâ”€â”€content
â”‚  â”œâ”€â”€post
â”‚  â”‚  â”œâ”€â”€2010-01-24-hello-world.md
â”‚  â”‚  â”œâ”€â”€2010-02-09-a-propos-de-joda-time.md
â”‚  â”‚  â”œâ”€â”€2010-02-12-une-fuite-memoire-beaucoup-de-reflection-et-pas-de-outofmemoryerror.md
â”‚  â”‚  â”œâ”€â”€2010-02-16-les-collections-par-google-comment-sy-retrouver.md
â”‚  â”‚  â””â”€â”€37 unlisted
â”œâ”€â”€data
â”œâ”€â”€layouts
â”œâ”€â”€resources
â”‚  â””â”€â”€_gen
â”‚     â”œâ”€â”€assets â€¦
â”‚     â””â”€â”€images
â”œâ”€â”€static
â”‚  â”œâ”€â”€assets
â”‚  â”‚  â”œâ”€â”€0x304D-ki-hiragana.png
â”‚  â”‚  â”œâ”€â”€0x6C23-chi.png
â”‚  â”‚  â”œâ”€â”€add_new_jsdk.png
â”‚  â”‚  â”œâ”€â”€application-gc.png
â”‚  â”‚  â””â”€â”€20 unlisted
â”‚  â”œâ”€â”€CNAME
â”‚  â”œâ”€â”€css
â”‚  â”‚  â”œâ”€â”€highlightjs.piperita.scss
â”‚  â”‚  â”œâ”€â”€jquery.mmenu.all.css
â”‚  â”‚  â”œâ”€â”€simplebar.css
â”‚  â”‚  â””â”€â”€style.scss
â”‚  â”œâ”€â”€favicons
â”‚  â”‚  â”œâ”€â”€android-chrome-144x144.png
â”‚  â”‚  â”œâ”€â”€android-chrome-192x192.png
â”‚  â”‚  â”œâ”€â”€android-chrome-36x36.png
â”‚  â”‚  â””â”€â”€26 unlisted
â”‚  â”œâ”€â”€js
â”‚  â”‚  â”œâ”€â”€jekyll-search.js
â”‚  â”‚  â””â”€â”€jquery.mmenu.min.all.js
â”‚  â”œâ”€â”€search.json
â”‚  â””â”€â”€serve.sh
â””â”€â”€themes
   â”œâ”€â”€hyde-hyde
   â”‚  â”œâ”€â”€archetypes â€¦
   â”‚  â”œâ”€â”€assets â€¦
   â”‚  â”œâ”€â”€CHANGELOG.md
   â”‚  â”œâ”€â”€exampleSite â€¦
   â”‚  â””â”€â”€7 unlisted
   â””â”€â”€slick
      â”œâ”€â”€_assets â€¦
      â”œâ”€â”€_sites â€¦
      â”œâ”€â”€archetypes â€¦
      â”œâ”€â”€build-site.js
      â””â”€â”€12 unlisted
----


== A long way to fix the small issues

Right now finding the theme that works for your blog is one of the most 
time-consuming tasks, as you need to identify which feature you need and 
how to migrate, I've been trying several themes to see how they work, one 
aspect that I didnâ€™t quite like is that you need to adapt for each theme 
the configuration file.

Especially the section `[params]` which is used by the theme templates, 
and each theme differ well enough for that to be a cumbersome process. 
At this point itâ€™s really a good thing to read the 
https://gohugo.io/getting-started/configuration/[Hugo configuration documentation].

=== Fixing the post permalinks

My current blog expose posts with the following path

[source]
----
https://blog.arkey.fr/2020/04/02/manage_dotfiles_with_chezmoi/
----

The default configuration exposed these links as

[source]
----
http://localhost:1313/posts/2020-04-01-manage_dotfiles_with_chezmoi/
----

After some search I found these can tweaked with the 
https://gohugo.io/content-management/urls/[permalink setting], I donâ€™t 
know exactly why but this was only taken in account after the `[params]` 
section.

[source,toml]
----
[permalinks]
    posts = "/:year/:month/:day/:title/"
----

Which made the post accessible to this url.

[source]
----
http://localhost:1313/2020/04/01/managing-dotfiles-and-secret-with-chezmoi/
----

At some point I might be considering the use of Hugo 
https://gohugo.io/content-management/urls/#aliases[aliases] and change 
the urls of the post to something like

[source]
----
http://localhost:1313/posts/2020/04/01/managing-dotfiles-and-secret-with-chezmoi/
----

â€¦

Actually I got this wrong, Jekyllâ€™s permalink configuration `/:year/:month/:day/:title` 
has a small _unusual_ thing, when reading the doc :

> |===
> | `title`  
> | Title from the **documentâ€™s filename**. May be overridden via the 
> documentâ€™s `slug` front matter.
> |===

So when setting `/:year/:month/:day/:title/` in Hugo `config.toml` the permalink 
are not exactly what I hoped them to be, this actually the title from the 
_front matter_ of the article. I had to resort to the technic used in this blog 
https://www.dev-eth0.de/2019/07/13/convert-jekyll-to-hugo-permalinks/[Convert Jekyll to Hugo Permalinks] 
to keep the same permalinks.

[source,bash]
----
cd content/posts
for f in *.md;
do
  base=`basename "$f" '.md' | cut -f 4- -d '-'`
  gsed -i "s/title:/slug: $base\ntitle:/" "$f"
done
----

`gsed` is gnu-sed from `brew install gnu-sed` on MacOs. Because newlines 
don't work with the BSD `sed` .




=== Adding custom pages
My Jekyll site had some other pages, those where located in the `_pages` 
of my Jekyll site. In order to understand how the site works, I needed 
to read https://gohugo.io/content-management/organization/[content organization documentation].
The only thing I had to do is copy these files over the `content` 
directory of the Hugo site.

[source]
----
/Users/bric3/private/bric3-hugo
â”œâ”€â”€archetypes
â”œâ”€â”€config.toml
â”œâ”€â”€content
â”‚  â”œâ”€â”€cool-stuff.md
â”‚  â”œâ”€â”€post
â”‚  â”‚  â”œâ”€â”€2010-01-24-hello-world.md
â”‚  â”‚  â”œâ”€â”€2010-02-09-a-propos-de-joda-time.md
â”‚  â”‚  â”œâ”€â”€2010-02-12-une-fuite-memoire-beaucoup-de-reflection-et-pas-de-outofmemoryerror.md
â”‚  â”‚  â”œâ”€â”€2010-02-16-les-collections-par-google-comment-sy-retrouver.md
â”‚  â”‚  â””â”€â”€37 unlisted
â”‚  â””â”€â”€whoami.md
----

Itâ€™s even possible to do a layout like that.

[source]
----
/Users/bric3/private/bric3-hugo
â”œâ”€â”€archetypes
â”œâ”€â”€config.toml
â”œâ”€â”€content
â”‚  â”œâ”€â”€cool-stuff
â”‚  â”‚  â””â”€â”€index.md
â”‚  â”œâ”€â”€post
----

I preferred the easy way in regard of these page content. Also, I wanted 
my post in the `posts` folder instead of `post`, I just had to rename 
the folder and that was it.

Finally, in order to access the content I needed to add the menu entries, 
like that. I didnâ€™t need to read the https://gohugo.io/content-management/menus/[menu documentation] 
for it to work, but thereâ€™s more stuff possible when going over it.

[source,toml]
----
[menu]
    [[menu.main]]
        identifier = "post"
        name = "Posts"
        title = "All posts"
        url = "/posts/"
        weight = 1

    # ...

    [[menu.main]]
        identifier = "whoami"
        name = "Who Am I ?"
        title = "About me"
        weight = 4
        url = "/whoami/"

    # ...
----


=== Accents (diacritical marks) in some url

This will be appreciated for languages that have diacritical marks like 
French. So defining the permalink with `/:year/:month/:day/:title/` lead 
to use the post title for the link, however some have accent that are 
then url-encoded :

[source]
----
http://localhost:1313/2012/07/30/script-dinstallation-du-jdk-5-sur-macosx-lion-et-mountain-lion-mis-%C3%A0-jour/
----

I didnâ€™t find it in the Hugo doc, but in the Hugo issue tracker, it's possible 
to add in the `config.toml`, this setting is not part of any section.

[source,toml]
----
removePathAccents = true
----

Will then make the urls as follows :

[source]
----
http://localhost:1313/2012/07/30/script-dinstallation-du-jdk-5-sur-macosx-lion-et-mountain-lion-mis-a-jour/
----


=== Migrate Jekyll related stuff

==== Migrate Jekyll liquid template to Hugo

 * `{{ site.baseurl }}` for images, simply removed as website base url 
    starts with `/assets` too.

// Escaped shortcode there using /* ... */ (https://liatas.com/posts/escaping-hugo-shortcodes/)
 * `{% comment %} ... {% endcomment %}` => comments are tricky, if it's a 
shortcake, this is part of the markdown generation and using html comment
may work `<!-- {{</* shortcode */>}} -->`. But for notes taken during
articles, in the end I created my own shortcode `draftNotes`.
+
[source]
----
{{ if .Site.Params.DisplayDraftNotes }}
{{ .Inner | markdownify }}
{{ end }}
----
 * `{% if ... %} {% endif %}` was used to comment stuff, it's replaced by `draftNotes` shortcode.
 * `{% gist gist_id %}` => `{{< gist user_name gist_id >}}`
 * `{% raw %} {% endraw %}` there's nothing to do here for me, this directive 
disables Jekyll processing for text having `{{ ... }}` which Jekyll
interpreted as Jekyll template.
 * `{:.alternate}` => used by _kramdown_ to apply a CSS style, it can be removed

I had to read the https://gohugo.io/content-management/shortcodes/[shortcodes documentation] 
and look at how to https://gohugo.io/templates/shortcode-templates/[create my own shortcode].


==== Amazon links

They are just as other Jekyll liquid template :

[source]
----
{{ amazon_product_image_link | replace:'$asin$','0132350882' | replace:'$size$',img_size }}
----

These can be easily changed to a shortcode. Hugo doc for example showcase 
the `figure` shortcode:

// Escaped shortcode there using /* ... */ (https://liatas.com/posts/escaping-hugo-shortcodes/)
[source]
----
{{</* figure src="/media/spf13.jpg" title="Steve Francia" */>}}
----

// Escaped shortcode there using /* ... */ (https://liatas.com/posts/escaping-hugo-shortcodes/)
I've crafted my own simple shortcode for Amazon `{{</* amzn "B07XW76VHZ" */>}}` :

[source,html]
----
<a href="https://www.amazon.com/exec/obidos/ASIN/{{ $itemId }}/" class="amazon-shortcode" target="\_blank">
    <figure>
        {{- if eq (len .Params) 1 -}}
        <img src="https://images-na.ssl-images-amazon.com/images/P/{{ $itemId }}.jpg"/>
        {{- else if eq (len .Params) 2 -}}
        {{- $imageId := .Get 1 -}}
        <img src="https://images-na.ssl-images-amazon.com/images/I/{{ $imageId }}.jpg"/>
        {{- end -}}
    </figure>
</a>
----
 
By the way I have found this 
https://www.thepolyglotdeveloper.com/2019/01/create-custom-shortcodes-embed-content-hugo-posts-pages/[blog post] 
interesting to read to craft my own shortcodes.

{{< draftNotes >}}
* https://gist.github.com/fuka/33f68aff8ae3a9a3416d2f1aadd36426
{{< /draftNotes >}}

==== Migrate inline HTML in the markdown content

The following HTML elements will be omitted in the rendered page

[source,markdown]
----
<div class="table-wrapper" markdown="block">
| Markdown table |
</div>
----

[source,html]
----
<!-- raw HTML omitted -->
<table>...</table>
<!-- raw HTML omitted -->
----

Hugo `0.69` uses Goldmark to render markdown, and it has a setting allow inline HTML

[source,toml]
----
[markup]
  defaultMarkdownHandler = "goldmark"
  [markup.goldmark]
    [markup.goldmark.renderer]
      unsafe = true
----

But for safety, and self documentation, I'd prefer to migrate those to 
shortcodes as well, like `wrapTable` for this one.

[source,html]
----
<div class="table-wrapper">
{{ .Inner | markdownify }}
</div>
----

I encountered an issue however when the table itself has shortcodes. This 
break table rendering. The only way to support that is to use/create 
shortcodes for opening and for closing the `div` in this cases.


=== Cleanup

The Hugo import command copied over a few Jekyll stuffs that are not 
anymore useful. So git gives me these files for example that could be 
removed. I included the favicon as well, as I wanted some refresh.

[source]
----
	renamed:    css/highlightjs.piperita.scss -> static/css/highlightjs.piperita.scss
	renamed:    css/jquery.mmenu.all.css -> static/css/jquery.mmenu.all.css
	renamed:    css/simplebar.css -> static/css/simplebar.css
	renamed:    css/style.scss -> static/css/style.scss
	renamed:    favicons/README.md -> static/favicons/README.md
	renamed:    favicons/android-chrome-144x144.png -> static/favicons/android-chrome-144x144.png
    ...
	renamed:    favicons/favicon.ico -> static/favicons/favicon.ico
	renamed:    js/jekyll-search.js -> static/js/jekyll-search.js
	renamed:    js/jquery.mmenu.min.all.js -> static/js/jquery.mmenu.min.all.js
	renamed:    search.json -> static/search.json
----

[source]
----
rm -rf static/{css,js,favicons,search.json}
----

However, the `CNAME` file has been moved to `static` folder, which is wrong, 
letâ€™s put it back at the root of the git repository.

[source]
----
renamed:    CNAME -> static/CNAME
----


Remove unused Hugo themes

[source]
----
rm -rf themes/slick
----


Adapt my `.gitignore`

[source]
----
# Created by https://www.gitignore.io/api/hugo
# Edit at https://www.gitignore.io/?templates=hugo

### Hugo ###
# Generated files by hugo
/public/
/resources/_gen/

# Executable may be added to repository
hugo.exe
hugo.darwin
hugo.linux

# End of https://www.gitignore.io/api/hugo
----

=== Paginate post list page

I found this issue https://github.com/htr3n/hyde-hyde/issues/18[#18 on Hyde-hyde theme], 
however this issue referred to an old version of the theme which has 
since been updated.

One thing that is interesting and useful is how Hugo allows overriding 
parts of a theme. The themes are located in the `./theme` folder, e.g.

[source]
----
/Users/bric3/private/bric3-hugo/themes/hyde-hyde
â”œâ”€â”€archetypes
â”‚  â””â”€â”€default.md
â”œâ”€â”€assets
â”‚  â””â”€â”€scss
â”‚     â”œâ”€â”€hyde-hyde â€¦
â”‚     â”œâ”€â”€hyde-hyde.scss
â”‚     â””â”€â”€4 unlisted
â”œâ”€â”€CHANGELOG.md
â”œâ”€â”€exampleSite
â”‚  â”œâ”€â”€config.toml
â”‚  â”œâ”€â”€content
â”‚  â”‚  â”œâ”€â”€about.md
â”‚  â”‚  â”œâ”€â”€portfolio â€¦
â”‚  â”‚  â””â”€â”€posts â€¦
â”‚  â”œâ”€â”€layouts
â”‚  â””â”€â”€static
â”‚     â””â”€â”€img â€¦
â”œâ”€â”€images
â”‚  â”œâ”€â”€main.png
â”‚  â”œâ”€â”€mobile.png
â”‚  â”œâ”€â”€portfolio.png
â”‚  â”œâ”€â”€post.png
â”‚  â”œâ”€â”€screenshot.png
â”‚  â””â”€â”€tn.png
â”œâ”€â”€layouts
â”‚  â”œâ”€â”€404.html
â”‚  â”œâ”€â”€_default
â”‚  â”‚  â”œâ”€â”€baseof.html
â”‚  â”‚  â”œâ”€â”€list.html
â”‚  â”‚  â””â”€â”€single.html
â”‚  â”œâ”€â”€about
â”‚  â”‚  â””â”€â”€single.html
â”‚  â”œâ”€â”€index.html
â”‚  â”œâ”€â”€partials
â”‚  â”‚  â”œâ”€â”€footer â€¦
â”‚  â”‚  â”œâ”€â”€header â€¦
â”‚  â”‚  â””â”€â”€9 unlisted
â”‚  â”œâ”€â”€portfolio
â”‚  â”‚  â””â”€â”€list.html
â”‚  â””â”€â”€shortcodes
â”‚     â”œâ”€â”€fig.html
â”‚     â”œâ”€â”€kbd.html
â”‚     â””â”€â”€3 unlisted
â”œâ”€â”€LICENSE.md
â”œâ”€â”€README.md
â”œâ”€â”€resources
â”‚  â””â”€â”€_gen
â”‚     â””â”€â”€assets â€¦
â”œâ”€â”€static
â”‚  â”œâ”€â”€apple-touch-icon-144-precomposed.png
â”‚  â”œâ”€â”€css
â”‚  â”‚  â”œâ”€â”€hugo-toc.css
â”‚  â”‚  â”œâ”€â”€hugo-toc.css.map
â”‚  â”‚  â”œâ”€â”€hyde-hyde.css
â”‚  â”‚  â””â”€â”€9 unlisted
â”‚  â”œâ”€â”€favicon.png
â”‚  â””â”€â”€img
â”‚     â”œâ”€â”€hugo.png
â”‚     â”œâ”€â”€menu-close-dark.svg
â”‚     â”œâ”€â”€menu-close.svg
â”‚     â””â”€â”€2 unlisted
â””â”€â”€theme.toml
----

In order to override parts of the theme itâ€™s possible to copy the file 
in the root of the Hugo site (following the same directory structure). For post 
lists, I identified two files in the theme directory :

 * `layouts/partials/page-list/content.html`
 * `layouts/partials/posts-list.html`

These files need to be copied over the root of the Hugo site with the 
same relative path. And modify them as needed.

.layouts/partials/page-list/content.html
[source,diff]
----
--- 1/themes/hyde-hyde/layouts/partials/page-list/content.html
+++ 2/layouts/partials/page-list/content.html
@@ -1,6 +1,4 @@
 <span class="section__title">{{ .Title }}</span>
 <ul class="posts">
-    {{ with .Data.Pages }}
-        {{ partial "posts-list.html" . }}
-    {{ end }}
-</ul>
+    {{ partial "posts-list.html" . }}
+</ul>
----

.layouts/partials/posts-list.html
[source,diff]
----
--- 1/themes/hyde-hyde/layouts/partials/posts-list.html
+++ 2/layouts/partials/posts-list.html
@@ -1,6 +1,7 @@
-{{ range . }}
+{{ $paginator := .Paginate (where .Pages "Type" "in" "posts") }}
+{{ template "_internal/pagination.html" . }}
+<br/>
+{{ range $paginator.Pages }}
 <li>
     <a href="{{ .RelPermalink }}" {{if .Draft}}class="draft"{{end}}>{{ .Title }}</a>
       {{if not .Date.IsZero}}
       <time class="pull-right hidden-tablet">{{ .Date.Format (.Site.Params.dateformat | default "Jan 02 '06") }}</time>
@@ -8,3 +9,4 @@
   </span>
 </li>
 {{ end }}
+<br/>
+{{ template "_internal/pagination.html" . }}
----

Here Iâ€™m using the Hugo internal template for pagination but one can 
image using a custom template. The `.Paginate` directive was taken 
from https://gohugo.io/templates/pagination/[pagination doc], however 
the doc have a slight issue, the where query needs to be 
`where .Pages â€œTypeâ€ â€œinâ€ â€œpostsâ€` keyword.

However, I noted that other lists do not render anymore, for example 
`/tags` or `/series`, this is because the file we modified affect all 
list based page, search where the `page-list/content.html` partial is 
used raises the general `list.html` located there 
`themes/hyde-hyde/layouts/_default/list.html`. Since I want the pagination 
only for posts at this time, I just have to create a structure like 
this in my root Hugo site.

[source]
----
/Users/bric3/private/bric3-hugo/layouts
â”œâ”€â”€index.html
â”œâ”€â”€partials
â”‚  â””â”€â”€posts
â”‚     â””â”€â”€content.html
â””â”€â”€posts
   â””â”€â”€list.html
----

I created a `posts` folder in the `layouts` directory and in the `layouts/partials`, 
then I moved the file `layouts/partials/page-list/content.html` 
to `layouts/partials/posts/content.html` and merged the content 
of `layouts/partials/posts-list.html` replacing the Hugo function 
`{{ partial "posts-list.html" . }}`, and I removed this file as it breaks other 
_taxinomies_. Finally, I had to create the `layouts/posts/list.html` file, that 
invokes `{{ partial "posts/content.html" . }}`.


=== Tweak landing page number of posts

Here I needed to modify the index layout to only display the last _X_ recent post.

.layouts/index.html
[source,diff]
----
--- 1/themes/hyde-hyde/layouts/index.html
+++ 2/layouts/index.html
@@ -4,7 +4,7 @@

 {{ define "content" }}
   <div class="post-list">
-    {{ $paginator := .Paginate (where .Site.RegularPages "Type" "in" site.Params.mainSections) }}
+    {{ $paginator := .Paginate (first .Site.Params.landingLastPosts (where .Site.RegularPages "Type" "in" site.Params.mainSections)) }}
     {{ range $paginator.Pages }}
       {{ if .Draft }}
         {{ .Scratch.Set "draftPage" true }}
----

This trick is not current as you need to _wrap_ the query part with 
the `first` function `(first .Site.Params.landingLastPosts <query>)`, 
and I added `landingLastPosts` in the params section.

[source,toml]
----
[params]
    landingLastPosts = 5
----

=== Comments with Disqus

**EDIT:** the comment system has been link:/2022/10/16/moving-from-disqus-to-giscus/[migrated from Disqus to Giscus].

So Hugo supports https://gohugo.io/content-management/comments/#add-disqus[Disqus comments], 
but the thing is that site is generated by a theme and the theme may 
or may not handle comments as you wished, so it's necessary to look 
at how it's done in Hugo and in the theme depending on the requirements. 

For my Jekyll site, my comments had to be migrated from a Wordpress engine, 
posts on Wordpress have different Disqus identifier that is now specified 
in the front matter, and this identifier was passed to Disqus script 
configuration. Here's my Jekyll website relevant part:

[source,html]
----
<script type=â€œtext/javascriptâ€>
    function disqus_config() {
        this.experiment.enable_scroll_container = true;
        this.page.url = â€œ{{ site.cname }}{{ page.url }}â€;  // Replace PAGE_URL with your pageâ€™s canonical URL variable
        this.page.identifier = â€˜{% if page.disqus_identifier %}{{ page.disqus_identifier}}{% else %}{{ site.cname }}{{ page.url }}{% endif %}â€™; // Replace PAGE_IDENTIFIER with your pageâ€™s unique identifier variable
    }
    var disqus_shortname = "{{ site.disqus_account }}"; // required: replace example with your forum shortname
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
----

This script was crafted manually to pass identifier coming from the old 
days when it was powered by Wordpress. Looking at the Hugo 
https://github.com/gohugoio/hugo/blob/master/tpl/tplimpl/embedded/templates/disqus.html[template for Disqus], 
I know there are other elements of the page configuration that are actually 
passed over to Disqus.

[source]
----
{{with .Params.disqus_identifier }}this.page.identifier = '{{ . }}';{{end}}
{{with .Params.disqus_title }}this.page.title = '{{ . }}';{{end}}
{{with .Params.disqus_url }}this.page.url = '{{ . | html  }}';{{end}}
----

So that's interesting but life isn't that simple as theme may override as well
internal template by their own; the theme I chose uses a template that doesn't 
use the Hugo internal to initialise Disqus script, my them file is located at 
`layouts/partials/page-single/comment/disqus.html`. THa leaves me no choice but to
to override this partial comment template of the theme 
`layouts/partials/page-single/post-comment.html`, it this I merged the Hugo 
internal template, and I tweaked the template of the script initialization 
to behave the same as my old Jekyll site. The most important bit is here :

[source]
----
this.page.identifier = {{with .Params.disqus_identifier }}'{{ . }}'{{else}}{{ printf "'%s%s'" .Site.Params.disqusIdentifierBaseURL .RelPermalink | safeJS }}{{end}};
this.page.title = {{with .Params.disqus_title }}'{{ . }}'{{ else }}'{{ .Title }}'{{end}};
this.page.url = {{with .Params.disqus_url }}'{{ . | html  }}'{{else}}{{ printf "'%s%s'" .Site.Params.disqusIdentifierBaseURL .RelPermalink | safeJS }}{{end}};
----

_Also for reasons that I don't understand, the `.RelPermalink` / `.Permalink` 
Hugo functions escape the URL's slashes with backslashes when the template 
function is placed inside a single quotes  of the JS script. The only 
workaround was to use `printf "'%s%s'"` then pipe to `safeJS` function._

Then just in case the admin is available here 
`https://<you disqus short code>.disqus.com/admin/settings/general/`.

=== Tie together the permalink, and the Disqus content with the `slug` for new posts

Now permalinks for **posts** are defined as `/:year/:month/:day/:slug/`, the `slug`  
is a special entry that is computed by Hugo or set in the front matter of the 
content page. And the permalinks are used as Disqus identifiers. In order to have 
stable permalinks and Disqus identifiers if changing the generation backend, 
it's better to write it down. 

I name my posts with a date then a string that is likely the title of the post, 
e.g. `2020-04-01-manage_dotfiles_with_chezmoi.md`. With the permalink structure 
in mind I need my `slug` as the part of the filename after the date.

So let's use the Hugo archetypes that will allow us to create a new post. 
It can be simply done by creating a file `archetypes/posts.md` with a content like:

[source,markdown]
----
---
authors: ["brice.dutheil"]
date: "{{ .Date }}"
language: en
draft: true
tags: ["cool"]
slug: "{{ .Name | replaceRE "\\d{4}-\\d{2}-\\d{2}-(.*)" "$1" }}"
title: "{{ .Name | replaceRE "\\d{4}-\\d{2}-\\d{2}-(.*)" "$1" | title }}"
---

Example content
----

The `slug` then becomes the part of the file without the date. Note that this archetype
file can be easily duplicated as an Asciidoc file by adding a `posts.adoc`.

However, for now it's necessary to write manually at the beginning of the 
filename the ISO-8601 date, meaning we have to write : 

[source,bash]
----
hugo new posts/2020-04-14-migrating-from-jekyll-to-hugo.md
----


{{< draftNotes >}}

=== Summary with style

See https://discourse.gohugo.io/t/markdown-content-renders-as-regular-text-in-summary/1396/7[Markdown content renders as regular text in summary - support - HUGO]
Maybe not possibleâ€¦

{{< /draftNotes >}}


== Automate deployment on Github Pages

As Iâ€™m using Github Pages to host this site, and it only supports Jekyll 
based website for automatic site generation. This is nice to avoid only 
technical maintenance for me, but with Hugo this is a different story. I need 
to actually generate the website, then push it to a special branch. Let's try 
to do that manually before going automatic.

=== Manual deployment of the static files

So that's what I had hoped. Yet I got this message in the repository settings.

image:{image-assets}/jekyll-to-hugo/github-pages-repo-settings.png[Github Pages repository settings]

I tried to create an empty `gh-pages` branch. Here's some useful git command 
by the way:

[source,bash]
----
# create a new empty branch (from your current branch)
true | git mktree | xargs git commit-tree | xargs git branch gh-ages
git push --set-upstream origin gh-pages:gh-pages
----

But the settings page still insists that it should be done on `master`, not quite 
the same as mentioned in the
https://help.github.com/en/github/working-with-github-pages/configuring-a-publishing-source-for-your-github-pages-site[GitHub Pages doc].
I decided to drop this approach and removed the `gh-pages` branch for now.

Finally, by trying things out, if there's an `index.html` file on `master`, then 
the branch files will be used to serve as static content. Following this clue, 
removing all files in master but `CNAME`, it is enough to publish Hugo generated 
file from the `./public` folder to the `master` branch.

Due to this Github Pages _constraint_ the Hugo directory structure and site 
files are in another branch like `hugo-sources` that is configured as the 
default branch of this repository.

=== Automate deployment

For that let's use Github Actions, it's possible to declare what needs to be 
done in a yaml file, and it appears the market place has everything I need to do that

* The https://github.com/peaceiris/actions-hugo[Hugo action] that install Hugo 
and configures Hugo

Let's configure the same version as the local one

[source,bash]
----
â¯ hugo version
Hugo Static Site Generator v0.69.0/extended darwin/amd64 BuildDate: unknown
----

Version `0.69.0`, and it is important to activate the `extended` flag as well.

* The https://github.com/peaceiris/actions-gh-pages[GitHub Pages deployment action] 
that will push the static file

The only thing that we need is a deployment key as documented https://github.com/peaceiris/actions-gh-pages#%EF%B8%8F-create-ssh-deploy-key[here].

[source,bash]
----
ssh-keygen -t rsa -b 4096 -C "$(git config user.email)" -f gh-pages -N ""
----

Going https://github.com/bric3/bric3.github.io/settings/keys[there], and add 
the public deployment key, check **Allow write access** :

[source,bash]
----
cat gh-pages.pub | pbcopy
----

Then add the secret key https://github.com/bric3/bric3.github.io/settings/secrets[here] 
named **`ACTIONS_DEPLOY_KEY`**.

[source,bash]
----
cat gh-pages | pbcopy
----

Don't commit these files. But it may be useful to store them securely.

At the time I performed this migration

* GitHub was building and deploying (the publication) from jekyll files on `master` branch
* GitHub could deploy (publish) HTMLs only from `master` branch

This was a requirement for user and organization page sites (`<username>/<username>.github.io`)
to set the `master` branch as the publishing branch as mentioned in the
https://github.com/peaceiris/actions-gh-pages/tree/v2.10.1#%EF%B8%8F-repository-type---user-and-organization[actions-gh-pages@v2 _Repository type - User and Organization_ section].
Meaning I kept the Hugo sources in another branch i.e. `hugo-sources` and configured
accordingly le the publication branch.

TIP: This requirement does seem to be necessary anymore. Currently, I'm using
what I just described, but in the future I may change the branch configuration.

> Note that the deployment actions seems to remove all files, but we 
> need the `CNAME` file fortunately it's possible to configure the `cname` option.  

This gives us the following configuration in `.github/workflows/<name of the workflow>.yml` :

[source,yaml]
----
name: GitHub Pages

on:
  push:
    branches:
      - hugo-sources

jobs:
  build-deploy:
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: true
          fetch-depth: 0

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: '0.69.0'
          extended: true

      - name: Build
        run: Hugo â€”minify

      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          deploy_key: ${{ secrets.ACTIONS_DEPLOY_KEY }}
          publish_branch: master
          publish_dir: ./public
          cname: blog.arkey.fr
----

After this file has been pushed, it's possible to inspect what this action 
has been doing, for how long, etc, at the 
https://github.com/bric3/bric3.github.io/runs/586180428?check_suite_focus=true[repository actions page]

image:{image-assets}/jekyll-to-hugo/github-actions-success.png[Github Actions jobs]


{{< draftNotes >}}

== Todos

- https://gohugo.io/content-management/archetypes/#create-a-new-archetype-template[x] New post archetype [Archetypes | Hugo]
	- [x] Generate the slug in the front matter
- https://kodify.net/hugo/strings/string-length/)[ ] Refine reading time ([How to get the length of a string in Hugo?Â· Kodify]
- [ ] Tweak CSS for dark mode
- [x] Automate deployment on GitHub pages
- [x] favicon
- [x] Tweak colours
- [x] Tweak CSS for page width
- http://stackoverflow.com/questions/13676587/ddg#13676803[x] Tweak CSS for pre>code [HTML <pre> tag values get horizontal scroll bars,how to format it? - Stack Overflow]
- [x] Tweak scrollbars
- https://fontawesome.com/icons/linkedin-in?style=brands[x] Some brand icon are not shown like LinkedIn and twitter this is due to adblocker see [Missing Brand Icons (Ad blockers related issue) Â· Issue #1799 Â· FortAwesome/Font-Awesome Â· GitHub](https://github.com/FortAwesome/Font-Awesome/issues/1799), alternative import/serve the fontawesome svg directly and rename it. It's possible to download the SVG there : [linkedin icon]
- https://cdnjs.com/libraries/font-awesome[x] Upgrade fontawesome, script copied from [cdnjs] which has the integrity attribute
- [x] Google verification file

=== Creates a conference section

Eventually use/create the following shortcodes.

<!-- Escaped shortcode https://liatas.com/posts/escaping-hugo-shortcodes/ -->
* tweet id => `{{</* tweet 877500564405444608 */>}}`
* YouTube => `{{</* youtube w7Ft2ymGmfc */>}}`
* Speakerdeck, etcâ€¦ 
* asciinema


{{< /draftNotes >}}

'''

.Sources
* https://foo-dogsquared.github.io/blog/posts/blogging-with-asciidoctor-and-hugo/[Blogging with Asciidoctor and Hugo]
* https://jvns.ca/blog/2016/10/09/switching-to-hugo/[Switching to Hugo - Julia Evans]
* https://jshingler.github.io/blog/2019/12/07/creating-this-site/[Creating This Site]
* https://rgielen.net/posts/2019/creating-a-blog-with-hugo-and-asciidoctor/[Creating a Blog with Hugo and AsciiDoctor Â· rgielen.net]
* https://rgielen.net/posts/2019/creating-a-dockerized-hugo-asciidoctor-toolchain/[Creating a Dockerized Hugo + AsciiDoctor Toolchain Â· rgielen.net]
* https://dev.to/infominer33/jekyll-hpstr-to-hugo-hpstr-migration-gia[Jekyll HPSTR to Hugo HPSTR Theme Migration - DEV Community ğŸ‘©â€ğŸ’»ğŸ‘¨â€ğŸ’»]
* https://haefelfinger.ch/posts/2019/2019-11-12-Migrate-from-jekyll-to-hugo/[Migrate from jekyll to gohugo / Haefelfinger - Techblog]
* https://gohugo.io/commands/hugo_import_jekyll/[Hugo import jekyll | Hugo]
* https://www.morling.dev/blog/automatically-deploying-hugo-website-via-github-actions/[Automatically deploying a Hugo website via Github Actions]