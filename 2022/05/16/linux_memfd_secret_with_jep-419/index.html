<!DOCTYPE html>
<html lang="en">
    
    


    <head>
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="https://oss.maxcdn.com">
    <link rel="dns-prefetch" href="https://www.gravatar.com">

    <link href="https://gmpg.org/xfn/11" rel="profile">
    
    <link rel="canonical" href="https://blog.arkey.fr/2022/05/16/linux_memfd_secret_with_jep-419/">
    

    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.82.1" />

    
    
    

<title>Using Linux&#39;s memfd_secret syscall from the JVM with JEP-419 • Brice Dutheil</title>













    
<meta property="og:locale" content="en">
<meta property="og:site_name" content="Brice Dutheil">
<meta property="og:title" content="Using Linux&amp;rsquo;s memfd_secret syscall from the JVM with JEP-419">
<meta property="og:type" content="website">
<meta property="og:url" content="https://blog.arkey.fr/2022/05/16/linux_memfd_secret_with_jep-419/" />
<meta property="og:description" content="Java mostly, and general tech">
<meta property="og:image" content="https://blog.arkey.fr/social-sharing.png">
<meta property="og:image:type" content="image/png">
    
    
    
<meta property="og:image:width" content="512">
<meta property="og:image:height" content="512">
    

<meta property="og:updated_time" content="2022-05-16T00:32:09&#43;0200">



<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@BriceDutheil">
<meta name="twitter:title" content="Using Linux&amp;rsquo;s memfd_secret syscall from the JVM with JEP-419">

<meta name="twitter:image" content="https://blog.arkey.fr/social-sharing.png">

<meta name="twitter:description" content="Java mostly, and general tech">
<meta name="twitter:creator" content="@BriceDutheil">
    
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.4.1/styles/a11y-light.min.css" media="(prefers-color-scheme: light)"><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.4.1/styles/gruvbox-dark.min.css" media="(prefers-color-scheme: dark)">




<link rel="stylesheet" href="/scss/ascii-press.d6bafe0d39194a15e5deee39d0dad5d2118d57cf6ace33b94bb9dbfda6ab0415.css" integrity="sha256-1rr&#43;DTkZShXl3u450NrV0hGNV89qzjO5S7nb/aarBBU=">


<link rel="stylesheet" href="/scss/ascii-press-dark.06869de8a04135a809635aeb8b272847be96c60ddaa9197e026e19efe21e6909.css" integrity="sha256-Boad6KBBNagJY1rriycoR76Wxg3aqRl&#43;Am4Z7&#43;IeaQk=" media="(prefers-color-scheme: dark)">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">




<link rel="stylesheet" href="/scss/hugo-toc.d31afb68f96b4b4a16c6def81c6cfb18992a6924bd88766a480bb24a08ca5796.css" integrity="sha256-0xr7aPlrS0oWxt74HGz7GJkqaSS9iHZqSAuySgjKV5Y=">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Icons from https://realfavicongenerator.net -->
<link rel="icon" href="/favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<meta name="msapplication-TileColor" content="#b64f4f">
<meta name="theme-color" content="#b64f4f">



    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/v4-shims.min.css" integrity="sha512-KNosrY5jkv7dI1q54vqk0N3x1xEmEn4sjzpU1lWL6bv5VVddcYKQVhHV08468FK6eBBSXTwGlMMZLPTXSpHYHA==" crossorigin="anonymous" />

    
    

</head>


    <body class="">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="https://blog.arkey.fr">Brice Dutheil</a>
      </span>
      
      
        <div class="author-image">
          <img src="https://www.gravatar.com/avatar/f31c7fbcbb0766d0632d96fd7e74b649?s=240&d=mp" class="img--circle img--headshot element--center" alt="gravatar">
        </div>
      
      <p class="site__description">
         Java mostly, and general tech 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">Brice Dutheil</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/"><span class='fa-icon'><i class='fas fa-home'></i></span><code>cd <em>~</em></code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/posts/"><span class='fa-icon'><i class='fas fa-stream'></i></span><code>ls <em>posts/*</em></code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/series/"><span class='fa-icon'><i class='fas fa-list-alt'></i></span><code>grep -o <em>series</em> posts/* | sort -u</code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/tags/"><span class='fa-icon'><i class='fas fa-tags'></i></span><code>grep -o <em>tags</em> posts/* | sort -u</code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/cool-stuff/"><span class='fa-icon'><i class='fas fa-thumbtack'></i></span><code>cd <em>cool-stuff</em></code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/whoami/"><span class='fa-icon'><i class='fas fa-id-card'></i></span><code>whoami</code>
						<span></span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://twitter.com/BriceDutheil" rel="me"><i class="fa-w-16" aria-hidden="true"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="bird" class="svg-inline--fa fa-bird fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></i></a>
	
	
	
	<a href="https://github.com/bric3" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	<a href="https://speakerdeck.com/bric3" rel="me"><i class="fab fa-speaker-deck" aria-hidden="true"></i></i></a>
	
	
	
	
	
	
	
	<a href="https://linkedin.com/in/dutheilbrice" rel="me"><i class="fa-w-16" aria-hidden="true"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="pro-network" class="svg-inline--fa fa-pro-network fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></i></a>
	
	
	<a href="https://stackoverflow.com/users/48136/brice" rel="me"><i class="fab fa-stack-overflow fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	
</section>

      </div>
    </div>

  </div>
  <div class="container fixed-container">
    
<div class="copyright">
  &copy; 2010 - 2022 Brice Dutheil
  
    <a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a>
  
</div>



  </div>
</div>

        <div class="content container">
            
    <header>

 
 
 <div class="github-edit">
     <a href="https://github.com/bric3/bric3.github.io/edit/hugo-sources/content/posts/2022-05-04-linux_memfd_secret_with_jep419.adoc">
     <i class="fab fa-github fa-lg" aria-hidden="true"></i> Edit this page
     </a>
 </div>
 


</header>

            
    

<article>
  <header>
    <h1>Using Linux&#39;s memfd_secret syscall from the JVM with JEP-419</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> 2022-05-16
    
    
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/jep-419">jep-419</a>
           
      
          <a class="badge badge-tag" href="/tags/java">java</a>
           
      
          <a class="badge badge-tag" href="/tags/jvm">jvm</a>
           
      
          <a class="badge badge-tag" href="/tags/memory">memory</a>
           
      
          <a class="badge badge-tag" href="/tags/linker">linker</a>
           
      
          <a class="badge badge-tag" href="/tags/foreign">foreign</a>
           
      
          <a class="badge badge-tag" href="/tags/jdk18">jdk18</a>
           
      
          <a class="badge badge-tag" href="/tags/panama">panama</a>
           
      
          <a class="badge badge-tag" href="/tags/linux">linux</a>
           
      
          <a class="badge badge-tag" href="/tags/syscall">syscall</a>
           
      
          <a class="badge badge-tag" href="/tags/memfd_secret">memfd_secret</a>
          
      
    
    
    <br/>
    <i class="fas fa-clock"></i> 63 min read

    
    
    
        <div class="page-series">
            <div class="title">In the same series :</div>
            <ul>
                
                    
                    <li hugo-nav="/2022/05/16/linux_memfd_secret_with_jep-419/"><a href="https://blog.arkey.fr/2022/05/16/linux_memfd_secret_with_jep-419/"> Using Linux&#39;s memfd_secret syscall from the JVM with JEP-419 </a> </li>
                    
                    <li hugo-nav="/2021/09/04/a-practical-look-at-jep-412-in-jdk17-with-libsodium/"><a href="https://blog.arkey.fr/2021/09/04/a-practical-look-at-jep-412-in-jdk17-with-libsodium/"> A practical look at JEP-412 in JDK17 with libsodium </a> </li>
                    
                    <li hugo-nav="/2021/02/20/a-practical-look-at-jep-389-in-jdk16-with-libsodium/"><a href="https://blog.arkey.fr/2021/02/20/a-practical-look-at-jep-389-in-jdk16-with-libsodium/"> A practical look at JEP-389 in JDK16 with libsodium </a> </li>
                    
                
            </ul>
        </div>
    

</div>


  </header>
  
  
  
    <div class="toc-wrapper">
      <input type="checkbox" id="tocToggle" checked>
      <label for="tocToggle"><i class="fas fa-list-ul fa-lg"></i><span id="toc-title">On this page</span></label>
      <div id="toc-toggle-cover"></div>

      
          <nav id="TableOfContents">
  <ul>
    <li><a href="#_what_is_a_system_call_syscall">What is a system call (<em>syscall</em>) ?</a>
      <ul>
        <li><a href="#_what_does_the_documentation_says_about_syscalls">What does the documentation says about syscalls ?</a></li>
        <li><a href="#_my_first_syscall">My first syscall</a></li>
      </ul>
    </li>
    <li><a href="#_making_syscalls_from_the_jvm">Making syscalls from the JVM</a></li>
    <li><a href="#_memfd_secret"><code>memfd_secret</code></a>
      <ul>
        <li><a href="#_errno"><code>errno</code></a></li>
        <li><a href="#_linux_bootloader_flag">Linux bootloader flag</a></li>
      </ul>
    </li>
    <li><a href="#_improvements">Improvements</a>
      <ul>
        <li><a href="#_trying_to_replace_most_panama_calls_by_jdk_types">Trying to replace most panama calls by JDK types</a></li>
        <li><a href="#_improving_our_syscall_api">Improving our syscall API.</a></li>
        <li><a href="#_generating_the_methodhandles_with_jextract">Generating the <code>MethodHandle</code>s with <code>jextract</code></a></li>
      </ul>
    </li>
    <li><a href="#_closing_words">Closing words</a></li>
  </ul>
</nav>
      
    </div>
  
  
  
  <div class="post adoc">
    
<div class="paragraph">
<p>Linux 5.14 brought a new system call <code>memfd_secret</code> in order to mitigate
speculative attack by preventing the kernel from being able to peek at memory
segments created by this system call.</p>
</div>
<div class="paragraph">
<p>In this article I will leverage the API introduced ⸺ well, still incubating ⸺ of
<a href="https://openjdk.java.net/jeps/419">JEP-419</a> (Project Panama). JEP-419 has been
delivered as part of <a href="https://openjdk.java.net/projects/jdk/18/">JDK 18</a>.</p>
</div>
<div class="paragraph">
<p>For those that don’t know, Project Panama is a project that aims to provide an
easy, secure and efficient way to call <em>native methods</em> from Java. You can look
at my previous articles on the earlier versions of the project, articles
on <a href="https://foojay.io">foojay.io</a> by <a href="https://twitter.com/CarlDea">Carl Dea</a>,
or those on <a href="https://inside.java">inside.java</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The project Panama APIs is the fruit of work started in 2014, from ideas
even older. The project is still evolving which means the next iteration
(<a href="https://openjdk.java.net/jeps/424">JEP-424</a>) in <a href="https://openjdk.java.net/projects/jdk/19/">JDK 19</a>
is going to promote these APIs <strong>as preview</strong>, but API and behavior adjustments are still likely.
</td>
</tr>
</tbody></table>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The following examples are based on <strong>JDK 18 2022-03-22, build 18+37 from Red Hat</strong>.
The Linux distribution is a <strong>Fedora release 35</strong> with the kernel <strong>5.16.20-200.fc35.x86_64</strong>.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p><em>While this article will focus on Linux, the same concepts apply to other OSes
(and CPU as we’ll see).</em> Also, this article is not about introducing JEP-419,
this is done in other material, which means this blog assumes the right
compilation and running flags for JEP-419, usually <code>--add-modules=jdk.incubator.foreign</code>,
<code>--enable-native-access=ALL-UNNAMED</code>.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">tl;dr</div>
<div class="paragraph">
<p>Here’s how one can make a syscall using JEP-419.</p>
</div>
<div class="listingblock">
<div class="title"><code>memfd_secret</code> syscall</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">var sys_memfd_secret = CLinker.systemCLinker().downcallHandle(
        systemCLinker.lookup(&#34;syscall&#34;).get(),
        FunctionDescriptor.of(
                ValueLayout.JAVA_INT,
                ValueLayout.JAVA_INT,
                ValueLayout.JAVA_INT
        )
);

int secret_fd = (int) sys_memfd_secret.invoke(447, 0)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now to know more about the whole deal, read on.</p>
</div>
<div class="sect1">
<h2 id="_what_is_a_system_call_syscall"><a class="anchor" href="#_what_is_a_system_call_syscall"></a><a class="link" href="#_what_is_a_system_call_syscall">What is a system call (<em>syscall</em>) ?</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before jumping to <code>memfd_secret</code>, let’s first understand how to make a system call.
And even before that, let’s see what is a system call.</p>
</div>
<div class="paragraph">
<p>For those not interested in this part you can jump to <a href="#_memfd_secret"><code>memfd_secret</code> section</a>.</p>
</div>
<div class="paragraph">
<p>In order to do something useful a program has to interact with some resources,
memory, disk, network, terminal, etc. On a computer, these resources are
handled by a very complex and critical software, the <strong>O</strong>perating <strong>S</strong>ystem.</p>
</div>
<div class="paragraph">
<p>In order to use these resources, a program has to make <em>system calls</em> like
<code>read</code>, <code>wait</code>, <code>write</code>, <code>exit</code>, etc. The standard <code>malloc</code>, the native allocator,
has to actually place a request to the OS to get memory via a <code>mmap</code> syscall.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/assets/off-heap-recon/malloc-mmap.svg" alt="malloc mmap" title="glibc’s malloc overview"/></span></p>
</div>
<div class="paragraph">
<p>As expected the JVM does plenty of syscalls too, e.g. when logging something
on <code>stdout</code> or persisting a (unified) log file.</p>
</div>
<div class="paragraph">
<p>Essentially,</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><strong>a system call is a way of requesting the kernel to do something for the program.</strong></p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Why system calls have to be in the kernel and not in the user space like in a
standard library? As mentioned earlier the reasoning is that system calls are
a way to interact or, involve, a resource like devices, file system, network,
processes, etc. These resources are managed by a <strong>privileged</strong> software :
the OS or kernel.</p>
</div>
<div class="paragraph">
<p>When a system call happens, the program doesn’t simply invoke a method at some
whose code resides at some address, <strong>a system call is actually making the CPU
switching to <em>Kernel mode</em></strong> because the kernel is a <strong>privileged</strong> software.</p>
</div>
<div class="paragraph">
<p>On most modern processors there is a security model, that allows to limit the
scope of what a program can do. In particular on Intel based CPUs, the model
is known as <a href="https://en.wikipedia.org/wiki/Protection_ring"><strong>processor protection ring</strong> (or <strong>hierarchical protection domains</strong>)</a>.</p>
</div>
<div class="imageblock">
<div class="content">
<svg preserveAspectRatio="xMidYMid meet" shape-rendering="geometricPrecision" version="1.0" viewBox="0 0 700 406" xmlns="http://www.w3.org/2000/svg" width="700" height="406"><defs><style type="text/css">@font-face {
  font-family: sans-serif;
}</style><filter height="200%" id="shadowBlur" width="200%" x="0" y="0"><feOffset dx="3.0003002" dy="3.0003002" in="SourceGraphic" result="offOut"></feOffset><feGaussianBlur in="offOut" stdDeviation="3"></feGaussianBlur></filter></defs><g stroke-linecap="square" stroke-linejoin="round" stroke-width="1"><rect height="406" style="fill: #ffffff" width="700" x="0" y="0"></rect><path d="M210.0 35.0 C312.17267 35.0 395.0 110.21617 395.0 203.0 C395.0 295.7838 312.17267 371.0 210.0 371.0 C107.827324 371.0 25.0 295.7838 25.0 203.0 C25.0 110.21617 107.827324 35.0 210.0 35.0 z" fill="#969696" filter="url(#shadowBlur)" stroke="#969696"></path><path d="M210.0 77.0 C284.55844 77.0 345.0 133.41212 345.0 203.0 C345.0 272.5879 284.55844 329.0 210.0 329.0 C135.44156 329.0 75.0 272.5879 75.0 203.0 C75.0 133.41212 135.44156 77.0 210.0 77.0 z" fill="#969696" filter="url(#shadowBlur)" stroke="#969696"></path><path d="M210.0 119.0 C256.9442 119.0 295.0 156.6081 295.0 203.0 C295.0 249.3919 256.9442 287.0 210.0 287.0 C163.0558 287.0 125.0 249.3919 125.0 203.0 C125.0 156.6081 163.0558 119.0 210.0 119.0 z" fill="#969696" filter="url(#shadowBlur)" stroke="#969696"></path><path d="M210.0 161.0 C234.85281 161.0 255.0 179.80405 255.0 203.0 C255.0 226.19595 234.85281 245.0 210.0 245.0 C185.14719 245.0 165.0 226.19595 165.0 203.0 C165.0 179.80405 185.14719 161.0 210.0 161.0 z" fill="#969696" filter="url(#shadowBlur)" stroke="#969696"></path><path d="M505.0 119.0 L565.0 119.0 L565.0 145.0 L505.0 145.0 z" fill="#969696" filter="url(#shadowBlur)" stroke="#969696"></path><path d="M505.0 205.0 L565.0 205.0 L565.0 231.0 L505.0 231.0 z" fill="#969696" filter="url(#shadowBlur)" stroke="#969696"></path><path d="M505.0 149.0 L565.0 149.0 L565.0 173.0 L505.0 173.0 z" fill="#969696" filter="url(#shadowBlur)" stroke="#969696"></path><path d="M505.0 177.0 L565.0 177.0 L565.0 201.0 L505.0 201.0 z" fill="#969696" filter="url(#shadowBlur)" stroke="#969696"></path><path d="M210.0 35.0 C312.17267 35.0 395.0 110.21617 395.0 203.0 C395.0 295.7838 312.17267 371.0 210.0 371.0 C107.827324 371.0 25.0 295.7838 25.0 203.0 C25.0 110.21617 107.827324 35.0 210.0 35.0 z" fill="#99ff99" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"></path><path d="M210.0 77.0 C284.55844 77.0 345.0 133.41212 345.0 203.0 C345.0 272.5879 284.55844 329.0 210.0 329.0 C135.44156 329.0 75.0 272.5879 75.0 203.0 C75.0 133.41212 135.44156 77.0 210.0 77.0 z" fill="#ffee99" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"></path><path d="M210.0 119.0 C256.9442 119.0 295.0 156.6081 295.0 203.0 C295.0 249.3919 256.9442 287.0 210.0 287.0 C163.0558 287.0 125.0 249.3919 125.0 203.0 C125.0 156.6081 163.0558 119.0 210.0 119.0 z" fill="#ffbb77" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"></path><path d="M210.0 161.0 C234.85281 161.0 255.0 179.80405 255.0 203.0 C255.0 226.19595 234.85281 245.0 210.0 245.0 C185.14719 245.0 165.0 226.19595 165.0 203.0 C165.0 179.80405 185.14719 161.0 210.0 161.0 z" fill="#ff6666" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"></path><path d="M505.0 119.0 L565.0 119.0 L565.0 145.0 L505.0 145.0 z" fill="#99ff99" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"></path><path d="M505.0 205.0 L565.0 205.0 L565.0 231.0 L505.0 231.0 z" fill="#ff6666" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"></path><path d="M505.0 149.0 L565.0 149.0 L565.0 173.0 L505.0 173.0 z" fill="#ffee99" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"></path><path d="M505.0 177.0 L565.0 177.0 L565.0 201.0 L505.0 201.0 z" fill="#ffbb77" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"></path><text fill="#000000" font-family="sans-serif" font-size="15" stroke="none" x="185" y="68">Ring 3</text><text fill="#000000" font-family="sans-serif" font-size="15" stroke="none" x="480" y="96">User space</text><text fill="#000000" font-family="sans-serif" font-size="15" stroke="none" x="480" y="110">(Lowest privileges)</text><text fill="#000000" font-family="sans-serif" font-size="15" stroke="none" x="185" y="110">Ring 2</text><text fill="#000000" font-family="sans-serif" font-size="15" stroke="none" x="185" y="152">Ring 1</text><text fill="#000000" font-family="sans-serif" font-size="15" stroke="none" x="185" y="194">Ring 0</text><text fill="#000000" font-family="sans-serif" font-size="15" stroke="none" x="184" y="222">Kernel</text><text fill="#000000" font-family="sans-serif" font-size="15" stroke="none" x="480" y="250">Kernel space</text><text fill="#000000" font-family="sans-serif" font-size="15" stroke="none" x="480" y="264">(Highest privileges)</text><text fill="#000000" font-family="sans-serif" font-size="15" stroke="none" x="153" y="264">Device drivers</text><text fill="#000000" font-family="sans-serif" font-size="15" stroke="none" x="153" y="306">Device drivers</text><text fill="#000000" font-family="sans-serif" font-size="15" stroke="none" x="161" y="348">Applications</text></g></svg>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It seems that Ring 1 and 2 are rarely used because paging (the way that the OS
handles memory, see my blog post on [off-heap memory]) only has the concept
of privileged and unprivileged which minimize the actual benefit of those rings,
according to <a href="https://stackoverflow.com/users/13430/evan-teran">Evan Teran</a>&#39;s
<a href="https://stackoverflow.com/a/6710138/48136">answer on SO</a>.&#39;</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>When a processor executes some code (in thread), the processor knows the current
mode, this way the processor is able to gate memory accesses, e.g. a Ring 3
(user-land program cannot access memory from Ring 0, the kernel). This is
yet another <em>feature</em> of the <em>virtual memory</em> abstraction.
The processor could also restrict some processor instructions and registers
to the software running in Ring 0.</p>
</div>
<div class="paragraph">
<p><em>Out of scope: there’s even negative rings on some CPU architectures for
hypervisor, or CPU System management, up to <code>Ring -3</code>.</em></p>
</div>
<div class="paragraph">
<p>Restrictions are enforced by the CPU, in order to perform its purpose a
user-land program needs to place a request to the kernel. This mechanism
is called <strong>syscall</strong>, it allows to transition between rings.</p>
</div>
<div class="imageblock">
<div class="content">
<svg preserveAspectRatio="xMidYMid meet" shape-rendering="geometricPrecision" version="1.0" viewBox="0 0 840 280" xmlns="http://www.w3.org/2000/svg" width="840" height="280"><defs><style type="text/css">@font-face {
  font-family: sans-serif;
}</style><filter height="200%" id="shadowBlur" width="200%" x="0" y="0"><feOffset dx="3.0003002" dy="3.0003002" in="SourceGraphic" result="offOut"></feOffset><feGaussianBlur in="offOut" stdDeviation="3"></feGaussianBlur></filter></defs><g stroke-linecap="square" stroke-linejoin="round" stroke-width="1"><rect height="280" style="fill: #ffffff" width="840" x="0" y="0"></rect><path d="M605.0 91.0 L605.0 147.0 L565.0 147.0 " fill="none" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"></path><path d="M225.0 147.0 L265.0 147.0 L265.0 175.0 " fill="none" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"></path><path d="M210.0 70.0 L220.0 77.0 L210.0 84.0 z" fill="#000000" stroke="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"></path><path d="M240.0 70.0 L230.0 77.0 L240.0 84.0 z" fill="#000000" stroke="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"></path><path d="M590.0 70.0 L600.0 77.0 L590.0 84.0 z" fill="#000000" stroke="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"></path><path d="M770.0 70.0 L780.0 77.0 L770.0 84.0 z" fill="#000000" stroke="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"></path><path d="M605.0 84.0 L600.0 98.0 L610.0 98.0 z" fill="#000000" stroke="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"></path><path d="M220.0 126.0 L225.0 140.0 L230.0 126.0 z" fill="#000000" stroke="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"></path><path d="M565.0 154.0 L560.0 168.0 L570.0 168.0 z" fill="#000000" stroke="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"></path><path d="M260.0 168.0 L265.0 182.0 L270.0 168.0 z" fill="#000000" stroke="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"></path><path d="M550.0 182.0 L560.0 189.0 L550.0 196.0 z" fill="#000000" stroke="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"></path><path d="M230.0 210.0 L220.0 217.0 L230.0 224.0 z" fill="#000000" stroke="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"></path><path d="M260.0 210.0 L270.0 217.0 L260.0 224.0 z" fill="#000000" stroke="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"></path><path d="M570.0 210.0 L560.0 217.0 L570.0 224.0 z" fill="#000000" stroke="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"></path><path d="M600.0 210.0 L610.0 217.0 L600.0 224.0 z" fill="#000000" stroke="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"></path><path d="M225.0 77.0 L225.0 133.0 " fill="none" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"></path><path d="M85.0 77.0 L215.0 77.0 " fill="none" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"></path><path d="M235.0 77.0 L375.0 77.0 " fill="none" stroke="#000000" stroke-dasharray="5.0,5.0" stroke-linecap="butt" stroke-linejoin="round" stroke-miterlimit="0" stroke-width="1.0"></path><path d="M445.0 77.0 L595.0 77.0 " fill="none" stroke="#000000" stroke-dasharray="5.0,5.0" stroke-linecap="butt" stroke-linejoin="round" stroke-miterlimit="0" stroke-width="1.0"></path><path d="M595.0 77.0 L775.0 77.0 " fill="none" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"></path><path d="M25.0 147.0 L205.0 147.0 " fill="none" stroke="#000000" stroke-dasharray="5.0,5.0" stroke-linecap="butt" stroke-linejoin="round" stroke-miterlimit="0" stroke-width="1.0"></path><path d="M285.0 147.0 L545.0 147.0 " fill="none" stroke="#000000" stroke-dasharray="5.0,5.0" stroke-linecap="butt" stroke-linejoin="round" stroke-miterlimit="0" stroke-width="1.0"></path><path d="M625.0 147.0 L815.0 147.0 " fill="none" stroke="#000000" stroke-dasharray="5.0,5.0" stroke-linecap="butt" stroke-linejoin="round" stroke-miterlimit="0" stroke-width="1.0"></path><path d="M565.0 161.0 L565.0 189.0 " fill="none" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"></path><path d="M265.0 189.0 L555.0 189.0 " fill="none" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"></path><path d="M225.0 217.0 L265.0 217.0 " fill="none" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"></path><path d="M565.0 217.0 L605.0 217.0 " fill="none" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"></path><path d="M608.5 77.0 L608.38074 77.90587 L608.03107 78.75 L607.47485 79.47488 L606.75 80.03109 L605.9059 80.38074 L605.0 80.5 L604.0941 80.38074 L603.25 80.03109 L602.52515 79.47488 L601.96893 78.75 L601.61926 77.90587 L601.5 77.0 L601.61926 76.09413 L601.96893 75.25 L602.52515 74.52512 L603.25 73.96891 L604.0941 73.61926 L605.0 73.5 L605.9059 73.61926 L606.75 73.96891 L607.47485 74.52512 L608.03107 75.25 L608.38074 76.09413 L608.5 77.0 z" fill="#ffffff" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"></path><path d="M228.5 147.0 L228.38074 147.90587 L228.03108 148.75 L227.47487 149.47487 L226.75 150.03108 L225.90587 150.38074 L225.0 150.5 L224.09413 150.38074 L223.25 150.03108 L222.52513 149.47487 L221.96892 148.75 L221.61926 147.90587 L221.5 147.0 L221.61926 146.09413 L221.96892 145.25 L222.52513 144.52513 L223.25 143.96892 L224.09413 143.61926 L225.0 143.5 L225.90587 143.61926 L226.75 143.96892 L227.47487 144.52513 L228.03108 145.25 L228.38074 146.09413 L228.5 147.0 z" fill="#ffffff" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"></path><path d="M268.5 147.0 L268.38074 147.90587 L268.0311 148.75 L267.47488 149.47487 L266.75 150.03108 L265.90585 150.38074 L265.0 150.5 L264.09415 150.38074 L263.25 150.03108 L262.52512 149.47487 L261.9689 148.75 L261.61926 147.90587 L261.5 147.0 L261.61926 146.09413 L261.9689 145.25 L262.52512 144.52513 L263.25 143.96892 L264.09415 143.61926 L265.0 143.5 L265.90585 143.61926 L266.75 143.96892 L267.47488 144.52513 L268.0311 145.25 L268.38074 146.09413 L268.5 147.0 z" fill="#ffffff" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"></path><path d="M568.5 147.0 L568.38074 147.90587 L568.03107 148.75 L567.47485 149.47487 L566.75 150.03108 L565.9059 150.38074 L565.0 150.5 L564.0941 150.38074 L563.25 150.03108 L562.52515 149.47487 L561.96893 148.75 L561.61926 147.90587 L561.5 147.0 L561.61926 146.09413 L561.96893 145.25 L562.52515 144.52513 L563.25 143.96892 L564.0941 143.61926 L565.0 143.5 L565.9059 143.61926 L566.75 143.96892 L567.47485 144.52513 L568.03107 145.25 L568.38074 146.09413 L568.5 147.0 z" fill="#ffffff" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"></path><path d="M608.5 147.0 L608.38074 147.90587 L608.03107 148.75 L607.47485 149.47487 L606.75 150.03108 L605.9059 150.38074 L605.0 150.5 L604.0941 150.38074 L603.25 150.03108 L602.52515 149.47487 L601.96893 148.75 L601.61926 147.90587 L601.5 147.0 L601.61926 146.09413 L601.96893 145.25 L602.52515 144.52513 L603.25 143.96892 L604.0941 143.61926 L605.0 143.5 L605.9059 143.61926 L606.75 143.96892 L607.47485 144.52513 L608.03107 145.25 L608.38074 146.09413 L608.5 147.0 z" fill="#ffffff" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"></path><path d="M268.5 189.0 L268.38074 189.90587 L268.0311 190.75 L267.47488 191.47487 L266.75 192.03108 L265.90585 192.38074 L265.0 192.5 L264.09415 192.38074 L263.25 192.03108 L262.52512 191.47487 L261.9689 190.75 L261.61926 189.90587 L261.5 189.0 L261.61926 188.09413 L261.9689 187.25 L262.52512 186.52513 L263.25 185.96892 L264.09415 185.61926 L265.0 185.5 L265.90585 185.61926 L266.75 185.96892 L267.47488 186.52513 L268.0311 187.25 L268.38074 188.09413 L268.5 189.0 z" fill="#ffffff" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"></path><path d="M568.5 189.0 L568.38074 189.90587 L568.03107 190.75 L567.47485 191.47487 L566.75 192.03108 L565.9059 192.38074 L565.0 192.5 L564.0941 192.38074 L563.25 192.03108 L562.52515 191.47487 L561.96893 190.75 L561.61926 189.90587 L561.5 189.0 L561.61926 188.09413 L561.96893 187.25 L562.52515 186.52513 L563.25 185.96892 L564.0941 185.61926 L565.0 185.5 L565.9059 185.61926 L566.75 185.96892 L567.47485 186.52513 L568.03107 187.25 L568.38074 188.09413 L568.5 189.0 z" fill="#ffffff" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"></path><text fill="#000000" font-family="sans-serif" font-size="15" stroke="none" x="110" y="40">process thread</text><text fill="#000000" font-family="sans-serif" font-size="15" stroke="none" x="110" y="54">executing</text><text fill="#000000" font-family="sans-serif" font-size="15" stroke="none" x="630" y="40">process thread</text><text fill="#000000" font-family="sans-serif" font-size="15" stroke="none" x="630" y="54">executing</text><text fill="#000000" font-family="sans-serif" font-size="15" stroke="none" x="395" y="82">Idle</text><text fill="#000000" font-family="sans-serif" font-size="15" stroke="none" x="198" y="110">syscall</text><text fill="#000000" font-family="sans-serif" font-size="15" stroke="none" x="20" y="124">Ring 3</text><text fill="#000000" font-family="sans-serif" font-size="15" stroke="none" x="20" y="138">User land</text><text fill="#000000" font-family="sans-serif" font-size="15" stroke="none" x="24" y="166">Kernel</text><text fill="#000000" font-family="sans-serif" font-size="15" stroke="none" x="25" y="180">Ring 0</text><text fill="#000000" font-family="sans-serif" font-size="15" stroke="none" x="322" y="208">kernal syscall executing</text><text fill="#ffffff" font-family="sans-serif" font-size="12" stroke="none" x="220" y="235">Mode</text><text fill="#000000" font-family="sans-serif" font-size="15" stroke="none" x="220" y="250">Switch</text><text fill="#ffffff" font-family="sans-serif" font-size="12" stroke="none" x="560" y="235">Mode</text><text fill="#000000" font-family="sans-serif" font-size="15" stroke="none" x="560" y="250">Switch</text></g></svg>
</div>
<div class="title">Syscall ring transitions</div>
</div>
<div class="paragraph">
<p>During mode switches a lot is happening, saving and restoring registers,
putting the CPU in specific mode (user vs kernel) etc. And of course doing the
reverse once the request is handled either with  success or a failure</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<em>Privilege context switches</em> are sufficiently costly that most libraries
try to avoid those. For example, reading <code>8 KiB</code> instead of <code>256 bytes</code> is a good
idea as it drastically reduces the number of syscall and as such mode switches.
</td>
</tr>
</tbody></table>
</div>
<div class="sect2">
<h3 id="_what_does_the_documentation_says_about_syscalls"><a class="anchor" href="#_what_does_the_documentation_says_about_syscalls"></a><a class="link" href="#_what_does_the_documentation_says_about_syscalls">What does the documentation says about syscalls ?</a></h3>
<div class="paragraph">
<p>Now let’s get practical.</p>
</div>
<div class="paragraph">
<p>Looking at <a href="https://man7.org/linux/man-pages/man2/syscall.2.html"><code>man 2 syscall</code></a>,
the manpage shed some details on how to make the call, specifically in the
<em>Architecture calling conventions</em> section. Those details are in assembly, e.g.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>processor interrupt <code>0x80</code> for i386 processors (32 bits), then specific registers</p>
</li>
<li>
<p><code>syscall</code> instruction for x86_64 processors (64 bits), then specific registers</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <em>calling convention</em> of other architectures are also described e.g.
on ARM processors, the system call is performed by a <code>swi 0x0</code> instruction,
on <em>aarch64</em> by <code>svc #0</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
For people not aware of what exactly is a <strong>calling convention</strong> should read at leas this
<a href="http://en.wikipedia.org/wiki/X86_calling_conventions">wikipedia article on x86 calling convention</a>.
But in a short a calling convention defines how and where parameters should be placed
in order to call the code, how parameters are passed registers or/and stack,
how values are returned etc.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>This manual page also gives an important difference with regular functions, while
we look up system calls by their names: <code>write</code>, <code>read</code>, <code>execve</code>, <code>exit</code>, <code>mmap</code>,
<code>memfd_create</code> etc. The programs and the kernel actually know them by <strong>numbers</strong>.</p>
</div>
<div class="paragraph">
<p>Why numbers? The reason is that syscalls are like messages that are passed down,
and these numbers somewhat like <em>enum ordinals</em> indicating the type of message.
These numbers are part of the syscall ABI (<strong>A</strong>pplication <strong>B</strong>inary <strong>I</strong>nterface)
and as such they are stable for a CPU architecture although unbounded (new syscalls
can be added).</p>
</div>
<div class="paragraph">



<div class="table-wrapper">
    <div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Outside, of this scope not all syscalls are made equal nowadays, some syscalls,
usually the most used ones are exported in the user space memory, to avoid
the cost of switching to kernel mode. In practice, vDSO (<strong>V</strong>irtual <strong>D</strong>escriptor
<strong>S</strong>hared <strong>O</strong>bject) is like a library, it is loaded in memory so that it can
be accessed from the program memory (glibc knows about this memory region and
will use it).</p>
</div>
<div class="listingblock">
<div class="title"><code>pmap -X {pid}</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs"># pmap -X 1
1:   java ...
         Address Perm   Offset Device   Inode Size  Rss  Pss Referenced Anonymous LazyFree ShmemPmdMapped FilePmdMapped Shared_Hugetlb Private_Hugetlb Swap SwapPss Locked THPeligible ProtectionKey Mapping
...
    7ffe78f4c000 rw-p 00000000  00:00       0  132  112  112        112       112        0              0             0              0               0    0       0      0           0             0 [stack]
    7ffe78fad000 r--p 00000000  00:00       0   16    0    0          0         0        0              0             0              0               0    0       0      0           0             0 [vvar]
    7ffe78fb1000 r-xp 00000000  00:00       0    8    4    0          4         0        0              0             0              0               0    0       0      0           0             0 [vdso]  <i class="conum" data-value="1"></i><b>(1)</b>
ffffffffff600000 r-xp 00000000  00:00       0    4    0    0          0         0        0              0             0              0               0    0       0      0           0             0 [vsyscall]
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The vDSO 8 KiB segment</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>To read more about it, one should read the relevant manual page (<a href="https://man7.org/linux/man-pages/man7/vdso.7.html"><code>man 7 vdso</code></a>).
Typically, this page lists the exported syscalls.</p>
</div>
<div class="paragraph">
<p>E.g ` __vdso_clock_gettime`, which is called by <code>clock_gettime</code> defined in the
standard libc (<a href="https://man7.org/linux/man-pages/man3/clock_gettime.3.html"><code>man 3 clock_gettime</code></a>).</p>
</div>
</td>
</tr>
</tbody></table>
</div>

</div>

</div>
<div class="admonitionblock caution">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
The syscall numbers are different between architectures! On Linux
one can look at their definition in the <code>/include/asm-<strong>/unistd-</strong>.h</code> files.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>From the syscall manpage the Intel CPUs syscall calling convention is:</p>
</div>
<div class="exampleblock primary">
<div class="title">Example 1. 64-bit programs</div>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Set the registers</dt>
<dd>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>rax</code> ← System Call number</p>
</li>
<li>
<p><code>rdi</code> ← First argument</p>
</li>
<li>
<p><code>rsi</code> ← Second argument</p>
</li>
<li>
<p><code>rdx</code> ← Third argument</p>
</li>
</ol>
</div>
</dd>
<dt class="hdlist1">Make the syscall</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>execute <code>syscall</code> processor instruction</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The actual syscall numbers (for 32 bit programs) is usually defined in <code>/usr/include/asm/unistd_64.h</code></p>
</div>
</div>
</div>
<div class="exampleblock secondary">
<div class="title">Example 2. 32-bit programs</div>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Set the registers</dt>
<dd>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>eax</code> ← System Call Number</p>
</li>
<li>
<p><code>ebx</code> ← First Argument</p>
</li>
<li>
<p><code>ecx</code> ← Second Argument</p>
</li>
<li>
<p><code>edx</code> ← Third Argument</p>
</li>
</ol>
</div>
</dd>
<dt class="hdlist1">Make the syscall</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Place a processor interrupt <code>int 0x80</code></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The actual syscall numbers (for 32 bit programs) is usually defined in <code>/usr/include/asm/unistd_32.h</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_my_first_syscall"><a class="anchor" href="#_my_first_syscall"></a><a class="link" href="#_my_first_syscall">My first syscall</a></h3>
<div class="paragraph">
<p>In order to quickly practice a <em>syscall,</em> let’s do a very simple
<em>hello world</em>. The example will be in assembler, I promise this is the only
source snippet in assembly and after that I’ll be back with Java and Panama.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>/usr/include/asm/unistd_64.h</code></p>
</li>
</ul>
</div>
<div class="exampleblock primary">
<div class="title">Example 3. 64-bits (with <code>syscall</code> instruction)</div>
<div class="content">
<div class="listingblock">
<div class="title">hello_syscall.asm (x86_64)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-asm hljs" data-lang="asm">global _start       ; define entrypoint
section .text
_start:
    mov rax, 0x1    ; syscall number for write <i class="conum" data-value="1"></i><b>(1)</b>
    mov rdi, 0x1    ; int fd                   <i class="conum" data-value="2"></i><b>(2)</b>
    mov rsi, msg    ; const void* buf
    mov rdx, mlen   ; size_t count
    syscall         ; make the call            <i class="conum" data-value="3"></i><b>(3)</b>

    mov rax, 0x3c   ; syscall number for exit  <i class="conum" data-value="1"></i><b>(1)</b>
    mov rdi, 0x1    ; int status               <i class="conum" data-value="2"></i><b>(2)</b>
    syscall         ; make the call            <i class="conum" data-value="3"></i><b>(3)</b>

section .rodata
    msg: db &#34;Hello Linux syscalls!&#34;,0x0a, 0x0d  ; message string, terminated by a new line (0A, 0D)
    mlen: equ $-msg                             ; calculate the lenght of the message</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>At this place this register will hold the selected the syscall (a number).
Note the number comes from <code>/usr/include/asm/unistd_64.h</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Syscall arguments are placed in next registers.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Make the syscall with interrupt <code>0x80</code>.</td>
</tr>
</tbody></table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">nasm -w+all -f elf64 -o hello_syscall.o hello_syscall.asm <i class="conum" data-value="1"></i><b>(1)</b>
ld -o hello_syscall hello_syscall.o
./hello_syscall</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Note the <code>elf64</code> format for 64 bits.</td>
</tr>
</tbody></table>
</div>
</div>
</div>
<div class="exampleblock secondary">
<div class="title">Example 4. 32-bits (with an interrupt)</div>
<div class="content">
<div class="listingblock">
<div class="title">hello_syscall_via_int80.asm (x86, ie won’t work on ARM)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-asm hljs" data-lang="asm">global _start                ; define entrypoint
section .text
_start:
    mov eax, 4               ; syscall number: write <i class="conum" data-value="1"></i><b>(1)</b>
    mov ebx, 1               ; stdout <i class="conum" data-value="2"></i><b>(2)</b>
    mov ecx, str             ; buffer address
    mov edx, str_len         ; buffer length
    int 0x80                 ; make the call <i class="conum" data-value="3"></i><b>(3)</b>

    mov eax, 1               ; syscall number: exit <i class="conum" data-value="1"></i><b>(1)</b>
    mov ebx, 0               ; exit status <i class="conum" data-value="2"></i><b>(2)</b>
    int 0x80                 ; make the call <i class="conum" data-value="3"></i><b>(3)</b>

section .rodata
    str: db &#34;Hello Linux!&#34;, 0Ah  ; message string, terminated by a new line (0A)
    str_len: equ $ - str         ; calculate the lenght of the message</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>At this place this register will hold the selected the syscall (a number).
Note the number comes from <code>/usr/include/asm/unistd_64.h</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Syscall arguments are placed in next registers.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Make the syscall with interrupt <code>0x80</code>.</td>
</tr>
</tbody></table>
</div>
<div class="listingblock">
<div class="title">compile and run</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">nasm -w+all -f elf32 -o hello_syscall_via_int80.o hello_syscall_via_int80.asm <i class="conum" data-value="1"></i><b>(1)</b>
ld -m elf_i386 -o hello_syscall_via_int80 hello_syscall_via_int80.o <i class="conum" data-value="2"></i><b>(2)</b>
./hello_syscall_via_int80</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Note the <code>elf32</code> format for 32 bits.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Note the linker <em>emulation</em> option for <code>i386</code></td>
</tr>
</tbody></table>
</div>
</div>
</div>
<div class="paragraph">
<p>When looking at this very simplistic code, something immediately stands out:
From application point of view (user land), a syscall is just like an <strong>atomic</strong>
<em>pseudo machine instruction</em>. I believe this example is more striking than the
figure above on <em>syscall ring transitions</em>.</p>
</div>
<div class="paragraph">
<p>We saw what is exactly a syscall and how to make one using assembly. In general
though, it’s rare to invoke syscall directly as the standard library exposes
wrappers that handle everything for most of the syscalls.</p>
</div>
<div class="imageblock">
<div class="content">
<svg preserveAspectRatio="xMidYMid meet" shape-rendering="geometricPrecision" version="1.0" viewBox="0 0 660 182" xmlns="http://www.w3.org/2000/svg" width="660" height="182"><defs><style type="text/css">@font-face {
  font-family: sans-serif;
}</style><filter height="200%" id="shadowBlur" width="200%" x="0" y="0"><feOffset dx="3.0003002" dy="3.0003002" in="SourceGraphic" result="offOut"></feOffset><feGaussianBlur in="offOut" stdDeviation="3"></feGaussianBlur></filter></defs><g stroke-linecap="square" stroke-linejoin="round" stroke-width="1"><rect height="182" style="fill: #ffffff" width="660" x="0" y="0"></rect><path d="M205.0 49.0 L435.0 49.0 L435.0 133.0 L205.0 133.0 z" fill="#969696" filter="url(#shadowBlur)" stroke="#969696"></path><path d="M505.0 49.0 L635.0 49.0 L635.0 133.0 L505.0 133.0 z" fill="#969696" filter="url(#shadowBlur)" stroke="#969696"></path><path d="M25.0 49.0 L135.0 49.0 L135.0 133.0 L25.0 133.0 z" fill="#969696" filter="url(#shadowBlur)" stroke="#969696"></path><path d="M205.0 49.0 L435.0 49.0 L435.0 133.0 L205.0 133.0 z" fill="white" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"></path><path d="M505.0 49.0 L635.0 49.0 L635.0 133.0 L505.0 133.0 z" fill="white" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"></path><path d="M25.0 49.0 L135.0 49.0 L135.0 133.0 L25.0 133.0 z" fill="white" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"></path><path d="M190.0 98.0 L200.0 105.0 L190.0 112.0 z" fill="#000000" stroke="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"></path><path d="M490.0 98.0 L500.0 105.0 L490.0 112.0 z" fill="#000000" stroke="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"></path><path d="M465.0 35.0 L465.0 91.0 " fill="none" stroke="#000000" stroke-dasharray="5.0,5.0" stroke-linecap="butt" stroke-linejoin="round" stroke-miterlimit="0" stroke-width="1.0"></path><path d="M145.0 105.0 L195.0 105.0 " fill="none" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"></path><path d="M445.0 105.0 L495.0 105.0 " fill="none" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"></path><path d="M465.0 119.0 L465.0 147.0 " fill="none" stroke="#000000" stroke-dasharray="5.0,5.0" stroke-linecap="butt" stroke-linejoin="round" stroke-miterlimit="0" stroke-width="1.0"></path><text fill="#000000" font-family="sans-serif" font-size="15" stroke="none" x="40" y="68">program</text><text fill="#000000" font-family="sans-serif" font-size="15" stroke="none" x="217" y="68">libc</text><text fill="#000000" font-family="sans-serif" font-size="15" stroke="none" x="514" y="68">Kernel</text><text fill="#000000" font-family="sans-serif" font-size="15" stroke="none" x="223" y="96">printf() {</text><text fill="#000000" font-family="sans-serif" font-size="15" stroke="none" x="233" y="110">syscall(SYS_write,…)</text><text fill="#000000" font-family="sans-serif" font-size="15" stroke="none" x="61" y="110">printf()</text><text fill="#000000" font-family="sans-serif" font-size="15" stroke="none" x="523" y="110">SYS_write</text></g></svg>
</div>
<div class="title">syscall wrappers in the standard library</div>
</div>
<div class="paragraph">
<p>Because <code>memfd_secret</code> syscall has been recently used there’s no wrapper functions
in the standard library, hence we’ll need to make a system call ourselves.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_making_syscalls_from_the_jvm"><a class="anchor" href="#_making_syscalls_from_the_jvm"></a><a class="link" href="#_making_syscalls_from_the_jvm">Making syscalls from the JVM</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The work of the Panama project doesn’t allow us to directly write assembly code
and execute it. Fortunately!</p>
</div>
<div class="paragraph">
<p>And the libc already exposes a <em>syscall</em> function that takes care of
the calling convention as mentioned in
<a href="https://man7.org/linux/man-pages/man2/syscall.2.html"><code>man 2 syscall</code></a>, ie it
will place the arguments in the right CPU registers.</p>
</div>
<div class="listingblock">
<div class="title">syscall manual example (omitting headers)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">int main(int argc, char *argv[])
{
   pid_t tid;

   pid = syscall(SYS_getpid);
   printf(&#34;pid: %ld\n&#34;, pid);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>So, basically to make a syscall using JEP-419, I only have to perform a lookup
for the <code>syscall</code> function, also since it’s part of the standard libc, this
just need <code>CLinker.systemLinker()</code>.</p>
</div>
<div class="listingblock">
<div class="title">syscall manual example with Panama</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">/*
  On linux (Intel x86_64) in
  - /usr/include/asm/unistd_64.h

  #define __NR_getpid 39

  On macOs (Intel x86_64) in either :
  - /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include/sys/syscall.h
  - /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/include/sys/syscall.h

  #define	SYS_getpid         20
*/
final static in SYS_getpid = 20; <i class="conum" data-value="1"></i><b>(1)</b>

MethodHandle syscall = systemCLinker.downcallHandle(
        systemCLinker.lookup(&#34;syscall&#34;).get(),
        FunctionDescriptor.of(
                ValueLayout.JAVA_INT, <i class="conum" data-value="2"></i><b>(2)</b>
                ValueLayout.JAVA_INT  <i class="conum" data-value="3"></i><b>(3)</b>
        )
);

int pid = (int) syscall.invoke(SYS_getpid); <i class="conum" data-value="4"></i><b>(4)</b>
System.out.println(&#34;pid: &#34; + pid);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The syscall number.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The return type of the syscall function.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The first argument is the syscall number.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Making the syscall.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>That’s it, we’ve made out first direct syscall using panama (and the JEP-419).
Simple right?Let’s try to use that knowledge for <code>memfd_secret</code> syscall.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_memfd_secret"><a class="anchor" href="#_memfd_secret"></a><a class="link" href="#_memfd_secret"><code>memfd_secret</code></a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>memfd_secret</code> syscall was introduced in this <a href="https://github.com/torvalds/linux/commit/1507f51255c9ff07d75909a84e7c0d7f3c4b2f49">commit</a>.
Fortunately Linux has good commit message, so we can read and learn more about
how to create &#34;secret&#34; memory areas.</p>
</div>
<div class="paragraph">



<div class="table-wrapper">
    <div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>The following example demonstrates creation of a secret mapping (error
handling is omitted):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">fd = memfd_secret(0);
ftruncate(fd, MAP_SIZE);
ptr = mmap(NULL, MAP_SIZE, PROT_READ | PROT_WRITE, MAP_SHARED, fd, 0);</code></pre>
</div>
</div>
</blockquote>
</div>

</div>

</div>
<div class="paragraph">
<p>Basically we need to create the <em>secret</em> file descriptor, truncate it to the
desired size, and then memory map it.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>First get a file descriptor with <code>memfd_secret</code></p>
<div class="listingblock">
<div class="title">memfd_secret syscall</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">/*
  On linux (Intel x86_64) in /usr/include/asm/unistd_64.h

  #define __NR_memfd_secret 447
*/
final static in SYS_memfd_secret = 447; <i class="conum" data-value="1"></i><b>(1)</b>

MethodHandle syscall = systemCLinker.downcallHandle(
        systemCLinker.lookup(&#34;syscall&#34;).get(),
        FunctionDescriptor.of(
                ValueLayout.JAVA_INT, <i class="conum" data-value="2"></i><b>(2)</b>
                ValueLayout.JAVA_INT, <i class="conum" data-value="3"></i><b>(3)</b>
                ValueLayout.JAVA_INT, <i class="conum" data-value="4"></i><b>(4)</b>
        )
);

int secret_fd = (int) syscall.invoke(SYS_memfd_secret, 0); <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>memfd_secret</code> number.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The return type of the syscall function.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The first argument is the syscall number.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The flags passed to <code>memfd_secret</code>, currently the only supported flag is
<code>O_CLOEXEC</code> according to this <a href="https://lwn.net/Articles/865256/">LWN article by Jonathan Corbet</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Making the syscall, not using any flags, the returned value is a file descriptor.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>We can proceed with the rest of the process.</p>
</div>
</li>
<li>
<p>Then sets the desired size</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// int ftruncate(int fd, off_t length);
MethodHandle ftruncate = systemCLinker.downcallHandle(
        systemCLinker.lookup(&#34;ftruncate&#34;).get(),
        FunctionDescriptor.of(
                ValueLayout.JAVA_INT,
                ValueLayout.JAVA_INT, // fd
                ValueLayout.JAVA_LONG // length
        )
);

var res = (int) ftruncate.invoke( <i class="conum" data-value="1"></i><b>(1)</b>
        secret_fd,
        secret.length()
);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Invoke the <code>ftruncate</code> from the <em>libc</em> on the file descriptor
with the wanted size.</td>
</tr>
</tbody></table>
</div>
</li>
<li>
<p>Finally, memory map this file descriptor, this operation has the effect to
<em>unmap</em> this memory segment from the Kernel pages (in Ring 0), so only the
user process can read these memory pages.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// in /usr/include/bits/mman-linux.h
// #define PROT_READ       0x1             /* Page can be read.  */
// #define PROT_WRITE      0x2             /* Page can be written.  */
final int PROT_READ = 1;
final int PROT_WRITE = 2;
// #define MAP_SHARED      0x01            /* Share changes.  */
final int MAP_SHARED = 1;

// in /usr/include/sys/mman.h
// extern void *mmap (void *__addr, size_t __len, int __prot,
//                   int __flags, int __fd, __off_t __offset) __THROW;
MethodHandle mmap = systemCLinker.downcallHandle(
        systemCLinker.lookup(&#34;mmap&#34;).get(),
        FunctionDescriptor.of(
                ValueLayout.ADDRESS, // addr
                ValueLayout.ADDRESS, // addr
                ValueLayout.JAVA_LONG, // size
                ValueLayout.JAVA_INT, // protection modes
                ValueLayout.JAVA_INT, // flags
                ValueLayout.JAVA_INT, // fd
                ValueLayout.JAVA_LONG // offset
        )
);

var segmentAddress = (MemoryAddress) mmap.invoke( <i class="conum" data-value="1"></i><b>(1)</b>
        NULL,
        secret.length(),
        PROT_READ | PROT_WRITE,
        MAP_SHARED,
        secret_fd,
        0
);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><em>Memory-map</em> the file descriptor, using the same wanted size,
and use the right protection modes (read &amp; write), and flags.</td>
</tr>
</tbody></table>
</div>
</li>
<li>
<p>Once the memory segment is mapped, we can actually get access to it
via the <code>MemorySegment</code> API.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">var secretSegment = MemorySegment.ofAddress(segmentAddress, length, scope); <i class="conum" data-value="1"></i><b>(1)</b>
secretSegment.copyFrom(MemorySegment.ofArray(secretBytes)); <i class="conum" data-value="2"></i><b>(2)</b>
var roSecretSegement = secretSegment.asReadOnly(); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create a <code>MemorySegment</code> from the memory segment address,
also using the same size, and the current <code>ResourceScope</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Since <code>secretSegment</code> is actually a <code>MemorySegment</code> <strong>off heap</strong>, the
secret array as to be transformed first into an <strong>on-heap</strong> <code>MemorySegment</code>
before being copied to the <em>secret</em> memory mapping.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Eventually make the segment read-only.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>And to read the secret, just extract the byte array from the memory segment.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">var bytes = secretSegment.toArray(ValueLayout.JAVA_BYTE);</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>With this you have a complete working example of how to use the <code>memfd_secret</code>
from Java using Panama (JEP-419).</p>
</div>
<div class="paragraph">
<p>…or not!</p>
</div>
<div class="paragraph">
<p>Indeed, running this will make the JVM <em>seg-fault</em>!</p>
</div>
<div class="listingblock">
<div class="title">stdout</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">#
# A fatal error has been detected by the Java Runtime Environment:
#
#  SIGSEGV (0xb) at pc=0x00007f561919ffd7, pid=4798, tid=4799
#
# JRE version: OpenJDK Runtime Environment 22.3 (18.0+37) (build 18+37)
# Java VM: OpenJDK 64-Bit Server VM 22.3 (18+37, mixed mode, sharing, tiered, compressed oops, compressed class ptrs, g1 gc, linux-amd64)
# Problematic frame:
# v  ~StubRoutines::jbyte_disjoint_arraycopy
#
# Core dump will be written. Default location: Core dumps may be processed with &#34;/usr/lib/systemd/systemd-coredump %P %u %g %s %t %c %h&#34; (or dumping to /home/bob/opensource/core.4798)
#
# An error report file with more information is saved as:
# /home/bob/opensource/hs_err_pid4798.log
#
# If you would like to submit a bug report, please visit:
#   https://bugzilla.redhat.com/enter_bug.cgi?product=Fedora&amp;component=java-latest-openjdk&amp;version=35
#</code></pre>
</div>
</div>
<div class="paragraph">
<p>So, what did happen ? The problematic frame isn’t helpful if you’re not familiar with JVM internals.
Opening <code>hs_err_pid4798.log</code> is more helpful.</p>
</div>
<div class="listingblock">
<div class="title">filename</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">...

Stack: [0x00007f734ae3d000,0x00007f734af3e000],  sp=0x00007f734af3c430,  free space=1021k
Native frames: (J=compiled Java code, j=interpreted, Vv=VM code, C=native code)
v  ~StubRoutines::jbyte_disjoint_arraycopy
V  [libjvm.so+0xe66d70]  Unsafe_CopyMemory0+0xd0
j  jdk.internal.misc.Unsafe.copyMemory0(Ljava/lang/Object;JLjava/lang/Object;JJ)V+0 java.base@18.0.1
j  jdk.internal.misc.Unsafe.copyMemory(Ljava/lang/Object;JLjava/lang/Object;JJ)V+29 java.base@18.0.1
j  jdk.internal.misc.ScopedMemoryAccess.copyMemoryInternal(Ljdk/internal/misc/ScopedMemoryAccess$Scope;Ljdk/internal/misc/ScopedMemoryAccess$Scope;Ljava/lang/Object;JLjava/lang/Object;JJ)V+32 java.base@18.0.1
j  jdk.internal.misc.ScopedMemoryAccess.copyMemory(Ljdk/internal/misc/ScopedMemoryAccess$Scope;Ljdk/internal/misc/ScopedMemoryAccess$Scope;Ljava/lang/Object;JLjava/lang/Object;JJ)V+12 java.base@18.0.1
j  jdk.incubator.foreign.MemorySegment.copy(Ljdk/incubator/foreign/MemorySegment;Ljdk/incubator/foreign/ValueLayout;JLjdk/incubator/foreign/MemorySegment;Ljdk/incubator/foreign/ValueLayout;JJ)V+202 jdk.incubator.foreign@18.0.1
j  jdk.incubator.foreign.MemorySegment.copy(Ljdk/incubator/foreign/MemorySegment;JLjdk/incubator/foreign/MemorySegment;JJ)V+13 jdk.incubator.foreign@18.0.1
j  jdk.incubator.foreign.MemorySegment.copyFrom(Ljdk/incubator/foreign/MemorySegment;)Ljdk/incubator/foreign/MemorySegment;+10 jdk.incubator.foreign@18.0.1 <i class="conum" data-value="1"></i><b>(1)</b>
j  io.github.bric3.panama.f.syscalls.LinuxSyscall.memfd_secret_external()V+48
j  io.github.bric3.panama.f.syscalls.LinuxSyscall.main([Ljava/lang/String;)V+99
v  ~StubRoutines::call_stub
V  [libjvm.so+0x81420a]  JavaCalls::call_helper(JavaValue*, methodHandle const&amp;, JavaCallArguments*, JavaThread*)+0x30a
V  [libjvm.so+0x8a2111]  jni_invoke_static(JNIEnv_*, JavaValue*, _jobject*, JNICallType, _jmethodID*, JNI_ArgumentPusher*, JavaThread*) [clone .isra.174] [clone .constprop.397]+0x351
V  [libjvm.so+0x8a4a05]  jni_CallStaticVoidMethod+0x145
C  [libjli.so+0x47a9]  JavaMain+0xd19
C  [libjli.so+0x7d69]  ThreadJavaMain+0x9
...

siginfo: si_signo: 11 (SIGSEGV), si_code: 1 (SEGV_MAPERR), si_addr: 0xffffffffffffffff <i class="conum" data-value="2"></i><b>(2)</b>

...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This happened while doing the <code>MemorySegment::copyFrom</code> call.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Moreover, the segmentation fault appears to have been caused by a memory access
to non mapped memory address <code>SEGV_MAPERR</code>. <em>The most common other reason for segfault
is <code>SEGV_ACCERR</code>, which is caused by accessing a memory address with wrong permissions.</em></td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>So what happened ? Actually, the value of the file descriptor was <code>-1</code>. Which of course
is not a valid file descriptor. Also, the call to <code>ftruncate</code> seems to handle well
the case where the file descriptor is not valid.</p>
</div>
<div class="paragraph">
<p>The call to <code>mmap</code> the file descriptor, also returns <code>-1</code>, which is supposed to
be the memory segment address.</p>
</div>
<div class="paragraph">
<p>So why did this happen? When invoking native methods, syscalls in particular, one
need to be aware of the <em>convention</em> about error handling for these methods.</p>
</div>
<div class="sect2">
<h3 id="_errno"><a class="anchor" href="#_errno"></a><a class="link" href="#_errno"><code>errno</code></a></h3>
<div class="paragraph">
<p>Indeed, when developing in C/C++, when something returns <code>-1</code>, it usually means
that something went wrong, and that the result is invalid.</p>
</div>
<div class="paragraph">
<p>Moreover, the <code>errno</code> variable is a global variable that is set by the system
calls and some library functions, see the relevant
<a href="https://www.man7.org/linux/man-pages/man3/errno.3.html"><code>man 3 errno</code></a>.</p>
</div>
<div class="paragraph">
<p>Because it is a global variable its declaration depends on the system.</p>
</div>
<div class="exampleblock primary">
<div class="title">Example 5. Linux’s <code>errno</code></div>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>/usr/include/asm-generic/errno.h</code></p>
</li>
<li>
<p><code>/usr/include/asm-generic/errno-base.h</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">errno declaration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">extern int *__errno_location (void) __THROW __attribute_const__;
# define errno (*__errno_location ())</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">errno codes</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">...
/*
 * This error code is special: arch syscall entry code will return
 * -ENOSYS if users try to call a syscall that doesn&#39;t exist.  To keep
 * failures of syscalls that really do exist distinguishable from
 * failures due to attempts to use a nonexistent syscall, syscall
 * implementations should refrain from returning -ENOSYS.
 */
#define ENOSYS          38      /* Invalid system call number */
...</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock secondary">
<div class="title">Example 6. macOs’s <code>errno</code></div>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include/sys/errno.h</code></p>
</li>
<li>
<p><code>/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/include/sys/errno.h</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">errno declaration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">extern int * __error(void);
#define errno (*__error())</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">errno codes</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">...
#define ENOLCK          77              /* No locks available */
#define ENOSYS          78              /* Function not implemented */
...</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>So we’ll need to check the errors after each call in our case, as each of these
calls are system calls underneath.</p>
</div>
<div class="paragraph">
<p>On Linux we can see that <code>errno</code> definition is actually a call to a function
that return a pointer : <code>*__errno_location ()</code></p>
</div>
<div class="listingblock">
<div class="title">checking <code>errno</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">MethodHandle __errnoLocationMH = systemCLinker.downcallHandle(
        systemCLinker.lookup(&#34;__errno_location&#34;),
        FunctionDescriptor.of(ValueLayout.ADDRESS)
);

int errno = ((MemoryAddress) __errnoLocationMH.invoke()) <i class="conum" data-value="1"></i><b>(1)</b>
        .get(ValueLayout.JAVA_INT, 0); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Get <code>errno</code> address</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Read <code>errno</code> value</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>On Linux the package <code>more-utils</code> has a tool called <code>errno</code> that can be used
to list all the error codes <code>errno -l</code>.</p>
</div>
<div class="paragraph">
<p>Additionally, there is a function <code>strerror</code> that returns a string from an error
code.</p>
</div>
<div class="listingblock">
<div class="title">getting the error message</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">MethodHandle strerror = systemCLinker.downcallHandle(
      systemCLinker.lookup(&#34;strerror&#34;).get(),
      FunctionDescriptor.of(ValueLayout.ADDRESS, ValueLayout.JAVA_INT)
);

String errmsg = ((MemoryAddress) strerror.invoke(errno)).getUtf8String(0);</code></pre>
</div>
</div>
<div class="paragraph">
<p>So, placing this check after the <code>memfd_secret</code> syscall, looked like a good bet.
Eventually doing something similar after each call is a good idea as well, it
kinda looks like the Go <em>lang</em> way of checking errors.</p>
</div>
<div class="listingblock">
<div class="title">memfd_secret error checking</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">fd = (int) sys_memfd_secret.invoke(0);
if (fd == -1) {
  var errno = errno();
  System.err.println(errno == ENOSYS ?
                     &#34;tried to call a syscall that doesn&#39;t exist (errno=ENOSYS), may need to set the &#39;secretmem.enable=1&#39; kernel boot option&#34; :
                     &#34;syscall memfd_secret failed, errno: &#34; + errno + &#34;, &#34; + strerror(errno));
  return Optional.empty();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>While reviewing the <code>memfd_secret</code> commit, we can see there’s a check that
returns <code>ENOSYS</code> when a
<a href="https://github.com/torvalds/linux/commit/1507f51255c9ff07d75909a84e7c0d7f3c4b2f49#diff-659f2a8bad777301f059a00056336b415c41e024f88280a2131e0eabd7507b91R186-R187">condition is not met</a>.</p>
</div>
<div class="paragraph">
<p>So in order to make the whole thing work, we need to tackle what’s preventing
<code>memfd_secret</code> to happen.</p>
</div>
</div>
<div class="sect2">
<h3 id="_linux_bootloader_flag"><a class="anchor" href="#_linux_bootloader_flag"></a><a class="link" href="#_linux_bootloader_flag">Linux bootloader flag</a></h3>
<div class="paragraph">
<p>So actually, Linux is gating the <code>memfd_secret</code> syscall by a flag named
<code>secretmem_enable</code>. That maybe why <code>memfd_secret</code> is not listed whe looking at
<a href="https://man7.org/linux/man-pages/man2/syscalls.2.html"><code>man 2 syscalls</code></a>.</p>
</div>
<div class="paragraph">
<p>It’s not quite clear from the <a href="https://github.com/torvalds/linux/commit/1507f51255c9ff07d75909a84e7c0d7f3c4b2f49">commit</a>
that introduced <code>memfd_secret</code> but in order to work, the <em>machine boot</em> has to
be configured with the flag <code>secretmem.enable=1</code>.</p>
</div>
<div class="admonitionblock important">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
DISCLAIMER: I am not responsible if something happens wrong on your
machines / OS. The following actually changes the Linux bootloader configuration,
and as such, any misconfiguration could make this system non-bootable!
Please read and understand the documentation of your system before proceeding.
</td>
</tr>
</tbody></table>
</div>
<div class="admonitionblock caution">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Enabling this prevents hibernation whenever there are active secret memory users.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>My test machine is a Fedora 35, let’s read their <a href="https://docs.fedoraproject.org/en-US/fedora/latest/system-administrators-guide/kernel-module-driver-configuration/Working_with_the_GRUB_2_Boot_Loader/">page on the GRUB2 bootloader</a>.</p>
</div>
<div class="paragraph">
<p>From this page, it seems there’s a fairly simple way to change the bootloader
configuration.</p>
</div>
<div class="listingblock">
<div class="title">add <code>secretmem.enable=1</code> flag</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo grubby --update-kernel=ALL --args=&#34;secretmem.enable=1&#34;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">check the configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo grubby --info=ALL</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">remove <code>secretmem.enable=1</code> flag</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo grubby --update-kernel=ALL --remove-args=&#34;secretmem.enable=1&#34;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice the actual flag name is <code>secretmem.enable</code>, not <code>secretmem_enable</code> !</p>
</div>
<div class="paragraph">
<p>The reboot the OS. Now if the configuration was properly applied,
<code>memfd_secret</code> should return a valid file descriptor.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ java --add-modules=jdk.incubator.foreign --enable-native-access=ALL-UNNAMED MemfdSecret.java
WARNING: Using incubator modules: jdk.incubator.foreign
warning: using incubating module(s): jdk.incubator.foreign
1 warning
Secret mem fd: 4 <i class="conum" data-value="1"></i><b>(1)</b>
Secret: super secret decryption key</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>memfd_secret</code> here returned the file descriptor <code>4</code></td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Typically, this secret storage could be used to store a decryption key
during startup, and it’ll be used to decrypt encrypted payload.
Of course, care must be taken to prevent this data from leaving
this memory. Which might not be possible under many circumstances.
E.g. a library that takes a Java String, in which case the secret
buffer is copied in elsewhere in the heap.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_improvements"><a class="anchor" href="#_improvements"></a><a class="link" href="#_improvements">Improvements</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_trying_to_replace_most_panama_calls_by_jdk_types"><a class="anchor" href="#_trying_to_replace_most_panama_calls_by_jdk_types"></a><a class="link" href="#_trying_to_replace_most_panama_calls_by_jdk_types">Trying to replace most panama calls by JDK types</a></h3>
<div class="paragraph">
<p>So appart from the <code>memfd_secret</code> syscall, the other calls, looks to be
replaceable ?</p>
</div>
<div class="paragraph">
<p><code>MemorySegment.mapFile</code> looks like a good bet to replace <code>mmap</code>.</p>
</div>
<div class="paragraph">
<p>However, upon first use, things start to look problematic. The signature
requires a <code>Path</code> and the mapping is limited to a single <code>MapMode</code>.</p>
</div>
<div class="listingblock">
<div class="title"><code>MemorySegment::mapFile</code> signature</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">static MemorySegment mapFile(
        Path path,
        long bytesOffset,
        long bytesSize,
        FileChannel.MapMode mapMode,
        ResourceScope scope
) throws IOException {</code></pre>
</div>
</div>
<div class="paragraph">
<p>Supposing the file descriptor value is <code>4</code>, if it was possible to pass
<code>/dev/fd/4</code> or <code>/proc/self/fd/4</code> as a <code>Path</code>, we could not map this segment
as read and write via this API.
And performing this operation twice, one in read-only mode and one in
write-only mode, would not work as this special file descriptor is closed
after the first memory mapping.</p>
</div>
<div class="paragraph">
<p>There’s some interesting bits in <code>FileOutputStream</code> / <code>FileInputStream</code> as they
can be created from a JDK’s <code>FileDescriptor</code>, they to allow to get the underneath
<code>FileChannel</code>, which then allow to call <code>map()</code> to get a memory mapping. However,
<code>FileDescriptor</code> class does not have a public constructor, and even being able to
hack <code>FileDescriptor</code> (with`--add-opens=java.base/java.io=ALL-UNNAMED`) is not
enough as we get in the same situation as above because it’s only possible to
have a mapping in read-only or write-only.</p>
</div>
<div class="paragraph">
<p>Basically, we’re stuck with using the <code>mmap</code> native function to do what’s
necessary. I don’t know if it is out of scope for the JEP-419, or the next
JEP-424, but I think this would be a good thing to support <code>MemorySegment</code> of
arbitrary file descriptor, in particular when writing programs that run on the
command line, this could enable things like
<code>java Main.java &lt;(cat neko | grep meow)</code>.</p>
</div>
<div class="paragraph">
<p>Finally, I don’t believe there’s something equivalent available in JDK for the
<code>ftruncate</code> function.</p>
</div>
</div>
<div class="sect2">
<h3 id="_improving_our_syscall_api"><a class="anchor" href="#_improving_our_syscall_api"></a><a class="link" href="#_improving_our_syscall_api">Improving our syscall API.</a></h3>
<div class="paragraph">
<p>In the snippet above, we’ve declared a <code>MethodHandle</code> to the <code>syscall</code> function,
if there’s multiple syscalls, we’ll need to pass the syscall number as the
first argument each time. <code>MethodHandle</code>s API allows to make <a href="https://codeblog.jonskeet.uk/2012/01/30/currying-vs-partial-function-application/">partial function</a>.</p>
</div>
<div class="listingblock">
<div class="title">syscall partial function</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">var syscallAddress = systemCLinker.lookup(&#34;syscall&#34;).get();
var syscall = systemCLinker.downcallHandle(
        syscallAddress,
        FunctionDescriptor.of(
                ValueLayout.JAVA_INT,
                ValueLayout.JAVA_INT  <i class="conum" data-value="1"></i><b>(1)</b>
        )
);

var sys_getpid = MethodHandles.insertArguments(syscall, 0, SYS_getpid); <i class="conum" data-value="2"></i><b>(2)</b>
sys_getpid.invoke(); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The first argument is the syscall number.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Capture the <code>syscall</code> number and creates a &#34;partial function&#34;.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Invocation of the partial function don’t need argument 0.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Now if the syscall has different arity, <code>MethodHandle::appendArgumentLayouts</code>
has us covered, so that we can use the basic <em>template</em> of a syscall, sort of,
and build on top of this to have specific identifiers for each syscall.</p>
</div>
<div class="listingblock">
<div class="title">syscall partial function, with added arguments</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">var sys_memfd_secret = MethodHandles.insertArguments(systemCLinker.downcallHandle(
        systemCLinker.lookup(&#34;syscall&#34;).get(),
        FunctionDescriptor.of(
                ValueLayout.JAVA_INT,
                ValueLayout.JAVA_INT
        ).appendArgumentLayouts(ValueLayout.JAVA_INT) <i class="conum" data-value="1"></i><b>(1)</b>
), 0, SYS_memfd_secret); <i class="conum" data-value="2"></i><b>(2)</b>

int fd = (int) sys_memfd_secret.invoke(0); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Append arguments to the function descriptor.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Capture the <code>syscall</code> number and creates a &#34;partial function&#34;.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Simply invoke the call passing only required arguments on call site.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Other things are possible with <code>MethodHandle</code>s that can be handy with Panama,
yet out of scope for this blog post. Just check the API.</p>
</div>
</div>
<div class="sect2">
<h3 id="_generating_the_methodhandles_with_jextract"><a class="anchor" href="#_generating_the_methodhandles_with_jextract"></a><a class="link" href="#_generating_the_methodhandles_with_jextract">Generating the <code>MethodHandle</code>s with <code>jextract</code></a></h3>
<div class="paragraph">
<p>The JDK Panama team, also created a tool known as <code>jextract</code> whose job is to
lift most of the work to generate the <code>MethodHandle</code>s.</p>
</div>
<div class="paragraph">
<p>So mentioned in other blog post or conference talks I gave, <code>jextract</code> is now
a separate tool, at this point there’s no binary release which means it has
to be built. The <a href="https://github.com/openjdk/jextract"><code>jextract</code> project page</a>
explains how to do this. My test machine is a Fedora, so adapt the command
and the JDK distribution to your needs.</p>
</div>
<div class="listingblock">
<div class="title">Build jextract</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo dnf install java-latest-openjdk-jmods.x86_64 <i class="conum" data-value="1"></i><b>(1)</b>
curl -LO https://github.com/llvm/llvm-project/releases/download/llvmorg-14.0.0/clang+llvm-14.0.0-x86_64-linux-gnu-ubuntu-18.04.tar.xz <i class="conum" data-value="2"></i><b>(2)</b>
tar xf clang+llvm-14.0.0-x86_64-linux-gnu-ubuntu-18.04.tar.xz
git clone --depth 1 https://github.com/openjdk/jextract.git
cd jextract
sh ./gradlew \
  -Pjdk18_home=/etc/alternatives/java_sdk_18_openjdk \
  -Pllvm_home=/home/bric3/clang+llvm-14.0.0-x86_64-linux-gnu-ubuntu-18.04/ \
  clean verify <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>At this time <em>latest</em> this is an OpenJDK 18</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>LLVM 14 for x86_64</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Run the documented build command with the required home directories.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>If everything is alright you can use <code>jextract</code>:</p>
</div>
<div class="listingblock">
<div class="title"><code>jextract</code> Version</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ build/jextract/bin/jextract --version
WARNING: Using incubator modules: jdk.incubator.foreign
jextract 18.0.1
JDK version 18.0.1+10
clang version 14.0.0</code></pre>
</div>
</div>
<div class="paragraph">
<p>The basic usage is <code>jextract &lt;options&gt; &lt;header file&gt;</code>. Since there is
multiple headers, the trick is to specify a handcrafted header with
every needed header.</p>
</div>
<div class="listingblock">
<div class="title">memfd_secret_header.h</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">#include &lt;errno.h&gt;
#include &lt;unistd.h&gt;
#include &lt;sys/mman.h&gt;
#include &lt;sys/syscall.h&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This would be really neat if <code>jextract</code> or even <code>java</code> could handle any
file descriptors, this could come handy with
<a href="https://en.wikipedia.org/wiki/Here_document#Unix_shells">heredocs</a>.</p>
</div>
<div class="listingblock">
<div class="title">jextract with here-doc, for multiple headers</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ jextract ... &lt;(cat &lt;&lt;-EOF <i class="conum" data-value="1"></i><b>(1)</b>
#include &lt;errno.h&gt;
#include &lt;unistd.h&gt;
#include &lt;sys/syscall.h&gt;
#include &lt;sys/mman.h&gt;
EOF
)</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>&lt;()</code> returns a file descriptor that is not a file on disk,
something like <code>/proc/self/fd/13</code>, whose content is the string between
the <code>&lt;←EOF</code> and <code>EOF</code> markers.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Of course nowadays, <code>jextract</code> bails out when something like <code>/proc/self/fd/13</code>
is passed, reporting that it is <em>not a file</em>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Also note that <code>jextract</code> support passing the options as <em>option file</em>.
So we can pass output options, like the target package and class name,
but also the symbols we’d like.</p>
</div>
<div class="listingblock">
<div class="title">memfd_secret_header.jextract.options</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">--source <i class="conum" data-value="1"></i><b>(1)</b>
--output build/generated/sources/jextract-syscall/java <i class="conum" data-value="2"></i><b>(2)</b>
--target-package linux <i class="conum" data-value="3"></i><b>(3)</b>
--header-class-name syscall_h <i class="conum" data-value="4"></i><b>(4)</b>

--include-function syscall
--include-macro SYS_memfd_secret

--include-function close
--include-function ftruncate

--include-function mmap
--include-function munmap
--include-macro PROT_READ
--include-macro PROT_WRITE
--include-macro MAP_SHARED

--include-function strerror

#### Since errno macro is not supported at this time, it is necessary
#### to manually resolve errno, and include OS specific declarations.
#### e.g. __errno_location is Linux specific
--include-function __errno_location <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Tells <code>jextract</code> to generate the source code, instead of classes.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Specifies the output directory.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Specifies the package name.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Specifies the class name.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Specifies the function used to resolve <code>errno</code> <strong>on Linux</strong>.</td>
</tr>
</tbody></table>
</div>
<div class="listingblock">
<div class="title">Running <code>jextract</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ jextract @memfd_secret.jextract.options tmp.h <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Assuming <code>jextract</code> is in the PATH, or there’s an alias.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>So once done, we’ll have a file with all the symbols we need.</p>
</div>
<div class="listingblock">
<div class="title">syscall_h.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// ...
public class syscall_h  {
    public static MemoryAddress __errno_location () {
        // ...
    }

    public static long syscall ( long __sysno, Object... x1) {
        // ...
    }

    public static MemoryAddress mmap ( Addressable __addr,  long __len,  int __prot,  int __flags,  int __fd,  long __offset) {
        // ...
    }

    // ...

    public static int SYS_memfd_secret() {
        return (int)447L;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>What’s nice is that the arguments are named, eg. <code><em>sysno</em></code><em>, <code></code></em><code>addr</code>, <code>__fd</code>, etc.</p>
</div>
<div class="paragraph">
<p>Once you have made your research on which symbols you need, it’s really nice to
let <code>jextract</code> generate the code for you, which is likely to be up-to date, with
the best practice backed in.</p>
</div>
<div class="paragraph">
<p>There’s one thing where this a bit suboptimal, the <code>__errno_location</code> function
is actually an OS specific function, that is used to revolve the <code>errno</code> value.
I’m unsure if jextract should resolve macros in general, yet <code>errno</code> seems
like something very common, so could it make sense if <code>jextract</code> could handle
this one? But then it’s opening the door to macro resolution which is
a different level of complexity.</p>
</div>
<div class="paragraph">
<p>That being said, it’s not a deal-breaker, just something to be aware of.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_closing_words"><a class="anchor" href="#_closing_words"></a><a class="link" href="#_closing_words">Closing words</a></h2>
<div class="sectionbody">
<div class="paragraph">
<div class="title">memfd_secret</div>
<p>Since I heard about this feature in Linux 5.14 I was hoping to test it after the
spectre style attacks, at least
form a developer perspective. The first thing is that you’ll need a Linux
with that version, so forget Docker Desktop for now as even the latest 4.8 is still
using a Linux 5.10 kernel (at least on macOs). Also, deployment wise, there’s
a flag to enable at boot time, which makes it difficult to deploy, in particular
in a cloud provider unless you have the hands on the bootloader.
On you regular laptop, the fact that this feature disables hibernation is almost
a deal-breaker for this kind of hardware.</p>
</div>
<div class="paragraph">
<p>Personally, If an application is not having a very tight control at how secrets
are actually used, I fail to see the value of such feature.</p>
</div>
<div class="paragraph">
<div class="title">JEP-419</div>
<p>Yet again project Panama embodied by JEP-419 in the JDK 18 delivers, it’s possible
to interact with the system. And doing so with some ease. And without having to
deal with different build systems. I have almost nothing relevant to mention here.
I missed the possibility of creating a <code>MemorySegment</code> from a file descriptor,
but this might be a rare case, especially with the topic at hand.
While I still find the mandatory use of <code>--enable-native-access=ALL-UNNAMED</code>
unpractical especially for an API that is arriving late after alternatives
that do not have this enforcement, this restriction will be relaxed in JEP-425
in JDK19 (<a href="https://github.com/openjdk/jdk/blob/743c779712184ae41e7be4078b0d485ebc51c845/src/java.base/share/classes/java/lang/foreign/package-info.java#L228-L232">java/lang/foreign/package-info.java</a>):
if this flag is not specified, users will get a warning for the first call to
a <em>restricted</em> method (one warning per module).</p>
</div>
<div class="paragraph">
<p>Yet again, I’m happy to see this part of project Panama landing in JDK to bridge
the gap to native world without third party.</p>
</div>
<div class="ulist">
<div class="title">Thanks</div>
<ul>
<li>
<p><a href="https://twitter.com/CarlDea">Carl Dea</a></p>
</li>
<li>
<p><a href="https://twitter.com/jpbempel">Jean-Philippe Bempel</a></p>
</li>
<li>
<p><a href="https://twitter.com/delabassee">David Delabassée</a></p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Resources</div>
<ul>
<li>
<p><a href="https://lwn.net/Articles/604287/">Anatomy of a system call part 1</a></p>
</li>
<li>
<p><a href="https://lwn.net/Articles/604515/">Anatomy of a system call part 2</a></p>
</li>
<li>
<p><a href="https://en.wikipedia.org/wiki/Protection_ring">Wikipedia: Protection Rings</a></p>
</li>
<li>
<p><a href="https://dev.to/tomassirio/hello-world-in-asm-x8664-jg7">Hello World! in ASM x86_64</a></p>
</li>
<li>
<p><a href="https://www.nekosecurity.com/x86-64-assembly/part-3-nasm-anatomy-syscall-passing-argument">NekoSecurity: x86-64 Assembly: Part-3: NASM Anatomy / Syscall / Passing Argument</a></p>
</li>
<li>
<p><a href="https://en.wikipedia.org/wiki/X86_assembly_language">Wikipedia: X86 assembly language</a></p>
</li>
<li>
<p><a href="https://www.pwnthebox.net/reverse/engineering/and/binary/exploitation/series/2019/03/30/return-oriented-programming-part2.html">PwnTheBox: Part 2: Return-oriented programming</a></p>
</li>
<li>
<p><a href="https://man7.org/linux/man-pages/">man7.org</a></p>
</li>
<li>
<p><a href="https://inside.java">inside.java</a> of course</p>
</li>
<li>
<p><a href="https://openjdk.java.net/jeps/419">JEP-419</a></p>
</li>
</ul>
</div>
</div>
</div>

  </div>
  

<div class="navigation navigation-single">
    
    <a href="/2021/09/04/a-practical-look-at-jep-412-in-jdk17-with-libsodium/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">A practical look at JEP-412 in JDK17 with libsodium</span>
    </a>
    
    
</div>


  

  <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
        
        
        
        this.page.identifier = 'https://blog.arkey.fr/2022/05/16/linux_memfd_secret_with_jep-419/';
        this.page.title = 'Using Linux\u0027s memfd_secret syscall from the JVM with JEP-419';
        this.page.url = 'https://blog.arkey.fr/2022/05/16/linux_memfd_secret_with_jep-419/';
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "thecoffeeworkshop" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</article>


            
    
<footer>

 
 
 <div class="github-edit">
     <a href="https://github.com/bric3/bric3.github.io/edit/hugo-sources/content/posts/2022-05-04-linux_memfd_secret_with_jep419.adoc">
     <i class="fab fa-github fa-lg" aria-hidden="true"></i> Edit this page
     </a>
 </div>
 




















<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: { inlineMath: [["\\(", "\\)"]], displayMath: [["\\[", "\\]"]], ignoreClass: "nostem|nolatexmath" },
  asciimath2jax: { delimiters: [["\\$", "\\$"]], ignoreClass: "nostem|noasciimath" },
  TeX: { equationNumbers: { autoNumber: "none" } }
})
MathJax.Hub.Register.StartupHook("AsciiMath Jax Ready", function () {
  MathJax.InputJax.AsciiMath.postfilterHooks.Add(function (data, node) {
    if ((node = data.script.parentNode) && (node = node.parentNode) && node.classList.contains("stemblock")) {
      data.math.root.display = "block"
    }
    return data
  })
})
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js" integrity="sha512-M36RUChWzAh1veeenRZFql7HydLEnkYmoloiCvVrhz402UZgKI93qkV7SsaxtVKdN95Wzajh39ysrXCq34NTsg==" crossorigin="anonymous"></script>
<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/config/TeX-MML-AM_HTMLorMML-full.min.js" integrity="sha512-SdNVJmCczXFqz3Iok8gP+cloe2CScrnHJczMBwL+aSrdZVllRNqRJ5A2p83S4fUM8I4endIZgM2ZIkwNqb3Eew==" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.4.1/highlight.min.js" integrity="sha512-DrpaExP2d7RJqNhXB41Q/zzzQrtb6J0zfnXD5XeVEWE8d9Hj54irCLj6dRS3eNepPja7DvKcV+9PnHC7A/g83A==" crossorigin="anonymous"></script>
    <script type="text/javascript">
        
        hljs.initHighlightingOnLoad();
    </script>
    

<script src="https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js" integrity="sha256-vrn14y7WH7zgEElyQqm2uCGSQrX/xjYDjniRUQx3NyU=" crossorigin="anonymous"></script>
<script type="text/javascript">
function addBlockSwitches() {
	$('.primary').each(function() {
		primary = $(this);
		createSwitchItem(primary, createBlockSwitch(primary)).item.addClass("selected");
		primary.children('.title').remove();
	});
	$('.secondary').each(function(idx, node) {
		secondary = $(node);
		primary = findPrimary(secondary);
		switchItem = createSwitchItem(secondary, primary.children('.switch'));
		switchItem.content.addClass('hidden');
		findPrimary(secondary).append(switchItem.content);
		secondary.remove();
	});
}

function createBlockSwitch(primary) {
	blockSwitch = $('<div class="switch"></div>');
	primary.prepend(blockSwitch);
	return blockSwitch;
}

function findPrimary(secondary) {
	candidate = secondary.prev();
	while (!candidate.is('.primary')) {
		candidate = candidate.prev();
	}
	return candidate;
}

function createSwitchItem(block, blockSwitch) {
	blockName = block.children('.title').text();
	content = block.children('.content').first().append(block.next('.colist'));
	item = $('<div class="switch--item">' + blockName + '</div>');
	blockSwitch.append(item);
	return {'item': item, 'content': content};
}

function globalSwitch() {
	$('.switch--item').each(function() {
		var blockId = blockIdForSwitchItem($(this));
		$(this).off('click');
		$(this).on('click', function() {
			selectedText = $(this).text()
			window.localStorage.setItem(blockId, selectedText);
			$(".switch--item").filter(function() {
				return blockIdForSwitchItem($(this)) === blockId;
			}).filter(function() {
				return $(this).text() === selectedText;
			}).each(function() {
				select($(this))
			});
		});
		if ($(this).text() === window.localStorage.getItem(blockId)) {
			select($(this))
		}
	});
}

function blockIdForSwitchItem(item) {
	idComponents = []
	idComponents.push(item.text().toLowerCase());
	item.siblings(".switch--item").each(function(index, sibling) {
		idComponents.push($(sibling).text().toLowerCase());
	});
	return idComponents.sort().join("-")
}

function select(selected) {
	selected.addClass('selected');
	selected.siblings().removeClass('selected');
	selectedContent = selected.parent().siblings(".content").eq(selected.index())
	selectedContent.removeClass('hidden');
	selectedContent.siblings().addClass('hidden');
}

$(addBlockSwitches);
$(globalSwitch);
</script>





</footer>

    



        </div>
    </body>
</html>

