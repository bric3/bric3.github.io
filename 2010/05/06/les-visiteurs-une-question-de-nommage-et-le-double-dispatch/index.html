<!DOCTYPE html>
<html lang="en-US">
    
    


    <head>
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="https://www.gravatar.com">
    <link rel="dns-prefetch" href="https://giscus.app">

    <link href="https://gmpg.org/xfn/11" rel="profile">
    
    <link rel="canonical" href="https://blog.arkey.fr/2010/05/06/les-visiteurs-une-question-de-nommage-et-le-double-dispatch/">
    

    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.82.1" />

    
    
    

<title>Les visiteurs, une question de nommage, et le double-dispatch â€¢ Brice Dutheil</title>













    
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Brice Dutheil">
<meta property="og:title" content="Les visiteurs, une question de nommage, et le double-dispatch">
<meta property="og:type" content="website">
<meta property="og:url" content="https://blog.arkey.fr/2010/05/06/les-visiteurs-une-question-de-nommage-et-le-double-dispatch/" />
<meta property="og:description" content="Java mostly, and general tech">
<meta property="og:image" content="https://blog.arkey.fr/social-sharing.png">
<meta property="og:image:type" content="image/png">
    
    
    
<meta property="og:image:width" content="512">
<meta property="og:image:height" content="512">
    

<meta property="og:updated_time" content="2010-05-06T16:02:10Z">



<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@BriceDutheil">
<meta name="twitter:title" content="Les visiteurs, une question de nommage, et le double-dispatch">

<meta name="twitter:image" content="https://blog.arkey.fr/social-sharing.png">

<meta name="twitter:description" content="Java mostly, and general tech">
<meta name="twitter:creator" content="@BriceDutheil">
    
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/a11y-light.min.css" media="(prefers-color-scheme: light)"><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/gruvbox-dark.min.css" media="(prefers-color-scheme: dark)">




<link rel="stylesheet" href="/scss/ascii-press.d6bafe0d39194a15e5deee39d0dad5d2118d57cf6ace33b94bb9dbfda6ab0415.css" integrity="sha256-1rr&#43;DTkZShXl3u450NrV0hGNV89qzjO5S7nb/aarBBU=">


<link rel="stylesheet" href="/scss/ascii-press-dark.06869de8a04135a809635aeb8b272847be96c60ddaa9197e026e19efe21e6909.css" integrity="sha256-Boad6KBBNagJY1rriycoR76Wxg3aqRl&#43;Am4Z7&#43;IeaQk=" media="(prefers-color-scheme: dark)">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">




<link rel="stylesheet" href="/scss/hugo-toc.d31afb68f96b4b4a16c6def81c6cfb18992a6924bd88766a480bb24a08ca5796.css" integrity="sha256-0xr7aPlrS0oWxt74HGz7GJkqaSS9iHZqSAuySgjKV5Y=">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js" integrity="sha512-UDJtJXfzfsiPPgnI5S1000FPLBHMhvzAMX15I+qG2E2OAzC9P1JzUwJOfnypXiOH7MRPaqzhPbBGDNNj7zBfoA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.min.js" integrity="sha512-qWVvreMuH9i0DrugcOtifxdtZVBBL0X75r9YweXsdCHtXUidlctw7NXg5KVP3ITPtqZ2S575A0wFkvgS2anqSA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <![endif]-->

    <!-- Icons from https://realfavicongenerator.net -->
<link rel="icon" href="/favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<meta name="msapplication-TileColor" content="#b64f4f">
<meta name="theme-color" content="#b64f4f">



    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/v4-shims.min.css" integrity="sha512-fHavkBby/gcFEB2taaBfG0DLdHRGrnvkWQNXVZ5Yb/Fj6LkogecQUd6oyvBVsrWPaHSxs5tNza6LUW/Y6Az9lQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    
    

</head>


    <body class="">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="https://blog.arkey.fr">Brice Dutheil</a>
      </span>
      
      
        <div class="author-image">
          <img src="https://www.gravatar.com/avatar/f31c7fbcbb0766d0632d96fd7e74b649?s=240&d=mp" class="img--circle img--headshot element--center" alt="gravatar">
        </div>
      
      <p class="site__description">
         Java mostly, and general tech 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">Brice Dutheil</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/"><span class='fa-icon'><i class='fas fa-home'></i></span><code>cd <em>~</em></code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/posts/"><span class='fa-icon'><i class='fas fa-stream'></i></span><code>ls <em>posts/*</em></code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/series/"><span class='fa-icon'><i class='fas fa-list-alt'></i></span><code>grep -o <em>series</em> posts/* | sort -u</code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/tags/"><span class='fa-icon'><i class='fas fa-tags'></i></span><code>grep -o <em>tags</em> posts/* | sort -u</code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/cool-stuff/"><span class='fa-icon'><i class='fas fa-thumbtack'></i></span><code>cd <em>cool-stuff</em></code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/whoami/"><span class='fa-icon'><i class='fas fa-id-card'></i></span><code>whoami</code>
						<span></span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://twitter.com/BriceDutheil" rel="me"><i class="fa-w-16" aria-hidden="true"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="bird" class="svg-inline--fa fa-bird fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></i></a>
	
	
	
	<a href="https://github.com/bric3" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	<a href="https://speakerdeck.com/bric3" rel="me"><i class="fab fa-speaker-deck" aria-hidden="true"></i></i></a>
	
	
	
	
	
	
	
	<a href="https://linkedin.com/in/dutheilbrice" rel="me"><i class="fa-w-16" aria-hidden="true"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="pro-network" class="svg-inline--fa fa-pro-network fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></i></a>
	
	
	<a href="https://stackoverflow.com/users/48136/brice" rel="me"><i class="fab fa-stack-overflow fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	
</section>

      </div>
    </div>

  </div>
  <div class="container fixed-container">
    
<div class="copyright">
  &copy; 2010 - 2022 Brice Dutheil
  
    <a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a>
  
</div>



  </div>
</div>

        <div class="content container">
            
    <header>

 
 
 <div class="github-edit">
     <a href="https://github.com/bric3/bric3.github.io/edit/hugo-sources/content/posts/2010-05-06-les-visiteurs-une-question-de-nommage-et-le-double-dispatch.md">
     <i class="fab fa-github fa-lg" aria-hidden="true"></i> Edit this page
     </a>
 </div>
 


</header>

            
    

<article>
  <header>
    <h1>Les visiteurs, une question de nommage, et le double-dispatch</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> 2010-05-06
    
    
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/code">code</a>
           
      
          <a class="badge badge-tag" href="/tags/design">design</a>
           
      
          <a class="badge badge-tag" href="/tags/pattern">pattern</a>
          
      
    
    
    <br/>
    <i class="fas fa-clock"></i> 25 min read

    
    
    

</div>


  </header>
  
  
  
    <div class="toc-wrapper">
      <input type="checkbox" id="tocToggle" checked>
      <label for="tocToggle"><i class="fas fa-list-ul fa-lg"></i><span id="toc-title">On this page</span></label>
      <div id="toc-toggle-cover"></div>

      
          <nav id="TableOfContents">
  <ul>
    <li><a href="#exemple-de-visiteurs">Exemple de visiteurs</a></li>
    <li><a href="#quand-on-a-davatage-dobjets-du-domaine-Ã -visiter-attention">Quand on a davatage d&rsquo;objets du domaine Ã  visiter, attention!</a></li>
  </ul>
</nav>
      
    </div>
  
  
  
  <div class="post md">
    <h1 id="une-histoire-qui-commence-mal">Une histoire qui commence mal</h1>
<p>OK, je tranche le malheureux pattern Visiteur a la vie dure; on ne l&rsquo;aime pas trop, il est mal compris, et le pauvre est sous utilisÃ©. Alors bon mÃªme s&rsquo;il a ses dÃ©fauts, pourquoi lui en vouloir autant, alors qu&rsquo;il apporte justement ses avantages au <strong>code orientÃ© objet</strong>.</p>
<p>Et oui vous avez bien lu orientÃ© objet. Jusqu&rsquo;Ã  aujourd&rsquo;hui j&rsquo;ai vu du code qui ressemble Ã  Ã§a?</p>
<ul>
<li>On a soit des objets trÃ¨s complexes, avec des comportements qu&rsquo;il n&rsquo;est pas forcÃ©mentÂ intÃ©ressantÂ de mettre dans l&rsquo;objet mÃªme. Le code ci-dessous montre un objet ou les mÃ©thodes qui permettent de rÃ©cupÃ©rer les livres d&rsquo;un certain genre ne sont pas forcÃ©ment appropriÃ©es dans cette partie du code. PourquoiÂ parce qu&rsquo;ilÂ est envisageable (selon le bon sens) que d&rsquo;autres genres serait apprÃ©ciÃ©. Et s&rsquo;il faut ajouter d&rsquo;autres mÃ©thodes encore.</li>
</ul>
<pre><code class="language-java">public class FatObject {
  private Iterable&lt;book&gt; books;

  public Iterable&lt;Book&gt; selectOnlySciFi() { ... }
  public Iterable&lt;Book&gt; selectOnlyThriller() { ... }
  public Iterable&lt;Book&gt; selectOnlyDetectiveStory() { ... }
  public Iterable&lt;Book&gt; selectOnlyRomance() { ... }
  public Iterable&lt;Book&gt; selectOnlyManga() { ... }
}
</code></pre>
<ul>
<li>Ou alors on a des objets anÃ©miques (cf <a href="http://www.martinfowler.com/bliki/AnemicDomainModel.html">Martin Fowler</a>) et le comportement est bien en dehors des objets traitÃ©s, mais, et c&rsquo;est la Ã§a pÃ¨che, le comportement est dÃ©localisÃ© dans des helpers. Bref en gros c&rsquo;est de la programmation procÃ©durale, ce sont des structures qui sont manipulÃ©es par des fonctions, c&rsquo;est du C avec des espaces de nommage (les classes <code>Helper.java</code>). La programmation objet en prends un coup, pas Ã©tonnant que les principes objets ne marchent pas dans ce contexte, mais je diverge. Bref on a du code qui ressemble Ã  ce qui suit. Un objet anÃ©mique qui ne fait rien. Au mieux il aura probablement les mÃ©thodes <code>equals</code> et <code>hashCode</code> et peut-Ãªtre un <code>toString</code>.</li>
</ul>
<pre><code class="language-java">public class AnemicObject {
private Iterable&lt;Book&gt; books;
  public void setBooks(Iterable&lt;Book&gt; books) {Â this.books = books;Â }
  public Iterable&lt;Book&gt; getBooks() { return books;Â }
  @Override public boolean equals(Object o) { ... }
  @OverrideÂ public int hashCode() { ... }
}
</code></pre>
<p>Et le dÃ©moniaque helper :</p>
<pre><code class="language-java">public class Helper {
  public void iDoSomethingWith(AnemicObject anemicObject) { ... }
  public Price iExtractTotalPriceFrom(AnemicObject anemicObject) { ... }
  public Iterable&lt;Book&gt; getSciFiBooks(AnemicObject anemicObject) { ... }
  public Iterable&lt;Book&gt; getDetectiveStoryBooks(AnemicObject anemicObject) { ... }
}
</code></pre>
<p>Comme vous le voyez les deux exemples ci-dessus ne sont pas vraiment Ã©lÃ©gants, mÃªme si je prÃ©fÃ¨re la premiÃ¨re voie. A long terme ce n&rsquo;est probablement pas une bonne idÃ©e. J&rsquo;aimerais d&rsquo;ailleurs avoir l&rsquo;avis des gens du [](<a href="http://fr.wikipedia.org/wiki/Conception_pilot%C3%A9e_par_le_domaine%22%3E">http://fr.wikipedia.org/wiki/Conception_pilot%C3%A9e_par_le_domaine&quot;&gt;</a>&lt;acronym title=&ldquo;Domain Driven Design)?</p>
<p>Et c&rsquo;est lÃ  que notre ami le visiteur va nous aider.</p>
<h1 id="pourquoi-le-visiteur-nous-aide-quapporte-t-il-">Pourquoi le visiteur nous aide, qu&rsquo;apporte-t-il ?</h1>
<p>Bonne question, ce pattern estÂ souventÂ incompris, et pour cause, il ne porte pas un nom qui lui facilite la vie.</p>
<p>Et oui pour le coup un <strong>visiteur n&rsquo;est pas fait pour visiter</strong>. Page 387 de la traduction franÃ§aise du livre Design Patterns (par le GoF), nous pouvons lire :</p>
<blockquote>
<p>Le visiteur fait la reprÃ©sentation d&rsquo;une opÃ©ration applicable aux Ã©lÃ©ments d&rsquo;une structure d&rsquo;objet. <strong>Il permet de dÃ©finir une nouvelle opÃ©ration, sans qu&rsquo;il soitÂ nÃ©cessaireÂ de modifier la classe des Ã©lÃ©ments sur lesquels il agit.</strong></p>
</blockquote>
<p>Effectivement aussi, ce livre donne comme un exemple un arbre. Et le visiteur prends toute sa puissance sur un arbre ou sur une structure composite. Mais ce n&rsquo;est le seul cas ou celui-ci est utile, dans tous les cas <strong>il s&rsquo;agit bien de permettre l&rsquo;ajout / la suppression / la modification de comportements d&rsquo;une maniÃ¨re objet sans retoucher Ã  ce quiÂ existeÂ dÃ©jÃ </strong>.</p>
<blockquote>
<p>Je le rÃ©pÃ¨te le fait que le visiteur marche super bien sur un arbre est un bonus, mais le problÃ¨me adressÃ©, l&rsquo;intention du visiteur n&rsquo;est pas de visiter, mais de <strong>dÃ©finir une nouvelle opÃ©ration sans changerÂ le code existantÂ sur lequel il agit</strong>.</p>
</blockquote>
<p>Il faut mesurer l&rsquo;intÃ©rÃªt du visiteur suivant deux axes.</p>
<ol>
<li>S&rsquo;il y a beaucoup d&rsquo;objet du domaine qui peuvent avoir le mÃªme comportement, ou si laÂ grappeÂ de nÅ“udÂ d&rsquo;un arbre est importante, un ou des visiteurs sera une bonne solution de conception pour mutualiser du code.</li>
<li>S&rsquo;il n&rsquo;y a pas Ã©normÃ©ment d&rsquo;objet du domaine, voir qu&rsquo;un seul, mais que les comportements relatifs sont Ã  la fois divers et volatiles. Alors le visiteur est un candidat pour ajouter des comportements sans faire de satanÃ© helper et sans avoir Ã  modifier les Ã©lÃ©ments du domaine.</li>
<li>Si vous avez des opÃ©rations diffÃ©rentes et un arbre ou des objets composite, le visiteur est le pattern pour vous, c&rsquo;est la qu&rsquo;il prendra toute son essence.</li>
<li>Si finalement vous n&rsquo;avez pas beaucoup de comportement, qu&rsquo;ils ne risque pas beaucoup de bouger et que vous n&rsquo;avez pas des objets variÃ©s pour mutualiser ce code, alors le visiteur n&rsquo;est probablement pas pour vous.</li>
</ol>
<p>Egalement aussi le visiteur Ã©tant un objet permet de conserver un Ã©tat, ce que ne permettent pas les objets mÃªme du domaine ou les helpers (sauf si on utilise des objets contextes passÃ© de fonction en fonction, ce n&rsquo;est pas exceptionnel).</p>
<h2 id="exemple-de-visiteurs">Exemple de visiteurs</h2>
<p>D&rsquo;abord la grappe d&rsquo;objet &ldquo;<em>complÃ¨te</em>&rdquo; :</p>
<pre><code class="language-java">public class CoolBookCollection {
    private Collection&lt;Book&gt; books;
    private String owner;
    private CollectionStatus status;
    private void accept(DomainOperation operation) {
        operation.operateOn(this);
    }
    public Collection&lt;Book&gt; books() { return books; }
    public static enum CollectionStatus {
        TIDY, MESSY, OK
    }
    // ...
}
</code></pre>
<pre><code class="language-java">public class Book {
    private Price price;
    private String title;
    private String author;

    public Price price() { return price; }
    public String title() { return title; }
    public String author() { return author; }
}
</code></pre>
<pre><code class="language-java">public class Price {
    public Price() { }
    public Price(Price priceA, Price priceB) { }
    public Price add(Price price) { return new Price(this, price); }
}
</code></pre>
<p>Et la partie relatives aux visiteurs, d&rsquo;abord l&rsquo;interface (ou j&rsquo;ai choisi volontairement de ne pas mettre les mot Visitor et visit) :</p>
<pre><code class="language-java">public interface DomainOperation {
    void operateOn(CoolBookCollection coolBookCollection);
}
</code></pre>
<pre><code class="language-java">public class CountAllBooks implements DomainOperation {
    private int count;

    public void operateOn(CoolBookCollection coolBookCollection) {
        count = coolBookCollection.books().size();
    }

    public int bookCount() {
        return count;
    }
}
</code></pre>
<pre><code class="language-java">public class ObtainCollectionPriceByGenre implements DomainOperation {
    private final String genre;
    private Price totalPrice = new Price();

    public ObtainCollectionPriceByGenre(String genre) {
        this.genre = genre;
    }

    public void operateOn(CoolBookCollection coolBookCollection) {
        for (Book book : coolBookCollection.books()) {
            totalPrice.add(book.price());
        }
    }
    public Price totalPrice() { return totalPrice; }
}
</code></pre>
<p>Et voilÃ  on des comportements diffÃ©rents liÃ©s Ã  un objet en particulier, pas besoin de retoucher notre Ã©lÃ©ment. Et on a une maniÃ¨re Ã©lÃ©gante de sortir nos comportements. Bien entendu, ce genre de chose est Ã  faire avec du bon sens, en fonction du contexte et de l&rsquo;opÃ©ration Ã  effectuer.</p>
<h2 id="quand-on-a-davatage-dobjets-du-domaine-Ã -visiter-attention">Quand on a davatage d&rsquo;objets du domaine Ã  visiter, attention!</h2>
<p>Attention quand mÃªme, comme prÃ©cisÃ© plus haut, le visiteur n&rsquo;est pas non plus sans dÃ©faut. Sur une structure d&rsquo;objet profonde ou large, votre pattern visiteur va crÃ©er une dÃ©pendance cyclique entre lui et les objetsÂ sur lesquelsÂ il est sensÃ© s&rsquo;appliquer.</p>
<pre><code class="language-java">public interface DomainOperation {
    void operateOn(CoolBookCollection coolBookCollection);
}
</code></pre>
<p>Si mon visiteur doit par exemple travailler sur plusieurs sous type de l&rsquo;objet (on pourrait typiquement avoir ce genre de problÃ¨me avec les structures composites) :</p>
<pre><code class="language-java">public interface DomainOperation {
    void operateOn(BookCollection bookCollection);
    void operateOn(CoolBookCollection coolBookCollection);
    void operateOn(CheesyBookCollection cheesyBookCollection);
    void operateOn(InTheCaveBookCollection inTheCaveBookCollection);
}
</code></pre>
<p>On voit vite le problÃ¨meÂ ouÂ le visiteur est forcÃ© d&rsquo;implÃ©menter des opÃ©rations pour des objets qui ne l&rsquo;intÃ©resse pas forcÃ©ment. Le problÃ¨me estÂ contournableÂ en utilisantÂ intelligemmentÂ les interfaces, mais cette solutionÂ palliativeÂ a Ã©galement des limites; on ne va faire implÃ©menter 45 interfaces Ã  nos objets.</p>
<p>PourÂ celaÂ il y a une solution un peu plus complexe qui est Ã©galement un pattern, c&rsquo;est le <a href="http://www.objectmentor.com/resources/articles/acv.pdf">Visiteur Acyclique</a>. Je n&rsquo;approfondie pas trop, mais l&rsquo;idÃ©e est d&rsquo;avoir pour chaque sous type du domaine une interface de visiteur qui permet de vÃ©rifier que l&rsquo;instance du visiteur est acceptable.Â EvidemmentÂ vous pourrez adapter le comportement, et vous n&rsquo;Ãªtes non plus obligÃ© d&rsquo;implÃ©menter toutes les mÃ©thodes, c&rsquo;est le but de ce pattern acyclique.</p>
<p><img src="/assets/VisiteurAcyclique.png" alt="VisiteurAcyclique"></p>
<p>Et typiquement le code du accept pour chaque sous-type de collection aurait une tÃªte du genre :</p>
<pre><code class="language-java">public void accept(DomainOperation operation) {
    if(operation instanceOf BookCollectionOperation) {
        ((BookCollectionOperation) operation).operateOn(this);
    }
}
</code></pre>
<p>Et voilÃ  on a cassÃ© les dÃ©pendance, et on est pas obligÃ© d&rsquo;implÃ©menter toute les interfaces de chaque type de collection.</p>
<blockquote>
<p><strong>Le double dispatch, Ã  ne pas confondre avec un visiteur</strong></p>
</blockquote>
<p>Le lecteur avertit aura vite devinÃ© que Ã§a ressemble au pattern stratÃ©gie, et il aura raison, ce sont des patterns comportementaux. Mais lÃ  ou le visiteur se distingue, etÂ notammentÂ dans des langages comme Java, .Net, C++ c&rsquo;est qu&rsquo;il utilise la technique duÂ <strong>double dispatch</strong>.</p>
<p>Alors le double dispatch (double rÃ©partition) c&rsquo;est quoi exactement, c&rsquo;est un moyen pour le logiciel de rÃ©soudre au runtime les mÃ©thodes Ã  exÃ©cuter.</p>
<p>Je vais citer les exemples <a href="http://en.wikipedia.org/wiki/Double_dispatch">wikipÃ©dia</a> et transformer leurs exemples en Java.</p>
<p>On a donc deux catÃ©gories d&rsquo;objets, desÂ astÃ©roÃ¯desÂ et des vaisseauxÂ spatiaux.</p>
<pre><code class="language-java">public class SpaceShip {
}
</code></pre>
<pre><code class="language-java">public class GiantSpaceShip extends SpaceShip {
}
</code></pre>
<pre><code class="language-java">public class Asteroid {
    void collideWith(SpaceShip spaceShip) {
        System.out.println(&quot;Asteroid hit a SpaceShip&quot;);
    }
    void collideWith(GiantSpaceShip giantSpaceShip) {
        System.out.println(&quot;Asteroid hit a GiantSpaceShip&quot;);
    }
}
</code></pre>
<pre><code class="language-java">public class ExplodingAsteroid extends Asteroid {
    void collideWith(SpaceShip spaceShip) {
        System.out.println(&quot;ExplodingAsteroid hit a Spaceship&quot;);
    }

    void collideWith(GiantSpaceShip giantSpaceShip) {
        System.out.println(&quot;ExplodingAsteroid hit a GiantSpaceShip&quot;);
    }
}
</code></pre>
<p>Ok, maintenant dans le code on a Ã§a</p>
<pre><code class="language-java">Asteroid theAsteroid = new ExplodingAsteroid();
SpaceShip theSpaceShip = new GiantSpaceShip();
GiantSpaceShip theGiantSpaceShip = new GiantSpaceShip();

theAsteroid.collideWith(theSpaceShip);
theAsteroid.collideWith(theGiantSpaceShip);
</code></pre>
<p>Comme en java c&rsquo;est la mÃ©thode de l&rsquo;instance qui est appelÃ©e, pas de problÃ¨me pour nos astÃ©roÃ¯des. Mais lÃ  ou Ã§a coince c&rsquo;est au niveau des vaisseaux spatiaux. Les deux appels vont afficher sur la sortie sandard:</p>
<pre><code>ExplodingAsteroid hit a SpaceShip
ExplodingAsteroid hit a GiantSpaceShip
</code></pre>
<p>En effet le type rÃ©el du vaisseau spatial n&rsquo;est pas connu, sauf si on fait de la reflection avec un <code>instanceof</code>, mais il y a plus Ã©lÃ©gant, c&rsquo;est le double dispatch.</p>
<p>Si maintenant nos vaisseaux spatiaux ont tous les deux cette mÃ©thode dÃ©finie :</p>
<pre><code class="language-java">public class SpaceShip {
    void collideWith(Asteroid asteroid) {
        asteroid.collideWith(this);
    }
}
</code></pre>
<pre><code class="language-java">public class GiantSpaceShip extends SpaceShip {
    void collideWith(Asteroid asteroid) {
        asteroid.collideWith(this);
    }
}
</code></pre>
<p>Maintenant notre code utilisera l&rsquo;API de cette faÃ§on :</p>
<pre><code class="language-java">Asteroid theAsteroid = new ExplodingAsteroid();
SpaceShip theSpaceShip = new GiantSpaceShip();
GiantSpaceShip theGiantSpaceShip = new GiantSpaceShip();

theSpaceShip.collideWith(theAsteroid);
theGiantSpaceShip.collideWith(theAsteroid);
</code></pre>
<p>Et on aura le code correcte utilisÃ©.</p>
<p>Cette technique est utilisÃ©e par le visiteur, mais nous ne somme pas obligÃ© d&rsquo;avoir des visiteurs pour l&rsquo;utiliser (la preuve par l&rsquo;exempleÂ grÃ¢ceÂ Ã  wikipÃ©dia). C&rsquo;est utilisÃ© rÃ©guliÃ¨rement dans la JDK, typiquement pour la sÃ©rialisation (mÃªme si c&rsquo;est cachÃ©). CotÃ© performance si on a le choix, le double dispatch sera toujours plus rapide qu&rsquo;un instanceof. CotÃ© design c&rsquo;est pratique quand on a des branches d&rsquo;objets qui travaillent ensemble.</p>
<p>Certains langages proposent nativement un support pour ces problÃ¨mes de rÃ©solution de type d&rsquo;opÃ©rande, comme Nice.</p>
<p>A regarder aussi, c&rsquo;est le multi dispatch ou les multi-mÃ©thodes, il y a notamment une implÃ©mentation de RÃ©my Forax de l&rsquo;universitÃ© de Marne-la-VallÃ©e, cette implÃ©mentation a le mÃ©rite d&rsquo;Ãªtre standard Java, c&rsquo;est Ã  dire qu&rsquo;elle n&rsquo;Ã©tends pas le langage lui-mÃªme.</p>
<p>Pour y jeter unÂ Å“il :Â <a href="http://www-igm.univ-mlv.fr/~forax/works/jmmf/index.html">http://www-igm.univ-mlv.fr/~forax/works/jmmf/index.html</a></p>
<h1 id="rÃ©capitulatif-sur-le-visiteur">RÃ©capitulatif sur le visiteur</h1>
<p>Le visiteur est bien un ami, mais comme tous les potes, il ne sait pas tous faire non plus.</p>
<p>Un visiteur saitÂ parcourirÂ des arbres, il se dÃ©brouille super bien avec, mais il est aussiÂ utileÂ quand il n&rsquo;y a pas d&rsquo;arbre.</p>
<p>Un visiteur sert avant tout Ã  extraire des comportements liÃ© Ã  un structure d&rsquo;objet qui bouge peu. La structure peut Ãªtre plate, ou en profondeur (celaÂ dit jeÂ privilÃ©gieraitÂ la composition Ã  la lace de l&rsquo;hÃ©ritage).</p>
<p>Le visiteur utilise la technique du double dispatch, ne pas confondre les deux.</p>
<p>Le visiteur permet de respecter le SRP (Single Responsibility Principle).</p>
<p>Le visiteur aide Ã  maintenir le CCP (Common Closure Principle), c&rsquo;est une histoire de cohÃ©sion entre les classes qui sont regroupÃ©es dans un mÃªme package.</p>
<blockquote>
<p>The classes in a package should be closed together against the same kind of changes. A change that affects a package affects all the classes in that package.</p>
</blockquote>
<p>Bon voilÃ , le dÃ©bat reste ouvert, si vous pensez que j&rsquo;ai tort, que j&rsquo;oublie un point important, ou pour autre chose, il y a les commentaires.</p>
<h1 id="rÃ©fÃ©rences">RÃ©fÃ©rences</h1>
<ul>
<li><a href="http://www.objectmentor.com/omSolutions/oops_what.html">http://www.objectmentor.com/omSolutions/oops_what.html</a></li>
<li><a href="http://www.objectmentor.com/resources/articles/visitor.pdf">http://www.objectmentor.com/resources/articles/visitor.pdf</a></li>
<li><a href="http://www.objectmentor.com/resources/articles/acv.pdf">http://www.objectmentor.com/resources/articles/acv.pdf</a></li>
<li><a href="http://codebetter.com/blogs/jeremy.miller/archive/2007/10/31/be-not-afraid-of-the-visitor-the-big-bad-composite-or-their-little-friend-double-dispatch.aspx">be-not-afraid-of-the-visitor-the-big-bad-composite-or-their-little-friend-double-dispatch</a></li>
<li><a href="http://www.artima.com/cppsource/top_cpp_aha_moments.html">http://www.artima.com/cppsource/top_cpp_aha_moments.html</a></li>
<li><a href="http://butunclebob.com/ArticleS.UncleBob.VisitorVersusInstanceOf">http://butunclebob.com/ArticleS.UncleBob.VisitorVersusInstanceOf</a></li>
<li><a href="http://www.javaperformancetuning.com/articles/ddispatch.shtml">http://www.javaperformancetuning.com/articles/ddispatch.shtml</a></li>
</ul>

  </div>
  

<div class="navigation navigation-single">
    
    <a href="/2010/03/30/a-propos-du-design-de-vos-objets-des-getters-et-setters-de-equalshashcode-et-de-la-mutabilite/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">A propos du design de vos objets, des getters et setters, de equals/hashCode et de la mutabilitÃ©</span>
    </a>
    
    
    <a href="/2010/07/11/petit-retour-sur-le-pair-programming/" class="navigation-next">
      <span class="navigation-tittle">Petit retour sur le pair-programming</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  

  <script
    src="https://giscus.app/client.js"
    data-repo="bric3/bric3.github.io"
    data-repo-id="MDEwOlJlcG9zaXRvcnk2MDc3NjczMQ=="
    data-category="Blog Comments"
    data-category-id="DIC_kwDOA59hG84CR_S_"
    data-mapping="pathname"
    data-reactions-enabled="1"
    data-input-position="top"
    data-theme="preferred-color-scheme"
    data-lang="en"
    data-loading="lazy"
    data-strict="1"
    
    data-theme="preferred-color-scheme"
    crossorigin="anonymous"
    async
  ></script>


</article>


            
    
<footer>

 
 
 <div class="github-edit">
     <a href="https://github.com/bric3/bric3.github.io/edit/hugo-sources/content/posts/2010-05-06-les-visiteurs-une-question-de-nommage-et-le-double-dispatch.md">
     <i class="fab fa-github fa-lg" aria-hidden="true"></i> Edit this page
     </a>
 </div>
 




















<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: { inlineMath: [["\\(", "\\)"]], displayMath: [["\\[", "\\]"]], ignoreClass: "nostem|nolatexmath" },
  asciimath2jax: { delimiters: [["\\$", "\\$"]], ignoreClass: "nostem|noasciimath" },
  TeX: { equationNumbers: { autoNumber: "none" } }
})
MathJax.Hub.Register.StartupHook("AsciiMath Jax Ready", function () {
  MathJax.InputJax.AsciiMath.postfilterHooks.Add(function (data, node) {
    if ((node = data.script.parentNode) && (node = node.parentNode) && node.classList.contains("stemblock")) {
      data.math.root.display = "block"
    }
    return data
  })
})
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js" integrity="sha512-M36RUChWzAh1veeenRZFql7HydLEnkYmoloiCvVrhz402UZgKI93qkV7SsaxtVKdN95Wzajh39ysrXCq34NTsg==" crossorigin="anonymous"></script>
<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/config/TeX-MML-AM_HTMLorMML-full.min.js" integrity="sha512-SdNVJmCczXFqz3Iok8gP+cloe2CScrnHJczMBwL+aSrdZVllRNqRJ5A2p83S4fUM8I4endIZgM2ZIkwNqb3Eew==" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/highlight.min.js" integrity="sha512-gU7kztaQEl7SHJyraPfZLQCNnrKdaQi5ndOyt4L4UPL/FHDd/uB9Je6KDARIqwnNNE27hnqoWLBq+Kpe4iHfeQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script type="text/javascript">
        
        hljs.initHighlightingOnLoad();
    </script>
    

<script src="https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js" integrity="sha256-vrn14y7WH7zgEElyQqm2uCGSQrX/xjYDjniRUQx3NyU=" crossorigin="anonymous"></script>
<script type="text/javascript">
function addBlockSwitches() {
	$('.primary').each(function() {
		primary = $(this);
		createSwitchItem(primary, createBlockSwitch(primary)).item.addClass("selected");
		primary.children('.title').remove();
	});
	$('.secondary').each(function(idx, node) {
		secondary = $(node);
		primary = findPrimary(secondary);
		switchItem = createSwitchItem(secondary, primary.children('.switch'));
		switchItem.content.addClass('hidden');
		findPrimary(secondary).append(switchItem.content);
		secondary.remove();
	});
}

function createBlockSwitch(primary) {
	blockSwitch = $('<div class="switch"></div>');
	primary.prepend(blockSwitch);
	return blockSwitch;
}

function findPrimary(secondary) {
	candidate = secondary.prev();
	while (!candidate.is('.primary')) {
		candidate = candidate.prev();
	}
	return candidate;
}

function createSwitchItem(block, blockSwitch) {
	blockName = block.children('.title').text();
	content = block.children('.content').first().append(block.next('.colist'));
	item = $('<div class="switch--item">' + blockName + '</div>');
	blockSwitch.append(item);
	return {'item': item, 'content': content};
}

function globalSwitch() {
	$('.switch--item').each(function() {
		var blockId = blockIdForSwitchItem($(this));
		$(this).off('click');
		$(this).on('click', function() {
			selectedText = $(this).text()
			window.localStorage.setItem(blockId, selectedText);
			$(".switch--item").filter(function() {
				return blockIdForSwitchItem($(this)) === blockId;
			}).filter(function() {
				return $(this).text() === selectedText;
			}).each(function() {
				select($(this))
			});
		});
		if ($(this).text() === window.localStorage.getItem(blockId)) {
			select($(this))
		}
	});
}

function blockIdForSwitchItem(item) {
	idComponents = []
	idComponents.push(item.text().toLowerCase());
	item.siblings(".switch--item").each(function(index, sibling) {
		idComponents.push($(sibling).text().toLowerCase());
	});
	return idComponents.sort().join("-")
}

function select(selected) {
	selected.addClass('selected');
	selected.siblings().removeClass('selected');
	selectedContent = selected.parent().siblings(".content").eq(selected.index())
	selectedContent.removeClass('hidden');
	selectedContent.siblings().addClass('hidden');
}

$(addBlockSwitches);
$(globalSwitch);
</script>





</footer>

    



        </div>
    </body>
</html>

