<!DOCTYPE html>
<html lang="en-US">
    
    


    <head>
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="https://www.gravatar.com">
    <link rel="dns-prefetch" href="https://giscus.app">

    <link href="https://gmpg.org/xfn/11" rel="profile">
    
    <link rel="canonical" href="https://blog.arkey.fr/2021/09/04/a-practical-look-at-jep-412-in-jdk17-with-libsodium/">
    

    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.82.1" />

    
    
    

<title>A practical look at JEP-412 in JDK17 with libsodium • Brice Dutheil</title>













    
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Brice Dutheil">
<meta property="og:title" content="A practical look at JEP-412 in JDK17 with libsodium">
<meta property="og:type" content="website">
<meta property="og:url" content="https://blog.arkey.fr/2021/09/04/a-practical-look-at-jep-412-in-jdk17-with-libsodium/" />
<meta property="og:description" content="Java mostly, and general tech">
<meta property="og:image" content="https://blog.arkey.fr/social-sharing.png">
<meta property="og:image:type" content="image/png">
    
    
    
<meta property="og:image:width" content="512">
<meta property="og:image:height" content="512">
    

<meta property="og:updated_time" content="2021-09-04T16:38:06&#43;0100">



<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@BriceDutheil">
<meta name="twitter:title" content="A practical look at JEP-412 in JDK17 with libsodium">

<meta name="twitter:image" content="https://blog.arkey.fr/social-sharing.png">

<meta name="twitter:description" content="Java mostly, and general tech">
<meta name="twitter:creator" content="@BriceDutheil">
    
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/a11y-light.min.css" media="(prefers-color-scheme: light)"><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/gruvbox-dark.min.css" media="(prefers-color-scheme: dark)">




<link rel="stylesheet" href="/scss/ascii-press.d6bafe0d39194a15e5deee39d0dad5d2118d57cf6ace33b94bb9dbfda6ab0415.css" integrity="sha256-1rr&#43;DTkZShXl3u450NrV0hGNV89qzjO5S7nb/aarBBU=">


<link rel="stylesheet" href="/scss/ascii-press-dark.06869de8a04135a809635aeb8b272847be96c60ddaa9197e026e19efe21e6909.css" integrity="sha256-Boad6KBBNagJY1rriycoR76Wxg3aqRl&#43;Am4Z7&#43;IeaQk=" media="(prefers-color-scheme: dark)">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">




<link rel="stylesheet" href="/scss/hugo-toc.d31afb68f96b4b4a16c6def81c6cfb18992a6924bd88766a480bb24a08ca5796.css" integrity="sha256-0xr7aPlrS0oWxt74HGz7GJkqaSS9iHZqSAuySgjKV5Y=">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js" integrity="sha512-UDJtJXfzfsiPPgnI5S1000FPLBHMhvzAMX15I+qG2E2OAzC9P1JzUwJOfnypXiOH7MRPaqzhPbBGDNNj7zBfoA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.min.js" integrity="sha512-qWVvreMuH9i0DrugcOtifxdtZVBBL0X75r9YweXsdCHtXUidlctw7NXg5KVP3ITPtqZ2S575A0wFkvgS2anqSA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <![endif]-->

    <!-- Icons from https://realfavicongenerator.net -->
<link rel="icon" href="/favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<meta name="msapplication-TileColor" content="#b64f4f">
<meta name="theme-color" content="#b64f4f">



    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/v4-shims.min.css" integrity="sha512-fHavkBby/gcFEB2taaBfG0DLdHRGrnvkWQNXVZ5Yb/Fj6LkogecQUd6oyvBVsrWPaHSxs5tNza6LUW/Y6Az9lQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    
    

</head>


    <body class="">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="https://blog.arkey.fr">Brice Dutheil</a>
      </span>
      
      
        <div class="author-image">
          <img src="https://www.gravatar.com/avatar/f31c7fbcbb0766d0632d96fd7e74b649?s=240&d=mp" class="img--circle img--headshot element--center" alt="gravatar">
        </div>
      
      <p class="site__description">
         Java mostly, and general tech 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">Brice Dutheil</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/"><span class='fa-icon'><i class='fas fa-home'></i></span><code>cd <em>~</em></code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/posts/"><span class='fa-icon'><i class='fas fa-stream'></i></span><code>ls <em>posts/*</em></code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/series/"><span class='fa-icon'><i class='fas fa-list-alt'></i></span><code>grep -o <em>series</em> posts/* | sort -u</code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/tags/"><span class='fa-icon'><i class='fas fa-tags'></i></span><code>grep -o <em>tags</em> posts/* | sort -u</code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/cool-stuff/"><span class='fa-icon'><i class='fas fa-thumbtack'></i></span><code>cd <em>cool-stuff</em></code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/whoami/"><span class='fa-icon'><i class='fas fa-id-card'></i></span><code>whoami</code>
						<span></span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://twitter.com/BriceDutheil" rel="me"><i class="fa-w-16" aria-hidden="true"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="bird" class="svg-inline--fa fa-bird fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></i></a>
	
	
	
	<a href="https://github.com/bric3" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	<a href="https://speakerdeck.com/bric3" rel="me"><i class="fab fa-speaker-deck" aria-hidden="true"></i></i></a>
	
	
	
	
	
	
	
	<a href="https://linkedin.com/in/dutheilbrice" rel="me"><i class="fa-w-16" aria-hidden="true"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="pro-network" class="svg-inline--fa fa-pro-network fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></i></a>
	
	
	<a href="https://stackoverflow.com/users/48136/brice" rel="me"><i class="fab fa-stack-overflow fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	
</section>

      </div>
    </div>

  </div>
  <div class="container fixed-container">
    
<div class="copyright">
  &copy; 2010 - 2022 Brice Dutheil
  
    <a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a>
  
</div>



  </div>
</div>

        <div class="content container">
            
    <header>

 
 
 <div class="github-edit">
     <a href="https://github.com/bric3/bric3.github.io/edit/hugo-sources/content/posts/2021-09-03-a-practical-look-at-jep-412-with-jdk17.adoc">
     <i class="fab fa-github fa-lg" aria-hidden="true"></i> Edit this page
     </a>
 </div>
 


</header>

            
    

<article>
  <header>
    <h1>A practical look at JEP-412 in JDK17 with libsodium</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> 2021-09-04
    
    
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/jep-389">jep-389</a>
           
      
          <a class="badge badge-tag" href="/tags/jep-412">jep-412</a>
           
      
          <a class="badge badge-tag" href="/tags/java">java</a>
           
      
          <a class="badge badge-tag" href="/tags/jvm">jvm</a>
           
      
          <a class="badge badge-tag" href="/tags/memory">memory</a>
           
      
          <a class="badge badge-tag" href="/tags/linker">linker</a>
           
      
          <a class="badge badge-tag" href="/tags/foreign">foreign</a>
           
      
          <a class="badge badge-tag" href="/tags/jdk17">jdk17</a>
           
      
          <a class="badge badge-tag" href="/tags/panama">panama</a>
          
      
    
    
    <br/>
    <i class="fas fa-clock"></i> 85 min read

    
    
    
        <div class="page-series">
            <div class="title">In the same series :</div>
            <ul>
                
                    
                    <li hugo-nav="/2022/05/16/linux_memfd_secret_with_jep-419/"><a href="https://blog.arkey.fr/2022/05/16/linux_memfd_secret_with_jep-419/"> Using Linux&#39;s memfd_secret syscall from the JVM with JEP-419 </a> </li>
                    
                    <li hugo-nav="/2021/09/04/a-practical-look-at-jep-412-in-jdk17-with-libsodium/"><a href="https://blog.arkey.fr/2021/09/04/a-practical-look-at-jep-412-in-jdk17-with-libsodium/"> A practical look at JEP-412 in JDK17 with libsodium </a> </li>
                    
                    <li hugo-nav="/2021/02/20/a-practical-look-at-jep-389-in-jdk16-with-libsodium/"><a href="https://blog.arkey.fr/2021/02/20/a-practical-look-at-jep-389-in-jdk16-with-libsodium/"> A practical look at JEP-389 in JDK16 with libsodium </a> </li>
                    
                
            </ul>
        </div>
    

</div>


  </header>
  
  
  
    <div class="toc-wrapper">
      <input type="checkbox" id="tocToggle" checked>
      <label for="tocToggle"><i class="fas fa-list-ul fa-lg"></i><span id="toc-title">On this page</span></label>
      <div id="toc-toggle-cover"></div>

      
          <nav id="TableOfContents">
  <ul>
    <li><a href="#_the_crypto_sealed_box_example">The crypto sealed box example</a>
      <ul>
        <li><a href="#_testing_the_idea_in_jshell">Testing the idea in <code>jshell</code></a></li>
        <li><a href="#_configuring_gradle">Configuring Gradle</a></li>
        <li><a href="#_the_first_and_minimal_call_crypto_box_sealbytes">The first and minimal call <code>crypto_box_sealbytes</code></a></li>
        <li><a href="#_then_a_more_interesting_case_passing_argument_pointers">Then a more interesting case, passing argument pointers</a></li>
        <li><a href="#_next_invoking_the_sealing_method">Next invoking the sealing method</a></li>
        <li><a href="#_ending_the_crypto_box_example">Ending the crypto box example</a></li>
        <li><a href="#_wrap_up_on_manually_using_the_foreign_linker_api">Wrap up on manually using the Foreign Linker API</a></li>
      </ul>
    </li>
    <li><a href="#memory-allocation">Remarks about <code>MemorySegment</code>s  memory mapping</a></li>
    <li><a href="#_jep_389_now_jep_412_foreign_functions_and_memory_is_still_incubating">JEP-389, now JEP-412 foreign functions and memory is still incubating</a></li>
    <li><a href="#_jextract"><code>jextract</code></a>
      <ul>
        <li><a href="#_extracting_java_liking_code_from_the_libsodium_headers">Extracting Java liking code from the Libsodium headers</a></li>
        <li><a href="#_invoking_the_library">Invoking the library</a></li>
        <li><a href="#_to_be_part_of_the_jdk_or_not">To be part of the JDK or not ?</a></li>
        <li><a href="#_wrapping_up_on_jextract_for_jep_412_build_17_panama3_167">Wrapping up on <code>jextract</code> for JEP-412 / build 17-panama+3-167</a></li>
      </ul>
    </li>
    <li><a href="#_closing_words">Closing words</a></li>
  </ul>
</nav>
      
    </div>
  
  
  
  <div class="post adoc">
    
<div class="admonitionblock important">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
This article is an updated version of this
<a href="https://blog.arkey.fr/2021/02/20/a-practical-look-at-jep-389-in-jdk16-with-libsodium/">article on JEP-389 shipped with JDK 16</a>.
This updated version merely reflects the change that appeared in JEP-412, along
with update to the gradle section.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p><a href="https://openjdk.java.net/projects/jdk/17/">JDK 17</a> will be released on September
14th 2021 with yet another <strong>incubator</strong> <a href="https://openjdk.java.net/jeps/412">JEP-412</a>
of the <em>Foreign Linker API</em>.</p>
</div>
<div class="paragraph">
<p>The Foreign Linker API is a very convenient and attractive way to connect to
the native world. Let’s have a practical look at this API that should supersede JNI.
In order to do so, I wanted Java code to interact with the infamous
<a href="https://doc.libsodium.org/"><strong>libsodium</strong></a>.</p>
</div>
<div class="paragraph">
<p>First I will focus on using the foreign linker API, then I will show how to use
<code>jextract</code> in its current state (it is still being actively developed).</p>
</div>
<div class="admonitionblock caution">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Note that JEP-412 is still incubating, therefore examples below are to be
obsolete for the next JDK as API and behavior are further refined.
</td>
</tr>
</tbody></table>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The following examples were based on <strong>JDK 17 release candidate build 35 (2021/8/6)</strong>.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Here’s a quick recapitulation of what’s changed:</p>
</div>
<div class="paragraph">



<div class="table-wrapper">
    <table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Changes</caption>
<colgroup>
<col style="width: 50%;"/>
<col style="width: 50%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">JEP-389</th>
<th class="tableblock halign-left valign-top">JEP-412</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-Dforeign.restricted=permit</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--enable-native-access=ALL-UNNAMED</code>
The new option allows fine-grained restriction over which module is permitted
to invoke native code. <code>ALL-UNNAMED</code> is a special value to refer to classpath
based code.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LibraryLookup.ofDefault()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CLinker.systemLookup()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LibraryLookup.ofLibrary(String)</code> / <code>LibraryLookup.ofPath(Path)</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>There’s no straight replacement, instead the code has to be a sequence of</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">System.load(String); // or System.loadLibrary(String);
SymbolLookup.loaderLookup();</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NativeScope.unboundedScope()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ResourceScope.newConfinedScope()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MemorySegment.allocateNative(long)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MemorySegment.allocateNative(long, ResourceScope)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NativeScope.allocate*</code> methods</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SegmentAllocator.allocate*</code>, the allocator has factory methods taking a
<code>ResourceScope</code>, e.g. <code>SegmentAllocator.ofScope(scope)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CLinker.toCString(String, Charset, ResourceScope)</code>,
<code>CLinker.toJavaString(MemorySegment, Charset)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">There’s no equivalent, encoding/decoding a string to/from a given charset
must be done manually.</p></td>
</tr>
</tbody>
</table>

</div>

</div>
<div class="paragraph">
<p>And <code>jextract</code> in particular saw massive improvements.</p>
</div>
<div class="paragraph">
<p><em>Thanks to <a href="https://twitter.com/jpbempel">Jean-Phillipe Bempel</a> for the review and
in particular spotting errors</em>.</p>
</div>
<div class="sect1">
<h2 id="_the_crypto_sealed_box_example"><a class="anchor" href="#_the_crypto_sealed_box_example"></a><a class="link" href="#_the_crypto_sealed_box_example">The crypto sealed box example</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let’s try to reproduce the following example from the
<a href="https://doc.libsodium.org/public-key_cryptography/sealed_boxes">libsodium sealbox documentation</a>,
on this page there is a simple code snippet, that could be interesting to reproduce in Java.</p>
</div>
<div class="listingblock">
<div class="title">Crypto sealed box example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">#define MESSAGE (const unsigned char *) &#34;Message&#34;
#define MESSAGE_LEN 7
#define CIPHERTEXT_LEN (crypto_box_SEALBYTES + MESSAGE_LEN)

/* Recipient creates a long-term key pair */
unsigned char recipient_pk[crypto_box_PUBLICKEYBYTES];
unsigned char recipient_sk[crypto_box_SECRETKEYBYTES];
crypto_box_keypair(recipient_pk, recipient_sk);

/* Anonymous sender encrypts a message using an ephemeral key pair
 * and the recipient&#39;s public key */
unsigned char ciphertext[CIPHERTEXT_LEN];
crypto_box_seal(ciphertext, MESSAGE, MESSAGE_LEN, recipient_pk);

/* Recipient decrypts the ciphertext */
unsigned char decrypted[MESSAGE_LEN];
if (crypto_box_seal_open(decrypted, ciphertext, CIPHERTEXT_LEN,
                         recipient_pk, recipient_sk) != 0) {
    /* message corrupted or not intended for this recipient */
}</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_testing_the_idea_in_jshell"><a class="anchor" href="#_testing_the_idea_in_jshell"></a><a class="link" href="#_testing_the_idea_in_jshell">Testing the idea in <code>jshell</code></a></h3>
<div class="paragraph">
<p>One of the cool thing with <code>jshell</code> is that you can try small ideas with a rapid
feedback loop. With the right configuration, it is also possible to play the
foreign linker.</p>
</div>
<div class="listingblock">
<div class="title">Allow jshell to use the foreign module</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ jshell --add-modules jdk.incubator.foreign -R--enable-native-access=ALL-UNNAMED</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then within jshell, let’s try out a simple smoke test.</p>
</div>
<div class="listingblock">
<div class="title">Smoke testing the foreign module</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">jshell&gt; import java.lang.invoke.*;
jshell&gt; import jdk.incubator.foreign.*;
jshell&gt; var getpid = CLinker.getInstance()
   ...&gt;                     .downcallHandle(
   ...&gt;                             CLinker.systemLookup().lookup(&#34;getpid&#34;).get(),
   ...&gt;                             MethodType.methodType(long.class),
   ...&gt;                             FunctionDescriptor.of(CLinker.C_LONG)
   ...&gt;                     );
getpid ==&gt; MethodHandle()long

jshell&gt; (long) getpid.invokeExact();
$4 ==&gt; 53699

jshell&gt; ProcessHandle.current().pid()
$5 ==&gt; 53699</code></pre>
</div>
</div>
<div class="paragraph">
<p>It works ! It really is easy to try native things for almost free without
leaving Java this is really neat.</p>
</div>
<div class="paragraph">
<p>In this article I would like to focus on the small example
with <strong>libsodium</strong> within a project. I’ll explain how to use the API along the way.</p>
</div>
</div>
<div class="sect2">
<h3 id="_configuring_gradle"><a class="anchor" href="#_configuring_gradle"></a><a class="link" href="#_configuring_gradle">Configuring Gradle</a></h3>
<div class="paragraph">
<p>The incubating modules are not on the default module path. Hence, it is required
to add the <code>jdk.incubator.foreign</code> module when invoking the compilation command.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ javac --add-modules jdk.incubator.foreign ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>This module also needs to be declared when running this code, as well as
another option --enable-native-access to <em>permit</em> modules to perform native operations.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ java --enable-native-access=ALL-UNNAMED --add-modules jdk.incubator.foreign ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you like to play with <code>jshell</code>, it will be necessary to use these two as well</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ jshell -R--enable-native-access=ALL-UNNAMED --add-modules jdk.incubator.foreign ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then comes the question to configure the build tool. I am using Gradle, the
configuration is likely similar for other build tool.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The following lines assume Gradle 7.2.
</td>
</tr>
</tbody></table>
</div>
<div class="listingblock">
<div class="title">build.gradle.kts</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">// ...

java {
    toolchain {
        languageVersion.set(JavaLanguageVersion.of(17))
    }
}

tasks {
    withType&lt;JavaCompile&gt;().configureEach {
        options.compilerArgs = listOf(
                &#34;--add-modules&#34;, &#34;jdk.incubator.foreign&#34; <i class="conum" data-value="1"></i><b>(1)</b>
        )
        options.release.set(17)
    }

    withType&lt;JavaExec&gt;().configureEach {
        jvmArgs(&#34;--enable-native-access=ALL-UNNAMED&#34;, <i class="conum" data-value="2"></i><b>(2)</b>
                &#34;--add-modules&#34;, &#34;jdk.incubator.foreign&#34;)
        javaLauncher.set(project.javaToolchains.launcherFor(java.toolchain)) <i class="conum" data-value="3"></i><b>(3)</b>
    }

    withType&lt;Test&gt;().configureEach {
        useJUnitPlatform()
        jvmArgs(&#34;--enable-native-access=ALL-UNNAMED&#34;, <i class="conum" data-value="4"></i><b>(4)</b>
                &#34;--add-modules&#34;, &#34;jdk.incubator.foreign&#34;)
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Let the compiler knows about the <code>jdk.incubator.foreign</code> module</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Configure the tasks that execute a main class, while this is not immediately useful
IntelliJ IDEA will pick up this configuration, when you click running a <code>main</code> method.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Currently, the project toolchain is not the default value for some properties
like the <code>JavaExec</code> task launcher, see <a href="https://github.com/gradle/gradle/issues/16791">gradle/gradle/issues#16791</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Configure test tasks to be able to run <code>jdk.incubator.foreign</code> tests.</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="_the_first_and_minimal_call_crypto_box_sealbytes"><a class="anchor" href="#_the_first_and_minimal_call_crypto_box_sealbytes"></a><a class="link" href="#_the_first_and_minimal_call_crypto_box_sealbytes">The first and minimal call <code>crypto_box_sealbytes</code></a></h3>
<div class="sect3">
<h4 id="_lookup"><a class="anchor" href="#_lookup"></a><a class="link" href="#_lookup">Lookup</a></h4>
<div class="paragraph">
<p>The very first thing to set up is the native symbol lookup mechanism. In JDK 17
the nifty <code>LibraryLookup</code> is gone, in my opinion this API was better as it allowed
to pass a path, which is particularly useful when embedding native libraries in JARs.</p>
</div>
<div class="paragraph">
<p>Basically in the JDK 17 there’s two options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>CLinker.systemLookup()</code> this mechanism will find symbols in the system libraries,
libraries of the JVM itself ; the path is defined in this property <code>sun.boot.library.path</code></p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ jshell -s - &lt;&lt;&lt; &#34;System.out.println(System.getProperty(\&#34;sun.boot.library.path\&#34;))&#34;
/Users/brice/.asdf/installs/java/openjdk-17/lib</code></pre>
</div>
</div>
<div class="paragraph">
<p>And it doesn’t seem related to classloader.</p>
</div>
</li>
<li>
<p><code>SymbolLookup.loaderLookup()</code> on the other hand appear to be based library
loaded via <code>System.load</code> / <code>System.loadLibrary</code>, which are tied to the classloader.
This mechanism will look up libraries defined in the <code>java.library.path</code> property</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">jshell -s - &lt;&lt;&lt; &#34;System.out.println(System.getProperty(\&#34;java.library.path\&#34;))&#34;
/Users/brice/Library/Java/Extensions:/Library/Java/Extensions:/Network/Library/Java/Extensions:/System/Library/Java/Extensions:/usr/lib/java:.</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>So which method to choose ?</p>
</div>
<div class="paragraph">
<p>Assuming libsodium has been installed with <a href="https://brew.sh">homebrew</a>
(<code>brew install libsodium</code>) this should install a symbolic link in
<code>$(brew --prefix)/lib/libsodium.dylib</code> (or <code>/usr/local/lib/libsodium.dylib</code>).</p>
</div>
<div class="paragraph">
<p>Basically there’s two choice to consume this library, and it is very similar to
what was needed with JNI.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>either the runtime execution requires alteration via the environment variable
<code>JAVA_LIBRARY_PATH</code>, and the library can be loaded by its name <code>System.loadLibrary(&#34;sodium&#34;)</code> .</p>
<div class="listingblock">
<div class="content">
<pre>env JAVA_LIBRARY_PATH=:/usr/local/lib java --enable-native-access=ALL-UNNAMED ...</pre>
</div>
</div>
</li>
<li>
<p>or the code explicitly load the library from a path <code>System.load(&#34;/usr/local/lib/libsodium.dylib&#34;)</code>
without requiring to change environment variable.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the code however the question remain: Which lookup mechanism ?</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Well if it’s a library loaded via <code>System::load</code> or <code>System::loadLibrary</code>
then use <code>SymbolLookup.loaderLookup()</code>.</p>
</li>
<li>
<p>If it is system library with system symbols like <code>printf</code> or <code>getpid</code>, the code
need to use <code>CLinker.systemLookup</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let’s define the lookup this way for this article</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">static {
    System.load(&#34;/usr/local/lib/libsodium.dylib&#34;);
    libsodiumLookup = SymbolLookup.loaderLookup();
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_from_c_to_java"><a class="anchor" href="#_from_c_to_java"></a><a class="link" href="#_from_c_to_java">From C to Java</a></h4>
<div class="paragraph">
<p>Going back to the snippet to translate, the first lines makes use of a few macros
(the lines starting with <code>#define</code>), we can assume that <code>MESSAGE</code> will be a
method parameter, <code>MESSAGE_LEN</code> will be derived from the message parameter,
and <code>CIPHERTEXT_LEN</code> is also derived from the message but needs another constant
<code>crypto_box_SEALBYTES</code>.</p>
</div>
<div class="paragraph">
<p>The first thing needed is to acquire the <code>crypto_box_SEALBYTES</code> constant, looking at
<a href="https://github.com/jedisct1/libsodium/blob/ae4add868124a32d4e54da10f9cd99240aecc0aa/src/libsodium/include/sodium/crypto_box.h#L125-L127"><code>crypto_box.h</code></a>
there’s a method <code>size_t crypto_box_sealbytes(void);</code> that returns this constant.</p>
</div>
<div class="paragraph">
<p>It’s simple, and it will be the first method I will present here.</p>
</div>
<div class="paragraph">
<p>The first challenge is to map the return type <code>size_t</code>, <em>unsigned integer type</em>,
since the constant
<a href="https://github.com/jedisct1/libsodium/blob/ae4add868124a32d4e54da10f9cd99240aecc0aa/src/libsodium/include/sodium/crypto_box.h#L125-L127"><sup>1</sup></a>
<a href="https://github.com/jedisct1/libsodium/blob/ae4add868124a32d4e54da10f9cd99240aecc0aa/src/libsodium/include/sodium/crypto_box_curve25519xsalsa20poly1305.h#L19"><sup>2</sup></a>
<a href="https://github.com/jedisct1/libsodium/blob/ae4add868124a32d4e54da10f9cd99240aecc0aa/src/libsodium/include/sodium/crypto_box_curve25519xsalsa20poly1305.h#L35"><sup>3</sup></a>
is inferior to the integer max value and that I’d like to use
this as an array size, I will map it to an <code>int</code>.</p>
</div>
<div class="listingblock">
<div class="title">crypto_box_sealbytes (.java)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">MethodHandle crypto_box_sealbytes =
        CLinker.getInstance()
               .downcallHandle(
                       libsodiumLookup.lookup(&#34;crypto_box_sealbytes&#34;).get(),
                       MethodType.methodType(int.class),
                       FunctionDescriptor.of(CLinker.C_INT)
               );

var crypto_box_SEALBYTES = (int) crypto_box_sealbytes.invokeExact();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The java type and the C descriptor must match, otherwise the call will fail at
runtime with a <code>IllegalArgumentException</code>.</p>
</div>
<div class="exampleblock primary">
<div class="title">Example 1. Carrier mismatch long != b32</div>
<div class="content">
<div class="paragraph">
<p>If the java method type used <code>long.class</code>, and the C descriptor was <code>C_INT</code>,
the code would have failed with a carrier mismatch.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">java.lang.IllegalArgumentException: Carrier size mismatch: long != b32[abi/kind=INT]</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock secondary">
<div class="title">Example 2. Carrier mismatch int != b64</div>
<div class="content">
<div class="paragraph">
<p>If the java method type used <code>int.class</code>, and the C descriptor was <code>C_LONG</code>,
the code would have failed with a carrier mismatch.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">java.lang.IllegalArgumentException: Carrier size mismatch: int != b64[abi/kind=LONG]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>For reference, <code>CLinker.C_INT</code> is actually a <code>MemoryLayout</code>, a <em>layout</em> is used
to model native memory, it is particularly useful when modeling the native
datatype like <code>struct</code>s, <code>union</code>s, etc.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_then_a_more_interesting_case_passing_argument_pointers"><a class="anchor" href="#_then_a_more_interesting_case_passing_argument_pointers"></a><a class="link" href="#_then_a_more_interesting_case_passing_argument_pointers">Then a more interesting case, passing argument pointers</a></h3>
<div class="paragraph">
<p>The next part of the example is a little more involved code, the
<code>crypto_box_keypair</code> method takes two array pointers <code>recipient_pk</code> and
<code>recipient_sk</code>, the generated keypair will be written to the given byte array.</p>
</div>
<div class="listingblock">
<div class="title">crypto_box_keypair (.c)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">unsigned char recipient_pk[crypto_box_PUBLICKEYBYTES];
unsigned char recipient_sk[crypto_box_SECRETKEYBYTES];
crypto_box_keypair(recipient_pk, recipient_sk);</code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to initialize the size of these arrays, the codes needs
two constants <code>crypto_box_PUBLICKEYBYTES</code> and
<code>crypto_box_SECRETKEYBYTES</code>. To access these two it’ll be the same
as <code>crypto_box_SEALBYTES</code>.</p>
</div>
<div class="paragraph">
<p>The C mapping is easy to get : a void method that takes 2 pointers
<code>FunctionDescriptor.ofVoid(C_POINTER, C_POINTER)</code>. In Java the method type
require a type called <code>MemoryAddress</code> which represents the pointer address.</p>
</div>
<div class="paragraph">
<p>The pointers need to point to some memory. That’s what the <code>MemorySegment</code> type
is for. Before invoking the method the necessary memory will be allocated
via <code>MemorySegment::allocateNative</code>, and the respective memory segment address
will be passed.</p>
</div>
<div class="listingblock">
<div class="title">crypto_box_keypair (.java)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">MethodHandle crypto_box_keypair =
        CLinker.getInstance().downcallHandle(
                libsodiumLookup.lookup(&#34;crypto_box_keypair&#34;).get(),
                MethodType.methodType(
                        void.class,
                        MemoryAddress.class, // pk
                        MemoryAddress.class  // sk
                ),
                FunctionDescriptor.ofVoid(C_POINTER, C_POINTER)
        );

var recipientPublicKey = MemorySegment.allocateNative(crypto_box_publickeybytes(), scope); <i class="conum" data-value="1"></i><b>(1)</b>
var recipientSecretKey = MemorySegment.allocateNative(crypto_box_secretkeybytes(), scope); <i class="conum" data-value="1"></i><b>(1)</b>
crypto_box_keypair.invokeExact(recipientPublicKey.address(),
                               recipientSecretKey.address());

var kp = new CryptoBoxKeyPair(
        recipientPublicKey.toByteArray(),
        recipientSecretKey.toByteArray()
);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>MemorySegment::allocateNative</code> method takes the segment size and a <code>ResourceScope</code>.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>JEP-389 already had the concept of bounded usage for memory segments with
the <code>NativeScope</code> class, but it was still possible to write code that never
deallocates native memory.
The API in the JEP-412 improves over JEP-389 and now imposes the user to handle
<strong>the native segment lifecycle</strong> via the same concepts embodied by the
<code>ResourceScope</code> type.</p>
</div>
<div class="paragraph">
<p>The above is completed by wrapping it in a <em>try-with-resources</em> block with a
<code>ResourceScope</code>, the scope will be take care the allocated memory segment upon
the block exit.</p>
</div>
<div class="listingblock">
<div class="title">crypto_box_keypair with <code>ResourceScope</code> (.java)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">MethodHandle crypto_box_keypair = ...

try (var scope = ResourceScope.newConfinedScope()) {
    var recipientPublicKey = MemorySegment.allocateNative(crypto_box_publickeybytes(), scope);
    var recipientSecretKey = MemorySegment.allocateNative(crypto_box_secretkeybytes(), scope);

    crypto_box_keypair.invokeExact(recipientPublicKey.address(),
                                   recipientSecretKey.address());

    return new CryptoBoxKeyPair(
            recipientPublicKey.toByteArray(),
            recipientSecretKey.toByteArray()
    );
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to get back the off-heap content into Java types, the code can call
any of the <code>to\{The Java Type}</code> methods on the <code>MemorySegment</code> instance, they
will take care of the conversion.</p>
</div>
<div class="paragraph">
<p>There’s more to say about allocation API in JEP 412, please refer to section :
<a href="#memory-allocation">Remarks about <code>MemorySegment</code>s  memory mapping</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_next_invoking_the_sealing_method"><a class="anchor" href="#_next_invoking_the_sealing_method"></a><a class="link" href="#_next_invoking_the_sealing_method">Next invoking the sealing method</a></h3>
<div class="paragraph">
<p>The next method to call is <code>crypto_box_seal</code>, which also takes
pointers and a message length.</p>
</div>
<div class="listingblock">
<div class="title">crypto_box_seal (.c)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">unsigned char ciphertext[CIPHERTEXT_LEN];
crypto_box_seal(ciphertext, MESSAGE, MESSAGE_LEN, recipient_pk);</code></pre>
</div>
</div>
<div class="paragraph">
<p>However when looking at the
<a href="https://github.com/jedisct1/libsodium/blob/ae4add868124a32d4e54da10f9cd99240aecc0aa/src/libsodium/include/sodium/crypto_box.h#L129-L132">C signature</a>
we notice something <em>unusual</em> for Java developers: the message length
argument is of type <code>long long</code>!</p>
</div>
<div class="paragraph">
<p>In C or C++, this declaration means the type is at least 8 bytes (64 bits),
this means a Java <code>long</code> type is what is needed.</p>
</div>
<div class="paragraph">
<p>In particular here’s a breakdown of the signed integers. It is incomplete
as they can be declared differently (e.g. <code>long</code> is the same as <code>long int</code>,
or <code>long long</code> is the same as <code>long long int</code>), this <a href="https://en.wikipedia.org/wiki/C_data_types">wikipedia page</a> has a more complete overview of
C data types.</p>
</div>
<div class="paragraph">



<div class="table-wrapper">
    <table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Signed integers</caption>
<colgroup>
<col style="width: 20%;"/>
<col style="width: 80%;"/>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>int</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>A signed integer type with <em>the natural size suggested by the
architecture of the execution environment</em>,<br/>
with a minimum of 2 byte (16 bits, \$[-32767; +32767]\$).</p>
</div>
<div class="paragraph">
<p>On a 64bits CPU, <code>int</code> is 4bytes and the range becomes \$[-2147483647; +2147483647]\$;</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>long</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>A signed integer type that is at least so 4 bytes (\$[-2147483647; +2147483647]\$).</p>
</div>
<div class="paragraph">
<p>On a 64bits CPU, <code>long</code> is 8bytes and the range becomes \$[−9223372036854775807; +9223372036854775807]\$;</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>long long</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>A signed integer type that is at least so 8 bytes (\$[−9223372036854775807; +9223372036854775807]\$).</p>
</div>
<div class="paragraph">
<p>On a 64bits CPU, <code>long long</code> is still 8 bytes long.</p>
</div></div></td>
</tr>
</tbody>
</table>

</div>

</div>
<div class="admonitionblock caution">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When you start to study these C data types a bit more, you’ll notice
two things that just don’t match with Java types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>unsigned</code> integers, while they do have the same width as their signed
counterpart, their math is different as their range is different:</p>
<div class="ulist">
<ul>
<li>
<p><code>unsigned long</code>&#39;s range is \$[0; +4294967295]\$ (on a 64-bit CPU)</p>
</li>
<li>
<p><code>unsigned long long</code>&#39;s range is \$[0; +18446744073709551615]\$ (on a 64 bit CPU)</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>long double</code>s are larger than 64 bytes, I never had to use those, but it
seems they can be as big as 128 bits (16 bytes).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As a reminder <code>size_t</code> is unsigned.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="listingblock">
<div class="title">crypto_box_seal definition (.c)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">SODIUM_EXPORT
int crypto_box_seal(unsigned char *c, const unsigned char *m,
                    unsigned long long mlen, const unsigned char *pk)
            __attribute__ ((nonnull(1, 4)));</code></pre>
</div>
</div>
<div class="paragraph">
<p>For this post, and I intend to pass a short <code>String</code> message,
which is baked by a <code>char</code> array, and array length in Java are limited
to the positive values of an <code>int</code> (\$[0; +2147483647]\$;).</p>
</div>
<div class="listingblock">
<div class="title">crypto_box_seal (.java)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">var crypto_box_seal = CLinker.getInstance().downcallHandle(
        libsodiumLookup.lookup(&#34;crypto_box_seal&#34;).get(),
        MethodType.methodType(int.class,
                              MemoryAddress.class, // cipherText, output buffer
                              MemoryAddress.class, // message
                              long.class,          // message length
                              MemoryAddress.class  // publicKey
        ),
        FunctionDescriptor.of(C_INT,
                              C_POINTER,
                              C_POINTER,
                              C_LONG_LONG,
                              C_POINTER)
);

try (var scope = ResourceScope.newConfinedScope()) {
    var segmentAllocator = SegmentAllocator.ofScope(scope);
    var nativeMessage = CLinker.toCString(message, scope);
    var cipherText = segmentAllocator.allocate(crypto_box_sealbytes() + nativeMessage.byteSize());
    var ret = (int) crypto_box_seal.invokeExact(
            cipherText.address(),
            nativeMessage.address(),
            (long) nativeMessage.byteSize(),
            segmentAllocator.allocateArray(C_CHAR, publicKey).address());
    );
    return cipherText.toByteArray();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>There’s a few thing to notice :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The <code>toCString</code> method don’t take anymore a charset compared to JEP-389 (JDK-16),
and encode the String to UTF-8. This change implies to pay attention to native APIs
that may not understand wide characters like <code>中文</code> that require more than 1 byte
to encode the character. Consequently, native API that may need the length
have to pay attention to this detail too — UTF-8 encode characters in one or
more byte if necessary — in other words don’t rely on <code>String::length</code> to count
bytes.</p>
<div class="paragraph">
<p>In the above snippet, the <code>String</code> is first encoded then the length is
taken from the memory segment <code>nativeMessage.byteSize()</code>.</p>
</div>
<div class="paragraph">
<p>Alternatively the encoding could have been done using a charset via <code>String::getBytes</code>.
And the actual size taken from the resulting byte array.</p>
</div>
</li>
<li>
<p>The <code>var ret</code> is not used, however due to the <em>dynamic</em>
nature of <code>invokeExact</code>, the compiler needs the <strong>exact</strong> signature on the
call-site, that’s why the result of this invocation is assigned to an <code>int</code>
variable even if it is not used.</p>
<div class="paragraph">
<p>Without this assignment the JVM would have raised a <code>WrongMethodTypeException</code>,
in this case the exception message helps to identify the type differences
in the signature:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">java.lang.invoke.WrongMethodTypeException: expected (MemoryAddress,MemoryAddress,long,MemoryAddress)int but found (MemoryAddress,MemoryAddress,long,MemoryAddress)void</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_ending_the_crypto_box_example"><a class="anchor" href="#_ending_the_crypto_box_example"></a><a class="link" href="#_ending_the_crypto_box_example">Ending the crypto box example</a></h3>
<div class="paragraph">
<p>The last method call of this snippet ends the libsodium <em>crypto box</em> example.
The method <code>crypto_box_seal_open</code> take pointers and a ciphered text length,
so let’s apply again what has been done for <code>crypto_box_seal</code>.</p>
</div>
<div class="listingblock">
<div class="title">crypto_box_seal_open (.c)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">unsigned char decrypted[MESSAGE_LEN];
if (crypto_box_seal_open(decrypted, ciphertext, CIPHERTEXT_LEN,
    recipient_pk, recipient_sk) != 0) {
    /* message corrupted or not intended for this recipient */
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which translates to</p>
</div>
<div class="listingblock">
<div class="title">crypto_box_seal_open (.java)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">var crypto_box_seal_open = getInstance().downcallHandle(
        libsodiumLookup.lookup(&#34;crypto_box_seal_open&#34;).get(),
        MethodType.methodType(int.class,
                              MemoryAddress.class, // message
                              MemoryAddress.class, // cipherText
                              long.class,          // cipherText.length
                              MemoryAddress.class, // public key
                              MemoryAddress.class  // secret key
        ),
        FunctionDescriptor.of(C_INT,
                              C_POINTER,
                              C_POINTER,
                              C_LONG_LONG,
                              C_POINTER,
                              C_POINTER
        )
);

try (var scope = ResourceScope.newConfinedScope()) {
    var allocator = SegmentAllocator.ofScope(scope); <i class="conum" data-value="1"></i><b>(1)</b>
    var decipheredText = allocator.allocateArray(C_CHAR,
                                                 cipherText.length - crypto_box_sealbytes());
    var ret = (int) crypto_box_seal_open.invokeExact(decipheredText.address(),
                                                     scope.allocateArray(C_CHAR, cipherText).address(),
                                                     (long) cipherText.length,
                                                     scope.allocateArray(C_CHAR, publicKey).address(),
                                                     scope.allocateArray(C_CHAR, secretkey).address());

    return CLinker.toJavaString(decipheredText); <i class="conum" data-value="2"></i><b>(2)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>MemorySegment</code> offers API to allocate segments, to allocate arrays <code>SegmentAllocator</code>
offers a better API</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>In JDK 16, using <code>toJavaString</code> raised a <code>IndexOutOfBoundsException</code> with the message
<code>Out of bound access on segment MemorySegment\{ id=0x6f11d841 limit: 20 }; new offset = 20; new length = 1</code>.
<div class="paragraph">
<p>Indeed, during my first use of the foreign linker API in the JDK 16 I used
<code>String::length</code> to indicate the number of bytes to <em>seal</em>, a Java String length
that didn’t include the null character <code>\0</code> that terminates a C string. Which caused
this bound issue during the reverse operation <code>toJavaString</code>.</p>
</div>
<div class="paragraph">
<p>The seal example with JDK 17 API uses the memory segment’s length, which
thereby prevents ths issue from happening.</p>
</div></td>
</tr>
</tbody></table>
</div>
<div class="admonitionblock caution">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
This reminds us that one has to be careful with String and encodings.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>A side note, in this snippet too I have intentionally left out the returned
status of <code>crypto_box_seal_open</code>, to focus on the foreign module API, but this
would make sense to perform checks on the returned value before returning the
buffer just as it is suggested on the libsodium documentation.</p>
</div>
<div class="paragraph">
<p>More interestingly this example introduces the <code>SegmentAllocator</code> of the JEP-412
which offers a richer set of API that can use <em>layout</em>s, in particular it can
be used for array allocation.</p>
</div>
<div class="paragraph">
<p><code>SegmentAllocator</code> provides different allocation strategies.</p>
</div>
<div class="paragraph">



<div class="table-wrapper">
    <table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Different segment allocators</caption>
<colgroup>
<col style="width: 50%;"/>
<col style="width: 50%;"/>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SegmentAllocator.ofScope(ResourceScope)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">It is a regular allocator for native memory.<br/>
It uses a standard <code>malloc</code> call. The new allocated<br/>
segments will all be cleaned when the<br/>
scope closes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SegmentAllocator.ofSegment(MemorySegment)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This allows to reuse, or recycle, the same memory segment.</p>
<p class="tableblock">Allocated segments are all sub parts of this parent memory<br/>
segment. This is useful to limit allocations as <code>malloc</code><br/>
operations as they are known to be expensive.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SegmentAllocator.arenaAllocator(scope)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This allocator is doing <a href="https://en.wikipedia.org/wiki/Region-based_memory_management">region based memory management</a>.</p>
<p class="tableblock">The short version of the arena memory management is :<br/>
the allocator allocates a chunk of memory and either<br/>
use a slice of that segment, or allocate a new<br/>
chunk of memory to satisfy the allocation request.<br/>
Since segment are scoped in inside a ResourceScope,<br/>
they are freed, and their slice can be used again.
This allocator is useful to limit costly <code>malloc</code><br/>
operations, yet allows more flexibility than the<br/>
alternative segment recycling.</p>
<p class="tableblock">The factory has an overload that takes a size, in this<br/>
case allocations are possible until no further allocation<br/>
is possible, ie it won’t add a new underlying chunk<br/>
of memory.</p></td>
</tr>
</tbody>
</table>

</div>

</div>
<div class="paragraph">
<p>All allocators are thread safe, but a confined scope will restrict the allocation
to the owner thread.</p>
</div>
</div>
<div class="sect2">
<h3 id="_wrap_up_on_manually_using_the_foreign_linker_api"><a class="anchor" href="#_wrap_up_on_manually_using_the_foreign_linker_api"></a><a class="link" href="#_wrap_up_on_manually_using_the_foreign_linker_api">Wrap up on manually using the Foreign Linker API</a></h3>
<div class="paragraph">
<p>I didn’t cover everything this API has to offer, like the <em>up call</em> stubs,
which is a way to pass a function pointer to the native code, nor did I cover
the every feature of JEP-412, like <code>MemorySegment</code> or <code>MemoryLayout</code> API.</p>
</div>
<div class="paragraph">
<p>At this time I find this API a pleasure to use compared to JNI. <em>Note that
I don’t have experience with JNA, so I may be lacking perspective there.</em></p>
</div>
<div class="paragraph">
<p>There’s a few pitfalls to be aware of using API that use pointers or reference,
String encoding is of particular interest, and <code>MemorySegment</code> lifecycles
get more complicated if those segments are shared between threads.
Overall I found the API well-designed and well documented, but if you’re novice
in this area, you’ll likely need other reading materials. A package wide
documentation, in <code>jdk.incubator.foreign</code>, should definitely fill this gap in
my opinion.</p>
</div>
<div class="paragraph">
<p>The chosen example was concise in native code, but writing the stubs in Java
is quickly tedious and verbose. JDK developers felt the same way as they
are also investing energy on a tool named <code>jextract</code> whose goal is to reduce
the tedious work amount. I’ll show in a section below what can be done with
the current state of <code>jextract</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="memory-allocation"><a class="anchor" href="#memory-allocation"></a><a class="link" href="#memory-allocation">Remarks about <code>MemorySegment</code>s  memory mapping</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>MemorySegment</code> do have the same constraints as <code>DirectByteBuffer</code>s,
ie the segment can’t go over <code>Runtime.getRuntime().maxMemory()</code></p>
</div>
<div class="listingblock">
<div class="title">Allocating a very bigger segment than <code>maxMemory</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Exception in thread &#34;main&#34; java.lang.OutOfMemoryError: Cannot reserve 2147483648 bytes of direct buffer memory (allocated: 8192, limit: 522190848)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This limit is configurable by setting the <code>-XX:MaxDirectMemorySize={size}</code> flag.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">var memorySegment = MemorySegment.allocateNative(nativeSegmentSize);</code></pre>
</div>
</div>
<div class="paragraph">
<p>There’s one interesting thing with this API it is possible to access the address
from the API, via <code>MemorySegment::address</code>, and one can bet the hexadecimal
representation, via <code>Long.toHexString(memorySegment.address().toRawLongValue())</code>.</p>
</div>
<div class="listingblock">
<div class="title">MemoryAddress::toString</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">MemoryAddress{ base: null offset=0x7fc513fff010 }</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you are on Linux then you use <code>pmap</code> from the <em>procps</em> package to
inspect memory mappings of the JVM.</p>
</div>
<div class="listingblock">
<div class="title">/pmap output of a 2 GiB native segment</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">151:   java --enable-native-access=ALL-UNNAMED --add-modules jdk.incubator.foreign -XX:MaxDirectMemorySize=2100m MemorySegments.java
Address           Kbytes     RSS   Dirty Mode  Mapping
...
0000557635ba1000       4       0       0 r-x-- java
0000557635ba3000       4       0       0 r---- java
0000557635ba4000       4       0       0 rw--- java
0000557636d4b000     132      16      16 rw---   [ anon ]
00007fc513fff000 2097156 1811456 1811456 rw---   [ anon ] <i class="conum" data-value="1"></i><b>(1)</b>
00007fc594000000     132       0       0 rw---   [ anon ]
00007fc594021000   65404       0       0 -----   [ anon ]
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is the allocated segment, 2 GiB ⇐⇒ 2097152 KiB, this segment is a bit
larger by one page (4 KiB). And in fact the base address of the segment is
<code>0x7fc513fff010</code>.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>In this case it is not related to alignment, but it may be possible. What is
important is that the address of a <code>MemorySegment</code> may be contained in a larger
memory mapping.</p>
</div>
<div class="paragraph">
<p>One important and useful distinction with <code>DirectByteBuffer</code>s is the presence
of a <code>MemorySegment::close</code> method, that will <strong>immediately free the native mapping</strong>
when called.
<code>DirectByteBuffer</code> used to be challenging because they had no explicit method
to free the native mapping, and as such had to wait for the GC to kick in
order to be freed.</p>
</div>
<div class="paragraph">
<div class="title">Initialization</div>
<p>Another thing to remind is that the memory mapping is zeroed, that means
a big segment will take a noticeable time to get initialized. As with
<code>DirectByteBuffer</code>s this pattern is interesting when inspecting off-heap memory.</p>
</div>
<div class="paragraph">
<div class="title">Scope</div>
<p>Usually it is more practical to use the <code>NativeScope</code> API as it is easier to
reason about boundaries of the involved memory mapping.
Using a larger <code>MemorySegment</code> could be interesting when it has to be sliced and
shared among various threads. Also given the high initialization cost for large
segments it’s likely to have the same lifecycle as the application.
Typically, in a few years, Netty, Aeron, Kafka, Cassandra, …​
could make use of this API !</p>
</div>
<div class="paragraph">
<div class="title">Slices</div>
<p><span class="line-through">One thing that caught me off-guard with JEP-389, is that when closing a <em>slice</em> (created by
<code>MemorySegment::asSlice</code>) also closes the underlying segment.</span> This is no longer the case
with JEP-412 since <code>MemorySegment</code> is not anymore <code>AutoCloseable</code>. Problem solved.</p>
</div>
<div class="paragraph">
<div class="title">Access modes</div>
<p>The <code>READ</code>, <code>WRITE</code>, <code>CLOSE</code> access modes and related API disappeared from
<code>MemorySegment</code>, now the only choice is to return a read-only view of the
segment via <code>MemorySegment::asReadOnly</code>. Which is more limited, but way more
intuitive to use.</p>
</div>
<div class="paragraph">
<div class="title">File API</div>
<p>Until JEP-389, we used a <code>FileChannel</code> and a <code>MappedByteBuffer</code> to memory map a
file. The JEP-389 also take care of this use case, by using the <code>mapFile</code> factory
method. JEP 412 amend this API with a <code>ResourceScope</code> parameter.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">try (var scope = ResourceScope.newConfinedScope()) {
    MemorySegment.mapFile(path, <i class="conum" data-value="1"></i><b>(1)</b>
                          0, <i class="conum" data-value="2"></i><b>(2)</b>
                          Files.size(path), <i class="conum" data-value="3"></i><b>(3)</b>
                          FileChannel.MapMode.READ_ONLY, <i class="conum" data-value="4"></i><b>(4)</b>
                          scope);
  // ...
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A path e.g. Path.of(&#34;…​&#34;)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The base offset</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The size of the mapping, here the complete file</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The mapping mode</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The <code>MemorySegment</code> is not any more auto closeable, instead it will be immediately
freed when the code leaves the try-with-resources block.</p>
</div>
<div class="paragraph">
<p>Also, with JEP 412, a <code>MemorySegment</code> gains some API (<code>MemorySegment::load</code>,
<code>MemorySegment::unload</code>, <code>MemorySegment::force</code>) that allows to force IO operations.
The <code>force</code> method looks particularly useful when forcing a write operation to
disk (<code>fsync</code>) to page-out to a colder storage such as a disk.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_jep_389_now_jep_412_foreign_functions_and_memory_is_still_incubating"><a class="anchor" href="#_jep_389_now_jep_412_foreign_functions_and_memory_is_still_incubating"></a><a class="link" href="#_jep_389_now_jep_412_foreign_functions_and_memory_is_still_incubating">JEP-389, now JEP-412 foreign functions and memory is still incubating</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>In JDK 17 <code>MemorySegment</code> dropped <code>AutoCloseable</code>, <code>NativeScope</code> is replaced by
<code>ResourceScope</code>, the loss of the <code>LibraryLookup</code> with an API with a different
scope replaced by <code>SymbolLookup</code> API, appearance of the <code>SegmentAllocator</code>.
<code>jextract</code> saw very good improvement, it seems mature enough to be featured
in a standard JDK, yet it is not part of incubator module. In fact, jextract
might never be part of the JDK itself as it might be distributed by other
mechanisms, see this <a href="https://mail.openjdk.java.net/pipermail/panama-dev/2021-May/013898.html">discussion</a>.</p>
</div>
<div class="paragraph">
<p>Given all this, I am not sure JEP-412 will get out of incubating for JDK 18 as
well. JEP-412 is working well and show great refinements, but to me the
developers are still tackling the API to get it right, indeed a broken API
could lead to broken applications. As with the previous
incubator, I think they are doing a fantastic job in my opinion.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_jextract"><a class="anchor" href="#_jextract"></a><a class="link" href="#_jextract"><code>jextract</code></a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>jextract</code> is still being backed and was not included in JDK 17
for incubation, but since it complements JEP-412, I wanted to give
it a try and showcase its usefulness.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The jextract version used in this entry comes the <em>build 17-panama+3-167</em>
that can be downloaded <a href="https://jdk.java.net/panama/">here</a>.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>This tool leverages the native <code>libclang</code> and the <code>jdk.incubator.foreign</code>
module.</p>
</div>
<div class="paragraph">
<p>In order to be able to use it, one should download the panama jdk
here: <a href="https://jdk.java.net/panama/" class="bare">https://jdk.java.net/panama/</a>. Don’t be scared by <em>early access</em>,
JDK 17 (very early at this stage) or the other warnings, you just need
to use <code>jextract</code> not the panama jdk.</p>
</div>
<div class="admonitionblock caution">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Again the <code>jextract</code> tool is still being backed at this time.
That means it that everything below can be obsolete any time.
</td>
</tr>
</tbody></table>
</div>
<div class="sect2">
<h3 id="_extracting_java_liking_code_from_the_libsodium_headers"><a class="anchor" href="#_extracting_java_liking_code_from_the_libsodium_headers"></a><a class="link" href="#_extracting_java_liking_code_from_the_libsodium_headers">Extracting Java liking code from the Libsodium headers</a></h3>
<div class="paragraph">
<p>The first thing I need is to get the headers of libsodium, either use
the headers installed by homebrew with symbolic links placed in
<code>/usr/local/include</code> (or <code>$(brew --prefix)/include</code>), or clone the repo
(Make sure to check out the correct tag for the installed binary library,
<code>1.0.18</code> at this time).</p>
</div>
<div class="sect3">
<h4 id="_first_contact_with_jextract"><a class="anchor" href="#_first_contact_with_jextract"></a><a class="link" href="#_first_contact_with_jextract">First contact with <code>jextract</code></a></h4>
<div class="listingblock">
<div class="title"><code>jextract</code> first use</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ jextract
  -d src/main/java \ <i class="conum" data-value="1"></i><b>(1)</b>
  -l sodium \ <i class="conum" data-value="2"></i><b>(2)</b>
  --target-package com.github.bric3.sodium \ <i class="conum" data-value="3"></i><b>(3)</b>
  -I $(brew --prefix)/include/sodium \ <i class="conum" data-value="4"></i><b>(4)</b>
  $(brew --prefix)/include/sodium.h <i class="conum" data-value="5"></i><b>(5)</b>
WARNING: Using incubator modules: jdk.incubator.foreign, jdk.incubator.jextract
/usr/local/include/sodium/crypto_hash_sha512.h:13:10: fatal error: &#39;stdlib.h&#39; file not found</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Destination of the generated sources</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Specifies the name of library, this option is important as it will drive the
way the library is loaded, with <code>-l sodium</code> the library has to be available on
the <code>java.library.path</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Indicates the target package of the generated source</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Includes of the library (some files include others in the library)</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The C header file</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Obviously some standard C headers are not discovered by <code>jextract</code>.</p>
</div>
<div class="paragraph">
<div class="title">macOs</div>
<p>On macOs the solution is to use the header that are installed by XCode, at this location</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Linux</div>
<p>The above command used to fail for an equivalent reason, I had to find the local
compiler includes like this on Fedora <code>/usr/lib/gcc/x86_64-redhat-linux/8/include</code>.
Now with the <em>build 17-panama+3-167</em> <code>jextract</code> worked fine.</p>
</div>
<div class="paragraph">
<p>This issue is tracked by the ticket <a href="https://bugs.openjdk.java.net/browse/JDK-8262127">JDK-8262127</a>.</p>
</div>
<div class="paragraph">
<p>Also, I noticed that <code>jextract</code> generates classes first, but you can pass
a <code>--source</code> option to configure it to generate sources instead.</p>
</div>
<details>
<summary class="title">Possible problems when working with libsodium repository clone</summary>
<div class="content">
<div class="paragraph">
<p><code>jextract</code> might fail the <code>extraction</code> process on the file <code>version.h</code>.</p>
</div>
<div class="paragraph">
<p>Reminder, in the libsodium repository, headers are located in this folder <code>src/libsodium/include</code>.</p>
</div>
<div class="listingblock">
<div class="title">Includes the compiler headers</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ jextract \
  -d src/main/java \
   -l sodium \
   --source \ <i class="conum" data-value="1"></i><b>(1)</b>
   --target-package com.github.bric3.sodium \
   -I /usr/lib/gcc/x86_64-redhat-linux/8/include \ <i class="conum" data-value="2"></i><b>(2)</b>
   -I src/libsodium/include/ \
   -I src/libsodium/include/sodium \
   src/libsodium/include/sodium.h
src/libsodium/include/sodium.h:5:10: fatal error: &#39;sodium/version.h&#39; file not found</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Generates the sources</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>the compiler includes installed on this linux image</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>In the libsodium repository there’s a file named <code>version.h.in</code>,
and upon inspection of its content I noticed placeholders that suggest
a preliminary phase in the libsodium build will generate the final <code>version.h</code>.
In native sources this usually happen via a combination of <code>./autogen.sh</code>
and <code>./configure</code>.</p>
</div>
<div class="paragraph">
<p>Let’s prepare the code base.</p>
</div>
<div class="listingblock">
<div class="title">Configure libsodium codebase</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ ./autogen.sh
autoreconf: Entering directory `.&#39;
autoreconf: configure.ac: not using Gettext
autoreconf: running: aclocal --force -I m4
autoreconf: configure.ac: tracing
autoreconf: configure.ac: creating directory build-aux
autoreconf: running: libtoolize --copy --force
libtoolize: putting auxiliary files in AC_CONFIG_AUX_DIR, &#39;build-aux&#39;.
libtoolize: copying file &#39;build-aux/ltmain.sh&#39;
libtoolize: putting macros in AC_CONFIG_MACRO_DIRS, &#39;m4&#39;.
libtoolize: copying file &#39;m4/libtool.m4&#39;
libtoolize: copying file &#39;m4/ltoptions.m4&#39;
libtoolize: copying file &#39;m4/ltsugar.m4&#39;
libtoolize: copying file &#39;m4/ltversion.m4&#39;
libtoolize: copying file &#39;m4/lt~obsolete.m4&#39;
autoreconf: running: /usr/bin/autoconf --force
autoreconf: configure.ac: not using Autoheader
autoreconf: running: automake --add-missing --copy --force-missing
configure.ac:75: installing &#39;build-aux/compile&#39;
configure.ac:9: installing &#39;build-aux/config.guess&#39;
configure.ac:9: installing &#39;build-aux/config.sub&#39;
configure.ac:10: installing &#39;build-aux/install-sh&#39;
configure.ac:10: installing &#39;build-aux/missing&#39;
src/libsodium/Makefile.am: installing &#39;build-aux/depcomp&#39;
parallel-tests: installing &#39;build-aux/test-driver&#39;
autoreconf: Leaving directory `.&#39;
Downloading config.guess and config.sub...
Done.

./configure
checking build system type... x86_64-pc-linux-gnu
checking host system type... x86_64-pc-linux-gnu
checking for a BSD-compatible install... /usr/bin/install -c
checking whether build environment is sane... yes
checking for a thread-safe mkdir -p... /usr/bin/mkdir -p
checking for gawk... gawk
checking whether make sets $(MAKE)... yes
checking whether make supports nested variables... yes
checking whether UID &#39;0&#39; is supported by ustar format... yes
checking whether GID &#39;0&#39; is supported by ustar format... yes
checking how to create a ustar tar archive... gnutar
checking whether make supports nested variables... (cached) yes
checking whether to enable maintainer-specific portions of Makefiles... no
checking whether make supports the include directive... yes (GNU style)
checking for gcc... gcc
...
configure: creating ./config.status
config.status: creating Makefile
config.status: creating builds/Makefile
config.status: creating contrib/Makefile
config.status: creating dist-build/Makefile
config.status: creating libsodium.pc
config.status: creating libsodium-uninstalled.pc
config.status: creating msvc-scripts/Makefile
config.status: creating src/Makefile
config.status: creating src/libsodium/Makefile
config.status: creating src/libsodium/include/Makefile
config.status: creating src/libsodium/include/sodium/version.h <i class="conum" data-value="1"></i><b>(1)</b>
config.status: creating test/default/Makefile
config.status: creating test/Makefile
config.status: executing depfiles commands
config.status: executing libtool commands</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configuring <code>version.h</code> with version values</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Finally, this time <code>jextract</code> worked as expected.</p>
</div>
</div>
</details>
</div>
<div class="sect3">
<h4 id="_narrowing_down_the_extraction"><a class="anchor" href="#_narrowing_down_the_extraction"></a><a class="link" href="#_narrowing_down_the_extraction">Narrowing down the extraction</a></h4>
<div class="paragraph">
<p>Looking at the generated classes, there’s a bag of <strong>288 files</strong>, not even
mentioning the symbols in these types.</p>
</div>
<div class="paragraph">
<p>When I looked at <code>jextract</code> during my review of JEP 389, <code>jextract</code> had
an option <code>--filter</code> that was supposed to only emit symbols of a specific file.
At this time of writing, this option is gone and replaced by a
<a href="https://mail.openjdk.java.net/pipermail/panama-dev/2021-March/012499.html">different mechanism</a>.</p>
</div>
<div class="paragraph">
<p>The previous mechanism filtered headers by their path, the new mechanism however
allows filtering by <code>type</code>, see these option in the help message.</p>
</div>
<div class="listingblock">
<div class="title">include-(function|macro|struct|typedef|union|var) options</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">--include-function &lt;String&gt;    name of function to include
--include-macro &lt;String&gt;       name of constant macro to include
--include-struct &lt;String&gt;      name of struct definition to include
--include-typedef &lt;String&gt;     name of type definition to include
--include-union &lt;String&gt;       name of union definition to include
--include-var &lt;String&gt;         name of global variable to include</code></pre>
</div>
</div>
<div class="paragraph">
<p>At first this looks like a huge effort to list every symbol (function, data
types, variables, etc.), but there’s a nifty trick. <code>jextract</code> comes with
<code>--dump-includes</code>. This option alter <code>jextract</code> behavior in that it won’t generate
source or class bindings, but instead it will dump symbols in the given file.</p>
</div>
<div class="listingblock primary">
<div class="title">dumping symbols configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">jextract \
  -d src/main/java \
  -l sodium \
  --source \
  --target-package com.github.bric3.sodium \
  -I /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include \
  -I $(brew --prefix)/include/sodium \
  --dump-includes sodium.conf \ <i class="conum" data-value="1"></i><b>(1)</b>
  $(brew --prefix)/include/sodium.h
WARNING: Using incubator modules: jdk.incubator.jextract, jdk.incubator.foreign
WARNING: skipping strtold because of unsupported type usage: long double
WARNING: Layout size not available for sys_errlist</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>the dump option</td>
</tr>
</tbody></table>
</div>
<div class="listingblock secondary">
<div class="title">sodium.conf</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">#### Extracted from: /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include/AvailabilityVersions.h

--include-macro MAC_OS_VERSION_11_0         # header: /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include/AvailabilityVersions.h
--include-macro MAC_OS_X_VERSION_10_0       # header: /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include/AvailabilityVersions.h
--include-macro MAC_OS_X_VERSION_10_1       # header: /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include/AvailabilityVersions.h
--include-macro MAC_OS_X_VERSION_10_10

...

#### Extracted from: /usr/local/include/sodium/core.h

--include-function sodium_init               # header: /usr/local/include/sodium/core.h
--include-function sodium_misuse             # header: /usr/local/include/sodium/core.h
--include-function sodium_set_misuse_handler # header: /usr/local/include/sodium/core.h

...</code></pre>
</div>
</div>
<div class="paragraph">
<p>When looking at the generated file (<code>sodium.conf</code>), we notice that <code>jextract</code>
actually wrote the <code>--include-(function|macro|struct|typedef|union|var)</code> options
with the found symbol, more <code>jextract</code> indicates were this file was found.</p>
</div>
<div class="paragraph">
<p>The ultimate part of this trick is that this file can be used on the command line</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">jextract \
  -d src/main/java \
  -l sodium \
  --source \
  --target-package com.github.bric3.sodium \
  -I /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include \
  -I $(brew --prefix)/include/sodium \
  @sodium.conf \ <i class="conum" data-value="1"></i><b>(1)</b>
  $(brew --prefix)/include/sodium.h</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Pass the option file into <code>jextract</code>, notice the preceding <code>@</code>.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>By editing the <code>sodium.conf</code> file and removing everything non-related to
<em>libsodium</em>, it was possible to cut down the generated bindings by more than a
half. Depending on the required API usage it is of course possible to remove
even more by selecting more aggressively the symbols.</p>
</div>
<div class="paragraph">
<p>One could even go further and move the other options (<code>-d</code>, <code>-l</code>, <code>--source</code>,
<code>--target-package</code>, etc.), in this option file. Making the command even simpler</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ jextract @sodium-only.conf $(brew --prefix)/include/sodium.h</code></pre>
</div>
</div>
<div class="paragraph">
<p>Even the last argument <code>$(brew --prefix)/include/sodium.h</code> can be appended in
the configuration file to use simplify even more the command to the simplest form
<code>jextract @sodium-only.conf</code>.</p>
</div>
<div class="paragraph">
<p><em>Remember that shell variable expansion <code>$(brew --prefix)</code> won’t work
and must be expanded manually.</em></p>
</div>
<div class="paragraph">
<p><em>This work was part of the following ticket <a href="https://bugs.openjdk.java.net/browse/JDK-8260976">JDK-8260976</a>.</em></p>
</div>
<div class="listingblock">
<div class="title">Generated files</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ \ls -lh src/main/java/com/github/bric3/sodium
total 1944
-rw-r--r--  1 brice  staff   8.9K Sep  4 14:50 RuntimeHelper.java
-rw-r--r--  1 brice  staff   1.9K Sep  4 14:50 constants$0.java
-rw-r--r--  1 brice  staff   2.2K Sep  4 14:50 constants$1.java
...
-rw-r--r--  1 brice  staff    14K Sep  4 14:50 randombytes_implementation.java
-rw-r--r--  1 brice  staff   398K Sep  4 14:50 sodium_h.java
-rw-r--r--  1 brice  staff   1.1K Sep  4 14:50 sodium_set_misuse_handler$handler.java</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_invoking_the_library"><a class="anchor" href="#_invoking_the_library"></a><a class="link" href="#_invoking_the_library">Invoking the library</a></h3>
<div class="paragraph">
<p>Let’s have a look at what <code>jextract</code> generated. The entry point is
the class <code>sodium_h</code>. In particular let’s compare the method stubs
to these I wrote earlier :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>crypto_box_sealbytes</code></p>
</li>
<li>
<p><code>crypto_box_keypair</code></p>
</li>
<li>
<p><code>crypto_box_seal</code></p>
</li>
<li>
<p><code>crypto_box_seal_open</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The libsodium headers declare a method named <code>crypto_box_sealbytes</code>,
whose role is to return a constant <code>crypto_box_SEALBYTES</code>, however
this constant is defined as a C preprocessor directive <code>#DEFINE</code>,
which is not visible as a symbol when performing a <em>library lookup</em>.
The native <code>crypto_box_sealbytes</code> method compensates this limitation.</p>
</div>
<div class="paragraph">
<p><code>jextract</code> is however reading the headers, in doing so it actually extracts
the constant <code>crypto_box_SEALBYTES</code>. It is still also exposed as method.</p>
</div>
<div class="paragraph">
<p>I noticed that if the library has lots of symbols bindings <code>jextract</code> use
inheritance: There’s a single entry point like the public type <code>sodium_h</code>, and
this type inherits package visible classes like <code>sodium_h_0</code>, <code>sodium_h_1</code> and so on.
The members in these package visible classes are public, and by inheritance
these members are accessible via the public entry point.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">sodium_h.crypto_box_SEALBYTES()</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_library_loading"><a class="anchor" href="#_library_loading"></a><a class="link" href="#_library_loading">Library loading</a></h4>
<div class="paragraph">
<p>Remember the passed <code>jextract</code> option <code>-l sodium</code>, this option makes the generated
code to load the library via the well-known <code>System.loadLibrary(&#34;sodium&#34;)</code> upon
class loading the of the generated type (<code>sodium_h</code>).</p>
</div>
<div class="paragraph">
<p>This operation expects the library to be available on the java library path, the
one set via this property <code>System.getProperty(&#34;java.library.path&#34;)</code>, or amended via
<code>JAVA_LIBRARY_PATH</code>.</p>
</div>
<div class="paragraph">
<p>If the library was installed in one of the lookup path there’s no issue, but if
it isn’t you need to alter the java library path.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">linux</dt>
<dd>
<p><code>/usr/java/packages/lib:/usr/lib64:/lib64:/lib:/usr/lib</code></p>
</dd>
<dt class="hdlist1">macOs</dt>
<dd>
<p><code>/Users/bric3/Library/Java/Extensions:/Library/Java/Extensions:/Network/Library/Java/Extensions:/System/Library/Java/Extensions:/usr/lib/java:.</code></p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Otherwise, the code will fail with the following stacktrace</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">no sodium in java.library.path: /Users/brice/Library/Java/Extensions:/Library/Java/Extensions:/Network/Library/Java/Extensions:/System/Library/Java/Extensions:/usr/lib/java:.
java.lang.UnsatisfiedLinkError: no sodium in java.library.path: /Users/brice/Library/Java/Extensions:/Library/Java/Extensions:/Network/Library/Java/Extensions:/System/Library/Java/Extensions:/usr/lib/java:.
	at java.base/java.lang.ClassLoader.loadLibrary(ClassLoader.java:2429)
	at java.base/java.lang.Runtime.loadLibrary0(Runtime.java:818)
	at java.base/java.lang.System.loadLibrary(System.java:1989)
	at com.github.bric3.libsodium.sodium_h.&lt;clinit&gt;(sodium_h.java:13)
	at com.github.bric3.sodium.Libsodium$JextractedLibsodium.crypto_box_keypair(Libsodium.java:283)
	at com.github.bric3.sodium.LibsodiumTest.can_invoke_crypto_box_keypair(LibsodiumTest.java:45)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a nice improvement over my previous try of jextract generated code,
before the stacktrace was a bit less obvious and the code harder to change,
because the loading mechanism was nested deep in the generated code.</p>
</div>
<div class="paragraph">
<p>But if one need to load the library from a custom path, e.g. jar that pack
native libraries (and extract them in some temporary folder), it’s possible to
drop the <code>-l sodium</code> option, in this case the generated code just won’t emit
the <code>System::loadLibrary</code> in the static initialization of <code>sodium_h</code>. Instead,
it becomes necessary to manually load the library to your need.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">System.load(&#34;tmp/path/to/libsodium.so&#34;); <i class="conum" data-value="1"></i><b>(1)</b>
sodium_h.crypto_kdf_blake2b_keybytes(); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Load the library</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Simply use the library bindings</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>This is a direct improvement (see <a href="https://bugs.openjdk.java.net/browse/JDK-8262126">JDK-8262126</a>)
over my previous use of <code>jextract</code>, loading a library from a specific location
was difficult to do.</p>
</div>
</div>
<div class="sect3">
<h4 id="_now_implementing_the_other_functions"><a class="anchor" href="#_now_implementing_the_other_functions"></a><a class="link" href="#_now_implementing_the_other_functions">Now implementing the other functions</a></h4>
<div class="paragraph">
<p>Now let’s profit from the generated function call, in the same order
I’d like to use <code>crypto_box_keypair</code>, this is straightforward.
The arguments are still <em>carrier</em> type like <code>MemorySegment</code>,
which means we still need to take care of the scope / lifecycle of
these allocations.</p>
</div>
<div class="listingblock">
<div class="title">crypto_box_keypair</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">try (var scope = ResourceScope.newConfinedScope()) {
    var segmentAllocator = SegmentAllocator.ofScope(scope);
    var recipientPublicKey = segmentAllocator.allocate(sodium_h.crypto_box_PUBLICKEYBYTES());
    var recipientSecretKey = segmentAllocator.allocate(sodium_h.crypto_box_SECRETKEYBYTES());
    sodium_h.crypto_box_keypair(recipientPublicKey, recipientSecretKey); <i class="conum" data-value="1"></i><b>(1)</b>
    return new CryptoBoxKeyPair(
            recipientPublicKey.toByteArray(),
            recipientSecretKey.toByteArray()
    );
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use the <em>jextracted</em> method</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The IDE might suggest a method named <code>crypto_box_keypair$MH</code> ; the suffix
<code>$MH</code> simply indicates this returns the <strong>M</strong>ethod <strong>H</strong>andle for this native
method which is basically what I showed in the first part of this blog post.</p>
</div>
<div class="paragraph">
<p>As reflex, I always like to navigate the code I’m invoking.
The method we are invoking are just the public API methods, checking null,
and declaring a correct call-site (correct return type, correct argument types).</p>
</div>
<div class="listingblock">
<div class="title">sodium_h.crypto_box_keypair</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public static MethodHandle crypto_box_keypair$MH() {
    return RuntimeHelper.requireNonNull(constants$22.crypto_box_keypair$MH,
                                        &#34;crypto_box_keypair&#34;);
}
public static int crypto_box_keypair ( Addressable pk,  Addressable sk) {
    var mh$ = RuntimeHelper.requireNonNull(constants$22.crypto_box_keypair$MH,
                                           &#34;crypto_box_keypair&#34;);
    try {
        return (int)mh$.invokeExact(pk.address(), sk.address());
    } catch (Throwable ex$) {
        throw new AssertionError(&#34;should not reach here&#34;, ex$);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Going further down to see how the <code>MethodHandle</code> is declared:</p>
</div>
<div class="listingblock">
<div class="title">sodium_h_constants_0.crypto_box_keypair$MH</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">static final FunctionDescriptor crypto_box_keypair$FUNC = FunctionDescriptor.of(
    C_INT,
    C_POINTER,
    C_POINTER
);

static final MethodHandle crypto_box_keypair$MH = RuntimeHelper.downcallHandle(
    sodium_h.LIBRARIES,
    &#34;crypto_box_keypair&#34;,
    &#34;(Ljdk/incubator/foreign/MemoryAddress;Ljdk/incubator/foreign/MemoryAddress;)I&#34;, <i class="conum" data-value="1"></i><b>(1)</b>
    constants$22.crypto_box_keypair$FUNC,
    false
);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Note that the Java method signature is declared with a String instead
of the Java API <code>MethodType</code>.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>This code creates the <em>down-call</em> stub, the only difference with the
handcrafted handle in the section above, is the signature of the method declared
as a <code>String</code>.</p>
</div>
<div class="ulist">
<div class="title"><code>(Ljdk/incubator/foreign/MemoryAddress;Ljdk/incubator/foreign/MemoryAddress;)I</code> &#39;s breakdown</div>
<ul>
<li>
<p><code>Ljdk/incubator/foreign/MemoryAddress</code> ⇒ arg0</p>
</li>
<li>
<p><code>Ljdk/incubator/foreign/MemoryAddress</code> ⇒ arg1</p>
</li>
<li>
<p><code>I</code> ⇒ <code>int</code> return type</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The other two methods in this example  <code>crypto_box_seal</code> and <code>crypto_box_seal_open</code>
are similar and don’t require to do the tedious handle declaration.</p>
</div>
<div class="paragraph">
<p>This type raised a few questions about how to map them in Java in the first section
where I used manually <code>jdk.incubator.foreign</code>. Also, there’s statement at this time
about <code>jextract</code> not supporting some wide types.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="ulist">
<ul>
<li>
<p>jextract does not support certain C types bigger than 64 bits (e.g. <code>long double</code>).</p>
</li>
</ul>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>How does it handle these unsupported types, the answer is in the source code.</p>
</div>
<div class="paragraph">
<p>In here we learn that unsigned types are represented with their signed counterpart and
the types wider than 64 bits are represented with a specific <em>unsupported</em> layout
during headers processing. The symbols with unsupported layouts won’t be generated
as the JEP-389 linker won’t be able to link them.</p>
</div>
<details>
<summary class="title">Some details on how <code>jextract</code>&#39;s primitive types handling</summary>
<div class="content">
<div class="paragraph">
<p>The enum below in jextract show how native primitive types are mapped to their
respective memory layout whether they are supported of not.</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/openjdk/panama-foreign/blob/9a6de2b4ddc3e7f0f8a9abfc571e7d6aa2a27129/src/jdk.incubator.jextract/share/classes/jdk/incubator/jextract/Type.java">Type.Primitive.Kind</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">enum Kind {
    /**
     * {@code void} type.
     */
    Void(&#34;void&#34;, null),
    /**
     * {@code Bool} type.
     */
    Bool(&#34;_Bool&#34;, CLinker.C_CHAR),
    /**
     * {@code char} type.
     */
    Char(&#34;char&#34;, CLinker.C_CHAR),
    /**
     * {@code char16} type.
     */
    Char16(&#34;char16&#34;, UnsupportedLayouts.CHAR16),
    /**
     * {@code short} type.
     */
    Short(&#34;short&#34;, CLinker.C_SHORT),
    /**
     * {@code int} type.
     */
    Int(&#34;int&#34;, CLinker.C_INT),
    /**
     * {@code long} type.
     */
    Long(&#34;long&#34;, CLinker.C_LONG),
    /**
     * {@code long long} type.
     */
    LongLong(&#34;long long&#34;, CLinker.C_LONG_LONG),
    /**
     * {@code int128} type.
     */
    Int128(&#34;__int128&#34;, UnsupportedLayouts.__INT128),
    /**
     * {@code float} type.
     */
    Float(&#34;float&#34;, CLinker.C_FLOAT),
    /**
     * {@code double} type.
     */
    Double(&#34;double&#34;,CLinker.C_DOUBLE),
    /**
      * {@code long double} type.
      */
    LongDouble(&#34;long double&#34;, UnsupportedLayouts.LONG_DOUBLE),
    /**
     * {@code float128} type.
     */
    Float128(&#34;float128&#34;, UnsupportedLayouts._FLOAT128),
    /**
     * {@code float16} type.
     */
    HalfFloat(&#34;__fp16&#34;, UnsupportedLayouts.__FP16),
    /**
     * {@code wchar} type.
     */
    WChar(&#34;wchar_t&#34;, UnsupportedLayouts.WCHAR_T)

    // ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Those types can be <em>qualified</em>, in particular integer types can be unsigned:</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/openjdk/panama-foreign/blob/9a6de2b4ddc3e7f0f8a9abfc571e7d6aa2a27129/src/jdk.incubator.jextract/share/classes/jdk/internal/jextract/impl/TypeMaker.java#L138-L157">jdk.internal.jextract.impl.TypeMaker#makeTypeInternal</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">case UShort: {
    Type chType = Type.primitive(Primitive.Kind.Short);
    return Type.qualified(Delegated.Kind.UNSIGNED, chType);
}
case UInt: {
    Type chType = Type.primitive(Primitive.Kind.Int);
    return Type.qualified(Delegated.Kind.UNSIGNED, chType);
}
case ULong: {
    Type chType = Type.primitive(Primitive.Kind.Long);
    return Type.qualified(Delegated.Kind.UNSIGNED, chType);
}
case ULongLong: {
    Type chType = Type.primitive(Primitive.Kind.LongLong);
    return Type.qualified(Delegated.Kind.UNSIGNED, chType);
}
case UChar: {
    Type chType = Type.primitive(Primitive.Kind.Char);
    return Type.qualified(Delegated.Kind.UNSIGNED, chType);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Going further we can see that signed and unsigned integers use the same
memory layout, e.g. <code>long long</code> and <code>unsigned long long</code> use the same layout
<code>C_LONG_LONG</code>.</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/openjdk/panama-foreign/blob/9a6de2b4ddc3e7f0f8a9abfc571e7d6aa2a27129/src/jdk.incubator.jextract/share/classes/jdk/internal/jextract/impl/LayoutUtils.java#L63-L120">LayoutUtils.getLayout</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public static MemoryLayout getLayout(Type t) {
    Supplier&lt;UnsupportedOperationException&gt; unsupported = () -&gt;
            new UnsupportedOperationException(&#34;unsupported: &#34; + t.kind());
    switch(t.kind()) {
        case UChar, Char_U:
        case SChar, Char_S:
            return Primitive.Kind.Char.layout().orElseThrow(unsupported);
        case Short:
        case UShort:
            return Primitive.Kind.Short.layout().orElseThrow(unsupported);
        case Int:
        case UInt:
            return Primitive.Kind.Int.layout().orElseThrow(unsupported);
        case ULong:
        case Long:
            return Primitive.Kind.Long.layout().orElseThrow(unsupported);
        case ULongLong:
        case LongLong:
            return Primitive.Kind.LongLong.layout().orElseThrow(unsupported); <i class="conum" data-value="1"></i><b>(1)</b>
        case UInt128:
        case Int128:
            return Primitive.Kind.Int128.layout().orElseThrow(unsupported); <i class="conum" data-value="2"></i><b>(2)</b>
        case Enum:
            return valueLayoutForSize(t.size() * 8).layout().orElseThrow(unsupported);
        case Bool:
            return Primitive.Kind.Bool.layout().orElseThrow(unsupported);
        case Float:
            return Primitive.Kind.Float.layout().orElseThrow(unsupported);
        case Double:
            return Primitive.Kind.Double.layout().orElseThrow(unsupported);
        case LongDouble:
            return Primitive.Kind.LongDouble.layout().orElseThrow(unsupported);
        case Complex:
            throw new UnsupportedOperationException(&#34;unsupported: &#34; + t.kind());
        case Record:
            return getRecordLayout(t);
        case Vector:
            return MemoryLayout.sequenceLayout(t.getNumberOfElements(), getLayout(t.getElementType()));
        case ConstantArray:
            return MemoryLayout.sequenceLayout(t.getNumberOfElements(), getLayout(t.getElementType()));
        case IncompleteArray:
            return MemoryLayout.sequenceLayout(getLayout(t.getElementType()));
        case Unexposed:
            Type canonical = t.canonicalType();
            if (canonical.equalType(t)) {
                throw new TypeMaker.TypeException(&#34;Unknown type with same canonical type: &#34; + t.spelling());
            }
            return getLayout(canonical);
        case Typedef:
        case Elaborated:
            return getLayout(t.canonicalType());
        case Pointer:
        case BlockPointer:
            return C_POINTER;
        default:
            throw new UnsupportedOperationException(&#34;unsupported: &#34; + t.kind());
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>C_LONG_LONG</code> will be used for both <code>long long</code> and <code>unsigned long long</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Native types longer than 64 bits are still represented internally by jextract.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p><code>jextract</code> identify unsupported types, and represents them correctly during the C
header processing. But the symbols that use them will be skipped during the
Java generation.</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/openjdk/panama-foreign/blob/9a6de2b4ddc3e7f0f8a9abfc571e7d6aa2a27129/src/jdk.incubator.jextract/share/classes/jdk/internal/jextract/impl/UnsupportedLayouts.java#L37-L64">jdk.internal.jextract.impl.UnsupportedLayouts</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">private static final String ATTR_LAYOUT_KIND = &#34;jextract.abi.unsupported.layout.kind&#34;;

public static final ValueLayout __INT128 = MemoryLayout.valueLayout(128, ByteOrder.nativeOrder()).
        withAttribute(ATTR_LAYOUT_KIND, &#34;__int128&#34;);

public static final ValueLayout LONG_DOUBLE = MemoryLayout.valueLayout(128, ByteOrder.nativeOrder()).
        withAttribute(ATTR_LAYOUT_KIND, &#34;long double&#34;);

public static final ValueLayout _FLOAT128 = MemoryLayout.valueLayout(128, ByteOrder.nativeOrder()).
        withAttribute(ATTR_LAYOUT_KIND, &#34;_float128&#34;);

public static final ValueLayout __FP16 = MemoryLayout.valueLayout(16, ByteOrder.nativeOrder()).
        withAttribute(ATTR_LAYOUT_KIND, &#34;__fp16&#34;);

public static final ValueLayout CHAR16 = MemoryLayout.valueLayout(16, ByteOrder.nativeOrder()).
        withAttribute(ATTR_LAYOUT_KIND, &#34;char16&#34;);

public static final ValueLayout WCHAR_T = MemoryLayout.valueLayout(16, ByteOrder.nativeOrder()).
        withAttribute(ATTR_LAYOUT_KIND, &#34;wchar_t&#34;);

static boolean isUnsupported(MemoryLayout vl) { <i class="conum" data-value="1"></i><b>(1)</b>
    return vl.attribute(ATTR_LAYOUT_KIND).isPresent();
}

static String getUnsupportedTypeName(MemoryLayout vl) {
    return (String)
            vl.attribute(ATTR_LAYOUT_KIND).orElseThrow(IllegalArgumentException::new);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Invoked during java representation generation.</td>
</tr>
</tbody></table>
</div>
</div>
</details>
</div>
</div>
<div class="sect2">
<h3 id="_to_be_part_of_the_jdk_or_not"><a class="anchor" href="#_to_be_part_of_the_jdk_or_not"></a><a class="link" href="#_to_be_part_of_the_jdk_or_not">To be part of the JDK or not ?</a></h3>
<div class="paragraph">
<p>It has been brought to me that jextract may never be part of a standard JDK.
This is still being <a href="https://mail.openjdk.java.net/pipermail/panama-dev/2021-May/013898.html">debated</a>.</p>
</div>
<div class="paragraph">
<p>But the main motivation is the substantial weight of <code>jextract</code>, indeed <code>jextract</code>
is based on <strong><code>libclang</code></strong> which is about <strong><code>81 MiB</code></strong> on macOs, <strong><code>92 MiB</code></strong> on Linux.
Panama developers don’t want to put this much weight on the JDK. Moreover, this
tool is likely to be <em>confined</em> to a small audience of Java developers.</p>
</div>
<div class="paragraph">
<p>Instead, <code>jextract</code> could be delivered via other means like JMH (Java Microbenchmark Harness),
or JDK Mission Control.</p>
</div>
</div>
<div class="sect2">
<h3 id="_wrapping_up_on_jextract_for_jep_412_build_17_panama3_167"><a class="anchor" href="#_wrapping_up_on_jextract_for_jep_412_build_17_panama3_167"></a><a class="link" href="#_wrapping_up_on_jextract_for_jep_412_build_17_panama3_167">Wrapping up on <code>jextract</code> for JEP-412 / build 17-panama+3-167</a></h3>
<div class="paragraph">
<p>This iteration showed massive improvements of <code>jextract</code>, for my usage the
pitfalls present at the time of JEP-389 (JDK 16) are gone. I tend to think the
generated code is still a bit verbose, but it got better.</p>
</div>
<div class="paragraph">
<p>Most welcome is the precise inclusion of symbols which is based on a two phase
approach : dump symbol include options then load as a configuration file.
This mechanism is very useful, the sheer number of dumped symbols can be
a tad intimidating, but this approach is easy to manage. The use of this
configuration file is great.</p>
</div>
<div class="paragraph">
<p>If there’s something that need improvement it’s the help. But I’m sure it will
be fixed before the final release.</p>
</div>
<div class="paragraph">
<p>When a final version is released, this could be leveraged by Gradle or
Jetbrains IntelliJ IDEA, etc.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_closing_words"><a class="anchor" href="#_closing_words"></a><a class="link" href="#_closing_words">Closing words</a></h2>
<div class="sectionbody">
<div class="paragraph">
<div class="title">Cool part</div>
<p>In JDK17 the foreign module is even easier and particularly safer to use
albeit <code>javac</code> and <code>java</code> command line requirement. The API is well-designed and
easy to use. I also appreciated the idea of scoped segments, a bit like what was
implemented in the Rust language. There’s also the coolness of being able
to free memory segment (in particular for mapped file) at will, without
depending on the GC.</p>
</div>
<div class="paragraph">
<div class="title">Sad part</div>
<p>This is yet another incubator with slight API change. It’s not unlikely the API
get refined again, e.g. to prevent unsafe usage. Some of this
blog post content will eventually become incorrect when the next JDK comes out.
Also, <code>jextract</code> solidify its position as a very practical tool, too sad it isn’t
included in the JDK yet, but the safer approach wins here.</p>
</div>
<div class="paragraph">
<div class="title">Overall</div>
<p>JEP-412 is yet another solid step-stone toward what looks like
the replacement (in terms of usage) of JNI or JNA. As before I can only applaud
the work done! My only regret is it’s not yet <em>already</em> available. That said as
a developer I support the idea to not ship until ready.</p>
</div>
<hr/>
<div class="ulist">
<div class="title">Sources in no particular order</div>
<ul>
<li>
<p><a href="https://openjdk.java.net/jeps/389" class="bare">https://openjdk.java.net/jeps/389</a></p>
</li>
<li>
<p><a href="https://openjdk.java.net/jeps/412" class="bare">https://openjdk.java.net/jeps/412</a></p>
</li>
<li>
<p><a href="https://mail.openjdk.java.net/pipermail/panama-dev/" class="bare">https://mail.openjdk.java.net/pipermail/panama-dev/</a></p>
</li>
<li>
<p><a href="https://cr.openjdk.java.net/~mcimadamore/panama/ffi.html" class="bare">https://cr.openjdk.java.net/~mcimadamore/panama/ffi.html</a></p>
</li>
<li>
<p><a href="https://inside.java/2020/10/06/jextract/" class="bare">https://inside.java/2020/10/06/jextract/</a></p>
</li>
<li>
<p><a href="https://jdk.java.net/panama/" class="bare">https://jdk.java.net/panama/</a></p>
</li>
<li>
<p><a href="https://github.com/sundararajana/panama-jextract-samples/" class="bare">https://github.com/sundararajana/panama-jextract-samples/</a></p>
</li>
<li>
<p><a href="https://github.com/openjdk/panama-foreign" class="bare">https://github.com/openjdk/panama-foreign</a></p>
</li>
<li>
<p><a href="https://github.com/jedisct1/libsodium" class="bare">https://github.com/jedisct1/libsodium</a></p>
</li>
<li>
<p><a href="https://doc.libsodium.org/installation" class="bare">https://doc.libsodium.org/installation</a></p>
</li>
<li>
<p><a href="https://inside.java/2021/01/25/memory-access-pulling-all-the-threads/" class="bare">https://inside.java/2021/01/25/memory-access-pulling-all-the-threads/</a></p>
</li>
<li>
<p><a href="https://foojay.io/today/project-panama-for-newbies-part-1/" class="bare">https://foojay.io/today/project-panama-for-newbies-part-1/</a></p>
</li>
<li>
<p><a href="https://foojay.io/today/project-panama-for-newbies-part-2/" class="bare">https://foojay.io/today/project-panama-for-newbies-part-2/</a></p>
</li>
<li>
<p><a href="https://foojay.io/today/project-panama-for-newbies-part-3/" class="bare">https://foojay.io/today/project-panama-for-newbies-part-3/</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You might also be interested in these two podcasts (thanks to <a href="https://twitter.com/delabassee">David Delabassée</a>)</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://inside.java/2020/12/11/podcast-009/">The Foreign Memory Access API</a></p>
</li>
<li>
<p><a href="https://inside.java/2020/12/21/podcast-010/">The Foreign Linker API</a></p>
</li>
</ul>
</div>
</div>
</div>

  </div>
  

<div class="navigation navigation-single">
    
    <a href="/2021/02/20/a-practical-look-at-jep-389-in-jdk16-with-libsodium/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">A practical look at JEP-389 in JDK16 with libsodium</span>
    </a>
    
    
    <a href="/2022/05/16/linux_memfd_secret_with_jep-419/" class="navigation-next">
      <span class="navigation-tittle">Using Linux&#39;s memfd_secret syscall from the JVM with JEP-419</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  

  <script
    src="https://giscus.app/client.js"
    data-repo="bric3/bric3.github.io"
    data-repo-id="MDEwOlJlcG9zaXRvcnk2MDc3NjczMQ=="
    data-category="Blog Comments"
    data-category-id="DIC_kwDOA59hG84CR_S_"
    data-mapping="pathname"
    data-reactions-enabled="1"
    data-input-position="top"
    data-theme="preferred-color-scheme"
    data-lang="en"
    data-loading="lazy"
    data-strict="1"
    
    data-theme="preferred-color-scheme"
    crossorigin="anonymous"
    async
  ></script>


</article>


            
    
<footer>

 
 
 <div class="github-edit">
     <a href="https://github.com/bric3/bric3.github.io/edit/hugo-sources/content/posts/2021-09-03-a-practical-look-at-jep-412-with-jdk17.adoc">
     <i class="fab fa-github fa-lg" aria-hidden="true"></i> Edit this page
     </a>
 </div>
 




















<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: { inlineMath: [["\\(", "\\)"]], displayMath: [["\\[", "\\]"]], ignoreClass: "nostem|nolatexmath" },
  asciimath2jax: { delimiters: [["\\$", "\\$"]], ignoreClass: "nostem|noasciimath" },
  TeX: { equationNumbers: { autoNumber: "none" } }
})
MathJax.Hub.Register.StartupHook("AsciiMath Jax Ready", function () {
  MathJax.InputJax.AsciiMath.postfilterHooks.Add(function (data, node) {
    if ((node = data.script.parentNode) && (node = node.parentNode) && node.classList.contains("stemblock")) {
      data.math.root.display = "block"
    }
    return data
  })
})
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js" integrity="sha512-M36RUChWzAh1veeenRZFql7HydLEnkYmoloiCvVrhz402UZgKI93qkV7SsaxtVKdN95Wzajh39ysrXCq34NTsg==" crossorigin="anonymous"></script>
<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/config/TeX-MML-AM_HTMLorMML-full.min.js" integrity="sha512-SdNVJmCczXFqz3Iok8gP+cloe2CScrnHJczMBwL+aSrdZVllRNqRJ5A2p83S4fUM8I4endIZgM2ZIkwNqb3Eew==" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/highlight.min.js" integrity="sha512-gU7kztaQEl7SHJyraPfZLQCNnrKdaQi5ndOyt4L4UPL/FHDd/uB9Je6KDARIqwnNNE27hnqoWLBq+Kpe4iHfeQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script type="text/javascript">
        
        
        
        
        
        var mergeHTMLPlugin = (function () {
            'use strict';

            var originalStream;

            

            function escapeHTML(value) {
                return value
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#x27;');
            }

             

             
            const mergeHTMLPlugin = {
                
                "before:highlightElement": ({ el }) => {
                    originalStream = nodeStream(el);
                },
                
                "after:highlightElement": ({ el, result, text }) => {
                    if (!originalStream.length) return;

                    const resultNode = document.createElement('div');
                    resultNode.innerHTML = result.value;
                    result.value = mergeStreams(originalStream, nodeStream(resultNode), text);
                    el.innerHTML = result.value;
                }
            };

             

            


            

            function tag(node) {
                return node.nodeName.toLowerCase();
            }

            

            function nodeStream(node) {
                 
                const result = [];
                (function _nodeStream(node, offset) {
                    for (let child = node.firstChild; child; child = child.nextSibling) {
                        if (child.nodeType === 3) {
                            offset += child.nodeValue.length;
                        } else if (child.nodeType === 1) {
                            result.push({
                                event: 'start',
                                offset: offset,
                                node: child
                            });
                            offset = _nodeStream(child, offset);
                            
                            
                            
                            if (!tag(child).match(/br|hr|img|input/)) {
                                result.push({
                                    event: 'stop',
                                    offset: offset,
                                    node: child
                                });
                            }
                        }
                    }
                    return offset;
                })(node, 0);
                return result;
            }

            

            function mergeStreams(original, highlighted, value) {
                let processed = 0;
                let result = '';
                const nodeStack = [];

                function selectStream() {
                    if (!original.length || !highlighted.length) {
                        return original.length ? original : highlighted;
                    }
                    if (original[0].offset !== highlighted[0].offset) {
                        return (original[0].offset < highlighted[0].offset) ? original : highlighted;
                    }

                    

                    return highlighted[0].event === 'start' ? original : highlighted;
                }

                

                function open(node) {
                     
                    function attributeString(attr) {
                        return ' ' + attr.nodeName + '="' + escapeHTML(attr.value) + '"';
                    }
                    
                    result += '<' + tag(node) + [].map.call(node.attributes, attributeString).join('') + '>';
                }

                

                function close(node) {
                    result += '</' + tag(node) + '>';
                }

                

                function render(event) {
                    (event.event === 'start' ? open : close)(event.node);
                }

                while (original.length || highlighted.length) {
                    let stream = selectStream();
                    result += escapeHTML(value.substring(processed, stream[0].offset));
                    processed = stream[0].offset;
                    if (stream === original) {
                        

                        nodeStack.reverse().forEach(close);
                        do {
                            render(stream.splice(0, 1)[0]);
                            stream = selectStream();
                        } while (stream === original && stream.length && stream[0].offset === processed);
                        nodeStack.reverse().forEach(open);
                    } else {
                        if (stream[0].event === 'start') {
                            nodeStack.push(stream[0].node);
                        } else {
                            nodeStack.pop();
                        }
                        render(stream.splice(0, 1)[0]);
                    }
                }
                return result + escapeHTML(value.substr(processed));
            }

            return mergeHTMLPlugin;

        }());
        hljs.addPlugin(mergeHTMLPlugin);
        


        
        hljs.initHighlightingOnLoad();
    </script>
    

<script src="https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js" integrity="sha256-vrn14y7WH7zgEElyQqm2uCGSQrX/xjYDjniRUQx3NyU=" crossorigin="anonymous"></script>
<script type="text/javascript">
function addBlockSwitches() {
	$('.primary').each(function() {
		primary = $(this);
		createSwitchItem(primary, createBlockSwitch(primary)).item.addClass("selected");
		primary.children('.title').remove();
	});
	$('.secondary').each(function(idx, node) {
		secondary = $(node);
		primary = findPrimary(secondary);
		switchItem = createSwitchItem(secondary, primary.children('.switch'));
		switchItem.content.addClass('hidden');
		findPrimary(secondary).append(switchItem.content);
		secondary.remove();
	});
}

function createBlockSwitch(primary) {
	blockSwitch = $('<div class="switch"></div>');
	primary.prepend(blockSwitch);
	return blockSwitch;
}

function findPrimary(secondary) {
	candidate = secondary.prev();
	while (!candidate.is('.primary')) {
		candidate = candidate.prev();
	}
	return candidate;
}

function createSwitchItem(block, blockSwitch) {
	blockName = block.children('.title').text();
	content = block.children('.content').first().append(block.next('.colist'));
	item = $('<div class="switch--item">' + blockName + '</div>');
	blockSwitch.append(item);
	return {'item': item, 'content': content};
}

function globalSwitch() {
	$('.switch--item').each(function() {
		var blockId = blockIdForSwitchItem($(this));
		$(this).off('click');
		$(this).on('click', function() {
			selectedText = $(this).text()
			window.localStorage.setItem(blockId, selectedText);
			$(".switch--item").filter(function() {
				return blockIdForSwitchItem($(this)) === blockId;
			}).filter(function() {
				return $(this).text() === selectedText;
			}).each(function() {
				select($(this))
			});
		});
		if ($(this).text() === window.localStorage.getItem(blockId)) {
			select($(this))
		}
	});
}

function blockIdForSwitchItem(item) {
	idComponents = []
	idComponents.push(item.text().toLowerCase());
	item.siblings(".switch--item").each(function(index, sibling) {
		idComponents.push($(sibling).text().toLowerCase());
	});
	return idComponents.sort().join("-")
}

function select(selected) {
	selected.addClass('selected');
	selected.siblings().removeClass('selected');
	selectedContent = selected.parent().siblings(".content").eq(selected.index())
	selectedContent.removeClass('hidden');
	selectedContent.siblings().addClass('hidden');
}

$(addBlockSwitches);
$(globalSwitch);
</script>





</footer>

    



        </div>
    </body>
</html>

