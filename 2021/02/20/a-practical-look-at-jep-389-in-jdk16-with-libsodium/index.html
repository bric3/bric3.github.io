<!DOCTYPE html>
<html lang="en">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.82.1" />

    
    
    

<title>A practical look at JEP-389 in JDK16 with libsodium • Brice Dutheil</title>













    
<meta property="og:locale" content="en">
<meta property="og:site_name" content="Brice Dutheil">
<meta property="og:title" content="A practical look at JEP-389 in JDK16 with libsodium">
<meta property="og:type" content="website">
<meta property="og:url" content="https://blog.arkey.fr/2021/02/20/a-practical-look-at-jep-389-in-jdk16-with-libsodium/" />
<meta property="og:description" content="Java mostly, and general tech">
<meta property="og:image" content="https://blog.arkey.fr/social-sharing.png">
<meta property="og:image:type" content="image/png">
    
    
    
<meta property="og:image:width" content="192">
<meta property="og:image:height" content="192">
    

<meta property="og:updated_time" content="2021-02-20T16:01:06&#43;0100">



<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@BriceDutheil">
<meta name="twitter:title" content="A practical look at JEP-389 in JDK16 with libsodium">

<meta name="twitter:image" content="https://blog.arkey.fr/social-sharing.png">

<meta name="twitter:description" content="Java mostly, and general tech">
<meta name="twitter:creator" content="@BriceDutheil">
    
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.4.1/styles/a11y-light.min.css" media="(prefers-color-scheme: light)"><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.4.1/styles/gruvbox-dark.min.css" media="(prefers-color-scheme: dark)">




<link rel="stylesheet" href="/scss/hyde-hyde.dd81e7ab42051dce4af5e995f71cc9ffa0a9d977c7fa252fbf1cfea75d1d463b.css" integrity="sha256-3YHnq0IFHc5K9emV9xzJ/6Cp2XfH&#43;iUvvxz&#43;p10dRjs=">


<link rel="stylesheet" href="/scss/hyde-hyde-dark.8dcf235ba9845159df4d1ea26547422f22737b721fb3bb5a9d1b7ecec0f09be8.css" integrity="sha256-jc8jW6mEUVnfTR6iZUdCLyJze3Ifs7tanRt&#43;zsDwm&#43;g=" media="(prefers-color-scheme: dark)">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">




<link rel="stylesheet" href="/scss/hugo-toc.d31afb68f96b4b4a16c6def81c6cfb18992a6924bd88766a480bb24a08ca5796.css" integrity="sha256-0xr7aPlrS0oWxt74HGz7GJkqaSS9iHZqSAuySgjKV5Y=">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    
    <link rel="shortcut icon" sizes="192x192" href="/android-192-favicon.png">

    
    <link rel="shortcut icon" href="/android-192-favicon.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/v4-shims.min.css" integrity="sha512-KNosrY5jkv7dI1q54vqk0N3x1xEmEn4sjzpU1lWL6bv5VVddcYKQVhHV08468FK6eBBSXTwGlMMZLPTXSpHYHA==" crossorigin="anonymous" />

    
    


    
</head>


    <body class="">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="https://blog.arkey.fr">Brice Dutheil</a>
      </span>
      
      
        <div class="author-image">
          <img src="https://www.gravatar.com/avatar/f31c7fbcbb0766d0632d96fd7e74b649?s=240&d=mp" class="img--circle img--headshot element--center" alt="gravatar">
        </div>
      
      <p class="site__description">
         Java mostly, and general tech 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">Brice Dutheil</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/"><span class='fa-icon'><i class='fas fa-home'></i></span><code>cd <em>~</em></code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/posts/"><span class='fa-icon'><i class='fas fa-stream'></i></span><code>ls <em>posts/*</em></code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/series/"><span class='fa-icon'><i class='fas fa-list-alt'></i></span><code>grep -o <em>series</em> posts/* | sort -u</code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/tags/"><span class='fa-icon'><i class='fas fa-tags'></i></span><code>grep -o <em>tags</em> posts/* | sort -u</code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/cool-stuff/"><span class='fa-icon'><i class='fas fa-thumbtack'></i></span><code>cd <em>cool-stuff</em></code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/whoami/"><span class='fa-icon'><i class='fas fa-id-card'></i></span><code>whoami</code>
						<span></span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://twitter.com/BriceDutheil" rel="me"><i class="fa-w-16" aria-hidden="true"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="bird" class="svg-inline--fa fa-bird fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></i></a>
	
	
	
	<a href="https://github.com/bric3" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	<a href="https://speakerdeck.com/bric3" rel="me"><i class="fab fa-speaker-deck" aria-hidden="true"></i></i></a>
	
	
	
	
	
	
	
	<a href="https://linkedin.com/in/dutheilbrice" rel="me"><i class="fa-w-16" aria-hidden="true"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="pro-network" class="svg-inline--fa fa-pro-network fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></i></a>
	
	
	<a href="https://stackoverflow.com/users/48136/brice" rel="me"><i class="fab fa-stack-overflow fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	
</section>

      </div>
    </div>

  </div>
  <div class="container fixed-container">
    
<div class="copyright">
  &copy; 2010 - 2021 Brice Dutheil
  
    <a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a>
  
</div>



  </div>
</div>

        <div class="content container">
            
    <header>

 
 
 <div class="github-edit">
     <a href="https://github.com/bric3/bric3.github.io/edit/hugo-sources/content/posts/2021-02-20-a-practical-look-at-jep-389-with-jdk16.adoc">
     <i class="fab fa-github fa-lg" aria-hidden="true"></i> Edit this page
     </a>
 </div>
 


</header>

            
    

<article>
  <header>
    <h1>A practical look at JEP-389 in JDK16 with libsodium</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> 2021-02-20
    
    
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/jep-389">jep-389</a>
           
      
          <a class="badge badge-tag" href="/tags/java">java</a>
           
      
          <a class="badge badge-tag" href="/tags/jvm">jvm</a>
           
      
          <a class="badge badge-tag" href="/tags/memory">memory</a>
           
      
          <a class="badge badge-tag" href="/tags/linker">linker</a>
           
      
          <a class="badge badge-tag" href="/tags/foreign">foreign</a>
           
      
          <a class="badge badge-tag" href="/tags/jdk16">jdk16</a>
          
      
    
    
    <br/>
    <i class="fas fa-clock"></i> 78 min read

    
    
    

</div>


  </header>
  
  
  
    <div class="toc-wrapper">
      <input type="checkbox" id="tocToggle" checked>
      <label for="tocToggle"><i class="fas fa-list-ul fa-lg"></i><span id="toc-title">On this page</span></label>
      <div id="toc-toggle-cover"></div>

      
          <nav id="TableOfContents">
  <ul>
    <li><a href="#_the_crypto_sealed_box_example">The crypto sealed box example</a>
      <ul>
        <li><a href="#_testing_the_idea_in_jshell">Testing the idea in <code>jshell</code></a></li>
        <li><a href="#_configuring_gradle">Configuring Gradle</a></li>
        <li><a href="#_the_first_and_minimal_call_crypto_box_sealbytes">The first and minimal call <code>crypto_box_sealbytes</code></a></li>
        <li><a href="#_then_a_more_interesting_case_passing_argument_pointers">Then a more interesting case, passing argument pointers</a></li>
        <li><a href="#_next_invoking_the_sealing_method">Next invoking the sealing method</a></li>
        <li><a href="#_ending_the_crypto_box_example">Ending the crypto box example</a></li>
        <li><a href="#_wrap_up_on_manually_using_the_foreign_linker_api">Wrap up on manually using the Foreign Linker API</a></li>
      </ul>
    </li>
    <li><a href="#_remarks_about_memorysegments_memory_mapping">Remarks about <code>MemorySegment</code>s  memory mapping</a></li>
    <li><a href="#_jep_389_is_still_incubating">JEP-389 is still incubating</a></li>
    <li><a href="#_jextract"><code>jextract</code></a>
      <ul>
        <li><a href="#_extracting_java_liking_code_from_the_libsodium_headers">Extracting Java liking code from the Libsodium headers</a></li>
        <li><a href="#_invoking_the_library">Invoking the library</a></li>
        <li><a href="#_wrapping_up_on_jextract">Wrapping up on <code>jextract</code></a></li>
      </ul>
    </li>
    <li><a href="#_closing_words">Closing words</a></li>
  </ul>
</nav>
      
    </div>
  
  
  
  <div class="post adoc">
    
<div class="paragraph">
<p>JDK 16 is coming and with the <strong>incubating</strong> <a href="https://openjdk.java.net/jeps/389">JEP-389</a>
(Foreign Linker API).</p>
</div>
<div class="paragraph">
<p>The Foreign Linker API is a very convenient and attractive way to connect to
the native world. Let’s have a practical look at this API that should supersede JNI.
In order to do so I wanted Java code to interact with the infamous
<a href="https://doc.libsodium.org/"><strong>libsodium</strong></a>.</p>
</div>
<div class="paragraph">
<p>First I will focus on using the foreign linker API, then I will show how to use
<code>jextract</code> in its current state (it is still being actively developed).</p>
</div>
<div class="admonitionblock caution">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Note that JEP-389 is still incubating, therefore examples below are to be
obsolete for the next JDK as API and behavior are further refined.
</td>
</tr>
</tbody></table>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The following examples were based on <strong>JDK 16 release candidate build 36 (2021/2/8)</strong>.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p><em>Thanks to <a href="https://twitter.com/jpbempel">Jean-Phillipe Bempel</a> for the review and
in particular spotting errors</em>.</p>
</div>
<div class="sect1">
<h2 id="_the_crypto_sealed_box_example"><a class="anchor" href="#_the_crypto_sealed_box_example"></a><a class="link" href="#_the_crypto_sealed_box_example">The crypto sealed box example</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let’s try to reproduce the following example from the
<a href="https://doc.libsodium.org/public-key_cryptography/sealed_boxes">libsodium sealbox documentation</a>,
on this page there is a simple code snippet, that could be interesting to reproduce in Java.</p>
</div>
<div class="listingblock">
<div class="title">Crypto sealed box example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">#define MESSAGE (const unsigned char *) &#34;Message&#34;
#define MESSAGE_LEN 7
#define CIPHERTEXT_LEN (crypto_box_SEALBYTES + MESSAGE_LEN)

/* Recipient creates a long-term key pair */
unsigned char recipient_pk[crypto_box_PUBLICKEYBYTES];
unsigned char recipient_sk[crypto_box_SECRETKEYBYTES];
crypto_box_keypair(recipient_pk, recipient_sk);

/* Anonymous sender encrypts a message using an ephemeral key pair
 * and the recipient&#39;s public key */
unsigned char ciphertext[CIPHERTEXT_LEN];
crypto_box_seal(ciphertext, MESSAGE, MESSAGE_LEN, recipient_pk);

/* Recipient decrypts the ciphertext */
unsigned char decrypted[MESSAGE_LEN];
if (crypto_box_seal_open(decrypted, ciphertext, CIPHERTEXT_LEN,
                         recipient_pk, recipient_sk) != 0) {
    /* message corrupted or not intended for this recipient */
}</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_testing_the_idea_in_jshell"><a class="anchor" href="#_testing_the_idea_in_jshell"></a><a class="link" href="#_testing_the_idea_in_jshell">Testing the idea in <code>jshell</code></a></h3>
<div class="paragraph">
<p>One of the cool thing with <code>jshell</code> is that you can try small ideas with a rapid
feedback loop. With the right configuration, it is also possible to play the
foreign linker.</p>
</div>
<div class="listingblock">
<div class="title">Allow jshell to use the foreign module</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ jshell --add-modules jdk.incubator.foreign -R-Dforeign.restricted=permit</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then within jshell, let’s try out a simple smoke test.</p>
</div>
<div class="listingblock">
<div class="title">Smoke testing the foreign module</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">jshell&gt; import java.lang.invoke.*;
jshell&gt; import jdk.incubator.foreign.*;
jshell&gt; var getpid = CLinker.getInstance()
   ...&gt;                     .downcallHandle(
   ...&gt;                             LibraryLookup.ofDefault().lookup(&#34;getpid&#34;).get(),
   ...&gt;                             MethodType.methodType(long.class),
   ...&gt;                             FunctionDescriptor.of(CLinker.C_LONG)
   ...&gt;                     );
getpid ==&gt; MethodHandle()long

jshell&gt; (long) getpid.invokeExact();
$4 ==&gt; 53699

jshell&gt; ProcessHandle.current().pid()
$5 ==&gt; 53699</code></pre>
</div>
</div>
<div class="paragraph">
<p>Yes it works ! It really is easy to try a things for almost free, without
leaving Java this is really neat. Now I would like to focus on the small example
with libsodium within a project. I’ll explain how to use the API along the way.</p>
</div>
</div>
<div class="sect2">
<h3 id="_configuring_gradle"><a class="anchor" href="#_configuring_gradle"></a><a class="link" href="#_configuring_gradle">Configuring Gradle</a></h3>
<div class="paragraph">
<p>The incubating modules are not on the default module path. Hence, it is required
to add the <code>jdk.incubator.foreign</code> module when invoking the compilation command.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ javac --add-modules jdk.incubator.foreign ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>This module also needs to be declared when running this code, as well as
another property <code>foreign.restricted</code> to be able to invoke native code.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ java -Dforeign.restricted=permit --add-modules jdk.incubator.foreign ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you like to play with <code>jshell</code>, it will be necessary to use these two as well</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ jshell -R-Dforeign.restricted=permit --add-modules jdk.incubator.foreign ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then comes the question to configure the build tool. I am using Gradle, the
configuration is likely similar for other build tool.</p>
</div>
<div class="listingblock">
<div class="title">build.gradle.kts</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">// ...

java {
    toolchain {
        languageVersion.set(JavaLanguageVersion.of(16))
    }
}

tasks {
    withType&lt;JavaCompile&gt;().configureEach {
        options.forkOptions.jvmArgs = listOf(
                &#34;--add-opens&#34;, &#34;jdk.compiler/com.sun.tools.javac.code=ALL-UNNAMED&#34; <i class="conum" data-value="1"></i><b>(1)</b>
        )

        options.compilerArgs = listOf(
                &#34;--add-modules&#34;, &#34;jdk.incubator.foreign&#34; <i class="conum" data-value="2"></i><b>(2)</b>
        )
        options.release.set(16)
    }

    withType&lt;JavaExec&gt;().configureEach {
        jvmArgs(&#34;-Dforeign.restricted=permit&#34;, <i class="conum" data-value="3"></i><b>(3)</b>
                &#34;--add-modules&#34;, &#34;jdk.incubator.foreign&#34;)
    }

    withType&lt;Test&gt;().configureEach {
        useJUnitPlatform()
        jvmArgs(&#34;-Dforeign.restricted=permit&#34;, <i class="conum" data-value="4"></i><b>(4)</b>
                &#34;--add-modules&#34;, &#34;jdk.incubator.foreign&#34;)
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Gradle itself can run on a different JDK, but the code needs to be compiled
with JDK16, at this time Gradle 6.8.2 does not support the new module restriction
introduced with JDK16 by default, hence it is necessary to explicitly open modules.
See <a href="https://github.com/gradle/gradle/issues/15538#issuecomment-744299876">gradle/gradle#15538</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Let the compiler knows about the <code>jdk.incubator.foreign</code> module</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Configure the tasks that executes a main class, while this is not immediately useful
IntelliJ IDEA will pick up this configuration, when you click running a <code>main</code> method.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Configure test tasks to be able to run <code>jdk.incubator.foreign</code> tests.</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="_the_first_and_minimal_call_crypto_box_sealbytes"><a class="anchor" href="#_the_first_and_minimal_call_crypto_box_sealbytes"></a><a class="link" href="#_the_first_and_minimal_call_crypto_box_sealbytes">The first and minimal call <code>crypto_box_sealbytes</code></a></h3>
<div class="paragraph">
<p>The first lines makes use of a few macros (the lines starting with <code>#define</code>),
we can assume that <code>MESSAGE</code> will be a method parameter, <code>MESSAGE_LEN</code>
will be derived from the message parameter, and <code>CIPHERTEXT_LEN</code> is also derived
from the message but needs another constant <code>crypto_box_SEALBYTES</code>.</p>
</div>
<div class="paragraph">
<p>The first thing needed is to acquire the <code>crypto_box_SEALBYTES</code> constant, looking at
<a href="https://github.com/jedisct1/libsodium/blob/ae4add868124a32d4e54da10f9cd99240aecc0aa/src/libsodium/include/sodium/crypto_box.h#L125-L127"><code>crypto_box.h</code></a>
there’s a method <code>size_t crypto_box_sealbytes(void);</code> that returns this constant.</p>
</div>
<div class="paragraph">
<p>It’s simple, and it will be the first method I will present here.</p>
</div>
<div class="paragraph">
<p>The first challenge is to map the return type <code>size_t</code>, <em>unsigned integer type</em>,
since the constant
<a href="https://github.com/jedisct1/libsodium/blob/ae4add868124a32d4e54da10f9cd99240aecc0aa/src/libsodium/include/sodium/crypto_box.h#L125-L127"><sup>1</sup></a>
<a href="https://github.com/jedisct1/libsodium/blob/ae4add868124a32d4e54da10f9cd99240aecc0aa/src/libsodium/include/sodium/crypto_box_curve25519xsalsa20poly1305.h#L19"><sup>2</sup></a>
<a href="https://github.com/jedisct1/libsodium/blob/ae4add868124a32d4e54da10f9cd99240aecc0aa/src/libsodium/include/sodium/crypto_box_curve25519xsalsa20poly1305.h#L35"><sup>3</sup></a>
is inferior to the integer max value and that I’d like to use
this as an array size, I will map it to an <code>int</code>.</p>
</div>
<div class="listingblock">
<div class="title">crypto_box_sealbytes (.java)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">MethodHandle crypto_box_sealbytes =
        CLinker.getInstance()
               .downcallHandle(
                       libsodiumLookup.lookup(&#34;crypto_box_sealbytes&#34;).get(),
                       MethodType.methodType(int.class),
                       FunctionDescriptor.of(CLinker.C_INT)
               );

var crypto_box_SEALBYTES = (int) crypto_box_sealbytes.invokeExact();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The java type and the C descriptor must match, otherwise the call will fail at
runtime with a <code>IllegalArgumentException</code>.</p>
</div>
<div class="exampleblock primary">
<div class="title">Example 1. Carrier mismatch long != b32</div>
<div class="content">
<div class="paragraph">
<p>If the java method type used <code>long.class</code>, and the C descriptor was <code>C_INT</code>,
the code would have failed with a carrier mismatch.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">java.lang.IllegalArgumentException: Carrier size mismatch: long != b32[abi/kind=INT]</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock secondary">
<div class="title">Example 2. Carrier mismatch int != b64</div>
<div class="content">
<div class="paragraph">
<p>If the java method type used <code>int.class</code>, and the C descriptor was <code>C_LONG</code>,
the code would have failed with a carrier mismatch.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">java.lang.IllegalArgumentException: Carrier size mismatch: int != b64[abi/kind=LONG]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>For reference, <code>CLinker.C_INT</code> is actually a <code>MemoryLayout</code>, a <em>layout</em> is used
to model native memory.</p>
</div>
</div>
<div class="sect2">
<h3 id="_then_a_more_interesting_case_passing_argument_pointers"><a class="anchor" href="#_then_a_more_interesting_case_passing_argument_pointers"></a><a class="link" href="#_then_a_more_interesting_case_passing_argument_pointers">Then a more interesting case, passing argument pointers</a></h3>
<div class="paragraph">
<p>The next part of the example is a little more involved code, the
<code>crypto_box_keypair</code> method takes two array pointers <code>recipient_pk</code> and
<code>recipient_sk</code>, the generated keypair will be written to the given byte array.</p>
</div>
<div class="listingblock">
<div class="title">crypto_box_keypair (.c)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">unsigned char recipient_pk[crypto_box_PUBLICKEYBYTES];
unsigned char recipient_sk[crypto_box_SECRETKEYBYTES];
crypto_box_keypair(recipient_pk, recipient_sk);</code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to initialize the size of these arrays, the codes needs
two constants <code>crypto_box_PUBLICKEYBYTES</code> and
<code>crypto_box_SECRETKEYBYTES</code>. To access these two it’ll be the same
as <code>crypto_box_SEALBYTES</code>.</p>
</div>
<div class="paragraph">
<p>The C mapping is easy to get : a void method that takes 2 pointers
<code>FunctionDescriptor.ofVoid(C_POINTER, C_POINTER)</code>. In Java the method type
require a type called <code>MemoryAddress</code> which represents the pointer address.</p>
</div>
<div class="paragraph">
<p>The pointers need to point to some memory. That’s what the <code>MemorySegment</code> type
is for. Before invoking the method the necessary memory will be allocated
via <code>MemorySegment::allocateNative</code>, and the respective memory segment address
will be passed.</p>
</div>
<div class="listingblock">
<div class="title">crypto_box_keypair (.java)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">MethodHandle crypto_box_keypair =
        CLinker.getInstance().downcallHandle(
                libsodiumLookup.lookup(&#34;crypto_box_keypair&#34;).get(),
                MethodType.methodType(
                        void.class,
                        MemoryAddress.class, // pk
                        MemoryAddress.class  // sk
                ),
                FunctionDescriptor.ofVoid(C_POINTER, C_POINTER)
        );

var recipientPublicKey = MemorySegment.allocateNative(crypto_box_publickeybytes());
var recipientSecretKey = MemorySegment.allocateNative(crypto_box_secretkeybytes());
crypto_box_keypair.invokeExact(recipientPublicKey.address(),
                               recipientSecretKey.address());

var kp = new CryptoBoxKeyPair(
        recipientPublicKey.toByteArray(),
        recipientSecretKey.toByteArray()
);</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
This code works, but there is something that must be taken care of,
<strong>the native segment lifecycle</strong>.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The above code snippet <strong>never</strong> deallocate native memory. Fortunately
in JDK 16 the <code>MemorySegment</code> class implements <code>AutoCloseable</code>, declaring it
in a <em>try-with_resources</em> block will solve the issue.</p>
</div>
<div class="listingblock">
<div class="title"><code>MemorySegment</code> lifecycle</div>
<div class="content">
<pre>try (var recipientPublicKey = MemorySegment.allocateNative(crypto_box_publickeybytes());
     var recipientSecretKey = MemorySegment.allocateNative(crypto_box_secretkeybytes())) {
    crypto_box_keypair.invokeExact(recipientPublicKey.address(),
                                   recipientSecretKey.address());

    return new CryptoBoxKeyPair(
            recipientPublicKey.toByteArray(),
            recipientSecretKey.toByteArray()
    );
}</pre>
</div>
</div>
<div class="paragraph">
<p>However, JEP-389 comes with the concept of scopes, which allows to express
temporal bounds of these segments, in JDK16 look for the <code>NativeScope</code> class,
it allows registering segments in a <em>code section</em> and allocating segments
anywhere in this section.</p>
</div>
<div class="listingblock">
<div class="title">crypto_box_keypair with <code>NativeScope</code> (.java)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">try (var scope = NativeScope.unboundedScope()) {
    var recipientPublicKey = scope.allocate(crypto_box_publickeybytes());
    var recipientSecretKey = scope.allocate(crypto_box_secretkeybytes());

    crypto_box_keypair.invokeExact(recipientPublicKey.address(),
                                   recipientSecretKey.address());

    return new CryptoBoxKeyPair(
            recipientPublicKey.toByteArray(),
            recipientSecretKey.toByteArray()
    );
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to get back the off-heap content into Java types, the code can call
any of the <code>to{The Java Type}</code> methods on the <code>MemorySegment</code> instance, they
will take care of the conversion.</p>
</div>
</div>
<div class="sect2">
<h3 id="_next_invoking_the_sealing_method"><a class="anchor" href="#_next_invoking_the_sealing_method"></a><a class="link" href="#_next_invoking_the_sealing_method">Next invoking the sealing method</a></h3>
<div class="paragraph">
<p>The next method to call is <code>crypto_box_seal</code>, which also takes
pointers and a message length.</p>
</div>
<div class="listingblock">
<div class="title">crypto_box_seal (.c)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">unsigned char ciphertext[CIPHERTEXT_LEN];
crypto_box_seal(ciphertext, MESSAGE, MESSAGE_LEN, recipient_pk);</code></pre>
</div>
</div>
<div class="paragraph">
<p>When looking at the
<a href="https://github.com/jedisct1/libsodium/blob/ae4add868124a32d4e54da10f9cd99240aecc0aa/src/libsodium/include/sodium/crypto_box.h#L129-L132">C signature</a>
however we notice something <em>unusual</em> for Java developers: the message length
argument is of type <code>long long</code>!</p>
</div>
<div class="paragraph">
<p>In C or C++, this declaration means the type is at least 8 bytes (64 bits),
this means a Java <code>long</code> type is what is needed.</p>
</div>
<div class="paragraph">
<p>In particular here’s a breakdown of the signed integers. It is incomplete
as they can be declared differently (eg. <code>long</code> is the same as <code>long int</code>,
or <code>long long</code> is the same as <code>long long int</code>), this <a href="https://en.wikipedia.org/wiki/C_data_types">wikipedia page</a> has a more complete overview of
C data types.</p>
</div>
<div class="paragraph">



<div class="table-wrapper">
    <table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Signed integers</caption>
<colgroup>
<col style="width: 20%;"/>
<col style="width: 80%;"/>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>int</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>A signed integer type with &#34;the natural size suggested by the
architecture of the execution environment&#34;, with a minimum of 2 byte (16 bits,
\$[-32767; +32767]\$).</p>
</div>
<div class="paragraph">
<p>On a 64bits CPU, <code>int</code> is 4bytes and the range becomes \$[-2147483647; +2147483647]\$;</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>long</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>A signed integer type that is at least so 4 bytes (\$[-2147483647; +2147483647]\$).</p>
</div>
<div class="paragraph">
<p>On a 64bits CPU, <code>long</code> is 4bytes and the range becomes \$[−9223372036854775807; +9223372036854775807]\$;</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>long long</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>A signed integer type that is at least so 8 bytes (\$[−9223372036854775807; +9223372036854775807]\$).</p>
</div>
<div class="paragraph">
<p>On a 64bits CPU, <code>long long</code> is still 8 bytes long.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="admonitionblock caution">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When you start to study these C data types a bit more, you’ll notice
two things that just don’t match with Java types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>unsigned</code> integers, while they do have the same width as their signed
counterpart, their math is different as their range is different:</p>
<div class="ulist">
<ul>
<li>
<p><code>unsigned long</code>&#39;s range is \$[0; +4294967295]\$ (on a 64 bit CPU)</p>
</li>
<li>
<p><code>unsigned long long</code>&#39;s range is \$[0; +18446744073709551615]\$ (on a 64 bit CPU)</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>long double</code>s are larger than 64 bytes, I never had to use those, but it
seems they can be as big as 128 bits (16 bytes).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As a reminder <code>size_t</code> is unsigned.</p>
</div>
</td>
</tr>
</tbody></table>
</div>

</div>

</div>
<div class="listingblock">
<div class="title">crypto_box_seal definition (.c)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">SODIUM_EXPORT
int crypto_box_seal(unsigned char *c, const unsigned char *m,
                    unsigned long long mlen, const unsigned char *pk)
            __attribute__ ((nonnull(1, 4)));</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also, for this post, and I intend to pass a short <code>String</code> message,
which is baked by a <code>char</code> array whose length can only be an <code>int</code>.</p>
</div>
<div class="listingblock">
<div class="title">crypto_box_seal (.java)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">var crypto_box_seal = CLinker.getInstance().downcallHandle(
        libsodiumLookup.lookup(&#34;crypto_box_seal&#34;).get(),
        MethodType.methodType(int.class,
                              MemoryAddress.class, // cipherText, output buffer
                              MemoryAddress.class, // message
                              long.class,          // message length
                              MemoryAddress.class  // publicKey
        ),
        FunctionDescriptor.of(C_INT,
                              C_POINTER,
                              C_POINTER,
                              C_LONG_LONG,
                              C_POINTER)

);

try (var scope = NativeScope.unboundedScope()) {
    var cipherText = scope.allocate(crypto_box_sealbytes() + message.length());
    var ret = (int) crypto_box_seal.invokeExact(
            cipherText.address(),
            CLinker.toCString(message, StandardCharsets.US_ASCII, scope).address(),
            (long) message.length(),
            scope.allocateArray(C_CHAR, publicKey).address()
    );
    return cipherText.toByteArray();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>There’s a few thing to notice :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>I am specifically passing the <code>US_ASCII</code> charset, as I now that
the byte array representation of the string will be 1 byte per <code>char</code>, implying
I can use the <code>String::length</code> method.
If the string used characters that do not fit in a single byte, I would have
needed to extract the byte array using <code>UTF-8</code> charset encoder first and use
the length of the byte array instead.</p>
</li>
<li>
<p>The <code>var ret</code> is not used, however due to the <em>dynamic</em>
nature of <code>invokeExact</code>, the compiler needs the <strong>exact</strong> signature on the
call-site, that’s why the result of this invocation is assigned to an <code>int</code>
variable even if it is not used.</p>
<div class="paragraph">
<p>Without this assignment the JVM would have raised a <code>WrongMethodTypeException</code>,
in this case the exception message helps to identify the type differences
in the signature:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">java.lang.invoke.WrongMethodTypeException: expected (MemoryAddress,MemoryAddress,long,MemoryAddress)int but found (MemoryAddress,MemoryAddress,long,MemoryAddress)void</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_ending_the_crypto_box_example"><a class="anchor" href="#_ending_the_crypto_box_example"></a><a class="link" href="#_ending_the_crypto_box_example">Ending the crypto box example</a></h3>
<div class="paragraph">
<p>The last method call of this snippet ends the libsodium <em>crypto box</em> example.
The method <code>crypto_box_seal_open</code> take pointers and a ciphered text length
so let’s apply again what has been done for <code>crypto_box_seal</code>.</p>
</div>
<div class="listingblock">
<div class="title">crypto_box_seal_open (.c)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">unsigned char decrypted[MESSAGE_LEN];
if (crypto_box_seal_open(decrypted, ciphertext, CIPHERTEXT_LEN,
    recipient_pk, recipient_sk) != 0) {
    /* message corrupted or not intended for this recipient */
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which translates to</p>
</div>
<div class="listingblock">
<div class="title">crypto_box_seal_open (.java)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">var crypto_box_seal_open = getInstance().downcallHandle(
        libsodiumLookup.lookup(&#34;crypto_box_seal_open&#34;).get(),
        MethodType.methodType(int.class,
                              MemoryAddress.class, // message
                              MemoryAddress.class, // cipherText
                              long.class,          // cipherText.length
                              MemoryAddress.class, // public key
                              MemoryAddress.class  // secret key
        ),
        FunctionDescriptor.of(C_INT,
                              C_POINTER,
                              C_POINTER,
                              C_LONG_LONG,
                              C_POINTER,
                              C_POINTER
        )
);

try (var scope = NativeScope.unboundedScope()) {
    var decipheredText = scope.allocateArray(C_CHAR, cipherText.length - crypto_box_sealbytes());
    var ret = (int) crypto_box_seal_open.invokeExact(decipheredText.address(),
                                                     scope.allocateArray(C_CHAR, cipherText).address(),
                                                     (long) cipherText.length,
                                                     scope.allocateArray(C_CHAR, publicKey).address(),
                                                     scope.allocateArray(C_CHAR, secretkey).address());

    return CLinker.toJavaString(decipheredText, StandardCharsets.US_ASCII);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Yet running this code raise an error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">java.lang.IndexOutOfBoundsException: Out of bound access on segment MemorySegment{ id=0x6f11d841 limit: 20 }; new offset = 20; new length = 1
	at jdk.incubator.foreign/jdk.internal.foreign.AbstractMemorySegmentImpl.outOfBoundException(AbstractMemorySegmentImpl.java:495)
	at jdk.incubator.foreign/jdk.internal.foreign.AbstractMemorySegmentImpl.checkBoundsSmall(AbstractMemorySegmentImpl.java:465)
	at jdk.incubator.foreign/jdk.internal.foreign.AbstractMemorySegmentImpl.checkBounds(AbstractMemorySegmentImpl.java:446)
	at jdk.incubator.foreign/jdk.internal.foreign.AbstractMemorySegmentImpl.checkAccess(AbstractMemorySegmentImpl.java:401)
	at java.base/java.lang.invoke.MemoryAccessVarHandleByteHelper.checkAddress(MemoryAccessVarHandleByteHelper.java:80)
	at java.base/java.lang.invoke.MemoryAccessVarHandleByteHelper.get(MemoryAccessVarHandleByteHelper.java:113)
	at jdk.incubator.foreign/jdk.incubator.foreign.MemoryAccess.getByteAtOffset(MemoryAccess.java:105)
	at jdk.incubator.foreign/jdk.internal.foreign.abi.SharedUtils.strlen(SharedUtils.java:259)
	at jdk.incubator.foreign/jdk.internal.foreign.abi.SharedUtils.toJavaStringInternal(SharedUtils.java:249)
	at jdk.incubator.foreign/jdk.incubator.foreign.CLinker.toJavaString(CLinker.java:342)</code></pre>
</div>
</div>
<div class="paragraph">
<p>I didn’t get why this code failed at first.</p>
</div>
<div class="paragraph">
<p><code>CLinker::toJavaString</code> is the mirror function of the <code>CLinker::toCString</code>, so it looked correct.</p>
</div>
<div class="paragraph">
<p>The exception message indicates the segment has the size 20 which is the length
of the string <code>Hello foreign code !</code>, there’s <code>new offset is 20</code> indicating the
segment was read up to the 20th byte / character, and there is the <code>new length = 1</code>,
which suggests <code>toJavaString</code> needs to read an additional character but can’t.</p>
</div>
<div class="paragraph">
<p>The javadoc of <code>toJavaString</code> says (emphasis is mine) :</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><strong>Converts a null-terminated C string</strong> stored at given address into a Java string, using the platform’s default charset.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>This immediately clicked: libsodium’s <em>message</em> does not imply it is a string.
It’s API takes a pointer to a memory region and the length to read in that memory
region. For all that matter, the message could be any binary payload.</p>
</div>
<div class="paragraph">
<p>Let’s look at the string <code>Hello</code></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Libsodium <em>seal</em> method will be passed the following byte array
<code>CLinker.toCString(&#34;Hello&#34;, StandardCharsets.US_ASCII).toByteArray()</code> ⇒ <code>48656C6C6F00</code></p>
</li>
<li>
<p>But since the code is using <code>String::length</code>, libsodium will only seal up to 5 bytes : <code>48656C6C6F</code>.</p>
</li>
<li>
<p>Then <em>opening the seal</em>, the content of the <code>MemorySegment</code> that contains the decrypted message
will be <code>48656C6C6F</code></p>
</li>
<li>
<p>But <code>CLinker.toJavaString(decipheredText, StandardCharsets.US_ASCII)</code> expects
the memory segment to be a valid C string, terminated by the <code>\0</code> character. And since
the actual decrypted memory segment is not terminated by &#39;\0&#39;, the code emit an error.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For this reason this suggests the code to use is
<code>new String(decipheredText.toByteArray(), StandardCharsets.US_ASCII)</code>. They are other
possibilities like not using the <code>CLinker::toCString</code> with the <code>crypto_box_seal</code>
method and instead, or to increment by 1 the length when <code>CLinker::toCString</code>
is passed.</p>
</div>
<div class="paragraph">
<p>For reference here are the bytes returned by <code>String::getBytes</code> and
<code>CLinker::toCString</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>&#34;Hello&#34;.getBytes(US_ASCII)</code> ⇒ <code>48656C6C6F</code></p>
</li>
<li>
<p><code>CLinker.toCString(&#34;Hello&#34;, US_ASCII).toByteArray()</code> ⇒ <code>48656C6C6F00</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For this blog post I’d like to keep the assumption the sealed message is a <code>String</code>,
which leads to the following correct code :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">try (var scope = NativeScope.unboundedScope()) {
    var decipheredText = scope.allocateArray(C_CHAR, cipherText.length - crypto_box_sealbytes());
    var ret = (int) crypto_box_seal_open.invokeExact(decipheredText.address(),
                                                     scope.allocateArray(C_CHAR, cipherText).address(),
                                                     (long) cipherText.length,
                                                     scope.allocateArray(C_CHAR, publicKey).address(),
                                                     scope.allocateArray(C_CHAR, secretkey).address());

    return new String(decipheredText.toByteArray(), StandardCharsets.US_ASCII);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also, I have intentionally left out the returned status of <code>crypto_box_seal_open</code>,
to focus on the foreign module API, but this would make sense to perform checks
on the returned value before returning the buffer as suggested on the libsodium
documentation.</p>
</div>
</div>
<div class="sect2">
<h3 id="_wrap_up_on_manually_using_the_foreign_linker_api"><a class="anchor" href="#_wrap_up_on_manually_using_the_foreign_linker_api"></a><a class="link" href="#_wrap_up_on_manually_using_the_foreign_linker_api">Wrap up on manually using the Foreign Linker API</a></h3>
<div class="paragraph">
<p>I didn’t cover everything this API has to offer, like the <em>up call</em> stubs,
which is a way to pass a function pointer to the native code, nor did I cover
the every feature of JEP-389, like <code>MemorySegment</code> or <code>MemoryLayout</code> API.</p>
</div>
<div class="paragraph">
<p>At this time I find this API a pleasure to use compared to JNI. Note that
I don’t have experience with JNA, so I may be lacking perspective there.</p>
</div>
<div class="paragraph">
<p>There’s a few pitfalls like the <code>CLinker::toJavaString</code> or the
<code>MemorySegment</code> lifecycles which get more complicated if those segments
are shared between threads. I found the API well-designed and well
documented, but if you’re novice in this area, you’ll likely need
other materials. A package wide documentation, in <code>jdk.incubator.foreign</code>,
should definitely fill this gap in my opinion.</p>
</div>
<div class="paragraph">
<p>The chosen example was concise in native code, but writing the stubs in Java
is quickly tedious and verbose. JDK developers felt the same way as they
are also investing energy on a tool named <code>jextract</code> whose goal is to reduce
the tedious work amount. I’ll show in a section below what can be done with
the current state of <code>jextract</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_remarks_about_memorysegments_memory_mapping"><a class="anchor" href="#_remarks_about_memorysegments_memory_mapping"></a><a class="link" href="#_remarks_about_memorysegments_memory_mapping">Remarks about <code>MemorySegment</code>s  memory mapping</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>MemorySegment</code> do have the same constraints as <code>DirectByteBuffer</code>s,
ie by default the size of the segment can’t size can’t go over
<code>Runtime.getRuntime().maxMemory()</code></p>
</div>
<div class="listingblock">
<div class="title">Allocating a very bigger segment than than <code>maxMemory</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Exception in thread &#34;main&#34; java.lang.OutOfMemoryError: Cannot reserve 2147483648 bytes of direct buffer memory (allocated: 8192, limit: 522190848)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This limit is configurable by setting the <code>-XX:MaxDirectMemorySize={size}</code> flag.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">var memorySegment = MemorySegment.allocateNative(nativeSegmentSize);</code></pre>
</div>
</div>
<div class="paragraph">
<p>There’s one interesting thing with this API it is possible to access the address
from the API, via <code>MemorySegment::address</code>, and one can bet the hexadecimal
representation, via <code>Long.toHexString(memorySegment.address().toRawLongValue())</code>.</p>
</div>
<div class="listingblock">
<div class="title">MemoryAddress::toString</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">MemoryAddress{ base: null offset=0x7fc513fff010 }</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you are on Linux then you use <code>pmap</code> from the <em>procps</em> package to
inspect memory mappings of the JVM.</p>
</div>
<div class="listingblock">
<div class="title">/pmap output of a 2GiB native segment</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">151:   java -Dforeign.restricted=permit --add-modules jdk.incubator.foreign -XX:MaxDirectMemorySize=2100m MemorySegments.java
Address           Kbytes     RSS   Dirty Mode  Mapping
...
0000557635ba1000       4       0       0 r-x-- java
0000557635ba3000       4       0       0 r---- java
0000557635ba4000       4       0       0 rw--- java
0000557636d4b000     132      16      16 rw---   [ anon ]
00007fc513fff000 2097156 1811456 1811456 rw---   [ anon ] <i class="conum" data-value="1"></i><b>(1)</b>
00007fc594000000     132       0       0 rw---   [ anon ]
00007fc594021000   65404       0       0 -----   [ anon ]
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is the allocated segment, 2 GiB ⇐⇒ 2097152 KiB, this segment is a bit
larger by one page (4 KiB). And in fact the base address of the segment is
<code>0x7fc513fff010</code>.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>In this case it is not related to alignment, but it may be possible. What is
important is that the address of a <code>MemorySegment</code> may be contained in a larger
memory mapping.</p>
</div>
<div class="paragraph">
<p>One important and useful distinction with <code>DirectByteBuffer</code>s is the presence
of a <code>MemorySegment::close</code> method, that will <strong>immediately free the native mapping</strong>
when called.
<code>DirectByteBuffer</code> used to be challenging because they had no explicit method
to free the native mapping, and as such had to wait for the GC to kick in
order to be freed.</p>
</div>
<div class="paragraph">
<div class="title">Initilization</div>
<p>Another thing to remind is that the memory mapping is zeroed, that means
a big segment will take a noticeable time to get initialized. As with
<code>DirectByteBuffer</code>s this pattern is interesting when inspecting off-heap memory.</p>
</div>
<div class="paragraph">
<div class="title">Scope</div>
<p>Usually it is more practical to use the <code>NativeScope</code> API as it is easier to
reason about boundaries of the involved memory mapping.
Using a larger <code>MemorySegment</code> coud be interesting when it has to be sliced and
shared among various threads. Also given the high initialization cost for large
segments it’s likely to have the same lifecycle as the application.
Typically, in a few years, Netty, Aeron, Kafka, Cassandra, …​
could make use of this API !</p>
</div>
<div class="paragraph">
<div class="title">Slices</div>
<p>One thing that caught me off-guard, is that when closing a <em>slice</em> (created by
<code>MemorySegment::asSlice</code>) also closes the underlying segment.</p>
</div>
<div class="paragraph">
<div class="title">Multiple allocations</div>
<p>Finally, when the code requires new native allocation, the JVM appears to be able to
grow native mappings. In short the JVM tries to put these segment in a bigger
memory mapping.</p>
</div>
<div class="paragraph">
<div class="title">Access modes</div>
<p>The access modes allows to define a set of <em>permissions</em> of the <code>MemorySegment</code>,
by default all permissions are given. In the example below this segment won’t
be readable by</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">var ms = MemorySegment.allocateNative(segmentSize)
                      .withAccessModes(MemorySegment.WRITE | MemorySegment.CLOSE);

ms.asByteBuffer().getLong(); <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Throws UnsupportedOperationException: Required access mode READ ; current access modes: [WRITE, CLOSE]</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>I am not quite sure how to use these at this time. It certainly would be useful
to prevent a slice from being closed though.</p>
</div>
<div class="paragraph">
<p>Also, the <code>WRITE</code> and <code>READ</code> permissions only apply to the Java object, the
native memory mapping isn’t afected, which is expected since it can hold multiple
<code>MemorySegment</code>.</p>
</div>
<div class="paragraph">
<div class="title">From a file</div>
<p>Until JEP-389, we used a <code>FileChannel</code> and a <code>MappedByteBuffer</code> to memory map a
file. The JEP-389 also take care of this use case, by using the <code>mapFile</code> factory
method.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">try (var mmaped = MemorySegment.mapFile(
    path, <i class="conum" data-value="1"></i><b>(1)</b>
    0, <i class="conum" data-value="2"></i><b>(2)</b>
    Files.size(path), <i class="conum" data-value="3"></i><b>(3)</b>
    FileChannel.MapMode.READ_ONLY <i class="conum" data-value="4"></i><b>(4)</b>
)) {
  // ...
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A path eg Path.of(&#34;…​&#34;)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The base offset</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The size of the mapping, here the complete file</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The mapping mode</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>What is really nice here is that the <code>MemorySegment</code> is also immediately freed
when the code leaves the try-with-resources block.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_jep_389_is_still_incubating"><a class="anchor" href="#_jep_389_is_still_incubating"></a><a class="link" href="#_jep_389_is_still_incubating">JEP-389 is still incubating</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>I mentioned that <code>MemorySegment</code> is implementing <code>AutoCloseable</code>, it won’t be
the case in the next JDK release.
In the same manner I mentioned <code>NativeScope</code> earlier, which is a JDK16 API, but
in the current panama state it will be replaced by a slightly different
construct.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">try (ResourceScope scope : ResourceScope.ofConfined()) {
  MemorySegment.allocateNative(layout, scope):
  MemorySegment.mapFile(… , scope);
  CLinker.upcallStub(… , scope);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Given the current state I have doubts JEP-389 will get out of incubating
for JDK 17. JEP-389 is working well, but I think the developers may need more
time to get this API right. They are doing a fantastic job in my opinion.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_jextract"><a class="anchor" href="#_jextract"></a><a class="link" href="#_jextract"><code>jextract</code></a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>jextract</code> is still being backed and was not ready to be included in JDK 16
for incubation, but since it complements JEP-389, I wanted to give
it a try and showcase its usefulness.</p>
</div>
<div class="paragraph">
<p>This tool leverages the native <code>libclang</code> and as such the <code>jdk.incubator.foreign</code>
module.</p>
</div>
<div class="paragraph">
<p>In order to be able to use it, one should download the panama jdk
here: <a href="https://jdk.java.net/panama/" class="bare">https://jdk.java.net/panama/</a>. Don’t be scared by <em>early access</em>,
JDK 17 (very early at this stage) or the other warnings, you just need
to use <code>jextract</code> not the panama jdk.</p>
</div>
<div class="paragraph">
<p>When I started to bootstrap work on JDK16 and libsodium, the built
panama JDK didn’t contain the <code>jextract</code>, as I wasn’t sure
I voiced <a href="https://twitter.com/bricedutheil/status/1361086142402199554?s=21">this on Twitter</a>,
Oracle engineers confirmed me this was a bug in the release
<a href="https://bugs.openjdk.java.net/browse/JDK-8261733">JDK-8261733</a> if this every
happen again, or you want to try the latest <code>jextract</code>, you’ll need to build
the panama JDK.</p>
</div>
<div class="admonitionblock caution">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Again the <code>jextract</code> tool is still being backed at this time.
That means it that everything below can be obsolete any time.
</td>
</tr>
</tbody></table>
</div>
<div class="sect2">
<h3 id="_extracting_java_liking_code_from_the_libsodium_headers"><a class="anchor" href="#_extracting_java_liking_code_from_the_libsodium_headers"></a><a class="link" href="#_extracting_java_liking_code_from_the_libsodium_headers">Extracting Java liking code from the Libsodium headers</a></h3>
<div class="paragraph">
<p>The first thing I need is to get the headers of libsodium, and for that
I cloned the repo. Then checked out the 1.0.18 tag as I intend to target
this released binary.</p>
</div>
<div class="listingblock">
<div class="title">Get the libsodium source</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ git clone https://github.com/jedisct1/libsodium.git
Cloning into &#39;libsodium&#39;...
remote: Enumerating objects: 151, done.
remote: Counting objects: 100% (151/151), done.
remote: Compressing objects: 100% (105/105), done.
remote: Total 32369 (delta 74), reused 86 (delta 41), pack-reused 32218
Receiving objects: 100% (32369/32369), 8.24 MiB | 10.52 MiB/s, done.
Resolving deltas: 100% (19205/19205), done.
$ git checkout 1.0.18</code></pre>
</div>
</div>
<div class="paragraph">
<p>Headers are located in this folder <code>src/libsodium/include</code>. Now let use
<code>jextract</code>.</p>
</div>
<div class="listingblock">
<div class="title">First contact with <code>jextract</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ jextract
  -d libsodium-jextract \ <i class="conum" data-value="1"></i><b>(1)</b>
  -l sodium \ <i class="conum" data-value="2"></i><b>(2)</b>
  --target-package com.github.bric3.sodium \ <i class="conum" data-value="3"></i><b>(3)</b>
  -I src/libsodium/include/ \ <i class="conum" data-value="4"></i><b>(4)</b>
  -I src/libsodium/include/sodium \ <i class="conum" data-value="4"></i><b>(4)</b>
  --filter sodium.h \ <i class="conum" data-value="5"></i><b>(5)</b>
  src/libsodium/include/sodium.h <i class="conum" data-value="6"></i><b>(6)</b>
src/libsodium/include/sodium/export.h:5:10: fatal error: &#39;stddef.h&#39; file not found</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Destination of the generated sources</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Extracts or more precisely generate sources, instead of classes</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Indicates the target package of the generated source</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Includes of the library (some files include others in the library)</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Only includes symbols from the given file, otherwise symbols of
other includes may be extracted</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The C header file</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Obviously the standard C headers are not discovered by <code>jextract</code>.
I tried to solve this by declaring the system includes in <code>/usr/include</code>
and <code>/usr/include/linux</code> (<code>/usr/include/linux/stddef.h</code>) but the error
went a bit further with <code>unknown type name &#39;size_t&#39;</code>. This is a known issue
that for some platforms jextract has issues to find the system headers
(<a href="https://bugs.openjdk.java.net/browse/JDK-8262127">JDK-8262127</a>).</p>
</div>
<div class="paragraph">
<p><code>size_t</code> is a standard C alias representing the <em>unsigned integer type</em>.
I found help in this <a href="https://www.mail-archive.com/dev@tomcat.apache.org/msg129346.html">old thread from november 2018</a>.
Instead of using the includes under <code>/usr/includes</code>, it is necessary to use
the includes of the compiler ; on my docker image they were located
here : <code>/usr/lib/gcc/x86_64-redhat-linux/8/include</code>.</p>
</div>
<div class="paragraph">
<p>Also I noticed that <code>jextract</code> generates classes first, but you can pass
a <code>--source</code> option to configure it to generate sources instead.</p>
</div>
<div class="paragraph">
<p>On the next run of <code>jextract</code> the <code>extraction</code> process stopped on
the file <code>version.h</code>.</p>
</div>
<div class="listingblock">
<div class="title">Includes the compiler headers</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ jextract \
  -d libsodium-jextract \
   -l sodium \
   --source \ <i class="conum" data-value="1"></i><b>(1)</b>
   --target-package com.github.bric3.sodium \
   -I /usr/lib/gcc/x86_64-redhat-linux/8/include \ <i class="conum" data-value="2"></i><b>(2)</b>
   -I src/libsodium/include/ \
   -I src/libsodium/include/sodium \
   --filter sodium.h \
   src/libsodium/include/sodium.h
src/libsodium/include/sodium.h:5:10: fatal error: &#39;sodium/version.h&#39; file not found</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>generates the sources</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>the compiler includes installed on this linux image</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>In the libsodium repository there’s a file named <code>version.h.in</code>,
and upon inspection of its content I noticed placeholders that suggests
a preliminary phase in the libsodium build will generate the final <code>version.h</code>.
In native sources this usually happen via a combination of <code>./autogen.sh</code>
and <code>./configure</code>.</p>
</div>
<div class="paragraph">
<p>Let’s prepare the code base.</p>
</div>
<div class="listingblock">
<div class="title">Configure libsodium codebase</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ ./autogen.sh
autoreconf: Entering directory `.&#39;
autoreconf: configure.ac: not using Gettext
autoreconf: running: aclocal --force -I m4
autoreconf: configure.ac: tracing
autoreconf: configure.ac: creating directory build-aux
autoreconf: running: libtoolize --copy --force
libtoolize: putting auxiliary files in AC_CONFIG_AUX_DIR, &#39;build-aux&#39;.
libtoolize: copying file &#39;build-aux/ltmain.sh&#39;
libtoolize: putting macros in AC_CONFIG_MACRO_DIRS, &#39;m4&#39;.
libtoolize: copying file &#39;m4/libtool.m4&#39;
libtoolize: copying file &#39;m4/ltoptions.m4&#39;
libtoolize: copying file &#39;m4/ltsugar.m4&#39;
libtoolize: copying file &#39;m4/ltversion.m4&#39;
libtoolize: copying file &#39;m4/lt~obsolete.m4&#39;
autoreconf: running: /usr/bin/autoconf --force
autoreconf: configure.ac: not using Autoheader
autoreconf: running: automake --add-missing --copy --force-missing
configure.ac:75: installing &#39;build-aux/compile&#39;
configure.ac:9: installing &#39;build-aux/config.guess&#39;
configure.ac:9: installing &#39;build-aux/config.sub&#39;
configure.ac:10: installing &#39;build-aux/install-sh&#39;
configure.ac:10: installing &#39;build-aux/missing&#39;
src/libsodium/Makefile.am: installing &#39;build-aux/depcomp&#39;
parallel-tests: installing &#39;build-aux/test-driver&#39;
autoreconf: Leaving directory `.&#39;
Downloading config.guess and config.sub...
Done.

./configure
checking build system type... x86_64-pc-linux-gnu
checking host system type... x86_64-pc-linux-gnu
checking for a BSD-compatible install... /usr/bin/install -c
checking whether build environment is sane... yes
checking for a thread-safe mkdir -p... /usr/bin/mkdir -p
checking for gawk... gawk
checking whether make sets $(MAKE)... yes
checking whether make supports nested variables... yes
checking whether UID &#39;0&#39; is supported by ustar format... yes
checking whether GID &#39;0&#39; is supported by ustar format... yes
checking how to create a ustar tar archive... gnutar
checking whether make supports nested variables... (cached) yes
checking whether to enable maintainer-specific portions of Makefiles... no
checking whether make supports the include directive... yes (GNU style)
checking for gcc... gcc
...
configure: creating ./config.status
config.status: creating Makefile
config.status: creating builds/Makefile
config.status: creating contrib/Makefile
config.status: creating dist-build/Makefile
config.status: creating libsodium.pc
config.status: creating libsodium-uninstalled.pc
config.status: creating msvc-scripts/Makefile
config.status: creating src/Makefile
config.status: creating src/libsodium/Makefile
config.status: creating src/libsodium/include/Makefile
config.status: creating src/libsodium/include/sodium/version.h <i class="conum" data-value="1"></i><b>(1)</b>
config.status: creating test/default/Makefile
config.status: creating test/Makefile
config.status: executing depfiles commands
config.status: executing libtool commands</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configuring <code>version.h</code> with version values</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Finally, this time <code>jextract</code> worked as expected.</p>
</div>
<div class="listingblock">
<div class="title">Working jextract command</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ jextract \
  -d libsodium-jextract \
   -l sodium \
   --source \
   --target-package com.github.bric3.sodium \
   -I /usr/lib/gcc/x86_64-redhat-linux/8/include \
   -I src/libsodium/include/ \
   -I src/libsodium/include/sodium \
   --filter sodium.h \
   src/libsodium/include/sodium.h</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, when I opened <code>sodium_h.java</code> it was empty.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public final class sodium_h  {

    /* package-private */ sodium_h() {}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the 1.x tree the <a href="https://github.com/jedisct1/libsodium/blob/1.0.18/src/libsodium/include/sodium.h"><code>sodium.h</code></a>
file <strong>only includes the declaration of other headers</strong>.
When I explicitly filtered on <code>sodium.h</code>, <code>jextract</code> evicted symbols
of the includes.</p>
</div>
<div class="paragraph">
<p>How to keep the declarations of the other headers ?
At this time <code>jextract</code> help is a bit vague.</p>
</div>
<div class="listingblock">
<div class="title">Jextract help</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ jextract --help
Non-option arguments:
[String] -- header file

Option                         Description
------                         -----------
-?, -h, --help                 print help
-C &lt;String&gt;                    pass through argument for clang
-I &lt;String&gt;                    specify include files path
-d &lt;String&gt;                    specify where to place generated files
--filter &lt;String&gt;              header files to filter
-l &lt;String&gt;                    specify a library
--source                       generate java sources
-t, --target-package &lt;String&gt;  target package for specified header files</code></pre>
</div>
</div>
<div class="paragraph">
<p>Looking at the <a href="https://github.com/openjdk/panama-foreign/blob/e4cd13dfc2b5a398645067bb6cb0807ad451f6df/src/jdk.incubator.jextract/share/classes/jdk/incubator/jextract/JextractTool.java#L199-L201"><code>jextract</code> source code</a> was the way to go, first the code suggests
that it’s possible to pass multiple filters (<code>--filter</code>), just like it
is possible to pass multiple include (<code>-I</code>).
Although it is not very practical with multiple values, isn’t is
possible to pass a pattern ?</p>
</div>
<div class="paragraph">
<p>This is answered here in this document
(<a href="https://github.com/openjdk/panama-foreign/blob/bedc58a3c967ea05ffdc0d5ec141e10e43faaf01/doc/panama_jextract.md">Using the <code>jextract</code> tool</a>)
or in the source code in the <a href="https://github.com/openjdk/panama-foreign/blob/e4cd13dfc2b5a398645067bb6cb0807ad451f6df/src/jdk.incubator.jextract/share/classes/jdk/internal/jextract/impl/Filter.java#L45-L50"><code>Filter</code></a> class ;
it’s possible to pass <code>--filter</code> a part of the path, the current
code will just verify if this string is contained in the header path.</p>
</div>
<div class="paragraph">
<p>Concretely I can use the string <code>sodium</code> as a filter to include headers
located in <code>include/sodium/</code> folder.</p>
</div>
<div class="listingblock">
<div class="title">Correct jextract command</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ jextract \
  -d libsodium-jextract \  <i class="conum" data-value="1"></i><b>(1)</b>
  --source \ <i class="conum" data-value="2"></i><b>(2)</b>
  --target-package com.github.bric3.sodium \ <i class="conum" data-value="3"></i><b>(3)</b>
  -l sodium \ <i class="conum" data-value="4"></i><b>(4)</b>
  -I /usr/lib/gcc/x86_64-redhat-linux/8/include \ <i class="conum" data-value="5"></i><b>(5)</b>
  -I src/libsodium/include/ \ <i class="conum" data-value="6"></i><b>(6)</b>
  -I src/libsodium/include/sodium \ <i class="conum" data-value="6"></i><b>(6)</b>
  --filter sodium \ <i class="conum" data-value="7"></i><b>(7)</b>
  src/libsodium/include/sodium.h <i class="conum" data-value="8"></i><b>(8)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Destination of the generated sources</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Extracts or more precisely generate sources, instead of classes</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Indicates the target package of the generated source</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Name without the JNI prefix and suffix (or path) of the library to load</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Includes C definitions or includes like <code>size_t</code>, <code>stddef.h</code> etc.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Includes of the library (some files include others in the library)</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Only includes symbols from the given file, otherwise symbols of
other includes may be extracted</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>The C header file</td>
</tr>
</tbody></table>
</div>
<div class="listingblock">
<div class="title">Generated files</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ ls -lh libsodium-jextract-f/com/github/bric3/sodium/
total 956K
-rw-r--r--. 1 root root  557 Feb 16 14:10 C.java
-rw-r--r--. 1 root root 8.8K Feb 16 14:10 RuntimeHelper.java
-rw-r--r--. 1 root root 350K Feb 16 14:10 sodium_h.java
-rw-r--r--. 1 root root 124K Feb 16 14:10 sodium_h_0.java
-rw-r--r--. 1 root root 329K Feb 16 14:10 sodium_h_constants_0.java
-rw-r--r--. 1 root root 131K Feb 16 14:10 sodium_h_constants_1.java</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_invoking_the_library"><a class="anchor" href="#_invoking_the_library"></a><a class="link" href="#_invoking_the_library">Invoking the library</a></h3>
<div class="paragraph">
<p>Let’s have a look at what <code>jextract</code> generated. The entry point is
the class <code>sodium_h</code>. In particular let’s compare the method stubs
to these I wrote earlier :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>crypto_box_sealbytes</code></p>
</li>
<li>
<p><code>crypto_box_keypair</code></p>
</li>
<li>
<p><code>crypto_box_seal</code></p>
</li>
<li>
<p><code>crypto_box_seal_open</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The libsodium headers declare a method named <code>crypto_box_sealbytes</code>,
whose role is to return a constant <code>crypto_box_SEALBYTES</code>, however
this constant is defined as a C preprocessor directive <code>#DEFINE</code>,
which is not visible as a symbol when performing a <em>library lookup</em>.
The native <code>crypto_box_sealbytes</code> method compensates this limitation.</p>
</div>
<div class="paragraph">
<p><code>jextract</code> is however reading the headers, in doing so it actually extracts
the constant <code>crypto_box_SEALBYTES</code>. It is still exposed as method,
and it is declared in a different class <code>sodium_h_0#crypto_box_SEALBYTES</code>.</p>
</div>
<div class="paragraph">
<p>Note that <code>sodium_h</code> extends <code>sodium_h_0</code>, so one will write</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">sodium_h.crypto_box_SEALBYTES()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Behind the scene this call invokes <code>sodium_h_constants_1#crypto_box_SEALBYTES</code>,
and for <code>sodium_h</code> this split in two classes due to the class limits.
<code>sodium_h_constants_1</code> extends <code>sodium_h_constants_0</code>.</p>
</div>
<div class="sect3">
<h4 id="_first_hiccup"><a class="anchor" href="#_first_hiccup"></a><a class="link" href="#_first_hiccup">First hiccup</a></h4>
<div class="paragraph">
<p>When I accessed this constant for the first time, I got this
error :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">java.lang.ExceptionInInitializerError
	at com.github.bric3.sodium.sodium_h_0.crypto_box_PUBLICKEYBYTES(sodium_h_0.java:1511)
	at com.github.bric3.sodium.Libsodium$JextractedLibsodium.crypto_box_keypair(Libsodium.java:263)
	at com.github.bric3.sodium.LibsodiumTest.can_invoke_crypto_box_keypair(LibsodiumTest.java:44)

Caused by: java.lang.IllegalArgumentException: Library not found: sodium
	at jdk.incubator.foreign/jdk.internal.foreign.LibrariesHelper.lookup(LibrariesHelper.java:94)
	at jdk.incubator.foreign/jdk.internal.foreign.LibrariesHelper.loadLibrary(LibrariesHelper.java:60)
	at jdk.incubator.foreign/jdk.incubator.foreign.LibraryLookup.ofLibrary(LibraryLookup.java:150)
	at com.github.bric3.sodium.RuntimeHelper.lambda$libraries$0(RuntimeHelper.java:46)
	at com.github.bric3.sodium.RuntimeHelper.libraries(RuntimeHelper.java:49)
	at com.github.bric3.sodium.sodium_h_constants_0.&lt;clinit&gt;(sodium_h_constants_0.java:14)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The stacktrace points to this code:</p>
</div>
<div class="listingblock">
<div class="title">sodium_h_constants_0.LIBRARIES</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">static final LibraryLookup[] LIBRARIES = RuntimeHelper.libraries(new String[] {
    &#34;sodium&#34;, <i class="conum" data-value="1"></i><b>(1)</b>
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is the value I passed to the <code>jextract</code> command.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p><code>RuntimeHelper::libraries</code> can load a library from a name (using JNI conventions,
<a href="https://github.com/openjdk/jdk16u/blob/1cc98bde6703d330b07ae873770df2c369b47eb2/src/hotspot/os/posix/include/jvm_md.h#L47-L55"><code>JNI_LIB_PREFIX</code> and <code>JNI_LIB_PREFIX</code></a>)
or a path.</p>
</div>
<div class="paragraph">
<p>The value above is the value I used in the <code>-l sodium</code> option of <code>jextract</code>,
yet this value here is obviously incorrect for my use case.</p>
</div>
<div class="paragraph">
<div class="title">Work around 1: with <code>jextract</code></div>
<p>It is not yet clear, in the <code>jextract</code> usage description at this time,
but one can pass to the <code>-l</code> option</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A library name, which has to be available on one of the paths declared in the
JVM system property <code>java.library.path</code></p>
<div class="exampleblock">
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">linux</dt>
<dd>
<p><code>/usr/java/packages/lib:/usr/lib64:/lib64:/lib:/usr/lib</code></p>
</dd>
<dt class="hdlist1">macOs</dt>
<dd>
<p><code>/Users/bric3/Library/Java/Extensions:/Library/Java/Extensions:/Network/Library/Java/Extensions:/System/Library/Java/Extensions:/usr/lib/java:.</code></p>
</dd>
</dl>
</div>
</div>
</div>
<div class="paragraph">
<p>The library must conform to JNI conventions, <code>libsodium.23.dylib</code> or <code>libtasn1.so.6.5.5</code>
won’t work as they contain version numbers.</p>
</div>
</li>
<li>
<p>Or an absolute path eg <code>/usr/local/opt/libsodium/lib/libsodium.23.dylib</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>However, the actual library path is dependent on the system, on the library
version and on the installation mechanism. I could have used <code>jextract</code>
with <code>-l /usr/local/opt/libsodium/lib/libsodium.23.dylib</code>, but then the generated
code can not run on Linux without modifications, etc.</p>
</div>
<div class="paragraph">
<p>My final objective for this code is to declare the libsodium bindings in java,
and link with the actual libsodium on the platform macOs or Linux.</p>
</div>
<div class="paragraph">
<div class="title">Work-around 2: Modify generated code</div>
<p><code>LIBRARIES</code> is a static final variable that is used by other static variables
in the same class. While it is possible to edit the <code>sodium_h_constants_0</code>
class, it is still difficult to make this <code>LibraryLookup</code> code configurable
without a significant refactoring.</p>
</div>
<div class="paragraph">
<p>Oracle engineers are aware of this problem <a href="https://bugs.openjdk.java.net/browse/JDK-8262126">JDK-8262126</a>,
so we might see it fixed in the final JEP-389 release.</p>
</div>
<div class="paragraph">
<p>For this article the easiest solution, is to declare the local libsodium path
in the code, as I did in the first section of this blog.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">static final LibraryLookup[] LIBRARIES = RuntimeHelper.libraries(new String[] {
    &#34;/usr/local/opt/libsodium/lib/libsodium.23.dylib&#34;
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the end I’ll rework this initialization later though with custom code
to find the actual libsodium on the current platform.</p>
</div>
</div>
<div class="sect3">
<h4 id="_now_implementing_the_other_functions"><a class="anchor" href="#_now_implementing_the_other_functions"></a><a class="link" href="#_now_implementing_the_other_functions">Now implementing the other functions</a></h4>
<div class="paragraph">
<p>Now let’s profit from the generated function call, in the same order
I’d like to use <code>crypto_box_keypair</code>, this is straightforward.
The arguments are still <em>carrier</em> type like <code>MemorySegment</code>,
which means we still need to take care of the scope / lifecycle of
these allocations.</p>
</div>
<div class="listingblock">
<div class="title">crypto_box_keypair</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">try (var scope = NativeScope.unboundedScope()) {
    var recipientPublicKey = scope.allocate(sodium_h.crypto_box_PUBLICKEYBYTES());
    var recipientSecretKey = scope.allocate(sodium_h.crypto_box_SECRETKEYBYTES());
    sodium_h.crypto_box_keypair(recipientPublicKey, recipientSecretKey); <i class="conum" data-value="1"></i><b>(1)</b>
    return new CryptoBoxKeyPair(
            recipientPublicKey.toByteArray(),
            recipientSecretKey.toByteArray()
    );
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>the <em>jextracted</em> method</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The IDE might suggest a method named <code>crypto_box_keypair$MH</code> ; the suffix
<code>$MH</code> simply indicates this returns the <strong>M</strong>ethod <strong>H</strong>andle for this native
method which is basically what I showed in the first part of this blog post.</p>
</div>
<div class="paragraph">
<p>As reflex, I always like to navigate the code I’m invoking.
The method we are invoking are just the public API methods, checking null,
and declaring a correct callsite (correct return type, correct argument types).</p>
</div>
<div class="listingblock">
<div class="title">sodium_h.crypto_box_keypair</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public static  MethodHandle crypto_box_keypair$MH() {
    return RuntimeHelper.requireNonNull(sodium_h_constants_0.crypto_box_keypair$MH(),
                                        &#34;unresolved symbol: crypto_box_keypair&#34;);
}
public static int crypto_box_keypair ( Addressable pk,  Addressable sk) {
    var mh$ = RuntimeHelper.requireNonNull(sodium_h_constants_0.crypto_box_keypair$MH(),
                                           &#34;unresolved symbol: crypto_box_keypair&#34;);
    try {
        return (int)mh$.invokeExact(pk.address(), sk.address());
    } catch (Throwable ex$) {
        throw new AssertionError(&#34;should not reach here&#34;, ex$);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Going further down to see how the <code>MethodHandle</code> is declared:</p>
</div>
<div class="listingblock">
<div class="title">sodium_h_constants_0.crypto_box_keypair$MH</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">static final FunctionDescriptor crypto_box_keypair$FUNC_ = FunctionDescriptor.of(
    C_INT,
    C_POINTER,
    C_POINTER
);

static final MethodHandle crypto_box_keypair$MH_ = RuntimeHelper.downcallHandle(
    LIBRARIES,
    &#34;crypto_box_keypair&#34;,
    &#34;(Ljdk/incubator/foreign/MemoryAddress;Ljdk/incubator/foreign/MemoryAddress;)I&#34;, <i class="conum" data-value="1"></i><b>(1)</b>
    crypto_box_keypair$FUNC_, false
);
static final java.lang.invoke.MethodHandle crypto_box_keypair$MH() { return crypto_box_keypair$MH_; }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Note that the Java method signature is declared with a String instead
of the Java API <code>MethodType</code>.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>This code invokes creates the down-call stub, the only difference with the
handcrafted handle in the section above, is the signature of the method declared
as a <code>String</code>.</p>
</div>
<div class="ulist">
<div class="title"><code>(Ljdk/incubator/foreign/MemoryAddress;Ljdk/incubator/foreign/MemoryAddress;)I</code> breakdown</div>
<ul>
<li>
<p><code>Ljdk/incubator/foreign/MemoryAddress</code> ⇒ arg0</p>
</li>
<li>
<p><code>Ljdk/incubator/foreign/MemoryAddress</code> ⇒ arg1</p>
</li>
<li>
<p><code>I</code> ⇒ <code>int</code> return type</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The other two methods in this example  <code>crypto_box_seal</code> and <code>crypto_box_seal_open</code>
are similar and don’t require to do the tedious handle declaration.</p>
</div>
<div class="paragraph">
<p>This type raised a few questions about how to map them in Java in the first section
where I used manually <code>jdk.incubator.foreign</code>. Also there’s statement at this time
about <code>jextract</code> not supporting some wide types.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="ulist">
<ul>
<li>
<p>jextract does not support certain C types bigger than 64 bits (e.g. <code>long double</code>).</p>
</li>
</ul>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>How does it handle these unsupported types, the answer is in the source code.</p>
</div>
<div class="paragraph">
<p>In here we learn that unsigned types are represented with their signed counterpart and
the types wider than 64 bits are represented with a specific <em>unsupported</em> layout
during headers processing. The symbols with unsupported layouts won’t be generated
as the JEP-389 linker won’t be able to link them.</p>
</div>
<details>
<summary class="title">Some details on how <code>jextract</code>&#39;s primitive types handling</summary>
<div class="content">
<div class="paragraph">
<p>The enum below in jextract show how native primitive types are mapped to their
respective memory layout whether they are supported of not.</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/openjdk/panama-foreign/blob/bedc58a3c967ea05ffdc0d5ec141e10e43faaf01/src/jdk.incubator.jextract/share/classes/jdk/incubator/jextract/Type.java">Type.Primitive.Kind</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">enum Kind {
    /**
     * {@code void} type.
     */
    Void(&#34;void&#34;, null),
    /**
     * {@code Bool} type.
     */
    Bool(&#34;_Bool&#34;, CLinker.C_CHAR),
    /**
     * {@code char} type.
     */
    Char(&#34;char&#34;, CLinker.C_CHAR),
    /**
     * {@code char16} type.
     */
    Char16(&#34;char16&#34;, UnsupportedLayouts.CHAR16),
    /**
     * {@code short} type.
     */
    Short(&#34;short&#34;, CLinker.C_SHORT),
    /**
     * {@code int} type.
     */
    Int(&#34;int&#34;, CLinker.C_INT),
    /**
     * {@code long} type.
     */
    Long(&#34;long&#34;, CLinker.C_LONG),
    /**
     * {@code long long} type.
     */
    LongLong(&#34;long long&#34;, CLinker.C_LONG_LONG),
    /**
     * {@code int128} type.
     */
    Int128(&#34;__int128&#34;, UnsupportedLayouts.__INT128),
    /**
     * {@code float} type.
     */
    Float(&#34;float&#34;, CLinker.C_FLOAT),
    /**
     * {@code double} type.
     */
    Double(&#34;double&#34;,CLinker.C_DOUBLE),
    /**
      * {@code long double} type.
      */
    LongDouble(&#34;long double&#34;, UnsupportedLayouts.LONG_DOUBLE),
    /**
     * {@code float128} type.
     */
    Float128(&#34;float128&#34;, UnsupportedLayouts._FLOAT128),
    /**
     * {@code float16} type.
     */
    HalfFloat(&#34;__fp16&#34;, UnsupportedLayouts.__FP16),
    /**
     * {@code wchar} type.
     */
    WChar(&#34;wchar_t&#34;, UnsupportedLayouts.WCHAR_T);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Those types can be <em>qualified</em>, in particular integer types can be unsigned:</p>
</div>
<div class="listingblock">
<div class="title">jdk.internal.jextract.impl.TypeMaker#makeTypeInternal</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">case UShort: {
    Type chType = Type.primitive(Primitive.Kind.Short);
    return Type.qualified(Delegated.Kind.UNSIGNED, chType);
}
case UInt: {
    Type chType = Type.primitive(Primitive.Kind.Int);
    return Type.qualified(Delegated.Kind.UNSIGNED, chType);
}
case ULong: {
    Type chType = Type.primitive(Primitive.Kind.Long);
    return Type.qualified(Delegated.Kind.UNSIGNED, chType);
}
case ULongLong: {
    Type chType = Type.primitive(Primitive.Kind.LongLong);
    return Type.qualified(Delegated.Kind.UNSIGNED, chType);
}
case UChar: {
    Type chType = Type.primitive(Primitive.Kind.Char);
    return Type.qualified(Delegated.Kind.UNSIGNED, chType);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Going further we can see that signed and unsigned integers use the same
memory layout, eg. <code>long long</code> and <code>unsigned long long</code> use the same layout
<code>C_LONG_LONG</code>.</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/openjdk/panama-foreign/blob/6aafbbbeeb59050f79d82f4d7cec85011e99f6bb/src/jdk.incubator.jextract/share/classes/jdk/internal/jextract/impl/LayoutUtils.java">LayoutUtils.getLayout</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public static MemoryLayout getLayout(Type t) {
    Supplier&lt;UnsupportedOperationException&gt; unsupported = () -&gt;
            new UnsupportedOperationException(&#34;unsupported: &#34; + t.kind());
    switch(t.kind()) {
        case UChar, Char_U:
        case SChar, Char_S:
            return Primitive.Kind.Char.layout().orElseThrow(unsupported);
        case Short:
        case UShort:
            return Primitive.Kind.Short.layout().orElseThrow(unsupported);
        case Int:
        case UInt:
            return Primitive.Kind.Int.layout().orElseThrow(unsupported);
        case ULong:
        case Long:
            return Primitive.Kind.Long.layout().orElseThrow(unsupported);
        case ULongLong:
        case LongLong:
            return Primitive.Kind.LongLong.layout().orElseThrow(unsupported); <i class="conum" data-value="1"></i><b>(1)</b>
        case UInt128:
        case Int128:
            return Primitive.Kind.Int128.layout().orElseThrow(unsupported); <i class="conum" data-value="2"></i><b>(2)</b>
        case Enum:
            return valueLayoutForSize(t.size() * 8).layout().orElseThrow(unsupported);
        case Bool:
            return Primitive.Kind.Bool.layout().orElseThrow(unsupported);
        case Float:
            return Primitive.Kind.Float.layout().orElseThrow(unsupported);
        case Double:
            return Primitive.Kind.Double.layout().orElseThrow(unsupported);
        case LongDouble:
            return Primitive.Kind.LongDouble.layout().orElseThrow(unsupported);
        case Complex:
            throw new UnsupportedOperationException(&#34;unsupported: &#34; + t.kind());
        case Record:
            return getRecordLayout(t);
        case Vector:
            return MemoryLayout.ofSequence(t.getNumberOfElements(), getLayout(t.getElementType()));
        case ConstantArray:
            return MemoryLayout.ofSequence(t.getNumberOfElements(), getLayout(t.getElementType()));
        case IncompleteArray:
            return MemoryLayout.ofSequence(getLayout(t.getElementType()));
        case Unexposed:
            Type canonical = t.canonicalType();
            if (canonical.equalType(t)) {
                throw new TypeMaker.TypeException(&#34;Unknown type with same canonical type: &#34; + t.spelling());
            }
            return getLayout(canonical);
        case Typedef:
        case Elaborated:
            return getLayout(t.canonicalType());
        case Pointer:
        case BlockPointer:
            return C_POINTER;
        default:
            throw new UnsupportedOperationException(&#34;unsupported: &#34; + t.kind());
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>C_LONG_LONG</code> will be used for both <code>long long</code> and <code>unsigned long long</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Native types longer than 64 bits are still represented internally by jextract.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>jextract identify unsupported types, and represents them correctly during the C
header processing. But the symbols that use them will be skipped during the
Java generation.</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/openjdk/panama-foreign/blob/1af1f2558760f8177b807d96582546a027959cbd/src/jdk.incubator.jextract/share/classes/jdk/internal/jextract/impl/UnsupportedLayouts.java">jdk.internal.jextract.impl.UnsupportedLayouts</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">private static final String ATTR_LAYOUT_KIND = &#34;jextract.abi.unsupported.layout.kind&#34;;

public static final ValueLayout __INT128 = MemoryLayout.ofValueBits(128, ByteOrder.nativeOrder()).
        withAttribute(ATTR_LAYOUT_KIND, &#34;__int128&#34;);

public static final ValueLayout LONG_DOUBLE = MemoryLayout.ofValueBits(128, ByteOrder.nativeOrder()).
        withAttribute(ATTR_LAYOUT_KIND, &#34;long double&#34;);

public static final ValueLayout _FLOAT128 = MemoryLayout.ofValueBits(128, ByteOrder.nativeOrder()).
        withAttribute(ATTR_LAYOUT_KIND, &#34;_float128&#34;);

public static final ValueLayout __FP16 = MemoryLayout.ofValueBits(16, ByteOrder.nativeOrder()).
        withAttribute(ATTR_LAYOUT_KIND, &#34;__fp16&#34;);

public static final ValueLayout CHAR16 = MemoryLayout.ofValueBits(16, ByteOrder.nativeOrder()).
        withAttribute(ATTR_LAYOUT_KIND, &#34;char16&#34;);

public static final ValueLayout WCHAR_T = MemoryLayout.ofValueBits(16, ByteOrder.nativeOrder()).
        withAttribute(ATTR_LAYOUT_KIND, &#34;wchar_t&#34;);

static boolean isUnsupported(MemoryLayout vl) { <i class="conum" data-value="1"></i><b>(1)</b>
    return vl.attribute(ATTR_LAYOUT_KIND).isPresent();
}

static String getUnsupportedTypeName(MemoryLayout vl) {
    return (String)
            vl.attribute(ATTR_LAYOUT_KIND).orElseThrow(IllegalArgumentException::new);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Invoked during java representation generation.</td>
</tr>
</tbody></table>
</div>
</div>
</details>
</div>
</div>
<div class="sect2">
<h3 id="_wrapping_up_on_jextract"><a class="anchor" href="#_wrapping_up_on_jextract"></a><a class="link" href="#_wrapping_up_on_jextract">Wrapping up on <code>jextract</code></a></h3>
<div class="paragraph">
<p>In the end <code>jextract</code> is useful but there’s a few little hiccups along the way.
The generated code is currently lacking in some usability. Also, the generated
code is a tad verbose, I would wish a way to eliminate some unneeded generated
methods. Using <code>jextract</code> is a bit obscure as well, and they are a few pitfalls
there too, and may require peeking at the <code>jdk.incubating.jextract</code> source code
(in the panama repository).</p>
</div>
<div class="paragraph">
<p>While I mention these point, this should not diminish the work done on this tool
and what this tool could become. When ready, this could be leveraged by Gradle,
or Jetbrains IntelliJ IDEA, etc.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_closing_words"><a class="anchor" href="#_closing_words"></a><a class="link" href="#_closing_words">Closing words</a></h2>
<div class="sectionbody">
<div class="paragraph">
<div class="title">Cool part</div>
<p>In JDK16 the foreign module is really easy to use albeit <code>javac</code> and <code>java</code>
command line requirement. The API is well-designed and easy to use.
I also appreciated the idea of scoped segments, a bit like what was
implemented in the Rust language. There’s also the coolness of being able
to free memory segment at will, without depending on the GC.</p>
</div>
<div class="paragraph">
<div class="title">Sad part</div>
<p>This is the third incubator and there’s still planned API. Some of this
blog post content will eventually become incorrect when JDK17 comes out.
<code>jextract</code> looks like a very practical tool, yet it is still
being <em>cooked</em>.</p>
</div>
<div class="paragraph">
<div class="title">Overall</div>
<p>JEP-389 looks like solid replacement of JNI or JNA. I can only applaud the work
done! My only regret is it’s not yet <em>already</em> available. That said as a
developer I support the idea to not ship until ready.</p>
</div>
<hr/>
<div class="ulist">
<div class="title">Sources in no particular order</div>
<ul>
<li>
<p><a href="https://openjdk.java.net/jeps/389" class="bare">https://openjdk.java.net/jeps/389</a></p>
</li>
<li>
<p><a href="https://mail.openjdk.java.net/pipermail/panama-dev/" class="bare">https://mail.openjdk.java.net/pipermail/panama-dev/</a></p>
</li>
<li>
<p><a href="https://cr.openjdk.java.net/~mcimadamore/panama/ffi.html" class="bare">https://cr.openjdk.java.net/~mcimadamore/panama/ffi.html</a></p>
</li>
<li>
<p><a href="https://inside.java/2020/10/06/jextract/" class="bare">https://inside.java/2020/10/06/jextract/</a></p>
</li>
<li>
<p><a href="https://jdk.java.net/panama/" class="bare">https://jdk.java.net/panama/</a></p>
</li>
<li>
<p><a href="https://github.com/sundararajana/panama-jextract-samples/" class="bare">https://github.com/sundararajana/panama-jextract-samples/</a></p>
</li>
<li>
<p><a href="https://github.com/openjdk/panama-foreign" class="bare">https://github.com/openjdk/panama-foreign</a></p>
</li>
<li>
<p><a href="https://github.com/jedisct1/libsodium" class="bare">https://github.com/jedisct1/libsodium</a></p>
</li>
<li>
<p><a href="https://doc.libsodium.org/installation" class="bare">https://doc.libsodium.org/installation</a></p>
</li>
<li>
<p><a href="https://inside.java/2021/01/25/memory-access-pulling-all-the-threads/" class="bare">https://inside.java/2021/01/25/memory-access-pulling-all-the-threads/</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You might also be interested in these two podcasts (thanks to <a href="https://twitter.com/delabassee">David Delabassée</a>)</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://inside.java/2020/12/11/podcast-009/">The Foreign Memory Access API</a></p>
</li>
<li>
<p><a href="https://inside.java/2020/12/21/podcast-010/">The Foreign Linker API</a></p>
</li>
</ul>
</div>
</div>
</div>

  </div>
  

<div class="navigation navigation-single">
    
    <a href="/2020/12/11/completablefuture-with-burstable-pods/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">Anonymous CompletableFuture threads with burstable pods</span>
    </a>
    
    
</div>


  

  <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
        
        
        
        this.page.identifier = 'https://blog.arkey.fr/2021/02/20/a-practical-look-at-jep-389-in-jdk16-with-libsodium/';
        this.page.title = 'A practical look at JEP-389 in JDK16 with libsodium';
        this.page.url = 'https://blog.arkey.fr/2021/02/20/a-practical-look-at-jep-389-in-jdk16-with-libsodium/';
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "thecoffeeworkshop" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</article>


            
    
<footer>

 
 
 <div class="github-edit">
     <a href="https://github.com/bric3/bric3.github.io/edit/hugo-sources/content/posts/2021-02-20-a-practical-look-at-jep-389-with-jdk16.adoc">
     <i class="fab fa-github fa-lg" aria-hidden="true"></i> Edit this page
     </a>
 </div>
 




















<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: { inlineMath: [["\\(", "\\)"]], displayMath: [["\\[", "\\]"]], ignoreClass: "nostem|nolatexmath" },
  asciimath2jax: { delimiters: [["\\$", "\\$"]], ignoreClass: "nostem|noasciimath" },
  TeX: { equationNumbers: { autoNumber: "none" } }
})
MathJax.Hub.Register.StartupHook("AsciiMath Jax Ready", function () {
  MathJax.InputJax.AsciiMath.postfilterHooks.Add(function (data, node) {
    if ((node = data.script.parentNode) && (node = node.parentNode) && node.classList.contains("stemblock")) {
      data.math.root.display = "block"
    }
    return data
  })
})
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js" integrity="sha512-M36RUChWzAh1veeenRZFql7HydLEnkYmoloiCvVrhz402UZgKI93qkV7SsaxtVKdN95Wzajh39ysrXCq34NTsg==" crossorigin="anonymous"></script>
<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/config/TeX-MML-AM_HTMLorMML-full.min.js" integrity="sha512-SdNVJmCczXFqz3Iok8gP+cloe2CScrnHJczMBwL+aSrdZVllRNqRJ5A2p83S4fUM8I4endIZgM2ZIkwNqb3Eew==" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.4.1/highlight.min.js" integrity="sha512-DrpaExP2d7RJqNhXB41Q/zzzQrtb6J0zfnXD5XeVEWE8d9Hj54irCLj6dRS3eNepPja7DvKcV+9PnHC7A/g83A==" crossorigin="anonymous"></script>
    <script type="text/javascript">
        
        hljs.initHighlightingOnLoad();
    </script>
    

<script src="https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js" integrity="sha256-vrn14y7WH7zgEElyQqm2uCGSQrX/xjYDjniRUQx3NyU=" crossorigin="anonymous"></script>
<script type="text/javascript">
function addBlockSwitches() {
	$('.primary').each(function() {
		primary = $(this);
		createSwitchItem(primary, createBlockSwitch(primary)).item.addClass("selected");
		primary.children('.title').remove();
	});
	$('.secondary').each(function(idx, node) {
		secondary = $(node);
		primary = findPrimary(secondary);
		switchItem = createSwitchItem(secondary, primary.children('.switch'));
		switchItem.content.addClass('hidden');
		findPrimary(secondary).append(switchItem.content);
		secondary.remove();
	});
}

function createBlockSwitch(primary) {
	blockSwitch = $('<div class="switch"></div>');
	primary.prepend(blockSwitch);
	return blockSwitch;
}

function findPrimary(secondary) {
	candidate = secondary.prev();
	while (!candidate.is('.primary')) {
		candidate = candidate.prev();
	}
	return candidate;
}

function createSwitchItem(block, blockSwitch) {
	blockName = block.children('.title').text();
	content = block.children('.content').first().append(block.next('.colist'));
	item = $('<div class="switch--item">' + blockName + '</div>');
	blockSwitch.append(item);
	return {'item': item, 'content': content};
}

function globalSwitch() {
	$('.switch--item').each(function() {
		var blockId = blockIdForSwitchItem($(this));
		$(this).off('click');
		$(this).on('click', function() {
			selectedText = $(this).text()
			window.localStorage.setItem(blockId, selectedText);
			$(".switch--item").filter(function() {
				return blockIdForSwitchItem($(this)) === blockId;
			}).filter(function() {
				return $(this).text() === selectedText;
			}).each(function() {
				select($(this))
			});
		});
		if ($(this).text() === window.localStorage.getItem(blockId)) {
			select($(this))
		}
	});
}

function blockIdForSwitchItem(item) {
	idComponents = []
	idComponents.push(item.text().toLowerCase());
	item.siblings(".switch--item").each(function(index, sibling) {
		idComponents.push($(sibling).text().toLowerCase());
	});
	return idComponents.sort().join("-")
}

function select(selected) {
	selected.addClass('selected');
	selected.siblings().removeClass('selected');
	selectedContent = selected.parent().siblings(".content").eq(selected.index())
	selectedContent.removeClass('hidden');
	selectedContent.siblings().addClass('hidden');
}

$(addBlockSwitches);
$(globalSwitch);
</script>





</footer>

    



        </div>
    </body>
</html>

