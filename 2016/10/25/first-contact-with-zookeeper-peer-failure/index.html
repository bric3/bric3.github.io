<!DOCTYPE html>
<html lang="en-US">
    
    


    <head>
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="https://www.gravatar.com">
    <link rel="dns-prefetch" href="https://giscus.app">

    <link href="https://gmpg.org/xfn/11" rel="profile">
    
    <link rel="canonical" href="https://blog.arkey.fr/2016/10/25/first-contact-with-zookeeper-peer-failure/">
    

    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<meta name="color-scheme" content="light dark">
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.155.3">

    
    
    

<title>Premier contact avec la perte d&amp;rsquo;instances Zookeeper • Brice Dutheil</title>













    
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Brice Dutheil">
<meta property="og:title" content="Premier contact avec la perte d&rsquo;instances Zookeeper">
<meta property="og:type" content="website">
<meta property="og:url" content="https://blog.arkey.fr/2016/10/25/first-contact-with-zookeeper-peer-failure/" />
<meta property="og:description" content="Java mostly, and general tech">
<meta property="og:image" content="https://blog.arkey.fr/social-sharing.png">
<meta property="og:image:type" content="image/png">
    
    
    
<meta property="og:image:width" content="512">
<meta property="og:image:height" content="512">
    

<meta property="og:updated_time" content="2016-10-25T00:00:00Z">



<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@BriceDutheil">
<meta name="twitter:title" content="Premier contact avec la perte d&rsquo;instances Zookeeper">

<meta name="twitter:image" content="https://blog.arkey.fr/social-sharing.png">

<meta name="twitter:description" content="Java mostly, and general tech">
<meta name="twitter:creator" content="@BriceDutheil">
    
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/a11y-light.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" media="(prefers-color-scheme: light)"><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/base16/gruvbox-dark-medium.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" media="(prefers-color-scheme: dark)">




<link rel="stylesheet" href="/scss/ascii-press.70f0dc6b0ba925a67d364f994bc556045605a427853874a5d71b04c9e8a989af.css" integrity="sha256-cPDcawupJaZ9Nk&#43;ZS8VWBFYFpCeFOHSl1xsEyeipia8=">


<link rel="stylesheet" href="/scss/ascii-press-dark.287256807294d72877e7d6ad2033ee800b6be06de5803c28476f7543c051a8bd.css" integrity="sha256-KHJWgHKU1yh359atIDPugAtr4G3lgDwoR291Q8BRqL0=" media="(prefers-color-scheme: dark)">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">




<link rel="stylesheet" href="/scss/hugo-toc.f44dcd620647796a2cf99d68a804ad4b52dacfcf98383c8344d085949175d65e.css" integrity="sha256-9E3NYgZHeWos&#43;Z1oqAStS1Laz8&#43;YODyDRNCFlJF11l4=">




    <!-- Icons from https://realfavicongenerator.net -->
<link rel="icon" href="/favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="196x196" href="/favicon-196x196.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<meta name="msapplication-TileColor" content="#b64f4f">
<meta name="theme-color" content="#b64f4f">



    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/v4-shims.min.css" integrity="sha512-7LGn7K+dj+CdmuqnrbIF/57brSK+L1DGyHMgby+dTT5n3Y6Bgmy/MmwHdaFRgLfLr6vwBA2yHplAutXldP8qAQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    
    

</head>


    <body class="">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="https://blog.arkey.fr/">Brice Dutheil</a>
      </span>
      
      
        <div class="author-image">
          <img src="https://www.gravatar.com/avatar/f31c7fbcbb0766d0632d96fd7e74b649?s=240&d=mp" class="img--circle img--headshot element--center" alt="gravatar">
        </div>
      
      <p class="site__description">
         Java mostly, and general tech 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">Brice Dutheil</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/"><span class='fa-icon'><i class='fas fa-home'></i></span><code>cd <em>~</em></code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/posts/"><span class='fa-icon'><i class='fas fa-stream'></i></span><code>ls <em>posts/*</em></code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/series/"><span class='fa-icon'><i class='fas fa-list-alt'></i></span><code>grep -o <em>series</em> posts/* | sort -u</code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/tags/"><span class='fa-icon'><i class='fas fa-tags'></i></span><code>grep -o <em>tags</em> posts/* | sort -u</code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/cool-stuff/"><span class='fa-icon'><i class='fas fa-thumbtack'></i></span><code>cd <em>cool-stuff</em></code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/whoami/"><span class='fa-icon'><i class='fas fa-id-card'></i></span><code>whoami</code>
						<span></span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://bsky.app/profile/bricedutheil.bsky.social" rel="me"><i class="fa-w-16" aria-hidden="true"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="bluesky" class="svg-inline--fa fa-bluesky fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2026 Fonticons, Inc. --><path fill="currentColor" d="M351.8 287C349.2 286.6 346.5 286.3 343.8 285.9C346.6 286.2 349.2 286.6 351.8 287zM256 232.9C236.7 192.3 178.3 116.7 125.5 79.4C74.9 43.7 55.6 50 43.1 55.6C28.2 62.2 25.6 84.7 25.6 98C25.6 111.1 32.9 206.4 37.6 222.3C53.2 274.9 108.9 292.6 160.2 286.9C162.8 286.5 165.4 286.2 168.2 285.8C165.5 286.2 162.9 286.6 160.2 286.9C85 297.8 18.3 325.4 105.8 422.8C202.1 522.5 237.7 401.4 256 340.1C274.3 401.4 295.4 518 404.5 422.8C486.4 340.1 427.0 298 351.8 286.9C349.2 286.5 346.5 286.2 343.8 285.8C346.6 286.1 349.2 286.6 351.8 286.9C403.1 292.6 458.7 274.9 474.4 222.3C479.1 206.4 486.4 111.2 486.4 98C486.4 84.6 483.8 62.2 468.9 55.6C457.5 50 438.1 43.7 386.6 79.4C333.7 116.7 275.3 192.3 256 232.9z"/></svg></i></a>
	
	
	<a href="https://mastodon.xyz/@BriceDutheil" rel="me"><i class="fa-w-16" aria-hidden="true"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="jumbo" class="svg-inline--fa fa-jumbo fa-w-18" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Pro 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path fill="currentColor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg></i></a>
	
	
	<a href="https://github.com/bric3" rel="me"><i class="fab fa-github" aria-hidden="true"></i></a>
	
	
	<a href="https://speakerdeck.com/bric3" rel="me"><i class="fab fa-speaker-deck" aria-hidden="true"></i></a>
	
	
	<a href="https://twitter.com/BriceDutheil" rel="me"><i class="fa-w-16" aria-hidden="true"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="bird" class="svg-inline--fa fa-bird fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Pro 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></i></a>
	
	
	
	
	
	
	
	
	<a href="https://linkedin.com/in/dutheilbrice" rel="me"><i class="fa-w-16" aria-hidden="true"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="pro-network" class="svg-inline--fa fa-pro-network fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Pro 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></i></a>
	
	
	<a href="https://stackoverflow.com/users/48136/brice" rel="me"><i class="fab fa-stack-overflow" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	
</section>

      </div>
    </div>

  </div>
  <div class="container fixed-container">
    
<div class="copyright">
  &copy; 2010 - 2026 Brice Dutheil
  
    <span style="white-space: nowrap;"><a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a></span>
  
</div>



  </div>
</div>

        <div class="content container">
            
    <header>

 
 
 <div class="github-edit">
     <a href="https://github.com/bric3/bric3.github.io/edit/hugo-sources/content/posts/2016-10-25-first-contact-with-zookeeper-peer-failure.md">
     <i class="fab fa-github fa-lg" aria-hidden="true"></i> Edit this page
     </a>
 </div>
 


</header>

            
    

<article>
  <header>
    <h1>Premier contact avec la perte d&rsquo;instances Zookeeper</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-days"></i> 2016-10-25
    
    
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/zookeeper">zookeeper</a>
           
      
          <a class="badge badge-tag" href="/tags/cluster">cluster</a>
           
      
          <a class="badge badge-tag" href="/tags/ensemble">ensemble</a>
          
      
    
    
    <br/>
    <i class="fas fa-clock"></i> 18 min read

    
    
    

</div>


  </header>
  
  
  
    <div class="toc-wrapper">
      <input type="checkbox" id="tocToggle" checked>
      <label for="tocToggle"><i class="fas fa-list-ul fa-lg"></i><span id="toc-title">On this page</span></label>
      <div id="toc-toggle-cover"></div>

      
          <nav id="TableOfContents">
  <ul>
    <li><a href="#comment-zookeeper-fonctionne-">Comment zookeeper fonctionne ?</a></li>
    <li><a href="#mise-en-pratique">Mise en pratique</a>
      <ul>
        <li><a href="#configuration">Configuration</a></li>
        <li><a href="#lancer-lensemble">Lancer l&rsquo;ensemble</a></li>
        <li><a href="#stopper-lensemble-zookeeper">Stopper l&rsquo;ensemble Zookeeper</a></li>
      </ul>
    </li>
    <li><a href="#supprimer-le-membre-leader-de-lensemble-zookeeper">Supprimer le membre leader de l&rsquo;ensemble Zookeeper</a>
      <ul>
        <li><a href="#stopper-linstance-proprement-avec-le-script-zkserver">Stopper l’instance proprement avec le script <code>zkServer</code></a></li>
        <li><a href="#stopper-linstance-avec-kill">Stopper l’instance avec <code>kill</code></a></li>
        <li><a href="#stopper-linstance-avec-kill--9">Stopper l’instance avec <code>kill -9</code></a></li>
        <li><a href="#rendre-lensemble-indisponible">Rendre l&rsquo;ensemble indisponible</a></li>
      </ul>
    </li>
    <li><a href="#wrap-up">Wrap Up</a></li>
  </ul>
</nav>
      
    </div>
  
  
  
  <div class="post md">
    <p>Zookeeper est un service de coordination distribuée. Son <a href="https://zookeeper.apache.org/doc/r3.4.9/recipes.html">usage</a> permet notamment de maintenir des informations de configuration, de faire du service discovery, de fournir des mécasnimes distribués de concurrence (lock).</p>
<p>Bien qu&rsquo;aujourd&rsquo;hui d&rsquo;autres logiciels plus pratiques et plus efficaces sont apparus, Zookeeper n&rsquo;en reste pas moins une pièce maitresse de certains outils comme <a href="http://hadoop.apache.org/">Hadoop</a> ou <a href="https://kafka.apache.org/documentation#quickstart_startserver">Kafka</a>.</p>
<h2 id="comment-zookeeper-fonctionne-">Comment zookeeper fonctionne ?</h2>
<p>Zookeeper peut fonctionner avec une seule instance ou avec plusieur, dasn ce cas appelé <em>ensemble Zookeeper</em>. L&rsquo;intérêt de Zookeeper est de fonctionner de manière distribué, une seul instance peut marcher, mais <strong>il n&rsquo;y a pas de continuité de service</strong> si cette seule instance s&rsquo;arrête.</p>
<p>Cet <em>ensemble</em> d&rsquo;instance Zookeeper vont donc partager un état. Lorsqu&rsquo;un changement doit avoir lieu sur cet état, le changement n&rsquo;est pas considéré comme terminé avec succès tant que le quorum de l&rsquo;ensemble Zookeeper n&rsquo;a pas été atteint. Ce qui veut dire <strong>plus de la la moitié</strong> des noeuds doivent acquitter l&rsquo;écriture.</p>
<p>Comme il s&rsquo;agit d&rsquo;un système distribué il peut y avoir des raisons pour les quelles une instance Zookeeper n&rsquo;est pas disponible (opération de maintenance, etc.). La règle de calcul pour établir le nombre d&rsquo;instances nécéssaire pour qu&rsquo;un ensemble supporte la perte d&rsquo;un certain nombre de membre est :</p>
<pre><code>( 2 x instance non disponible ) + 1
</code></pre>
<ul>
<li>Pour qu&rsquo;un ensemble puisse supporter la perte de une instance, il faudra 3 serveurs.</li>
<li>Pour qu&rsquo;un ensemble puisse supporter la perte de deux instances, il faudra 5 serveurs.</li>
<li>Pour qu&rsquo;un ensemble puisse supporter la perte de trois instances, il faudra 7 server.</li>
</ul>
<p>(À noter que plus il y a de noeuds plus le quorum <a href="http://zookeeper.apache.org/doc/r3.4.9/zookeeperOver.html#Performance">met longtemps à s&rsquo;établir</a> ; dans la majorité des cas un cluster de 3 ou 5 instances sera suffisant)</p>
<p>Cette formule conduit naturellement au fait que le nombre minimum nécéssaire pour un ensemble zookeeper sera toujours impair. Si le nombre de l&rsquo;ensemble était pair, le quorum ne serait toujours atteint qu&rsquo;avec plus de la moitié.</p>
<p>Exemple: Un cluster de 6 perds 2 instances, il en reste 4, le quorum peut être atteint. S&rsquo;il en en perd 3, il reste 3 instances, le quorum ne peut pas être atteint.</p>
<p>Enfin un ensemble zookeeper choisit toujours un leader, ce leader est choisit également par quorum. Les autres instances sont des <em>suiveurs</em> (follower). Toutes les écritures sont transferrée au leader. Les lectures peuvent en revanche être traitées par les autres instances.</p>
<p>Pour plus d&rsquo;info j&rsquo;invite à poursuivre sur le site de <a href="https://zookeeper.apache.org/doc/trunk/zookeeperOver.html">zookeeper</a>.</p>
<blockquote>
<p>À noter comme cet article n&rsquo;utilise pas  le terme <em>noeud</em> pour parler d&rsquo;une <em>instance</em> ou d&rsquo;un <em>serveur</em> Zookeeper, la raison est que le terme noeud (<code>node</code> donc) a une signification spéciale pour zookeeper. En effet un <code>node</code> correspond à un point dans <a href="https://zookeeper.apache.org/doc/r3.4.9/zookeeperOver.html#Nodes&#43;and&#43;ephemeral&#43;nodes">l&rsquo;arborescence Zookeeper</a>.</p>
</blockquote>
<h2 id="mise-en-pratique">Mise en pratique</h2>
<p>Pour s&rsquo;amuser un peu avec Zookeeper et ses collègues. Il est possible assez facilement de voir comment un ensemble zookeeper réagit à la perte de ses membres.</p>
<p>Cet exemple se base sur un ensemble de 5 instances. Qui est dans un premier temps en local.</p>
<h3 id="configuration">Configuration</h3>
<p>Bien sûr après avoir téléchargé la distributon de zookeeper, il faut préparer quelques répertoires</p>
<pre><code class="language-bash">mkdir -p ~/zktests/local/cluster
cd ~/zktests/local/cluster
wget http://www-eu.apache.org/dist/zookeeper/zookeeper-3.4.9/zookeeper-3.4.9.tar.gz
tar zxf zookeeper-3.4.9.tar.gz
</code></pre>
<p>Depuis ce dossier, il faut créer un fichier de configuration <code>zoo.template.cfg</code> qui servira de template pour toute les instances. Le texte à remplacer sera <code>{{peer}}</code> et <code>{{dataDir}}</code> :</p>
<pre><code class="language-properties">server.1=localhost:28881:38881
server.2=localhost:28882:38882
server.3=localhost:28883:38883
server.4=localhost:28884:38884
server.5=localhost:28885:38885
syncLimit=5
initLimit=10
tickTime=2000
quorumListenOnAllIPs=true
clientPort=2181{{peer}}
autopurge.purgeInterval=24
dataDir={{dataDir}}
autopurge.snapRetainCount=10
</code></pre>
<p>Ces placeholders devront être remplacé par le numéro du membre zookeeper. Ensuite il faut créer la structure des répertoires de chaque membre ainsi que les fichiers correspondants :</p>
<ul>
<li>Donc les 5 fichiers <code> zoo.$i.cfg</code> créés depuis <code>zoo.template.cfg</code> dans le répertoire courant (<code>~/zktests/local/cluster</code>)</li>
<li>Ensuite créer les 5 dossiers <code>$i</code>, c&rsquo;est là ou va être stockée les données de chaque instance (défini par la propriété <code>dataDir</code>)</li>
<li>Créer le fichier <code>myid</code> dans chacun de ces dossiers, ce fichier contiendra l&rsquo;identifiant du membre zookeeper (i.e. <code>$i</code>)</li>
</ul>
<pre><code class="language-bash">for i in {1..5}; do echo zk-$i; echo &quot;zk-peer-$i config file&quot;; cat zoo.template.cfg | sed -e &quot;s|{{dataDir}}|$(pwd)/$i|g&quot; -e &quot;s|{{peer}}|$i|g&quot; &gt; zoo.$i.cfg; done
for i in {1..5}; do mkdir $i; done
for i in {1..5}; do echo $i &gt; $i/myid; done
</code></pre>
<h3 id="lancer-lensemble">Lancer l&rsquo;ensemble</h3>
<p>Une fois que tout est près, on peut lancer chaque instance de zookeeper. La commande suivante permet de lancer ces 5 instances depuis le répertoire en cours (<code>~/zktests/local/cluster</code>)</p>
<pre><code class="language-bash">for i in {1..5}; do env ZOO_LOG_DIR=`pwd`/$i `pwd`/zookeeper-3.4.9/bin/zkServer.sh start `pwd`/zoo.$i.cfg; done
jps -v
</code></pre>
<p><code>jps</code> montre que ces instances tournent, le nom du programme est <code>QuorumPeerMain</code>. Mais est-ce que le cluster fonctionne correctement ? Pour cela il faut interroger les membres en envoyant sur le le port client (<code>clientPort</code>), un <a href="https://zookeeper.apache.org/doc/trunk/zookeeperAdmin.html#The&#43;Four&#43;Letter&#43;Words"><strong>mot à 4 lettres</strong></a> ; celui qui nous intéresse est le mot <code>stat</code>.</p>
<pre><code class="language-bash">for i in {1..5}; do echo &quot;\nzk peer $i\n---------&quot;; echo stat | nc localhost 2181$i; done
</code></pre>
<p>Il devrait y avoir 5 blocs de statistiques, avec les modes de chaque noeud (follower ou leader).</p>
<h3 id="stopper-lensemble-zookeeper">Stopper l&rsquo;ensemble Zookeeper</h3>
<p>Pour stopper correctement un ensemble il faut utiliser le script shell avec la commande <code>stop</code> la commande qui suit stoppe les 5 instances démarrées.</p>
<pre><code class="language-bash">for i in {1..5}; do env ZOO_LOG_DIR=`pwd`/$i `pwd`/zookeeper-3.4.9/bin/zkServer.sh stop `pwd`/zoo.$i.cfg; done
</code></pre>
<h2 id="supprimer-le-membre-leader-de-lensemble-zookeeper">Supprimer le membre leader de l&rsquo;ensemble Zookeeper</h2>
<p>Sur cet ensemble Zookeeper bien portant, on voudrait donc jouer avec la perte d&rsquo;une instance.</p>
<p>Pour monitorer les 5 noeuds en continue la commande suivante se base sur <code>watch</code></p>
<pre><code class="language-bash">watch --difference --color 'for i in {1..5}; do printf &quot;\nzk peer $i\n&quot;; echo stat | nc localhost 2181$i; done'
</code></pre>
<p>Une fois qu&rsquo;on peut voir l&rsquo;état de chaque noeud, on peut dans une console séparée, de préférence à coté.</p>
<h3 id="stopper-linstance-proprement-avec-le-script-zkserver">Stopper l&rsquo;instance proprement avec le script <code>zkServer</code></h3>
<p>Il faut en premier trouver le leader (<code>mode : leader</code>), par exemple si le server <code>2</code> est le leader on devrait voir quelque chose de similaire à :</p>
<pre><code>zk peer 2
Zookeeper version: 3.4.6-1569965, built on 02/20/2014 09:09 GMT
Clients:
 /0:0:0:0:0:0:0:1:64572[0](queued=0,recved=1,sent=0)

Latency min/avg/max: 0/0/0
Received: 202
Sent: 201
Connections: 1
Outstanding: 0
Zxid: 0x700000000
Mode: leader
Node count: 4
</code></pre>
<p>On peut stopper cette instance avec la commande suivante:</p>
<pre><code class="language-bash">env ZOO_LOG_DIR=`pwd`/2 `pwd`/zookeeper-3.4.9/bin/zkServer.sh stop `pwd`/zoo.2.cfg
</code></pre>
<p>Une fois le leader supprimé, le cluster élit un nouveau leader parmis les membres restants.</p>
<p>En local l&rsquo;élection est rapide. Le cluster n&rsquo;est <strong>indisponible</strong> qu&rsquo;un bref moment, mais il est quand même indisponible, sur réseau ce processus peut-être significativement plus long.</p>
<p>Maintenant supprimons un deuxième serveur, cet ensemble est constitué de cinq membre, la perte d&rsquo;un autre membre est donc tolérée.
Après la réélection le nouveau leader est l&rsquo;instance <code>5</code> :</p>
<pre><code class="language-bash">env ZOO_LOG_DIR=`pwd`/5 `pwd`/zookeeper-3.4.9/bin/zkServer.sh stop `pwd`/zoo.5.cfg
</code></pre>
<p>Une fois encore la suppression d&rsquo;un noeud montre une petite période d&rsquo;indisponibilité de l&rsquo;ensemble.</p>
<h3 id="stopper-linstance-avec-kill">Stopper l&rsquo;instance avec <code>kill</code></h3>
<p><code>kill</code> envoie le signal <code>TERM</code> (<code>15</code>), ce qui permet au processus de se terminer gracieusement.</p>
<p>Relancer tous les membres arretés, s&rsquo;il s&rsquo;agit des membres <code>2</code> et <code>5</code> il suffit de faire :</p>
<pre><code class="language-bash">env ZOO_LOG_DIR=`pwd`/2 `pwd`/zookeeper-3.4.6/bin/zkServer.sh stop `pwd`/zoo.2.cfg
env ZOO_LOG_DIR=`pwd`/5 `pwd`/zookeeper-3.4.6/bin/zkServer.sh stop `pwd`/zoo.5.cfg
</code></pre>
<p>En adaptant le scénario, c&rsquo;est à dire de trouver le leader, il fautdra trouver le <em>pid</em> du processus zookeeper :</p>
<p>Si le leader est le membre <code>1</code>, alors son pid peut se trouver dans le dossier de donnée (<code>dataDir</code>) de zookeeper. Un fichier qui contient ce pid est stocké dans ce répertoire sous le nom <code>zookeeper_server.pid</code>, on peut changer ce dossier avec la variable d&rsquo;environnement <code>ZOOPIDFILE</code>.</p>
<p>Donc pour terminer le process zookeeper :</p>
<pre><code class="language-bash">kill $(&lt; 1/zookeeper_server.pid)
</code></pre>
<p>De la même manière on peut observer que l&rsquo;ensemble est indisponible un court moment tant qu&rsquo;un nouveau leader n&rsquo;est pas élu.</p>
<h3 id="stopper-linstance-avec-kill--9">Stopper l&rsquo;instance avec <code>kill -9</code></h3>
<p>Même scénario qu&rsquo;au dessus pour retrouver le pid mais cette fois on envoie le signal <code>KILL</code> (<code>9</code>) qui tue le processus sans lui permettre de terminer gracieusement. Si le leader est le membre <code>2</code>.</p>
<pre><code class="language-bash">kill -KILL $(&lt; 2/zookeeper_server.pid)
</code></pre>
<p>Encore une fois le cluster zookeeper tolère la perte brutale d&rsquo;un noeud, mais demande un peu de temps pour élire un nouveau leader.</p>
<h3 id="rendre-lensemble-indisponible">Rendre l&rsquo;ensemble indisponible</h3>
<p>Il s&rsquo;agit d&rsquo;un cluster de 5 membres, celui-ci supporte la défaillance de 2 membres. Donc pour le rendre indisponible il faut éliminer un autre processus Zookeeper qu&rsquo;il soit leader ou pas:</p>
<pre><code class="language-bash">kill -KILL $(&lt; 4/zookeeper_server.pid)
</code></pre>
<p>Les stat des deux noeuds restant affichent alors le message :</p>
<pre><code>This ZooKeeper instance is not currently serving requests
</code></pre>
<h2 id="wrap-up">Wrap Up</h2>
<p>Un ensemble Zookeeper est capable de se remettre de la perte de ces membres tant que le quorum peut-être atteint. Cependant la perte des membres introduit une fenêtre d&rsquo;indisponibilité.
Qui plus est, les processus de cet ensemble utilise l&rsquo;interface <em>loopback</em> ; reproduire ces scénarios sur des machines différentes montrera que le réseau introduit des latences. Zookeeper n&rsquo;aime pas du tout les latences (par exemple une instance qui a des problèmes peut ralentir considérablement le reste de l&rsquo;ensemble Zookeeper pour le vote d&rsquo;acquittement d&rsquo;écriture ou pour élire un nouveau leader).</p>
<p>Ces considérations sont à prendre en compte lorsqu&rsquo;une maintenance est à prévoir sur les machines qui hébergent ces processus.</p>

  </div>
  

<div class="navigation navigation-single">
    
    <a href="/2016/04/01/1000_first_primes/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">The First 1,000 Primes</span>
    </a>
    
    
    <a href="/2016/12/05/make-docker-container-access-host-ssh-tunnel/" class="navigation-next">
      <span class="navigation-tittle">Connecter un container docker sur un tunnel ssh OSX</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  

  <script
    src="https://giscus.app/client.js"
    data-repo="bric3/bric3.github.io"
    data-repo-id="MDEwOlJlcG9zaXRvcnk2MDc3NjczMQ=="
    data-category="Blog Comments"
    data-category-id="DIC_kwDOA59hG84CR_S_"
    data-mapping="pathname"
    data-reactions-enabled="1"
    data-input-position="top"
    data-theme="preferred-color-scheme"
    data-lang="en"
    data-loading="lazy"
    data-strict="1"
    
    data-theme="preferred-color-scheme"
    crossorigin="anonymous"
    async
  ></script>


</article>


            
    
<footer>

 
 
 <div class="github-edit">
     <a href="https://github.com/bric3/bric3.github.io/edit/hugo-sources/content/posts/2016-10-25-first-contact-with-zookeeper-peer-failure.md">
     <i class="fab fa-github fa-lg" aria-hidden="true"></i> Edit this page
     </a>
 </div>
 















<script>
window.MathJax = {
  loader: {
    load: ['input/asciimath']
  },
  tex: {
    inlineMath: [['\\(', '\\)']],
    displayMath: [['\\[', '\\]']],
    tags: 'none'
  },
  asciimath: {
    delimiters: [['$', '$'], ['`', '`']]
  },
  options: {
    ignoreHtmlClass: 'nostem|nolatexmath|noasciimath',
    processHtmlClass: 'stemblock|latexmath|asciimath'
  },
  startup: {
    ready() {
      MathJax.startup.defaultReady();
      MathJax.startup.promise.then(() => {
        
        const asciimath = MathJax._.input.asciimath.AsciiMath?.AsciiMath;
        if (asciimath) {
          const originalCompile = asciimath.Compile;
          asciimath.Compile = function(latex, display) {
            const node = this.parseMath(latex);
            
            if (node && node.parentNode?.parentNode?.classList?.contains('stemblock')) {
              display = true;
            }
            return originalCompile.call(this, latex, display);
          };
        }
      });
    }
  }
};



</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/4.0.0/tex-mml-chtml.js" integrity="sha512-D0eU0TwZjXn2FsQXymdhToKse0yD7CFS6dQhhBQe5sUKYVp1hufw6lQtXxpvwBRj7dDjVJ858l2HEfktsOBv0A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js" integrity="sha512-EBLzUL8XLl+va/zAsmXwS7Z2B1F9HUHkZwyS/VKwh3S7T/U0nF4BaU29EP/ZSf6zgiIxYAnKLu6bJ8dqpmX5uw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script type="text/javascript">
        
        
        
        
        
        var mergeHTMLPlugin = (function () {
            'use strict';

            var originalStream;

            

            function escapeHTML(value) {
                return value
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#x27;');
            }

             

             
            const mergeHTMLPlugin = {
                
                "before:highlightElement": ({ el }) => {
                    originalStream = nodeStream(el);
                },
                
                "after:highlightElement": ({ el, result, text }) => {
                    if (!originalStream.length) return;

                    const resultNode = document.createElement('div');
                    resultNode.innerHTML = result.value;
                    result.value = mergeStreams(originalStream, nodeStream(resultNode), text);
                    el.innerHTML = result.value;
                }
            };

             

            


            

            function tag(node) {
                return node.nodeName.toLowerCase();
            }

            

            function nodeStream(node) {
                 
                const result = [];
                (function _nodeStream(node, offset) {
                    for (let child = node.firstChild; child; child = child.nextSibling) {
                        if (child.nodeType === 3) {
                            offset += child.nodeValue.length;
                        } else if (child.nodeType === 1) {
                            result.push({
                                event: 'start',
                                offset: offset,
                                node: child
                            });
                            offset = _nodeStream(child, offset);
                            
                            
                            
                            if (!tag(child).match(/br|hr|img|input/)) {
                                result.push({
                                    event: 'stop',
                                    offset: offset,
                                    node: child
                                });
                            }
                        }
                    }
                    return offset;
                })(node, 0);
                return result;
            }

            

            function mergeStreams(original, highlighted, value) {
                let processed = 0;
                let result = '';
                const nodeStack = [];

                function selectStream() {
                    if (!original.length || !highlighted.length) {
                        return original.length ? original : highlighted;
                    }
                    if (original[0].offset !== highlighted[0].offset) {
                        return (original[0].offset < highlighted[0].offset) ? original : highlighted;
                    }

                    

                    return highlighted[0].event === 'start' ? original : highlighted;
                }

                

                function open(node) {
                     
                    function attributeString(attr) {
                        return ' ' + attr.nodeName + '="' + escapeHTML(attr.value) + '"';
                    }
                    
                    result += '<' + tag(node) + [].map.call(node.attributes, attributeString).join('') + '>';
                }

                

                function close(node) {
                    result += '</' + tag(node) + '>';
                }

                

                function render(event) {
                    (event.event === 'start' ? open : close)(event.node);
                }

                while (original.length || highlighted.length) {
                    let stream = selectStream();
                    result += escapeHTML(value.substring(processed, stream[0].offset));
                    processed = stream[0].offset;
                    if (stream === original) {
                        

                        nodeStack.reverse().forEach(close);
                        do {
                            render(stream.splice(0, 1)[0]);
                            stream = selectStream();
                        } while (stream === original && stream.length && stream[0].offset === processed);
                        nodeStack.reverse().forEach(open);
                    } else {
                        if (stream[0].event === 'start') {
                            nodeStack.push(stream[0].node);
                        } else {
                            nodeStack.pop();
                        }
                        render(stream.splice(0, 1)[0]);
                    }
                }
                return result + escapeHTML(value.substr(processed));
            }

            return mergeHTMLPlugin;

        }());
        hljs.addPlugin(mergeHTMLPlugin);
        


        
        hljs.highlightAll();
    </script>
    

<script>


(function() {
  'use strict';

  
  function getScrollInfo(element, checkChildren = true) {
    let scrollLeft = element.scrollLeft;
    let scrollWidth = element.scrollWidth;
    const clientWidth = element.clientWidth;

    if (checkChildren) {
      
      const codeElement = element.querySelector('code');
      if (codeElement && codeElement.scrollWidth > scrollWidth) {
        scrollWidth = codeElement.scrollWidth;
        if (codeElement.scrollLeft > 0 || element.scrollLeft === 0) {
          scrollLeft = Math.max(scrollLeft, codeElement.scrollLeft);
        }
      }

      
      const tableElement = element.querySelector('table');
      if (tableElement && tableElement.scrollWidth > scrollWidth) {
        scrollWidth = tableElement.scrollWidth;
        if (tableElement.scrollLeft > 0 || element.scrollLeft === 0) {
          scrollLeft = Math.max(scrollLeft, tableElement.scrollLeft);
        }
      }
    }

    const maxScroll = scrollWidth - clientWidth;
    
    const hasOverflow = scrollWidth > clientWidth + 2;

    return { scrollLeft, scrollWidth, clientWidth, maxScroll, hasOverflow };
  }

  
  function applyScrollClasses(element, scrollInfo) {
    if (!scrollInfo.hasOverflow) {
      element.classList.remove('has-scroll-shadow-left', 'has-scroll-shadow-right');
      return;
    }

    
    if (scrollInfo.scrollLeft > 5) {
      element.classList.add('has-scroll-shadow-left');
    } else {
      element.classList.remove('has-scroll-shadow-left');
    }

    
    if (scrollInfo.scrollLeft < scrollInfo.maxScroll - 5) {
      element.classList.add('has-scroll-shadow-right');
    } else {
      element.classList.remove('has-scroll-shadow-right');
    }
  }

  
  function updateScrollShadows(element) {
    const scrollInfo = getScrollInfo(element);
    applyScrollClasses(element, scrollInfo);
  }

  function initScrollShadows() {
    
    const selectors = [
      '.post.adoc .literalblock pre',
      '.post.adoc .listingblock > .content > pre',
      '.post.adoc .openblock > .content > pre',  
      '.post.md pre',  
      '.table-wrapper',  
    ];

    const scrollables = document.querySelectorAll(selectors.join(', '));
    scrollables.forEach(element => {
      
      let scrollingElement = element;
      let targetElement = element;  

      
      let checkChildren = true;

      if (element.classList.contains('table-wrapper')) {
        
        const admonitionBlock = element.querySelector(':scope > .admonitionblock');
        if (admonitionBlock) {
          const computedStyle = window.getComputedStyle(admonitionBlock);
          if (computedStyle.overflowX === 'auto' || computedStyle.overflowX === 'scroll') {
            scrollingElement = admonitionBlock;  
            targetElement = element;  
            checkChildren = true;  
          }
        } else {
          
          const table = element.querySelector(':scope > table');
          if (table) {
            const computedStyle = window.getComputedStyle(table);
            if (computedStyle.overflowX === 'auto' || computedStyle.overflowX === 'scroll') {
              scrollingElement = table;  
              targetElement = element;  
              checkChildren = false;  
            }
          }
        }
      }

      
      const updateShadows = () => {
        const scrollInfo = getScrollInfo(scrollingElement, checkChildren);
        applyScrollClasses(targetElement, scrollInfo);
      };

      
      updateShadows();

      
      scrollingElement.addEventListener('scroll', updateShadows, { passive: true });

      
      if (checkChildren) {
        
        const codeElement = scrollingElement.querySelector('code');
        if (codeElement) {
          codeElement.addEventListener('scroll', updateShadows, { passive: true });
        }

        
        const tableElement = scrollingElement.querySelector('table');
        if (tableElement) {
          tableElement.addEventListener('scroll', updateShadows, { passive: true });
        }
      }
    });

    
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        scrollables.forEach(element => updateScrollShadows(element));
      }, 150);
    }, { passive: true });
  }

  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initScrollShadows);
  } else {
    initScrollShadows();
  }

  
  window.addEventListener('load', () => {
    setTimeout(() => {
      const selectors = [
        '.post.adoc .literalblock pre',
        '.post.adoc .listingblock > .content > pre',
        '.post.adoc .openblock > .content > pre',  
        '.post.md pre',
        '.table-wrapper'
      ];
      const scrollables = document.querySelectorAll(selectors.join(', '));
      scrollables.forEach(element => updateScrollShadows(element));
    }, 500);
  });

  
  window.debugScrollShadow = function(element) {
    if (typeof element === 'string') {
      element = document.querySelector(element);
    }
    if (!element) {
      console.error('Element not found');
      return;
    }
    updateScrollShadows(element);
  };

  
  window.refreshScrollShadows = function() {
    const selectors = [
      '.post.adoc .literalblock pre',
      '.post.adoc .listingblock > .content > pre',
      '.post.adoc .openblock > .content > pre',
      '.post.md pre',
      '.table-wrapper'
    ];
    const scrollables = document.querySelectorAll(selectors.join(', '));
    scrollables.forEach(element => {
      
      if (element.offsetParent === null) return;
      updateScrollShadows(element);
    });
  };
})();
</script>
<script type="text/javascript">

function children(element, selector) {
	if (!selector) return Array.from(element.children);
	return Array.from(element.children).filter(child => child.matches(selector));
}

function siblings(element, selector) {
	const sibs = Array.from(element.parentElement.children).filter(child => child !== element);
	return selector ? sibs.filter(sib => sib.matches(selector)) : sibs;
}

function getOffset(element) {
	const rect = element.getBoundingClientRect();
	return {
		top: rect.top + window.scrollY,
		left: rect.left + window.scrollX
	};
}

function addBlockSwitches() {
	document.querySelectorAll('.primary').forEach(primary => {
		const switchItem = createSwitchItem(primary, createBlockSwitch(primary));
		switchItem.item.classList.add("selected");
		const title = children(primary, '.title')[0];
		if (title) title.remove();
	});

	document.querySelectorAll('.secondary').forEach(secondary => {
		const primary = findPrimary(secondary);
		const switchElement = children(primary, '.switch')[0];
		const switchItem = createSwitchItem(secondary, switchElement);
		switchItem.content.classList.add('hidden');
		findPrimary(secondary).appendChild(switchItem.content);
		secondary.remove();
	});
}

function createBlockSwitch(primary) {
	const blockSwitch = document.createElement('div');
	blockSwitch.className = 'switch';
	primary.prepend(blockSwitch);
	return blockSwitch;
}

function findPrimary(secondary) {
	let candidate = secondary.previousElementSibling;
	while (candidate && !candidate.matches('.primary')) {
		candidate = candidate.previousElementSibling;
	}
	return candidate;
}

function createSwitchItem(block, blockSwitch) {
	const titleElement = children(block, '.title')[0];
	const blockName = titleElement ? titleElement.textContent : '';
	const contentElement = children(block, '.content')[0];
	const colist = block.nextElementSibling?.matches('.colist') ? block.nextElementSibling : null;
	if (contentElement && colist) {
		contentElement.appendChild(colist);
	}
	const item = document.createElement('div');
	item.className = 'switch--item';
	item.textContent = blockName;
	blockSwitch.appendChild(item);
	return {'item': item, 'content': contentElement};
}

function globalSwitch() {
	document.querySelectorAll('.switch--item').forEach(item => {
		const blockId = blockIdForSwitchItem(item);

		
		const newItem = item.cloneNode(true);
		item.parentNode.replaceChild(newItem, item);

		newItem.addEventListener('click', function() {
			const selectedText = this.textContent;
			window.localStorage.setItem(blockId, selectedText);

			
			const clickedSwitch = this.closest('.openblock.primary');

			
			const scrollTopBefore = window.scrollY;
			const offsetTopBefore = getOffset(clickedSwitch).top;

			Array.from(document.querySelectorAll(".switch--item"))
				.filter(el => blockIdForSwitchItem(el) === blockId)
				.filter(el => el.textContent === selectedText)
				.forEach(el => select(el));

			
			requestAnimationFrame(function() {
				requestAnimationFrame(function() {
					
					const offsetTopAfter = getOffset(clickedSwitch).top;

					
					const scrollAdjustment = offsetTopAfter - offsetTopBefore;

					if (Math.abs(scrollAdjustment) > 1) {
						window.scrollTo({
							top: scrollTopBefore + scrollAdjustment,
							behavior: 'instant'
						});
					}

					
					setTimeout(function() {
						if (typeof window.refreshScrollShadows === 'function') {
							window.refreshScrollShadows();
						}
					}, 0);
				});
			});
		});

		if (newItem.textContent === window.localStorage.getItem(blockId)) {
			select(newItem);
		}
	});
}

function blockIdForSwitchItem(item) {
	const idComponents = [];
	idComponents.push(item.textContent.toLowerCase());
	siblings(item, ".switch--item").forEach(sibling => {
		idComponents.push(sibling.textContent.toLowerCase());
	});
	return idComponents.sort().join("-");
}

function select(selected) {
	selected.classList.add('selected');
	siblings(selected).forEach(sib => sib.classList.remove('selected'));

	const parent = selected.parentElement;
	const selectedIndex = Array.from(parent.children).indexOf(selected);
	const contentElements = siblings(parent, ".content");

	if (contentElements[selectedIndex]) {
		contentElements[selectedIndex].classList.remove('hidden');
		contentElements.forEach((content, idx) => {
			if (idx !== selectedIndex) {
				content.classList.add('hidden');
			}
		});
	}
}


if (document.readyState === 'loading') {
	document.addEventListener('DOMContentLoaded', function() {
		addBlockSwitches();
		globalSwitch();
	});
} else {
	addBlockSwitches();
	globalSwitch();
}
</script>

<script type="text/javascript">
  
  
  window.addEventListener("load", () => {
    if (!'IntersectionObserver' in window) {
      return;
    }

    
    const sections = Array.from(document.querySelectorAll("section[id], h2[id], h3[id], h4[id], h5[id]"));
    const visibleSectionClass = "visible-section";

    
    
    const scrollHandler = entries =>
            entries.forEach(entry => {
              const section = entry.target;
              const sectionId = section.id;
              const sectionLink = document.querySelector(`a[href="#${sectionId}"]`);

              console.log(sectionId, sectionLink);
              console.log(entry)
              console.log(entry.intersectionRect.height / entry.rootBounds.height)

              if (entry.intersectionRatio > 0) {
                section.classList.add(visibleSectionClass);
                sectionLink.classList.add(visibleSectionClass);
              } else {
                section.classList.remove(visibleSectionClass);
                sectionLink.classList.remove(visibleSectionClass);
              }
            });

    
    const observer = new IntersectionObserver(scrollHandler);
    sections.map(section => {
      if (section.tagName === "SECTION") {
        return section;
      } else {
        
        
        
        
        
        
        
        
        let actualSectionContainer = section.parentElement;
        actualSectionContainer.id = section.id;
        return actualSectionContainer;
      }
    }).forEach(section => observer.observe(section));
  });

</script>






</footer>

    



        </div>
    </body>
</html>

